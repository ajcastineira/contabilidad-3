<?php//funcion AJAX que es llamada por 'cobrar_facturas_proceso.php'session_start();require_once '../general/funcionesGenerales.php';require_once '../CN/clsCNContabilidad.php';$clsCNContabilidad=new clsCNContabilidad();$clsCNContabilidad->setStrBD($_SESSION['dbContabilidad']);$clsCNContabilidad->setStrBDCliente($_SESSION['mapeo']);$IdFactura = $_GET['idFactura'];//primero comprobamos que esta factura no este cobrada por que se este recargando la pagina //(para no hacerlo dos o mas veces en este proceso)if(isset($_SESSION['facturasCobradas'][$IdFactura]) && $_SESSION['facturasCobradas'][$IdFactura] === 'SI'){    //si existe es que ya esta guardadopor lo que nos salimos    echo '';die;}$cantidad = $_GET['cantidad'];$pendiente = $_GET['pendiente'];$fecha = fecha_to_DATETIME($_GET['fecha']);$cuenta57 = substr($_GET['cuenta57'],0,9);$fecha2 = explode('/',$_GET['fecha']);$periodo = (int)$fecha2[1];$ejercicio = $fecha2[2];$respuesta='Factura ';$datosFactura=$clsCNContabilidad->datosFactura($IdFactura);//ahora guardo en la tabla tbmisfacturas_cobros los datos de cada factura//y actualizo en la tabla tbmisfacturas.Situacion el estado que queda la factura//si se a cobrado todo se indicara Situacion=Cobrada, sino Situacion=Cobro parcial$OK = $clsCNContabilidad->FacturaCobro($IdFactura,$cantidad,$fecha,$cuenta57);if((float)$cantidad === (float)$pendiente){    $clsCNContabilidad->ActualizarSituacionFactura($IdFactura,'Cobrada');}else{    $clsCNContabilidad->ActualizarSituacionFactura($IdFactura,'Cobro parcial');}//preparo los datos para insertarlo utilizando la funcion AltaIngresosGastos()$movimientosAsiento[]=array("IdMovimiento"=>'',                            "Cuenta"=>$cuenta57,                            "Concepto"=>'Cobro Factura '.$datosFactura['NumFactura'],                            "Cantidad"=>$cantidad,                            "DoH"=>'D');$movimientosAsiento[]=array("IdMovimiento"=>'',                            "Cuenta"=>$datosFactura['Cliente'],                            "Concepto"=>'Cobro Factura '.$datosFactura['NumFactura'],                            "Cantidad"=>$cantidad,                            "DoH"=>'H');$OK = $clsCNContabilidad->AltaIngresosGastos($_SESSION["idEmp"],$movimientosAsiento,$_GET['fecha'],$periodo, $ejercicio, $_SESSION["strUsuario"]);   if($OK === true){    //guardo en session que el cobro de esta factura esta guardada    //por si se recargara la pagina de donde llaman a esta funcion AJAX no lo guarde    $_SESSION['facturasCobradas'][$IdFactura] = 'SI';        $respuesta=$respuesta.$datosFactura['NumFactura'].'...OK<br>';}else{    $respuesta=$respuesta.$datosFactura['NumFactura'].'...ERROR<br>';}echo $respuesta;?>