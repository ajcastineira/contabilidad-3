<?phpclass clsCADMovimientos {    private $strDB = '';    function setStrBD($str) {        $this->strDB = $str;    }    function getStrBD() {        return $this->strDB;    }    //($empresa,$strCuenta,$strPeriodo,$lngEjercicio,$datFecha,$datFechaFin,$strOperacion,$strCantidad,$lngCantidad,$strConcepto);    function ListadoASP_Mov($empresa, $strCuenta, $strPeriodo, $lngEjercicio, $datFecha, $datFechaFin, $strOperacion, $strCantidad, $lngCantidad, $strConcepto) {        require_once '../general/' . $_SESSION['mapeo'];//		require_once '../general/conexion.php';        $db = new DbC();        $db->conectar($this->getStrBD());        //extraigo los datos de los usuarios de las tablas 'tbusuarios', 'tbempleados', 'tbdepartamentos' y 'tbcargos'//BORRAR--> PRAP PROBAR//$strCuenta = '700000000';               //La cuenta habrá que tratarla con NumCuenta - Nombre Cuenta          $strSQL = "SELECT * " .                "FROM tbmovimientos " .                " WHERE borrado = 1 and activo = 1  " .                " and idCuenta = '" . $strCuenta . "'";        //incluyo los filtros        if ($strPeriodo <> '') {            $strSQL = $strSQL . " AND periodo = '" . $strPeriodo . "'";        }        if ($strConcepto <> '') {            $strSQL = $strSQL . " AND concepto like '%" . $strConcepto . "%'";        }        if ($lngEjercicio <> '') {            $strSQL = $strSQL . " AND ejercicio =" . $lngEjercicio;        }        if (($datFecha <> '') && ($datFechaFin <> '')) {            $strSQL = $strSQL . " AND fechaApunte between '" . date('Y-m-d', strtotime($datFecha)) . " %' and '" . date('Y-m-d', strtotime($datFechaFin)) . " %'";        } else {            if ($datFecha <> '') {                $strSQL = $strSQL . " AND fechaApunte > '" . date('Y-m-d', strtotime($datFecha)) . " %'";            }            if ($datFechaFin <> '') {                $strSQL = $strSQL . " AND fechaApunte < '" . date('Y-m-d', strtotime($datFechaFin)) . " %'";            }        }        if ($strOperacion <> '') {            $strSQL = $strSQL . " AND DoH = '" . $strOperacion . "'";        }        if (($strCantidad <> '') && ($lngCantidad <> '')) {            $strSQL = $strSQL . " AND cantidad " . $strCantidad . $lngCantidad;        }        logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                ', SesionID: ' . session_id() . " ListadoASP_Mov($empresa,$strCuenta,$strPeriodo,$lngEjercicio,$datFecha,$datFechaFin,$strOperacion,$strCantidad,$lngCantidad,$strConcepto)|| SQL : " . $strSQL);        $stmt = $db->ejecutar($strSQL);        $db->desconectar();        //aqui guardo los datos de la consulta        $arDoc = '';        if ($stmt) {            //tengo datos            while ($row = mysql_fetch_array($stmt, MYSQL_ASSOC)) {                $arDoc[] = array("Id" => $row['IdMovimiento'],                    "idEmpresa" => $row['IdEmpresa'],                    "asiento" => $row['asiento'],                    "orden" => $row['orden'],                    "idCuenta" => $row['idcuenta'],                    "Grupo" => $row['Grupo'],                    "SubGrupo2" => $row['Subgrupo2'],                    "SubGrupo4" => $row['Subgrupo4'],                    "DoH" => $row['DoH'],                    "cantidad" => $row['cantidad'],                    "Saldo" => $row['Saldo'],                    "fecha" => $row['fecha'],                    "fechaApunte" => $row['fechaApunte'],                    "periodo" => $row['periodo'],                    "ejercicio" => $row['ejercicio'],                    "concepto" => $row['concepto'],                    "strUsuario" => $row['strUsuario'],                    "activo" => $row['activo'],                    "" => $row['Borrado']                );            }            logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                    ', SesionID: ' . session_id() . " ListadoASP_Mov($empresa,$strCuenta,$strPeriodo,$lngEjercicio,$datFecha,$datFechaFin,$strOperacion,$strCantidad,$lngCantidad,$strConcepto)|| SQL : " . $strSQL . " Si hay datos");            return $arDoc;        } else {            logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                    ', SesionID: ' . session_id() . " ListadoASP_Mov($empresa,$strCuenta,$strPeriodo,$lngEjercicio,$datFecha,$datFechaFin,$strOperacion,$strCantidad,$lngCantidad,$strConcepto)|| SQL : " . $strSQL . " NO hay datos");            return $arDoc;        }   //no hay datos        return '';    }    function ListadoASP_MovAgru($empresa, $strCuenta, $lngNumDigits, $strPeriodo, $lngEjercicio, $datFecha, $datFechaFin, $strOperacion, $strCantidad, $lngCantidad, $strConcepto) {        require_once '../general/' . $_SESSION['mapeo'];//		require_once '../general/conexion.php';        $db = new DbC();        $db->conectar($this->getStrBD());        //extraigo los datos de los usuarios de las tablas 'tbusuarios', 'tbempleados', 'tbdepartamentos' y 'tbcargos'//BORRAR--> PRAP PROBAR//$strCuenta = '700000000';               $cuenta_limitada = substr($strCuenta, 0, $lngNumDigits);        //La cuenta habrá que tratarla con NumCuenta - Nombre Cuenta          $strSQL = "SELECT * " .                "FROM tbacumulados " .                " WHERE cuenta like '" . $cuenta_limitada . "%'";        //incluyo los filtros        if ($strPeriodo <> '') {            $strSQL = $strSQL . " AND periodo = '" . $strPeriodo . "'";        }        // if($strConcepto<>''){        //     $strSQL=$strSQL." AND concepto like '%".$strConcepto."%'";        //}        if ($lngEjercicio <> '') {            $strSQL = $strSQL . " AND ejercicio =" . $lngEjercicio;        }        $strSQL = $strSQL . " order by cuenta asc";        /* 	if(($datFecha<>'') && ($datFechaFin<>'')) {          $strSQL=$strSQL." AND fecha between '".date('Y-m-d',strtotime($datFecha))." %' and '".date('Y-m-d',strtotime($datFechaFin))." %'" ;          }else{          if($datFecha<>''){          $strSQL=$strSQL." AND fecha > '".date('Y-m-d',strtotime($datFecha))." %'" ;          }          if($datFechaFin<>''){          $strSQL=$strSQL." AND fecha < '".date('Y-m-d',strtotime($datFechaFin))." %'" ;          }          }          if($strOperacion<>''){          $strSQL=$strSQL." AND DoH = '".$strOperacion."'" ;          }          if(($strCantidad<>'') && ($lngCantidad<>'')){          $strSQL=$strSQL." AND cantidad ".$strCantidad.$lngCantidad ;          }         */        logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                ', SesionID: ' . session_id() . " ListadoASP_Mov($empresa,$strCuenta,$lngNumDigits,$strPeriodo,$lngEjercicio,$datFecha,$datFechaFin,$strOperacion,$strCantidad,$lngCantidad,$strConcepto)|| SQL : " . $strSQL);        $stmt = $db->ejecutar($strSQL);        $db->desconectar();        //aqui guardo los datos de la consulta        $arDoc = '';        if ($stmt) {            //tengo datos            while ($row = mysql_fetch_array($stmt, MYSQL_ASSOC)) {                $arDoc[] = array("Id" => $row['IdMovimiento'],                    "idEmpresa" => $row['IdEmpresa'],                    "ejercicio" => $row['ejercicio'],                    "periodo" => $row['periodo'],                    "cuenta" => $row['cuenta'],                    "debe" => $row['debe'],                    "haber" => $row['haber'],                    "fecha" => $row['fecha']                );            }            logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                    ', SesionID: ' . session_id() . " ListadoASP_Mov($empresa,$strCuenta,$lngNumDigits,$strPeriodo,$lngEjercicio,$datFecha,$datFechaFin,$strOperacion,$strCantidad,$lngCantidad,$strConcepto)|| SQL : " . $strSQL . " Si hay datos");            return $arDoc;        } else {            logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                    ', SesionID: ' . session_id() . " ListadoASP_Mov($empresa,$strCuenta,$lngNumDigits,$strPeriodo,$lngEjercicio,$datFecha,$datFechaFin,$strOperacion,$strCantidad,$lngCantidad,$strConcepto)|| SQL : " . $strSQL . " NO hay datos");            return $arDoc;        }   //no hay datos        return '';    }    function AcumuladosAgrupados($empresa, $Mapa, $Tipo) {        require_once '../general/' . $_SESSION['mapeo'];//		require_once '../general/conexion2.php';        $db = new Db();        $db->conectar($this->getStrBD());        $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where Tipo = '" . $Tipo . "' and Mapa ='" . $Mapa . "' group by Tipo";        if ($Tipo == 'PyG1_13') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where lngAux2 <> 'null' and lngAux2 <= 13  and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'PyG14_19') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where lngAux2 <> 'null' and lngAux2 > 13 and lngAux2 <= 19 and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'PyG_AB') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where lngAux2 <> 'null' and lngAux2 <= 19 and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'PyG_C20') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where lngAux2 <> 'null' and lngAux2 <= 20 and Mapa ='" . $Mapa . "'";        }//Particularizadas para Para Balances        if ($Tipo == 'ANC') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where strAux1 = 'ACTIVO_NO_CORRIENTE' and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'AC') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where strAux1 = 'ACTIVO_CORRIENTE' and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'TOTAL_AB') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where strAux1 in ('ACTIVO_NO_CORRIENTE', 'ACTIVO_CORRIENTE') and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'PN') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where strAux1 = 'PATRIMONIO_NETO'  and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'PNC') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where strAux1 = 'PASIVO_NO_CORRIENTE' and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'PC') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where strAux1 = 'PASIVO_CORRIENTE' and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'TOTAL_ABC') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where strAux1 in ('PATRIMONIO_NETO', 'PASIVO_NO_CORRIENTE', 'PASIVO_CORRIENTE') and Mapa ='" . $Mapa . "'";        }        //echo $Tipo . " - " . $strSQL;        //echo "<br>";        //$strSQL= "select ValorDebe, valorHaber, saldo from tbmapastemp where Tipo = '" . $Tipo . "' and Mapa ='" . $Mapa . "' group by Tipo";	           logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                ', SesionID: ' . session_id() . " AcumuladosAgrupados($empresa,$strTipo,$Mapa,$Tipo)|| SQL : " . $strSQL);        $stmt = $db->ejecutar($strSQL);        //$db->desconectar ();        $arDoc = '';        if ($stmt) {            //tengo datos            //$cnt=0;            //while($row=  mysql_fetch_array($stmt,MYSQL_ASSOC)){            //  $cnt= $cnt +1;            $row = mysql_fetch_array($stmt, MYSQL_ASSOC);            $arDoc[] = array("debe" => $row['debe'],                "haber" => $row['haber'],                "saldo" => $row['saldo'],                "strAux" => $row['strAux']);            //}	        }        return $arDoc;    }    function AcumuladosAgrupadosB($empresa, $Mapa, $Tipo) {        require_once '../general/' . $_SESSION['mapeo'];//		require_once '../general/conexion2.php';        $db = new Db();        $db->conectar($this->getStrBD());                /*          -------------------------------          A - Activo No Corriente          B - Activo Corriente          Total Activo (A + B)          -------------------------------          A - Patrimonio Neto          B - Pasivo No Corriente          C - Pasivo Corriente          Total PN + PASIVO  (A + B + C)          -------------------------------         *///Consulta General		        $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where Tipo = '" . $Tipo . "' and Mapa ='" . $Mapa . "' group by Tipo";//Particularizadas para PyG        if ($Tipo == 'PyG1_13') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where lngAux2 <> 'null' and lngAux2 <= 13  and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'PyG14_19') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where lngAux2 <> 'null' and lngAux2 > 13 and lngAux2 <= 19 and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'PyG_AB') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where lngAux2 <> 'null' and lngAux2 <= 19 and Mapa ='" . $Mapa . "'";        }        if ($Tipo == 'PyG_C20') {            $strSQL = "select sum(ValorDebe) as debe, sum(valorHaber) as haber, sum(saldo) as saldo, strAux from tbmapastemp where lngAux2 <> 'null' and lngAux2 <= 20 and Mapa ='" . $Mapa . "'";        }        //$strSQL= "select ValorDebe, valorHaber, saldo from tbmapastemp where Tipo = '" . $Tipo . "' and Mapa ='" . $Mapa . "' group by Tipo";	           logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                ', SesionID: ' . session_id() . " AcumuladosAgrupados($empresa,$strTipo,$Mapa,$Tipo)|| SQL : " . $strSQL);        $stmt = $db->ejecutar($strSQL);        //$db->desconectar ();        $arDoc = '';        if ($stmt) {            //tengo datos            //$cnt=0;            //while($row=  mysql_fetch_array($stmt,MYSQL_ASSOC)){            //  $cnt= $cnt +1;            $row = mysql_fetch_array($stmt, MYSQL_ASSOC);            $arDoc[] = array("debe" => $row['debe'],                "haber" => $row['haber'],                "saldo" => $row['saldo'],                "strAux" => $row['strAux']);            //}	        }        return $arDoc;    }    function ListadoASP_Balance($empresa, $strTipo, $strPeriodoD, $strPeriodoH, $lngEjercicio, $lngDigitos) {        function MacheaFechas($fecha) {            /*              selectPeriodo($_GET['strPeriodoD'], 'APERTURA');              selectPeriodo($_GET['strPeriodoD'], 'ENERO');              selectPeriodo($_GET['strPeriodoD'], 'FEBRERO');              selectPeriodo($_GET['strPeriodoD'], 'MARZO');              selectPeriodo($_GET['strPeriodoD'], 'ABRIL');              selectPeriodo($_GET['strPeriodoD'], 'MAYO');              selectPeriodo($_GET['strPeriodoD'], 'JUNIO');              selectPeriodo($_GET['strPeriodoD'], 'JULIO');              selectPeriodo($_GET['strPeriodoD'], 'AGOSTO');              selectPeriodo($_GET['strPeriodoD'], 'SEPTIEMBRE');              selectPeriodo($_GET['strPeriodoD'], 'OCTUBRE');              selectPeriodo($_GET['strPeriodoD'], 'NOVIEMBRE');              selectPeriodo($_GET['strPeriodoD'], 'DICIEMBRE');              selectPeriodo($_GET['strPeriodoD'], 'CIERRE_E');              selectPeriodo($_GET['strPeriodoD'], 'CIERRE_C'); */            switch ($fecha) {                case "APERTURA":                    return 0;                    break;                case "ENERO":                    return 1;                    break;                case "FEBRERO":                    return 2;                    break;                case "MARZO":                    return 3;                    break;                case "ABRIL":                    return 4;                    break;                case "MAYO":                    return 5;                    break;                case "JUNIO":                    return 6;                    break;                case "JULIO":                    return 7;                    break;                case "AGOSTO":                    return 8;                    break;                case "SEPTIEMBRE":                    return 9;                    break;                case "OCTUBRE":                    return 10;                    break;                case "NOVIEMBRE":                    return 11;                    break;                case "DICIEMBRE":                    return 12;                    break;                case "CIERRE_E":                    return 13;                    break;                case "CIERRE_C":                    return 14;                    break;            }        }//        require_once '../general/conexion2.php';        require_once '../general/' . $_SESSION['mapeo'];        $db = new Db();        $db->conectar($this->getStrBD());        //Primero hacer un Update de la tabla tbmapastemp para resetear la tabla        $strSQL = "UPDATE tbmapastemp set valorDebe = 0, valorHaber = 0, saldo = 0 ";        logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                ', SesionID: ' . session_id() . " ListadoASP_Balance($empresa,$strTipo,$strPeriodoD,$strPeriodoH,$lngEjercicio,$lngDigitos)|| SQL : " . $strSQL);        $stmt1 = $db->ejecutar($strSQL);        //Posteriormente sacamos las cuentas pertenecientes a PyG o al Balance	           $strSQL = "SELECT cuenta " .                "FROM tbmapas " .                " WHERE mapa = '" . $strTipo . "' and nivel = 1 and cuenta <> ''";        logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                ', SesionID: ' . session_id() . " ListadoASP_Balance($empresa,$strTipo,$strPeriodoD,$strPeriodoH,$lngEjercicio,$lngDigitos)|| SQL : " . $strSQL);        $stmt = $db->ejecutar($strSQL);        //aqui guardo los datos de la consulta        $arDoc = '';        if ($stmt) {            //tengo datos            $cnt = 0;            while ($row = mysql_fetch_array($stmt, MYSQL_ASSOC)) {                $cnt = $cnt + 1;                $arDoc[] = array("Id" => $row['cuenta']);                //***********************************************************************+                //Posteriormente sacamos los valores de las cuentas de la tabla acumulados                //Sacamos el id cuenta sobre el strsub indicado (1 o 3)                 $lngDigitos = 3;                if ($lngDigitos == "") {                    $lngDigitos = 3;                }                $cuentaSub = substr($row['cuenta'], 0, $lngDigitos);                $strSQL = "select sum(debe) as debe, sum(haber) as haber, (sum(debe) - sum(haber)) as saldo " .                        "from tbacumulados " .                        "where cuenta like '" . $cuentaSub . "%'";                //Gestion de Condiciones   $empresa,$strTipo,$strPeriodoD,$strPeriodoH,$lngEjercicio,$lngDigitos                if (($strPeriodoD <> '') && ($strPeriodoH <> '')) {                    $desde = MacheaFechas($strPeriodoD);                    $hasta = MacheaFechas($strPeriodoH);                    $strSQL = $strSQL . " and Periodo between " . $desde . " and " . $hasta;                }                if ($lngEjercicio <> '') {                    $strSQL = $strSQL . " and Ejercicio = " . $lngEjercicio;                }                logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                        ', SesionID: ' . session_id() . " ListadoASP_Balance($empresa,$strTipo,$strPeriodoD,$strPeriodoH,$lngEjercicio,$lngDigitos)|| SQL : " . $strSQL);                $stmt2 = $db->ejecutar($strSQL);                //$db->desconectar ();                $cnt2 = 0;                while ($row2 = mysql_fetch_array($stmt2, MYSQL_ASSOC)) {                    $cnt2 = $cnt2 + 1;                    $arDoc[] = array("Debe" => $row2['debe'],                        "Haber" => $row2['haber'],                        "Saldo" => $row2['saldo']);                    //Por último updateamos		                    $strSQL = "UPDATE tbmapastemp set valorDebe = " . $row2['debe'] . ", valorHaber =" . $row2['haber'] . " , saldo =" . $row2['saldo'] . " where cuenta = " . $cuentaSub . " and Mapa = '" . $strTipo . "'";                    logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                            ', SesionID: ' . session_id() . " ListadoASP_Balance($empresa,$strTipo,$strPeriodoD,$strPeriodoH,$lngEjercicio,$lngDigitos)|| SQL : " . $strSQL);                    $stmt3 = $db->ejecutar($strSQL);                }            }            logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                    ', SesionID: ' . session_id() . " ListadoASP_Mov($empresa,$strCuenta,$lngNumDigits,$strPeriodo,$lngEjercicio,$datFecha,$datFechaFin,$strOperacion,$strCantidad,$lngCantidad,$strConcepto)|| SQL : " . $strSQL . " Si hay datos");            /*             * ****************************************************** */            //Por último leo de la tabla los resultados temporales que acabamos de introducir            $strSQL3 = "SELECT * " .                    "FROM tbmapastemp " .                    " WHERE mapa = '" . $strTipo . "'";            logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                    ', SesionID: ' . session_id() . " ListadoASP_Balance($empresa,$strTipo,$strPeriodoD,$strPeriodoH,$lngEjercicio,$lngDigitos)|| SQL : " . $strSQL3);            $stmt3 = $db->ejecutar($strSQL3);                        //aqui guardo los datos de la consulta            $arDoc3 = '';            if ($stmt3) {                //tengo datos                $cnt = 0;                while ($row = mysql_fetch_array($stmt3, MYSQL_ASSOC)) {                    $cnt = $cnt + 1;                    $arDoc3[] = array("IdDato" => $row['IdDato'],                        "GrupoDato" => $row['GrupoDato'],                        "Mapa" => $row['Mapa'],                        "Nivel" => $row['Nivel'],                        "OrdenCabecera" => $row['OrdenCabecera'],                        "Descripcion" => $row['Descripcion'],                        "NivelLinea" => $row['NivelLinea'],                        "Cuenta" => $row['Cuenta'],                        "Cuenta" => $row['Cuenta'],                        "Tipo" => $row['Tipo'],                        "ValorDebe" => $row['ValorDebe'],                        "ValorHaber" => $row['ValorHaber'],                        "Saldo" => $row['Saldo'],                        "strAux" => $row['strAux'],                        "strAux1" => $row['strAux1'],                        "lngAux" => $row['lngAux'],                        "lngAux2" => $row['lngAux2']                    );                }            }            $db->desconectar();            return $arDoc3;        } else {            logger('traza', 'clsCADMovimientos.php-', "Usuario: " . $_SESSION['strUsuario'] . ', Empresa: ' . $_SESSION['strBD'] .                    ', SesionID: ' . session_id() . " ListadoASP_Mov($empresa,$strCuenta,$lngNumDigits,$strPeriodo,$lngEjercicio,$datFecha,$datFechaFin,$strOperacion,$strCantidad,$lngCantidad,$strConcepto)|| SQL : " . $strSQL . " NO hay datos");            return $arDoc;        }   //no hay datos        return '';    }    function SumasYSaldos(&$get){        require_once '../general/'.$_SESSION['mapeo'];        $db = new Db();        $db->conectar($this->getStrBD());                        //preparo el listado de los periodos        $desde = macheaPeriodo($get['strPeriodoDesde']);        $hasta = macheaPeriodo($get['strPeriodoHasta']);                //como son numeros enteros (0 al 14), si desde = 2 y hasta = 6 el listado es (2,3,4,5,6)        $listado = '(' . $desde;        //$resta = $hasta - $desde;        for ($i = $desde+1; $i <= $hasta; $i++) {            $listado = $listado . ',' . $i;        }        $listado = $listado . ')';        //si vienen vacias las cuentas (lngCuentaDesde y lngCuentaHasta)        //pongo por defecto la 100000000 y 999999999        if($get['lngCuentaDesde'] === ''){            $get['lngCuentaDesde'] = '100000000';        }        if($get['lngCuentaHasta'] === ''){            $get['lngCuentaHasta'] = '999999999';        }                //para hacer la consulta primero distinguimos si son detalladas o de resumen        //si son detalladas incluimos las cuentas tal cual vienen        //si son de resumen solo cojo los 3 primeros digitos        if($get['detalle_resumen'] === 'resumen'){            $get['lngCuentaDesde'] = substr($get['lngCuentaDesde'],0,3).'000000';            $get['lngCuentaHasta'] = substr($get['lngCuentaHasta'],0,3).'999999';        }                //preparo la consulta a la tabla 'tbacumulados'        $strSQL = "                    SELECT A.Cuenta, ROUND(SUM(A.Debe),2) AS Debe, ROUND(SUM(A.Haber),2) AS Haber                    FROM tbacumulados A                    WHERE A.Ejercicio = " . $get['lngEjercicio'] . "                    AND A.Periodo IN $listado                   ";        //incluyo los filtros        if($get['lngCuentaDesde'] !== ''){            $strSQL = $strSQL . " AND A.Cuenta >= ".$get['lngCuentaDesde'];        }        if($get['lngCuentaHasta'] !== ''){            $strSQL = $strSQL . " AND A.Cuenta <= ".$get['lngCuentaHasta'];        }        $strSQL = $strSQL . " GROUP BY A.Cuenta";                logger('traza','clsCADMovimientos.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().               " clsCADMovimientos->SumasYSaldos()|| SQL : ".$strSQL);        $stmt = $db->ejecutar ( $strSQL );        //$db->desconectar ();        if(!$stmt){            //si ha fallado la consulta DEVOLVEMOS false            $db->desconectar ();            logger('traza','clsCADMovimientos.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().                    " clsCADMovimientos->SumasYSaldos()<ROLLBACK");            return false;        }                $resultado='';        while($row=mysql_fetch_array($stmt)){            $reg='';            foreach($row as $propiedad=>$valor){                if(!is_numeric($propiedad)){                    $reg[$propiedad]=$valor;                }            }            $resultado[] = $reg;        }                        //ahora incluyo el nombre de la cuenta y el saldo        if(is_array($resultado)){            for ($i = 0; $i < count($resultado); $i++) {                //busco el nombre de la cuenta                $strSQL = "                            SELECT C.Nombre                            FROM tbcuenta C                            WHERE C.NumCuenta='".$resultado[$i]['Cuenta']."'                            AND C.Borrado=0                           ";                                logger('traza','clsCADMovimientos.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().                       " clsCADMovimientos->SumasYSaldos()|| SQL : ".$strSQL);                $stmt = $db->ejecutar ( $strSQL );                //$db->desconectar ();                if($stmt){                    $row = mysql_fetch_array($stmt);                    $resultado[$i]['Nombre'] = $row['Nombre'];                    $saldo = (double)$resultado[$i]['Debe'] - (double)$resultado[$i]['Haber'];                    if($saldo >= 0){//positivo                        $resultado[$i]['SaldoDeudor'] = $saldo;                        $resultado[$i]['SaldoAcreedor'] = 0.00;                    }else{//negativo                        $resultado[$i]['SaldoDeudor'] = 0.00;                        $resultado[$i]['SaldoAcreedor'] = -$saldo;                    }                }else{                    //si ha fallado la consulta DEVOLVEMOS false                    $db->desconectar ();                    logger('traza','clsCADMovimientos.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().                            " clsCADMovimientos->SumasYSaldos()<ROLLBACK");                    return false;                }            }        }                //var_dump($resultado);die;                //ahora vemos si tienen que ir todas las cuentas o solo las que tienen saldo        //(la vble $resultado solo tiene las cuentas con saldo)        if($get['cuentas_con_saldo'] === 'todas' || $get['detalle_resumen'] === 'resumen'){            //incluyo el resto de cuentas con ceros en el array $resultado            //el listado lo extraigo de la tabla 'tbcuenta'            $strSQL = "                        SELECT C.NumCuenta, C.Nombre                        FROM tbcuenta C                        WHERE C.NumCuenta >= " . $get['lngCuentaDesde'] . "                        AND C.NumCuenta <= " . $get['lngCuentaHasta'] . "                        AND C.Borrado=0                        ORDER BY C.NumCuenta                       ";                        logger('traza','clsCADMovimientos.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().                   " clsCADMovimientos->SumasYSaldos()|| SQL : ".$strSQL);            $stmt = $db->ejecutar ( $strSQL );            //$db->desconectar ();            if(!$stmt){                //si ha fallado la consulta DEVOLVEMOS false                $db->desconectar ();                logger('traza','clsCADMovimientos.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().                        " clsCADMovimientos->SumasYSaldos()<ROLLBACK");                return false;            }            $cuentas='';            while($row=mysql_fetch_array($stmt)){                $reg='';                foreach($row as $propiedad=>$valor){                    if(!is_numeric($propiedad)){                        $reg[$propiedad]=$valor;                    }                }                $cuentas[] = $reg;            }                        //ahora hago el array final con los dos arrays(cuentas y resultados)            $resultFinal = '';            for ($i = 0; $i < count($cuentas); $i++) {                for ($j = 0; $j < count($resultado); $j++) {                    $encontrado = 'NO';                    if($cuentas[$i]['NumCuenta'] === $resultado[$j]['Cuenta']){                        $encontrado = 'SI';                        $resultFinal[] = $resultado[$j];                        break;                    }                }                                if($encontrado === 'NO'){                    $reg2['Cuenta'] = $cuentas[$i]['NumCuenta'];                    $reg2['Debe'] = 0;                    $reg2['Haber'] = 0;                    $reg2['Nombre'] = $cuentas[$i]['Nombre'];                    $reg2['SaldoDeudor'] = 0;                    $reg2['SaldoAcreedor'] = 0;                    $resultFinal[] = $reg2;                }            }        }else{            $resultFinal = $resultado;        }                        //por último miro si $get['detalle_resumen'] === 'resumen',         //entonces agrupo el array en cuentas de 3 primeros digitos        $result3cifras = '';        if($get['detalle_resumen'] === 'resumen'){            for ($i = 0; $i < count($resultFinal); $i++) {                //sumo las cuentas por el resumen de la cuenta de 3 digitos                $trescifras = substr($resultFinal[$i]['Cuenta'], 0,3);                $reg3 = $resultFinal[$i];                //renombro el campo                $reg3['Cuenta'] = $trescifras.'******';                for ($j = $i+1; $j <= count($resultFinal); $j++) {                    if($trescifras === substr($resultFinal[$j]['Cuenta'], 0,3)){                        //sumo esta fila a la anterior                        $reg3['Debe'] = $reg3['Debe'] + $resultFinal[$j]['Debe'];                        $reg3['Haber'] = $reg3['Haber'] + $resultFinal[$j]['Haber'];                    }else{                        //lo añado al array final                        $saldo3cifras = $reg3['Debe'] - $reg3['Haber'];                        $saldo3cDeudor = '0';                        $saldo3cAcreedor = '0';                        if($saldo3cifras > 0){                            $saldo3cDeudor = $saldo3cifras;                        }else                        if($saldo3cifras < 0){                            $saldo3cAcreedor = -$saldo3cifras;                        }                        $reg3['SaldoDeudor'] = $saldo3cDeudor;                        $reg3['SaldoAcreedor'] = $saldo3cAcreedor;                        $result3cifras[] = $reg3;                        $i = $j-1;                        break;                    }                }            }                        $resultFinal = $result3cifras;        }                return $resultFinal;    }}?>