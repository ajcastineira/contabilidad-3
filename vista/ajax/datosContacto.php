<?phpsession_start();//carga la conexionrequire_once '../../general/'.$_SESSION['mapeo'];$dbC = new Db();require_once '../../general/conexion.php';$dbG = new DbC();//cojemos el parametro 'q' de la URL$tipo=$_GET["q"];$numero=$_GET['numero'];//si $tipo CO=contacto se busca por IdContacto//si $tipo CL=cliente se busca por NumCuentaif($tipo==='CO'){    $query="SELECT CONCAT(M.NombreContacto,' ',M.ApellidosContacto) AS Cliente,M.NombreEmpresa,            M.CIF,M.direccion,CONCAT(M.CodPostal,' - ',M.Ciudad) AS poblacion,M.Provincia,M.FormaPagoHabitual,M.Correo            FROM tbmiscontactos M            WHERE M.Borrado=1             AND M.IdCliProv=0             AND M.IdContacto=".$numero;    $dbC->conectar($_SESSION['mapeo']);    $result=$dbC->ejecutar($query);    $dbC->desconectar();    if($result){        $count= mysql_num_rows($result);        if($count>0){            $row= mysql_fetch_array($result);            $datos=array(                "Cliente"=>$row['Cliente'],                "NombreEmpresa"=>$row['NombreEmpresa'],                "CIF"=>$row['CIF'],                "direccion"=>$row['direccion'],                "poblacion"=>$row['poblacion'],                "provincia"=>$row['Provincia'],                "FormaPagoHabitual"=>$row['FormaPagoHabitual'],                "Correo"=>$row['Correo'],            );            $response=$datos;        }else{            $response='vacio';        }    }else{        $response='vacio';    }}else if($tipo==='CL'){    //la informacion que extraemos esta en dos tablas, dbContabilidad.tbcliprov y dbCliente.tbmiscontactos    //y se busca de esta forma    //1-Cliente: tbmiscontactos.NombreContacto + tbmiscontactos.ApellidosContacto    //2-NombreEmpresa: tbcliprov.nombre    //3-CIF: tbcliprov.CIF    //4-direccion: tbcliprov.direccion    //5-poblacion: tbcliprov.municipio    //6-FormaPagoHabitual: tbmiscontactos.FormaPagoHabitual    //7-Correo: tbcliprov.Correo        //array donde guardo los datos    $datos=array(        "Cliente"=>'',        "NombreEmpresa"=>'',        "CIF"=>'',        "direccion"=>'',        "FormaPagoHabitual"=>'',        "CC_Trans"=>'',        "Correo"=>'',        "Correo2"=>'',    );        //primero hago la consulta en dbContabilidad.tbcliprov y estraigo los campos 2, 3 y 4    //el numero de la cuenta en la tabla tbrelacioncliprov esta dividido en dos partes    //4300=0 se guarda en CliProv y  el resto '00005' se guarda en 'codigo'//    $codigo=substr($numero,-5);    $codigo=$numero;    $query="            SELECT C.nombre AS NombreEmpresa,C.CIF,            C.direccion,CONCAT(C.CP,' - ',C.municipio) AS poblacion,C.provincia,C.IdCliProv,C.Correo,C.Correo2,R.CC_Recibos            FROM tbrelacioncliprov R, tbcliprov C            WHERE C.IdCliProv=R.IdCliProv            AND R.Borrado=0            AND R.CliProv=0            AND R.IdEmpresa=".$_SESSION['idEmp']."            AND R.codigo='$codigo'            ";    $dbG->conectar($_SESSION['dbContabilidad']);    $result=$dbG->ejecutar($query);    $dbG->desconectar();        if($result){        $count= mysql_num_rows($result);        if($count>0){            $row= mysql_fetch_array($result);            $datos['NombreEmpresa']=$row['NombreEmpresa'];//2            $datos['CIF']=$row['CIF'];//3            $datos['direccion']=$row['direccion'];//4            $datos['poblacion']=$row['poblacion'];//5            $datos['provincia']=$row['provincia'];//6            $datos['Correo']=$row['Correo'];//7            $datos['Correo2']=$row['Correo2'];//7b            $datos['CC_Recibos']=$row['CC_Recibos'];                        $IdCliProv=$row['IdCliProv'];                        //ahora hago la consulta contra la tabla dbCliente.tbmiscontactos            //y extraigo si encuentro los campos 1 y 5            $query="                    SELECT CONCAT(C.NombreContacto,' ',C.ApellidosContacto) AS Cliente,C.FormaPagoHabitual,C.Correo                    FROM tbmiscontactos C                    WHERE C.IdCliProv =$IdCliProv                    AND Borrado=1                    ";            $dbC->conectar($_SESSION['mapeo']);            $result2=$dbC->ejecutar($query);            $dbC->desconectar();            if($result2){                $count= mysql_num_rows($result2);                if($count>0){                    $row= mysql_fetch_array($result2);                    $datos['Cliente']=$row['Cliente'];                    $datos['FormaPagoHabitual']=$row['FormaPagoHabitual'];                    //$datos['Correo']=$row['Correo'];                }            }        }    }}//devuelvo el array de datos con lo que haya encontrado$response=$datos;//devuelvo la respuesta al sendecho json_encode($response);?>