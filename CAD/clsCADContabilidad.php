<?php
class clsCADContabilidad{
    //Tipos de Asientos
    //El numero se hace con 3 digitos = 03A
    //Tabla con el tipo de Asiento y caracteristicas
    //
    //TIPOASIENTO |    TIPO    |  FACTURA  |  IVA  |  IRPF  |  CUENTAS
    //-------------------------------------------------------------------
    //    00N     |  Gasto     |    No     |    No    |   No   |    1
    //    01N     |  Gasto     |    Si     |     1    |   No   |    1
    //    02N     |  Gasto     |    Si     |     1    |   Si   |    1
    //    03N     |  Gasto     |    Si     |  Varios  |   No   |    1
    //    04N     |  Gasto     |    Si     |  Varios  |   Si   |    1
    //    05N     |  Gasto     |    Si     |     1    |   No   |  Varias
    //    06N     |  Gasto     |    Si     |     1    |   Si   |  Varias
    //    07N     |  Gasto     |    Si     |  Varios  |   No   |  Varias
    //    08N     |  Gasto     |    Si     |  Varios  |   Si   |  Varias
    //-------------------------------------------------------------------
    //    10N     |  Ingreso   |    No     |    No    |   No   |    1
    //    11N     |  Ingreso   |    Si     |     1    |   No   |    1
    //    12N     |  Ingreso   |    Si     |     1    |   Si   |    1
    //    13N     |  Ingreso   |    Si     |  Varios  |   No   |    1
    //    14N     |  Ingreso   |    Si     |  Varios  |   Si   |    1
    //    15N     |  Ingreso   |    Si     |     1    |   No   |  Varias
    //    16N     |  Ingreso   |    Si     |     1    |   Si   |  Varias
    //    17N     |  Ingreso   |    Si     |  Varios  |   No   |  Varias
    //    18N     |  Ingreso   |    Si     |  Varios  |   Si   |  Varias
    
    
    
    private $strDB = '';
    private $strDBCliente='';
    
    public $IVAREPERCUTIDO='477000000';
    public $IVASOPORTADO='472000000';
    public $IRPF='475100000';
    public $IRPFPago='473000000';

    function setStrBD($str) {
        $this->strDB = $str;
    }

    function getStrBD() {
        return $this->strDB;
    }

    function setStrBDCliente($str){
        $this->strDBCliente=$str;
    }

    function getStrBDCliente(){
        return $this->strDBCliente;
    }
    
    function SelectCuentas($GRoSUBGR,$valor){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //y ahora hago la insercion en la tabla 'tbcuenta'
        $strSQL = "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas,NumCuenta
                   FROM tbcuenta
                   WHERE ".$GRoSUBGR." = ".$valor." AND Borrado=0 ORDER BY NumCuenta ASC";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->SelectCuentas($GRoSUBGR,$valor)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //introduzco los datos en un array y lo devuelvo
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->SelectCuentas($GRoSUBGR,$valor)<TRUE");
            $resultado=array();
            $idx=1;
            while ($row=  mysql_fetch_array($stmt)){
                $resultado[$idx]=array(
                                    "NumCuenta"=>$row['NumCuenta'],
                                    "cuentas"=>$row['cuentas']
                                 );
                $idx++;
            }
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->SelectCuentas($GRoSUBGR,$valor)<FALSE");
            return false;
        }
    }

    function AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario) || START TRANSACTION");
        
        //________________________________________________________________________________________________
        //________________________________________________________________________________________________-
        //  INSERTAMOS LOS DATOS PARA LA CUENTA 1 ES DECIR LA DEL CLIENTE.
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario) || CUENTA 1 CLIENTE");
        
        //averiguo el valor asiento de la tabla 'tbmovimientos' mas alto que haya
        $strSQL = 'SELECT asiento FROM tbmovimientos ORDER BY asiento DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| SQL : ".$strSQL);
        $stmt11 = $db->ejecutar ( $strSQL );
        if($stmt11){
            $num=  mysql_num_rows($stmt11);
            $asiento=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt11);
                $asiento=$row['asiento']+1;
            }else{
                $asiento=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| Asiento : ".$asiento);
        
        //obtengo la informacion de la cuenta origen
        //si no existe doy error (la busco en la funcion DatosCuenta donde le paso la conexion $db)
        $cuentaOrigen = $this->DatosCuenta($strCuentaCli,$db);
        if($cuentaOrigen=='ERRORGEN'){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| ERRORGEN");
            return false;
        }
        
        //OBTENGO LA INFO DEL SALDO AUNQUE NO VALGA A POSTERIORI
        $strSQL = "SELECT saldo FROM tbmovimientos WHERE idCuenta = '" . $strCuentaCli . "'
                   AND borrado = 1 AND activo= 1  ORDER BY idMovimiento DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| SQL : ".$strSQL);
        $stmt12 = $db->ejecutar ( $strSQL );
        if($stmt12){
            $num=  mysql_num_rows($stmt12);
            $saldo=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt12);
                $saldo=$row['saldo']+$lngIngreso;
            }else{
                $saldo=0;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| Saldo Ingreso: ".$saldo);

        //obtengo el idMovimiento
        $strSQL = "SELECT idMovimiento FROM tbmovimientos ORDER BY idMovimiento DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| SQL : ".$strSQL);
        $stmt13 = $db->ejecutar ( $strSQL );
        if($stmt13){
            $num=  mysql_num_rows($stmt13);
            $idMovimiento=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt13);
                $idMovimiento=$row['idMovimiento']+1;
            }else{
                $idMovimiento=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| idMovimiento : ".$idMovimiento);
        
        //hago la insercion en la tabla 'tbmovimientos'
        $strSQL = "INSERT INTO tbmovimientos (IdMovimiento, idEmpresa, asiento, orden, idCuenta, Grupo, SubGrupo2, SubGrupo4, DoH, cantidad, " .
                  "Saldo, Fecha, fechaApunte, periodo, ejercicio,concepto, strUsuario, activo,Borrado) " .
                  "VALUES (" . $idMovimiento . "," . $idEmp . "," . $asiento . ",1,'" . $strCuentaCli . "'," . $cuentaOrigen['Grupo'] .
                  ", " . $cuentaOrigen['SubGrupo2'] . ", " . $cuentaOrigen['SubGrupo4'] . ",'D'," . $lngIngreso . "," . $saldo . "," .
                  "now(),'" . fecha_to_DATETIME($datFecha) . "','" . $lngPeriodo . "'," . $lngEjercicio . ",'" . $strConcepto . "','" . $usuario . "',1,1)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| SQL : ".$strSQL);
        $stmt14 = $db->ejecutar ( $strSQL );
        if(!$stmt14){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)<ROLLBACK");
            return false;
        }
        
        
        //________________________________________________________________________________________________
        //________________________________________________________________________________________________-
        //  HACEMOS LO MISMO PARA LA CUENTA 2 ES DECIR LA DE ORIGEN.
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| CUENTA 2 ORIGEN");
        //obtengo la informacion de la cuenta origen
        //si no existe doy error (la busco en la funcion DatosCuenta donde le paso la conexion $db
        $cuentaOrigen = $this->DatosCuenta($strCuenta,$db);
        if($cuentaOrigen=='ERRORGEN'){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| ERRORGEN");
            return false;
        }
        //OBTENGO LA INFO DEL SALDO AUNQUE NO VALGA A POSTERIORI
        $strSQL = "SELECT saldo FROM tbmovimientos WHERE idCuenta = '" . $strCuenta . "'
                   AND borrado = 1 AND activo= 1  ORDER BY idMovimiento DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| SQL : ".$strSQL);
        $stmt21 = $db->ejecutar ( $strSQL );
        if($stmt21){
            $num=  mysql_num_rows($stmt21);
            $saldo=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt21);
                $saldo=$row['saldo']+$lngCantidad;
            }else{
                $saldo=0;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| Saldo Cliente: ".$saldo);

        //obtengo el idMovimiento
        $strSQL = "SELECT idMovimiento FROM tbmovimientos ORDER BY idMovimiento DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| SQL : ".$strSQL);
        $stmt22 = $db->ejecutar ( $strSQL );
        if($stmt22){
            $num=  mysql_num_rows($stmt22);
            $idMovimiento=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt22);
                $idMovimiento=$row['idMovimiento']+1;
            }else{
                $idMovimiento=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| idMovimiento : ".$idMovimiento);
        
        $strSQL = "INSERT INTO tbmovimientos (IdMovimiento, idEmpresa, asiento, orden, idCuenta, Grupo, SubGrupo2, SubGrupo4, DoH, cantidad, " .
                  "Saldo, Fecha, fechaApunte, periodo, ejercicio,concepto, strUsuario, activo,Borrado) " .
                  "VALUES (" . $idMovimiento . "," . $idEmp . "," . $asiento . ",2,'" . $strCuenta . "'," . $cuentaOrigen['Grupo'] .
                  ", " . $cuentaOrigen['SubGrupo2'] . ", " . $cuentaOrigen['SubGrupo4'] . ",'H'," . $lngCantidad . "," . $saldo . "," .
                  "now(),'" . fecha_to_DATETIME($datFecha) . "','" . $lngPeriodo . "'," . $lngEjercicio . ",'" . $strConcepto . "','" . $usuario . "',1,1)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| SQL : ".$strSQL);
                
        $stmt23 = $db->ejecutar ( $strSQL );
        if(!$stmt23){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)<ROLLBACK");
            return false;
        }

        
        //________________________________________________________________________________________________
        //________________________________________________________________________________________________-
        //  HACEMOS LO MISMO PARA EL IVA QUE SERIA LA CUENTA 3 IVA
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| CUENTA 3 IVA");
        
        //obtengo la informacion de la cuenta origen
        //si no existe doy error (la busco en la funcion DatosCuenta donde le paso la conexion $db
        $cuentaOrigen = $this->DatosCuenta($this->IVAREPERCUTIDO,$db);
        if($cuentaOrigen=='ERRORGEN'){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| ERRORGEN");
            return false;
        }
        
        //OBTENGO LA INFO DEL SALDO AUNQUE NO VALGA A POSTERIORI
        $strSQL = "SELECT saldo FROM tbmovimientos WHERE idCuenta = '" . $this->IVAREPERCUTIDO . "'
                   AND borrado = 1 AND activo= 1  ORDER BY idMovimiento DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| SQL : ".$strSQL);
        $stmt31 = $db->ejecutar ( $strSQL );
        if($stmt31){
            $num=  mysql_num_rows($stmt31);
            $saldo=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt31);
                $saldo=$row['saldo']+$lngIva;
            }else{
                $saldo=0;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| Saldo IVA: ".$saldo);
        
        //obtengo el idMovimiento
        $strSQL = "SELECT idMovimiento FROM tbmovimientos ORDER BY idMovimiento DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| SQL : ".$strSQL);
        $stmt32 = $db->ejecutar ( $strSQL );
        if($stmt32){
            $num=  mysql_num_rows($stmt32);
            $idMovimiento=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt32);
                $idMovimiento=$row['idMovimiento']+1;
            }else{
                $idMovimiento=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                             $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| idMovimiento : ".$idMovimiento);
        
        $strSQL = "INSERT INTO tbmovimientos (IdMovimiento, idEmpresa, asiento, orden, idCuenta, Grupo, SubGrupo2, SubGrupo4, DoH, cantidad, " .
                  "Saldo, Fecha, fechaApunte, periodo, ejercicio,concepto, strUsuario, activo,Borrado) " .
                  "VALUES (" . $idMovimiento . "," . $idEmp . "," . $asiento . ",3,'" . $this->IVAREPERCUTIDO . "'," . $cuentaOrigen['Grupo'] .
                  ", " . $cuentaOrigen['SubGrupo2'] . ", " . $cuentaOrigen['SubGrupo4'] . ",'H'," . $lngIva . "," . $saldo . "," .
                  "now(),'" . fecha_to_DATETIME($datFecha) . "','" . $lngPeriodo . "'," . $lngEjercicio . ",'" . $strConcepto . "','" . $usuario . "',1,1)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)|| SQL : ".$strSQL);
                
        $stmt33 = $db->ejecutar ( $strSQL );
        if(!$stmt33){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                    $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)<ROLLBACK");
            return false;
        }
        
        
        //actualizo la tabla atbacumulados
        $this->actualizar_tbacumulados();
        
        //-------------------------------------------------------------
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaMovimientos($idEmp,$strCuenta, $lngIngreso,$strCuentaCli,$lngCantidad,$lngIva,
                $datFecha,$lngPeriodo,$lngEjercicio,$strConcepto,$usuario)<COMMIT");
        return true;
    }
    
    //REVISAR 4/10/2013
    private function DatosCuenta($strCuentaCli,$conexion){

        //hago la consulta
        $strSQL = "SELECT Grupo,SubGrupo2,SubGrupo4 FROM tbcuenta WHERE NumCuenta ='" . $strCuentaCli . "' AND Borrado=0";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->DatosCuenta($strCuentaCli)|| SQL : ".$strSQL);
        $stmt = $conexion->ejecutar ( $strSQL );
        
        //introduzco los datos en un array y lo devuelvo
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->DatosCuenta($strCuentaCli)<TRUE");
            //$resultado=array();
            $row=  mysql_fetch_array($stmt);
            $resultado=array(
                                "Grupo"=>$row['Grupo'],
                                "SubGrupo2"=>$row['SubGrupo2'],
                                "SubGrupo4"=>$row['SubGrupo4']
                             );
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->DatosCuenta($strCuentaCli)<FALSE");
            return 'ERRORGEN';
        }
    }
    
    private function numeroAsientoNuevo($db){
        //averiguo el valor asiento de la tabla 'tbmovimientos' mas alto que haya
        $strSQL = 'SELECT asiento FROM tbmovimientos ORDER BY asiento DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->numeroAsientoNuevo()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $asiento=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $asiento=$row['asiento']+1;
            }else{
                $asiento=1;
            }
        }else{
            //devolvemos false
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->numeroAsientoNuevo()|| Asiento : ".$asiento);
        return $asiento;
    }
    
    private function tbmovimientos_insertar($idEmp,$asiento,$contOrden,$strCuenta,$DoH,$importe,$saldo,$datFecha,$strPeriodo,
                                            $lngEjercicio,$strConcepto,$strUsuario,$db,$tipoAsiento){
        
        $grupo=substr($strCuenta,0,1);
        $subGrupo2=substr($strCuenta,0,2);
        $subGrupo4=substr($strCuenta,0,4);

        //obtengo el idMovimiento
        $strSQL = "SELECT idMovimiento FROM tbmovimientos ORDER BY idMovimiento DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_insertar()|| SQL : ".$strSQL);
        $stmt13 = $db->ejecutar ( $strSQL );
        if($stmt13){
            $num=  mysql_num_rows($stmt13);
            $idMovimiento=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt13);
                $idMovimiento=$row['idMovimiento']+1;
            }else{
                $idMovimiento=1;
            }
        }else{
            //devolvemos false
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_insertar()|| idMovimiento : ".$idMovimiento);
        
        //hago la insercion en la tabla 'tbmovimientos'
        $strSQL = "INSERT INTO tbmovimientos (IdMovimiento, idEmpresa, asiento, orden, idCuenta, Grupo, SubGrupo2, SubGrupo4, DoH, cantidad, " .
                  "Saldo, Fecha, fechaApunte, periodo, ejercicio,concepto, TipoAsiento, strUsuario, activo,Borrado) " .
                  "VALUES (" . $idMovimiento . "," . $idEmp . "," . $asiento . ",$contOrden,'" . $strCuenta . "'," . $grupo .
                  ", " . $subGrupo2 . ", " . $subGrupo4 . ",'".$DoH."'," . $importe . "," . $saldo . "," .
                  "now(),'" . fecha_to_DATETIME($datFecha) . "','" . $strPeriodo . "'," . $lngEjercicio . ",'" . $strConcepto . "','".$tipoAsiento."','" . $strUsuario . "',1,1)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_insertar()|| SQL : ".$strSQL);

        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //devolvemos false
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_insertar()<TRUE");
        return true;
    }
    
    private function tbacumulados_insertar($idEmp,$lngEjercicio,$strPeriodo,$strCuenta,$DoH,$importe,$db){
        //obtengo la informacion de la cuenta origen
        $grupo=substr($strCuenta,0,1);
        $subGrupo2=substr($strCuenta,0,2);
        $subGrupo4=substr($strCuenta,0,4);
        

        //leo de la tabla 'tbmovimientos' para hacer un nuevo acumulado
        $strSQL="
                SELECT idCuenta,ejercicio,periodo,
                if(DoH='D',round(sum(cantidad),2),0) AS Debe,
                if(DoH='H',round(sum(cantidad),2),0) AS Haber
                FROM tbmovimientos
                WHERE Borrado=1
                AND ejercicio=$lngEjercicio
                AND periodo=$strPeriodo
                AND idCuenta = '$strCuenta'
                GROUP BY idCuenta,ejercicio,periodo,DoH
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbacumulados_insertar()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $acumuladoCuenta='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                if(is_array($acumuladoCuenta)){
                    //existe por lo tanto añado a ese array
                    $acumuladoCuenta['Debe']=$acumuladoCuenta['Debe']+$row['Debe'];
                    $acumuladoCuenta['Haber']=$acumuladoCuenta['Haber']+$row['Haber'];
                }else{
                    //no existe, se crea y añade datos
                    $acumuladoCuenta=array(
                        'cuenta'=>$row['idCuenta'],
                        'ejercicio'=>$row['ejercicio'],
                        'periodo'=>$row['periodo'],
                        'Debe'=>$row['Debe'],
                        'Haber'=>$row['Haber'],
                    );
                }
            }
        }else{
            //devolvemos false
            return false;
        }
        
        //ahora se inserta en la tabla acumulados
        //primero compruebo si existe (Empresa+Periodo+Cuenta)
        $strSQL="SELECT IdMovimiento,Debe,Haber FROM tbacumulados
                 WHERE IdEmpresa=".$idEmp.
                 " AND Ejercicio=".$lngEjercicio.
                 " AND Periodo='".$strPeriodo."'".
                 " AND Cuenta='".$strCuenta."'";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbacumulados_insertar()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            //comprobamos si hay registro que cumple la condicion (Empresa+Perido+Cuenta)
            if($num>0){
                //existe acumulado
                //----------------
                //se actualiza el dato
                //actualizamos los datos, que serna el HABER y la fecha
                $strSQL = "UPDATE tbacumulados SET ".
                          "fecha=now(), ".
                          "Debe=".$acumuladoCuenta['Debe'].
                          ",Haber=".$acumuladoCuenta['Haber'].
                          " WHERE Ejercicio=".$acumuladoCuenta['ejercicio'].
                          " AND Periodo='".$acumuladoCuenta['periodo']."'".
                          " AND Cuenta='".$acumuladoCuenta['cuenta'].
                          "'";
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->tbacumulados_insertar()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //devolvemos false
                    return false;
                }
            }else{
                //no existe acumulado
                //-------------------
                //hacemos una insercion en la tabla con los datos pertinentes
                
                //obtengo el idMovimiento
                $strSQL = "SELECT idMovimiento FROM tbacumulados ORDER BY idMovimiento DESC LIMIT 0,1";
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->tbacumulados_insertar()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                if($stmt){
                    $num=  mysql_num_rows($stmt);
                    $idMovimientoAc=0;
                    if($num>0){
                        $row=  mysql_fetch_assoc($stmt);
                        $idMovimientoAc=$row['idMovimiento']+1;
                    }else{
                        $idMovimientoAc=1;
                    }
                }else{
                    //devolvemos false
                    return false;
                }
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->tbacumulados_insertar()|| idMovimiento tbAcumulados : ".$idMovimientoAc);

                //veo si es asiento normal o abono
                if($DoH=='D'){
                    $strSQL="INSERT INTO tbacumulados (IdMovimiento,IdEmpresa,Ejercicio,Periodo,Cuenta,Grupo,SubGrupo2,SubGrupo4,Debe,Haber,fecha)".
                            " VALUES ($idMovimientoAc,$idEmp,$lngEjercicio,$strPeriodo,$strCuenta,".$grupo.",".$subGrupo2.",".$subGrupo4.",
                             $importe,0,now())";
                }else{
                    $strSQL="INSERT INTO tbacumulados (IdMovimiento,IdEmpresa,Ejercicio,Periodo,Cuenta,Grupo,SubGrupo2,SubGrupo4,Debe,Haber,fecha)".
                            " VALUES ($idMovimientoAc,$idEmp,$lngEjercicio,$strPeriodo,$strCuenta,".$grupo.",".$subGrupo2.",".$subGrupo4.",
                             0,$importe,now())";
                }
                
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->tbacumulados_insertar()|| SQL : ".$strSQL);
                $stmt17 = $db->ejecutar ( $strSQL );
                if(!$stmt17){
                    //devolvemos false
                    return false;
                }
            }
        }else{
            //devolvemos false
            return false;
        }
        return true;
    }
    
    private function AltaGastosMovimientos_tbMovimientos_tbacumulados($idEmp,$strCuenta, $lngIngreso,$strCuentaCli, $lngCantidad,$lngIva,$datFecha,
                                   $optTipo,$strCuentaBancos,$strPeriodo, $lngEjercicio,$strConcepto, $strUsuario,$db,$ordenInicial,$asiento,$esAbono,$tipoAsiento){
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados($idEmp,$strCuenta, $lngIngreso,$strCuentaCli, $lngCantidad,$lngIva,$datFecha,
                                   $optTipo,$strCuentaBancos,$strPeriodo, $lngEjercicio,$strConcepto, $strUsuario,$esAbono,$tipoAsiento)");

        
        //segun sea asiento normal o abono sera el debe o haber de las distintas cuentas en el asiento
        if($esAbono==='NO'){
            $cuenta6='D';
            $cuentaIVA4720='D';
            $cuenta4000='H';
        }else{
            $cuenta6='H';
            $cuentaIVA4720='H';
            $cuenta4000='D';
        }
        
        
        //________________________________________________________________________________________________
        //________________________________________________________________________________________________-
        //  INSERTAMOS LOS DATOS PARA LA CUENTA 6 ES DECIR LA ORIGEN(GASTO).
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados() || CUENTA 6 ORIGEN(GASTO)");
        
        //contador interno del campo 'orden'
        $contOrden=$ordenInicial;
        
        $saldo=0;

        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contOrden, $strCuenta, $cuenta6,
                $lngCantidad, $saldo, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //devolvemos false
            return false;
        }
        
        
        //________________________________________________________________________________________________
        //________________________________________________________________________________________________-
        //  HACEMOS LO MISMO PARA EL IVA QUE SERIA LA CUENTA 4720 IVA
        
        //primero comprobamos que no venga en valor $lngIva>0 (si es 0 no se guarda en la tabla tbmovimientos)
        if($lngIva>0){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados()|| CUENTA  4720 IVA");

            //avanzo el numero de orden
            $contOrden++;
        
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contOrden, $this->IVASOPORTADO, $cuentaIVA4720,
                    $lngIva, $saldo, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //devolvemos false
                return false;
            }
        }

        
        //________________________________________________________________________________________________-
        //'________________________________________________________________________________________________-
        //'________________________________________________________________________________________________-
        //'________________________________________________________________________________________________-
        //  'HACEMOS LO MISMO PARA LA CUENTA 4000 ES DECIR LA DEL PROVEEDOR.
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados()|| CUENTA 4000 PROVEEDOR");

        //avanzo el numero de orden
        $contOrden++;
        
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contOrden, $strCuentaCli, $cuenta4000,
                $lngIngreso, $saldo, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //devolvemos false
            return false;
        }

        
        //si todo a ido correctamente devolvemos el numero de orden
        return $contOrden;
    }
    
    private function AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago($idEmp,$strCuenta, $lngIngreso,$strCuentaCli, $lngCantidad,$lngIva,$datFecha,
                                   $optTipo,$strCuentaBancos,$strPeriodo, $lngEjercicio,$strConcepto, $strUsuario,$db,$ordenInicial,$asiento,$esAbono,$tipoAsiento){

        //segun sea asiento normal o abono sera el debe o haber de las distintas cuentas en el asiento
        if($esAbono==='NO'){
            $cuenta4000='D';
            $cuenta57='H';
        }else{
            $cuenta4000='H';
            $cuenta57='D';
        }
        
        //-----------------------------------------------------
        //-----------------------------------------------------
        //-----------------------------------------------------
        //Ahora miramos si la variable 'optTipo' es 1 hay que apuntar los movimientos del Pago que registran
        //el pago al banco/caja de este gasto
        $contOrden=$ordenInicial;
        
        if($optTipo==1){
            //  'HACEMOS LO MISMO PARA LA CUENTA 4000 ES DECIR LA DEL PROVEEDOR.
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()|| CUENTA 4000 PROVEEDOR");

            //avanzo el numero de orden
            $contOrden++;
        
            $saldo=0;

            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contOrden, $strCuentaCli, $cuenta4000,
                    $lngIngreso, $saldo, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //devolvemos false
                return false;
            }
            
        
            //________________________________________________________________________________________________
            //________________________________________________________________________________________________-
            //  HACEMOS LO MISMO PARA EL BANCO/CAJA 57
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()|| CUENTA 57 BANCO/CAJA");

            //avanzo el numero de orden
            $contOrden++;
        
            //OBTENGO LA INFO DEL SALDO AUNQUE NO VALGA A POSTERIORI
            $saldo=0;

            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contOrden, $strCuentaBancos, $cuenta57,
                    $lngIngreso, $saldo, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //devolvemos false
                return false;
            }
        }
        //si todo a ido correctamente devolvemos el numero de orden
        return true;
    }
    
    function AltaGastosMovimientos($numAsiento,$idEmp,$strCuenta, $lngIngreso,$strCuentaCli, $lngCantidad,$lngIva,$lngPorciento,$datFecha,
                                   $optTipo,$strCuentaBancos,$strPeriodo, $lngEjercicio,$strConcepto,$esAbono, $strUsuario,$tipoAsiento){
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientos()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos()|| IdCliProv : ".$IdCliProv);
        
        
        //ahora trabajo con la BBDD del cliente
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos() || START TRANSACTION");

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos()>");
        
        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }
        
        //realizo las inserciones en las tablas tbmovimientos y tbacumulados utilizando la funcion 'AltaGastosMovimientos_tbMovimientos_tbacumulados'
        $orden=$this->AltaGastosMovimientos_tbMovimientos_tbacumulados($idEmp, $strCuenta, $lngIngreso, $strCuentaCli, $lngCantidad, $lngIva,
                                                                $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                                                $lngEjercicio, $strConcepto, $strUsuario, $db,1,$asiento,$esAbono,$tipoAsiento);
        if($orden==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientos()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos()<OK");
        
        //realizo las inserciones en las tablas tbmovimientos y tbacumulados utilizando la funcion 'AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago'
        $OK=$this->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago($idEmp, $strCuenta, $lngIngreso, $strCuentaCli, $lngCantidad, $lngIva,
                                                                $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                                                $lngEjercicio, $strConcepto, $strUsuario, $db,$orden,$asiento,$esAbono,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientos()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos()<OK");
        
        //AHORA SE INSERTA EN LA TABLA DE LOS IVAS
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()>");
        //obtengo el Id
        $Id=$this->tbmovimientos_iva_Id($db); 
        if($Id==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientos()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
        //obtengo el IdIva (en este caso es Soportado por lo que comienza por S)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'S',$numAsiento);
        if($IdIva==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientos()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        //ahora hacemos la insercion del iva
        //comprobamos si es asiento normal o abono
        if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,$lngCantidad,$lngPorciento,$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }else{//abono->el importe de iva es negativo 
            
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,-$lngCantidad,$lngPorciento,-$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientos()<ROLLBACK");
            return false;
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function AltaIngresosMovimientos($numAsiento,$idEmp,$strCuenta, $lngIngreso,$strCuentaCli, $lngCantidad,$lngIva,$lngPorciento,$datFecha,
                                   $optTipo,$strCuentaBancos,$strPeriodo, $lngEjercicio,$strConcepto,$esAbono, $strUsuario,$tipoAsiento){
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $dbCont->ejecutar ("ROLLBACK");
            $dbCont->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos()|| IdCliProv : ".$IdCliProv);
        
        
        //ahora trabajo con la BBDD del cliente
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos() || START TRANSACTION");

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos()>");
        
        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }
        
        //1º Cuenta 7 (Ingreso)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 1, $strCuenta, $DoH,
                $lngCantidad, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos()<ROLLBACK");
            return false;
        }
        
        //2º Cuenta 4770 (IVA)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 2, $this->IVAREPERCUTIDO, $DoH,
                $lngIva, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos()<ROLLBACK");
            return false;
        }
        
        //3º Cuenta 43 (cliente)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 3, $strCuentaCli, $DoH,
                $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos()<ROLLBACK");
            return false;
        }
        //si se ha pagado se inserta
        if($optTipo==1){
            //4º Cuenta 43 (cliente)
            if($esAbono==='NO'){
                $DoH='H';
            }else{
                $DoH='D';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 4, $strCuentaCli, $DoH,
                    $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientos()<ROLLBACK");
                return false;
            }
            
            //5º Cuenta 57 (banco o caja)
            if($esAbono==='NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 5, $strCuentaBancos, $DoH,
                    $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientos()<ROLLBACK");
                return false;
            }
        }
        
        
        //AHORA SE INSERTA EN LA TABLA DE LOS IVAS
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()>");
        //obtengo el Id
        $Id=$this->tbmovimientos_iva_Id($db); 
        if($Id==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
        //obtengo el IdIva (en este caso es Repercutido por lo que comienza por R)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'R',$numAsiento);
        if($IdIva==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        //ahora hacemos la insercion del iva
        //comprobamos si es asiento normal o abono
        if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,$lngCantidad,$lngPorciento,$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }else{//abono->el importe de iva es negativo 
            
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,-$lngCantidad,$lngPorciento,-$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos()<ROLLBACK");
            return false;
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function AltaIngresosMovimientos_VariasCuentas($numAsiento,$idEmp,$cuentaVentas, $lngIngreso,$strCuentaCli, $lngCantidad,$lngIva,$lngPorciento,$datFecha,
                                   $optTipo,$strCuentaBancos,$strPeriodo, $lngEjercicio,$strConcepto,$esAbono, $strUsuario,$tipoAsiento){
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $dbCont->ejecutar ("ROLLBACK");
            $dbCont->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()|| IdCliProv : ".$IdCliProv);
        
        
        //ahora trabajo con la BBDD del cliente
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas() || START TRANSACTION");

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()>");
        
        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }
        
        //1º Cuentas 7 (Ingreso)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        
        $contadorOrden = 1;
        
        for ($z = 0; $z < count($cuentaVentas); $z++) {
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $cuentaVentas[$z]['cuenta'], $DoH,
                    $cuentaVentas[$z]['importe'], $cuentaVentas[$z]['cuota'], $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
        }
        
        
        //2º Cuenta 4770 (IVA)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $this->IVAREPERCUTIDO, $DoH,
                $lngIva, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        //3º Cuenta 43 (cliente)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaCli, $DoH,
                $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        //si se ha pagado se inserta
        if($optTipo==1){
            //4º Cuenta 43 (cliente)
            if($esAbono==='NO'){
                $DoH='H';
            }else{
                $DoH='D';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaCli, $DoH,
                    $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
            
            //5º Cuenta 57 (banco o caja)
            if($esAbono==='NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaBancos, $DoH,
                    $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()<ROLLBACK");
                return false;
            }
        }
        
        
        //AHORA SE INSERTA EN LA TABLA DE LOS IVAS
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()>");
        //obtengo el Id
        $Id=$this->tbmovimientos_iva_Id($db); 
        if($Id==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
        //obtengo el IdIva (en este caso es Repercutido por lo que comienza por R)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'R',$numAsiento);
        if($IdIva==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        //ahora hacemos la insercion del iva
        //comprobamos si es asiento normal o abono
        if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,$lngCantidad,$lngPorciento,$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }else{//abono->el importe de iva es negativo 
            
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,-$lngCantidad,$lngPorciento,-$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()<ROLLBACK");
            return false;
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos_VariasCuentas()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function actualizar_tbacumulados(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
//        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                " clsCADContabilidad->actualizar_tbacumulados() || START TRANSACTION");
        
        //primero borro los datos
        $strSQL="
                DELETE FROM tbacumulados;
                ";
//        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                " clsCADContabilidad->actualizar_tbacumulados()|| SQL : ".$strSQL);
        $db->ejecutar ( $strSQL );

        //ahora extraigo las sumas de las cuentas por ejercios y periodos
        $strSQL="
                SELECT idCuenta,ejercicio,periodo,
                if(DoH='D',round(sum(cantidad),2),0) AS Debe,
                if(DoH='H',round(sum(cantidad),2),0) AS Haber
                FROM tbmovimientos
                WHERE Borrado=1
                GROUP BY idCuenta,ejercicio,periodo,DoH
                order by idCuenta,ejercicio,periodo
                ";
//        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                " clsCADContabilidad->actualizar_tbacumulados()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        //compruebo que la consulta SQL es correcta, si lo es guardo los datos en un array, sino devuelvo false
        if($stmt){
//            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                   " clsCADContabilidad->actualizar_tbacumulados()<TRUE");
            $resultado='';
            while ($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
        }else{
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
//            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                    " clsCADContabilidad->actualizar_tbacumulados()<ROLLBACK");
            return false;
        }

        //ahora creamos el array donde iran los datos definitivos
        $datos='';
        $idx=1;
        if(is_array($resultado)){
            for($i=0;$i<count($resultado);$i++){
                //veo si existe el array tiene algun dato (es array propiamente dicho)
                if(is_array($datos)){
                    //busco si el registro existe en el array $datos (Cuenta+Ejercicio+Periodo)
                    for($j=1;$j<=count($datos);$j++){
                        $encontrado='NO';
                        //si existe la Cuenta+Ejercicio+Periodo, actualizo los datos
                        if($datos[$j]['Cuenta']===$resultado[$i]['idCuenta'] && 
                            $datos[$j]['Ejercicio']===$resultado[$i]['ejercicio'] &&
                            $datos[$j]['Periodo']===$resultado[$i]['periodo']){
                            $datos[$j]['Debe']=$datos[$j]['Debe']+$resultado[$i]['Debe'];
                            $datos[$j]['Haber']=$datos[$j]['Haber']+$resultado[$i]['Haber'];
                            $encontrado='SI';
                            break;
                        }
                    }
                    //compruebo si se encontro antes la Cuenta+Ejercicio+Periodo
                    //si no se encontro es que no existe por lo que hay que insertarla
                    if($encontrado==='NO'){
                        $datos[$idx]=array(
                            'IdEmpresa'=>$_SESSION['idEmp'],
                            'Ejercicio'=>$resultado[$i]['ejercicio'],
                            'Periodo'=>$resultado[$i]['periodo'],
                            'Cuenta'=>$resultado[$i]['idCuenta'],
                            'Grupo'=>substr($resultado[$i]['idCuenta'],0,1),
                            'SubGrupo2'=>substr($resultado[$i]['idCuenta'],0,2),
                            'SubGrupo4'=>substr($resultado[$i]['idCuenta'],0,4),
                            'Debe'=>$resultado[$i]['Debe'],
                            'Haber'=>$resultado[$i]['Haber'],
                        );
                        $idx++;
                    }
                }
                //si no es array es que esta vacio, se inserta este dato
                else{
                    $datos[$idx]=array(
                        'IdEmpresa'=>$_SESSION['idEmp'],
                        'Ejercicio'=>$resultado[$i]['ejercicio'],
                        'Periodo'=>$resultado[$i]['periodo'],
                        'Cuenta'=>$resultado[$i]['idCuenta'],
                        'Grupo'=>substr($resultado[$i]['idCuenta'],0,1),
                        'SubGrupo2'=>substr($resultado[$i]['idCuenta'],0,2),
                        'SubGrupo4'=>substr($resultado[$i]['idCuenta'],0,4),
                        'Debe'=>$resultado[$i]['Debe'],
                        'Haber'=>$resultado[$i]['Haber'],
                    );
                    $idx++;
                }
            }
        
            //por ultimo inserto estos datos en la tabla 'tbacumulados'
            for($i=1;$i<=count($datos);$i++){
                $strSQL="
                        INSERT INTO tbacumulados VALUES
                        ($i,".$_SESSION['idEmp'].",".$datos[$i]['Ejercicio'].",".$datos[$i]['Periodo'].",".$datos[$i]['Cuenta'].",
                         '".$datos[$i]['Grupo']."','".$datos[$i]['SubGrupo2']."','".$datos[$i]['SubGrupo4']."',".$datos[$i]['Debe'].",
                         ".$datos[$i]['Haber'].",now())
                        ";
//                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                        " clsCADContabilidad->actualizar_tbacumulados()|| SQL insertar tabla 'tbacumulados linea $i : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
//                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                            " clsCADContabilidad->actualizar_tbacumulados()<ROLLBACK");
                    return false;
                }
            }
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar();
//        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                " clsCADContabilidad->actualizar_tbacumulados()<COMMIT");
        
        return true;
    }
    
    private function tbmovimientos_iva_Id($db){
        $strSQL = "SELECT Id FROM tbmovimientos_iva ORDER BY Id DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $Id=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $Id=$row['Id']+1;
            }else{
                $Id=1;
            }
        }else{
            //si ha fallado la consulta DEVOLVEMOS false
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()|| Id : ".$Id);
        return $Id;
    }
    
    private function tbmovimientos_iva_IdIva($db,$opcion,$asiento){
        //obtengo el IdIva (S=Soportado, R=Repercutido)
        //si $asiento = 0, calculo uno nuevo, 
        //si $asiento > 0, este asiento existe por lo que busco el numero IdIva
        if((int)$asiento === 0){
            $strSQL = "SELECT IdIva FROM tbmovimientos_iva WHERE IdIva like '$opcion%' ORDER BY IdIva DESC LIMIT 0,1";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_IdIva()|| SQL : ".$strSQL);
            $stmt100 = $db->ejecutar ( $strSQL );
            if($stmt100){
                $num=  mysql_num_rows($stmt100);
                $IdIva=0;
                if($num>0){
                    $row = mysql_fetch_assoc($stmt100);
                    $num=substr($row['IdIva'],1,4);
                    $IdIva=intval($num)+1;
                    $count=strlen($IdIva);
                    while($count<4){
                        $IdIva='0'.$IdIva;
                        $count=strlen($IdIva);
                    }
                    $IdIva=$opcion.$IdIva;
                }else{
                    $IdIva=$opcion.'0001';
                }
            }else{
                //si ha fallado la consulta DEVOLVEMOS false
                return false;
            }
        }else{
            $strSQL = "SELECT IdIva FROM tbmovimientos_iva WHERE IdAsiento = $asiento ORDER BY IdIva DESC LIMIT 0,1";
            $stmt100 = $db->ejecutar ( $strSQL );
            if($stmt100){
                $resultado='';
                while ($row = mysql_fetch_array($stmt100)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $reg[$propiedad]=$valor;
                        }
                    }
                    $resultado[]=$reg;
                }
                
                //$row = mysql_fetch_assoc($stmt100);
                $IdIva = $resultado[0]['IdIva'];
            }else{
                //si ha fallado la consulta DEVOLVEMOS false
                return false;
            }
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()|| IdIva : ".$IdIva);
        return $IdIva;    
    }
    
    private function tbmovimientos_iva_insertarDato($db,$Id,$IdIva,$numOrden,$asiento,$idEmp,$lngCantidad,$lngPorciento,$lngIva,$tipoAsiento){
        $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                " VALUES ($Id,'$IdIva',$numOrden,$asiento,$idEmp,$lngCantidad,$lngPorciento,$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_insertarDato()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion DEVOLVEMOS false
            return false;
        }
        return true;
    }
    
    function AltaGastosMovimientosIRPF($numAsiento,$idEmp,$strCuenta,$strCuentaCli,
                                            $lngCantidad,$lngIva,$lngPorciento,
                                            $lngIRPF,$lngPorcientoIRPF,$datFecha,
                                            $optTipo,$strCuentaBancos,$lngPeriodo,$strPeriodo,
                                            $lngEjercicio, $strConcepto, $esAbono, $strUsuario,$tipoAsiento)
    {
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| IdCliProv : ".$IdCliProv);
        
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF() || START TRANSACTION");

        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados()>");
        
        //realizo las inserciones en las tablas tbmovimientos y tbacumulados utilizando la funcion 'AltaGastosMovimientos_tbMovimientos_tbacumulados'
        $orden=$this->AltaGastosMovimientos_tbMovimientos_tbacumulados($idEmp, $strCuenta, $lngCantidad+$lngIva-$lngIRPF, $strCuentaCli, $lngCantidad, $lngIva,
                                                                $datFecha, $optTipo, $strCuentaBancos, $lngPeriodo,
                                                                $lngEjercicio, $strConcepto, $strUsuario, $db,1,$asiento,$esAbono,$tipoAsiento);
        if($orden==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados()<OK");

        
        //inserto el IRPF en las tablas 'tbmovimientos'
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF() || inserto el IRPF en las tablas 'tbmovimientos' y 'tbacumulados'");

        //las cuentas que intervienen en esta parte de codigo
        
        if($esAbono==='NO'){
            $CuentaIRPF='H';
        }else{
            $CuentaIRPF='D';
        }
        
        //aumentamos el orden del asiento
        $orden++;
        
        $saldo=0;

        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $orden, $this->IRPF, $CuentaIRPF,
                $lngIRPF, $saldo, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        
        
        //AHORA SE INSERTA EN LA TABLA DE LOS IVAS
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()>");
        //obtengo el Id
        $Id=$this->tbmovimientos_iva_Id($db); 
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
        //obtengo el IdIva (en este caso es Soportado por lo que comienza por S)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'S',$numAsiento);
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        //ahora hacemos la insercion del iva
        //comprobamos si es asiento normal o abono
        if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,$lngCantidad,$lngPorciento,$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }else{//abono->el importe de iva es negativo
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,-$lngCantidad,$lngPorciento,-$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        
        //POR ULTIMO SE INSERTA EN LA TABLA DEL IRPF tbretenciones_irpf
        //obtengo el idMovimiento
        $strSQL = "SELECT Id FROM tbretenciones_irpf ORDER BY Id DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $Id=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $Id=$row['Id']+1;
            }else{
                $Id=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| Id : ".$Id);
        
        //ahora hacemos la insercion del IRPF
        //comprobamos si es asiento normal o abono
        if($esAbono==='NO'){//asiento normal->el importe de IRPF es positivo
            $strSQL="INSERT INTO tbretenciones_irpf (Id,IdAsiento,IdCliProv,BaseImponible,Retencion,ImporteRetencion,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento,Clave)".
                    " VALUES ($Id,$asiento,$IdCliProv,$lngCantidad,$lngPorcientoIRPF,$lngIRPF,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."','G')";
        }else{//Abono->el importe del IRPF es negativo
            $strSQL="INSERT INTO tbretenciones_irpf (Id,IdAsiento,IdCliProv,BaseImponible,Retencion,ImporteRetencion,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento,Clave)".
                    " VALUES ($Id,$asiento,$IdCliProv,-$lngCantidad,$lngPorcientoIRPF,-$lngIRPF,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."','G')";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()>");

        //realizo las inserciones en las tablas tbmovimientos y tbacumulados utilizando la funcion 'AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago'
        $OK=$this->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago($idEmp, $strCuenta, $lngCantidad+$lngIva-$lngIRPF, $strCuentaCli, $lngCantidad, $lngIva,
                                                                $datFecha, $optTipo, $strCuentaBancos, $lngPeriodo,
                                                                $lngEjercicio, $strConcepto, $strUsuario, $db,$orden,$asiento,$esAbono,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()<OK");
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }        
    
    
    function AltaIngresosMovimientosIRPF($numAsiento,$idEmp,$strCuenta,$strCuentaCli,
                                            $lngCantidad,$lngIva,$lngPorciento,
                                            $lngIRPF,$lngPorcientoIRPF,$datFecha,
                                            $optTipo,$strCuentaBancos,$lngPeriodo,$strPeriodo,
                                            $lngEjercicio, $strConcepto, $esAbono, $strUsuario,$tipoAsiento)
    {
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF()|| IdCliProv : ".$IdCliProv);
        
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF() || START TRANSACTION");

        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }

        //1º Cuenta 7 (Ingreso)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 1, $strCuenta, $DoH,
                $lngCantidad, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        
        //2º Cuenta 4770 (IVA)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 2, $this->IVAREPERCUTIDO, $DoH,
                $lngIva, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        
        //3º Cuenta 4730 (IRPF)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 3, $this->IRPFPago, $DoH,
                $lngIRPF, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        
        //4º Cuenta 43 (cliente)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 4, $strCuentaCli, $DoH,
                $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        
        //si se ha pagado se inserta
        if($optTipo==1){
            //5º Cuenta 43 (cliente)
            if($esAbono==='NO'){
                $DoH='H';
            }else{
                $DoH='D';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 5, $strCuentaCli, $DoH,
                    $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIRPF()<ROLLBACK");
                return false;
            }
            
            //6º Cuenta 57 (banco o caja)
            if($esAbono==='NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 6, $strCuentaBancos, $DoH,
                    $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIRPF()<ROLLBACK");
                return false;
            }
        }
        
        
        //AHORA SE INSERTA EN LA TABLA DE LOS IVAS
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()>");
        //obtengo el Id
        $Id=$this->tbmovimientos_iva_Id($db); 
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
        //obtengo el IdIva (en este caso es Repercutido por lo que comienza por R)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'R',$numAsiento);
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        //ahora hacemos la insercion del iva
        //comprobamos si es asiento normal o abono
        if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,$lngCantidad,$lngPorciento,$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }else{//abono->el importe de iva es negativo
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,-$lngCantidad,$lngPorciento,-$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }        
    
    function AltaIngresosMovimientosIRPF_VariasCuentas($numAsiento,$idEmp,$cuentaVentas,$strCuentaCli,
                                            $lngCantidad,$lngIva,$lngPorciento,
                                            $lngIRPF,$lngPorcientoIRPF,$datFecha,
                                            $optTipo,$strCuentaBancos,$lngPeriodo,$strPeriodo,
                                            $lngEjercicio, $strConcepto, $esAbono, $strUsuario,$tipoAsiento)
    {
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()|| IdCliProv : ".$IdCliProv);
        
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas() || START TRANSACTION");

        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }

        //1º Cuenta 7 (Ingreso)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        
        $contadorOrden = 1;
        
        for ($z = 0; $z < count($cuentaVentas); $z++) {
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $cuentaVentas[$z]['cuenta'], $DoH,
                    $cuentaVentas[$z]['importe'], $cuentaVentas[$z]['cuota'], $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
        }
        
        //2º Cuenta 4770 (IVA)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $this->IVAREPERCUTIDO, $DoH,
                $lngIva, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        //3º Cuenta 4730 (IRPF)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $this->IRPFPago, $DoH,
                $lngIRPF, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        //4º Cuenta 43 (cliente)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaCli, $DoH,
                $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        //si se ha pagado se inserta
        if($optTipo==1){
            //5º Cuenta 43 (cliente)
            if($esAbono==='NO'){
                $DoH='H';
            }else{
                $DoH='D';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaCli, $DoH,
                    $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
            
            //6º Cuenta 57 (banco o caja)
            if($esAbono==='NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 6, $strCuentaBancos, $DoH,
                    $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
        }
        
        
        //AHORA SE INSERTA EN LA TABLA DE LOS IVAS
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()>");
        //obtengo el Id
        $Id=$this->tbmovimientos_iva_Id($db); 
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
        //obtengo el IdIva (en este caso es Soportado por lo que comienza por S)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'R',$numAsiento);
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        //ahora hacemos la insercion del iva
        //comprobamos si es asiento normal o abono
        if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,$lngCantidad,$lngPorciento,$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }else{//abono->el importe de iva es negativo
            $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                    " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,-$lngCantidad,$lngPorciento,-$lngIva,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()<ROLLBACK");
            return false;
        }
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }        
    
    function AltaGastosMovimientosIVA_Varios($numAsiento,$idEmp, $strCuenta, $lngIngreso, $strCuentaCli, $lngCantidad,
                                      $lngIva, $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                      $lngEjercicio,$strConcepto, $strUsuario,
                                      $lngCantidad1,$lngIva1,$lngPorciento1,
                                      $lngCantidad2,$lngIva2,$lngPorciento2,
                                      $lngCantidad3,$lngIva3,$lngPorciento3,
                                      $lngCantidad4,$lngIva4,$lngPorciento4,$esAbono,$tipoAsiento)
    {
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| IdCliProv : ".$IdCliProv);
        
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIVA_Varios() || START TRANSACTION");

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados()>");

        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }

        //realizo las inserciones en las tablas tbmovimientos y tbacumulados tuilizando la funcion 'AltaGastosMovimientos_tbMovimientos_tbacumulados'
        $orden=$this->AltaGastosMovimientos_tbMovimientos_tbacumulados($idEmp, $strCuenta, $lngIngreso, $strCuentaCli, $lngCantidad, $lngIva,
                                                                $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                                                $lngEjercicio, $strConcepto, $strUsuario, $db,1,$asiento,$esAbono,$tipoAsiento);
        if($orden==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados()<OK");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()>");
        
        //realizo las inserciones en las tablas tbmovimientos y tbacumulados utilizando la funcion 'AltaGastosMovimientos_tbMovimientos_tbacumulados'
        $OK=$this->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago($idEmp, $strCuenta, $lngIngreso, $strCuentaCli, $lngCantidad, $lngIva,
                                                                $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                                                $lngEjercicio, $strConcepto, $strUsuario, $db,$orden,$asiento,$esAbono,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()<OK");
        
        //ahora inserto los distintos ivas que vengan del formulario
        //----------------------------------------------------------
        //son 4 lineas de datos

        //orden interno de iva
        $lngOrdenIVA=0;
        //linea 1
        //compruebo que no venga a 0 el valor de $lngCantidad1, si fuese 0 no se inserta (no se han introducido datos correctos)
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        
        //obtengo el IdIva (en este caso es Soportado por lo que comienza por S)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'S',$numAsiento);
        if($IdIva==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        if($lngCantidad1 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| Insertamos linea 1");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad1, $lngPorciento1, -$lngIva1,$tipoAsiento);
            }
            
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 2
        //compruebo que no venga a 0 el valor de $lngCantidad2, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad2 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| Insertamos linea 2");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad2, $lngPorciento2, -$lngIva2,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 3
        //compruebo que no venga a 0 el valor de $lngCantidad3, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad3 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| Insertamos linea 3");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad3, $lngPorciento3, -$lngIva3,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 4
        //compruebo que no venga a 0 el valor de $lngCantidad4, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad4 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| Insertamos linea 4");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad4, $lngPorciento4, -$lngIva4,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<COMMIT");
        
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function AltaGastosMovimientosIVA_VariosIRPF($numAsiento,$idEmp, $strCuenta, $lngIngreso, $strCuentaCli, $lngCantidad,
                                      $lngIva, $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                      $lngEjercicio,$strConcepto, $strUsuario,
                                      $lngCantidad1,$lngIva1,$lngPorciento1,
                                      $lngCantidad2,$lngIva2,$lngPorciento2,
                                      $lngCantidad3,$lngIva3,$lngPorciento3,
                                      $lngCantidad4,$lngIva4,$lngPorciento4,$esAbono,$tipoAsiento,
                                      $lngPorcientoIRPF,$lngIRPF) 
    {
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| IdCliProv : ".$IdCliProv);
        
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIVA_Varios() || START TRANSACTION");

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados()>");

        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }

        //realizo las inserciones en las tablas tbmovimientos y tbacumulados utilizando la funcion 'AltaGastosMovimientos_tbMovimientos_tbacumulados'
        $orden=$this->AltaGastosMovimientos_tbMovimientos_tbacumulados($idEmp, $strCuenta, $lngCantidad+$lngIva-$lngIRPF, $strCuentaCli, $lngCantidad, $lngIva,
                                                                $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                                                $lngEjercicio, $strConcepto, $strUsuario, $db,1,$asiento,$esAbono,$tipoAsiento);
        if($orden==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados()<OK");
        
        //inserto el IRPF en las tablas 'tbmovimientos'
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF() || inserto el IRPF en las tablas 'tbmovimientos' y 'tbacumulados'");

        //las cuentas que intervienen en esta parte de codigo
        
        if($esAbono==='NO'){
            $CuentaIRPF='H';
        }else{
            $CuentaIRPF='D';
        }
        
        //aumentamos el orden del asiento
        $orden++;
        
        $saldo=0;

        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $orden, $this->IRPF, $CuentaIRPF,
                $lngIRPF, $saldo, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()>");
        
//        //realizo las inserciones en las tablas tbmovimientos y tbacumulados utilizando la funcion 'AltaGastosMovimientos_tbMovimientos_tbacumulados'
//        $OK=$this->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago($idEmp, $strCuenta, $lngIngreso, $strCuentaCli, $lngCantidad, $lngIva,
//                                                                $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
//                                                                $lngEjercicio, $strConcepto, $strUsuario, $db,$orden,$asiento,$esAbono,$tipoAsiento);

        //segun sea asiento normal o abono sera el debe o haber de las distintas cuentas en el asiento
        if($esAbono==='NO'){
            $cuenta4000='D';
            $cuenta57='H';
        }else{
            $cuenta4000='H';
            $cuenta57='D';
        }
        
        //-----------------------------------------------------
        //-----------------------------------------------------
        //-----------------------------------------------------
        //Ahora miramos si la variable 'optTipo' es 1 hay que apuntar los movimientos del Pago que registran
        //el pago al banco/caja de este gasto
        
        if($optTipo==1){
            //  'HACEMOS LO MISMO PARA LA CUENTA 4000 ES DECIR LA DEL PROVEEDOR.
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()|| CUENTA 4000 PROVEEDOR");

            //aumentamos el orden del asiento
            $orden++;
        
            $saldo=0;

            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $orden, $strCuentaCli, $cuenta4000,
                    $lngCantidad+$lngIva-$lngIRPF, $saldo, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
                return false;
            }
            
        
            //________________________________________________________________________________________________
            //________________________________________________________________________________________________-
            //  HACEMOS LO MISMO PARA EL BANCO/CAJA 57
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()|| CUENTA 57 BANCO/CAJA");

            //avanzo el numero de orden
            $orden++;
        
            //OBTENGO LA INFO DEL SALDO AUNQUE NO VALGA A POSTERIORI
            $saldo=0;

            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $orden, $strCuentaBancos, $cuenta57,
                    $lngCantidad+$lngIva-$lngIRPF, $saldo, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
                return false;
            }
        }
        
        
//        if($OK==false){
//            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
//            $db->ejecutar ("ROLLBACK");
//            $db->desconectar ();
//            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
//            return false;
//        }
//        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()<OK");

        
        //ahora inserto los distintos ivas que vengan del formulario
        //----------------------------------------------------------
        //son 4 lineas de datos

        //orden interno de iva
        $lngOrdenIVA=0;
        //linea 1
        //compruebo que no venga a 0 el valor de $lngCantidad1, si fuese 0 no se inserta (no se han introducido datos correctos)
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        
        //obtengo el IdIva (en este caso es Soportado por lo que comienza por S)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'S',$numAsiento);
        if($IdIva==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        if($lngCantidad1 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| Insertamos linea 1");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad1, $lngPorciento1, -$lngIva1,$tipoAsiento);
            }
            
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 2
        //compruebo que no venga a 0 el valor de $lngCantidad2, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad2 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| Insertamos linea 2");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad2, $lngPorciento2, -$lngIva2,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 3
        //compruebo que no venga a 0 el valor de $lngCantidad3, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad3 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| Insertamos linea 3");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad3, $lngPorciento3, -$lngIva3,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 4
        //compruebo que no venga a 0 el valor de $lngCantidad4, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad4 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()|| Insertamos linea 4");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad4, $lngPorciento4, -$lngIva4,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        
        //POR ULTIMO SE INSERTA EN LA TABLA DEL IRPF tbretenciones_irpf
        //obtengo el idMovimiento
        $strSQL = "SELECT Id FROM tbretenciones_irpf ORDER BY Id DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $Id=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $Id=$row['Id']+1;
            }else{
                $Id=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| Id : ".$Id);
        
        //ahora hacemos la insercion del IRPF
        //comprobamos si es asiento normal o abono
        if($esAbono==='NO'){//asiento normal->el importe de IRPF es positivo
            $strSQL="INSERT INTO tbretenciones_irpf (Id,IdAsiento,IdCliProv,BaseImponible,Retencion,ImporteRetencion,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento,Clave)".
                    " VALUES ($Id,$asiento,$IdCliProv,$lngCantidad,$lngPorcientoIRPF,$lngIRPF,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."','G')";
        }else{//Abono->el importe del IRPF es negativo
            $strSQL="INSERT INTO tbretenciones_irpf (Id,IdAsiento,IdCliProv,BaseImponible,Retencion,ImporteRetencion,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento,Clave)".
                    " VALUES ($Id,$asiento,$IdCliProv,-$lngCantidad,$lngPorcientoIRPF,-$lngIRPF,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."','G')";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosIRPF()<ROLLBACK");
            return false;
        }
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIVA_Varios()<COMMIT");
        
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function AltaIngresosMovimientosIVA_Varios($numAsiento,$idEmp, $strCuenta, $lngIngreso, $strCuentaCli, $lngCantidad,
                                      $lngIva, $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                      $lngEjercicio,$strConcepto, $strUsuario,
                                      $lngCantidad1,$lngIva1,$lngPorciento1,
                                      $lngCantidad2,$lngIva2,$lngPorciento2,
                                      $lngCantidad3,$lngIva3,$lngPorciento3,
                                      $lngCantidad4,$lngIva4,$lngPorciento4,$esAbono,$tipoAsiento)
    {
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()|| IdCliProv : ".$IdCliProv);
        
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios() || START TRANSACTION");

        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }

        //1º Cuenta 7 (Ingreso)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 1, $strCuenta, $DoH,
                $lngCantidad, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }

        //2º Cuenta 4770 (IVA)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 2, $this->IVAREPERCUTIDO, $DoH,
                $lngIva, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }
        
        //3º Cuenta 43 (cliente)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 3, $strCuentaCli, $DoH,
                $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }
        //si se ha pagado se inserta
        if($optTipo==1){
            //4º Cuenta 43 (cliente)
            if($esAbono==='NO'){
                $DoH='H';
            }else{
                $DoH='D';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 4, $strCuentaCli, $DoH,
                    $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            
            //5º Cuenta 57 (banco o caja)
            if($esAbono==='NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 5, $strCuentaBancos, $DoH,
                    $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
        }
        
        
        //ahora inserto los distintos ivas que vengan del formulario
        //----------------------------------------------------------
        //son 4 lineas de datos

        //orden interno de iva
        $lngOrdenIVA=0;
        //linea 1
        //compruebo que no venga a 0 el valor de $lngCantidad1, si fuese 0 no se inserta (no se han introducido datos correctos)
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
        
        //obtengo el IdIva (en este caso es Repercutido por lo que comienza por R)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'R',$numAsiento);
        if($IdIva==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        if($lngCantidad1 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()|| Insertamos linea 1");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad1, $lngPorciento1, -$lngIva1,$tipoAsiento);
            }
            
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 2
        //compruebo que no venga a 0 el valor de $lngCantidad2, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad2 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()|| Insertamos linea 2");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad2, $lngPorciento2, -$lngIva2,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 3
        //compruebo que no venga a 0 el valor de $lngCantidad3, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad3 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()|| Insertamos linea 3");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad3, $lngPorciento3, -$lngIva3,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 4
        //compruebo que no venga a 0 el valor de $lngCantidad4, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad4 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()|| Insertamos linea 4");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad4, $lngPorciento4, -$lngIva4,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()<COMMIT");
        
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function AltaIngresosMovimientosIVA_Varios_VariasCuentas($numAsiento,$idEmp, $cuentaVentas, $lngIngreso, $strCuentaCli, $lngCantidad,
                                      $lngIva, $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                      $lngEjercicio,$strConcepto, $strUsuario,
                                      $lngCantidad1,$lngIva1,$lngPorciento1,
                                      $lngCantidad2,$lngIva2,$lngPorciento2,
                                      $lngCantidad3,$lngIva3,$lngPorciento3,
                                      $lngCantidad4,$lngIva4,$lngPorciento4,$esAbono,$tipoAsiento)
    {
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()|| IdCliProv : ".$IdCliProv);
        
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas() || START TRANSACTION");

        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }

        //1º Cuenta 7 (Ingreso)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        
        $contadorOrden = 1;
        
        for ($z = 0; $z < count($cuentaVentas); $z++) {
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $cuentaVentas[$z]['cuenta'], $DoH,
                    $cuentaVentas[$z]['importe'], $cuentaVentas[$z]['cuota'], $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
        }
        
        //2º Cuenta 4770 (IVA)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $this->IVAREPERCUTIDO, $DoH,
                $lngIva, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        //3º Cuenta 43 (cliente)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaCli, $DoH,
                $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        //si se ha pagado se inserta
        if($optTipo==1){
            //4º Cuenta 43 (cliente)
            if($esAbono==='NO'){
                $DoH='H';
            }else{
                $DoH='D';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaCli, $DoH,
                    $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
            
            //5º Cuenta 57 (banco o caja)
            if($esAbono==='NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 5, $strCuentaBancos, $DoH,
                    $lngIngreso, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
        }
        
        
        //ahora inserto los distintos ivas que vengan del formulario
        //----------------------------------------------------------
        //son 4 lineas de datos

        //orden interno de iva
        $lngOrdenIVA=0;
        //linea 1
        //compruebo que no venga a 0 el valor de $lngCantidad1, si fuese 0 no se inserta (no se han introducido datos correctos)
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
        
        //obtengo el IdIva (en este caso es Repercutido por lo que comienza por R)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'R',$numAsiento);
        //$IdIva=$this->tbmovimientos_iva_IdIva($db,'R',$asiento);  //BORRAR 20/5/2016
        if($IdIva==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        if($lngCantidad1 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios()|| Insertamos linea 1");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad1, $lngPorciento1, -$lngIva1,$tipoAsiento);
            }
            
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 2
        //compruebo que no venga a 0 el valor de $lngCantidad2, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad2 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()|| Insertamos linea 2");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad2, $lngPorciento2, -$lngIva2,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 3
        //compruebo que no venga a 0 el valor de $lngCantidad3, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad3 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()|| Insertamos linea 3");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad3, $lngPorciento3, -$lngIva3,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 4
        //compruebo que no venga a 0 el valor de $lngCantidad4, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad4 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()|| Insertamos linea 4");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad4, $lngPorciento4, -$lngIva4,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_Varios_VariasCuentas()<COMMIT");
        
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function AltaIngresosMovimientosIVA_VariosIRPF($numAsiento,$idEmp, $strCuenta, $lngIngreso, $strCuentaCli, $lngCantidad,
                                      $lngIva, $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                      $lngEjercicio,$strConcepto, $strUsuario,
                                      $lngCantidad1,$lngIva1,$lngPorciento1,
                                      $lngCantidad2,$lngIva2,$lngPorciento2,
                                      $lngCantidad3,$lngIva3,$lngPorciento3,
                                      $lngCantidad4,$lngIva4,$lngPorciento4,
                                      $esAbono,$lngPorcientoIRPF,$lngIRPF,$tipoAsiento)
    {
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()|| IdCliProv : ".$IdCliProv);
        
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF() || START TRANSACTION");

        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }

        //1º Cuenta 7 (Ingreso)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 1, $strCuenta, $DoH,
                $lngCantidad, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
            return false;
        }

        //2º Cuenta 4770 (IVA)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 2, $this->IVAREPERCUTIDO, $DoH,
                $lngIva, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
            return false;
        }
        
        //3º Cuenta 4730 (IRPF)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 3, $this->IRPFPago, $DoH,
                $lngIRPF, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
            return false;
        }
        
        //4º Cuenta 43 (cliente)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 4, $strCuentaCli, $DoH,
                $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
            return false;
        }
        //si se ha pagado se inserta
        if($optTipo==1){
            //4º Cuenta 43 (cliente)
            if($esAbono==='NO'){
                $DoH='H';
            }else{
                $DoH='D';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 5, $strCuentaCli, $DoH,
                    $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
                return false;
            }
            
            //5º Cuenta 57 (banco o caja)
            if($esAbono==='NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 6, $strCuentaBancos, $DoH,
                    $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
                return false;
            }
        }
        
        
        //ahora inserto los distintos ivas que vengan del formulario
        //----------------------------------------------------------
        //son 4 lineas de datos

        //orden interno de iva
        $lngOrdenIVA=0;
        //linea 1
        //compruebo que no venga a 0 el valor de $lngCantidad1, si fuese 0 no se inserta (no se han introducido datos correctos)
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
        
        //obtengo el IdIva (en este caso es Repercutido por lo que comienza por R)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'R',$numAsiento);
        if($IdIva==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        if($lngCantidad1 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()|| Insertamos linea 1");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad1, $lngPorciento1, -$lngIva1,$tipoAsiento);
            }
            
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 2
        //compruebo que no venga a 0 el valor de $lngCantidad2, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad2 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()|| Insertamos linea 2");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad2, $lngPorciento2, -$lngIva2,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 3
        //compruebo que no venga a 0 el valor de $lngCantidad3, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad3 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()|| Insertamos linea 3");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad3, $lngPorciento3, -$lngIva3,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 4
        //compruebo que no venga a 0 el valor de $lngCantidad4, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad4 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()|| Insertamos linea 4");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad4, $lngPorciento4, -$lngIva4,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }
        

        //POR ULTIMO SE INSERTA EN LA TABLA DEL IRPF tbretenciones_irpf
        //obtengo el idMovimiento
        $strSQL = "SELECT Id FROM tbretenciones_irpf ORDER BY Id DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $Id=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $Id=$row['Id']+1;
            }else{
                $Id=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| Id : ".$Id);
        
        //ahora hacemos la insercion del IRPF
        //comprobamos si es asiento normal o abono
        if($esAbono==='NO'){//asiento normal->el importe de IRPF es positivo
            $strSQL="INSERT INTO tbretenciones_irpf (Id,IdAsiento,IdCliProv,BaseImponible,Retencion,ImporteRetencion,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento,Clave)".
                    " VALUES ($Id,$asiento,$IdCliProv,$lngCantidad,$lngPorcientoIRPF,$lngIRPF,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."','G')";
        }else{//Abono->el importe del IRPF es negativo
            $strSQL="INSERT INTO tbretenciones_irpf (Id,IdAsiento,IdCliProv,BaseImponible,Retencion,ImporteRetencion,
                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento,Clave)".
                    " VALUES ($Id,$asiento,$IdCliProv,-$lngCantidad,$lngPorcientoIRPF,-$lngIRPF,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."','G')";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<ROLLBACK");
            return false;
        }
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF()<COMMIT");
        
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas($numAsiento,$idEmp, $cuentaVentas, $lngIngreso, $strCuentaCli, $lngCantidad,
                                      $lngIva, $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                      $lngEjercicio,$strConcepto, $strUsuario,
                                      $lngCantidad1,$lngIva1,$lngPorciento1,
                                      $lngCantidad2,$lngIva2,$lngPorciento2,
                                      $lngCantidad3,$lngIva3,$lngPorciento3,
                                      $lngCantidad4,$lngIva4,$lngPorciento4,
                                      $esAbono,$lngPorcientoIRPF,$lngIRPF,$tipoAsiento)
    {
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()|| IdCliProv : ".$IdCliProv);
        
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas() || START TRANSACTION");

        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }

        //1º Cuenta 7 (Ingreso)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        
        $contadorOrden = 1;
        
        for ($z = 0; $z < count($cuentaVentas); $z++) {
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $cuentaVentas[$z]['cuenta'], $DoH,
                    $cuentaVentas[$z]['importe'], $cuentaVentas[$z]['cuota'], $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
        }

        //2º Cuenta 4770 (IVA)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $this->IVAREPERCUTIDO, $DoH,
                $lngIva, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        //3º Cuenta 4730 (IRPF)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $this->IRPFPago, $DoH,
                $lngIRPF, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        //4º Cuenta 43 (cliente)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaCli, $DoH,
                $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        //si se ha pagado se inserta
        if($optTipo==1){
            //4º Cuenta 43 (cliente)
            if($esAbono==='NO'){
                $DoH='H';
            }else{
                $DoH='D';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaCli, $DoH,
                    $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
            
            //5º Cuenta 57 (banco o caja)
            if($esAbono==='NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaBancos, $DoH,
                    $lngCantidad+$lngIva-$lngIRPF, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
        }
        
        
        //ahora inserto los distintos ivas que vengan del formulario
        //----------------------------------------------------------
        //son 4 lineas de datos

        //orden interno de iva
        $lngOrdenIVA=0;
        //linea 1
        //compruebo que no venga a 0 el valor de $lngCantidad1, si fuese 0 no se inserta (no se han introducido datos correctos)
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
        
        //obtengo el IdIva (en este caso es Repercutido por lo que comienza por R)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'R',$numAsiento);
        if($IdIva==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        if($lngCantidad1 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()|| Insertamos linea 1");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad1, $lngPorciento1, $lngIva1,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad1, $lngPorciento1, -$lngIva1,$tipoAsiento);
            }
            
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 2
        //compruebo que no venga a 0 el valor de $lngCantidad2, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad2 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()|| Insertamos linea 2");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad2, $lngPorciento2, $lngIva2,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad2, $lngPorciento2, -$lngIva2,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 3
        //compruebo que no venga a 0 el valor de $lngCantidad3, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad3 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()|| Insertamos linea 3");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad3, $lngPorciento3, $lngIva3,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad3, $lngPorciento3, -$lngIva3,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }

        //linea 4
        //compruebo que no venga a 0 el valor de $lngCantidad4, si fuese 0 no se inserta (no se han introducido datos correctos)
        if($lngCantidad4 > 0){
            $lngOrdenIVA++;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()|| Insertamos linea 4");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato($Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4)>");
            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($esAbono==='NO'){//asiento normal->el importe de iva es positivo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, $lngCantidad4, $lngPorciento4, $lngIva4,$tipoAsiento);
            }else{//abono->el importe de uva es negativo
                $OK=$this->tbmovimientos_iva_insertarDato($db, $Id, $IdIva, $lngOrdenIVA, $asiento, $IdCliProv, -$lngCantidad4, $lngPorciento4, -$lngIva4,$tipoAsiento);
            }
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_insertarDato()<OK");
        }
        
//EN LAS VENTAS NO VA EL IRPF A LA TABLA tbretenciones_irpf  **********
//        //POR ULTIMO SE INSERTA EN LA TABLA DEL IRPF tbretenciones_irpf
//        //obtengo el idMovimiento
//        $strSQL = "SELECT Id FROM tbretenciones_irpf ORDER BY Id DESC LIMIT 0,1";
//        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()|| SQL : ".$strSQL);
//        $stmt = $db->ejecutar ( $strSQL );
//        if($stmt){
//            $num=  mysql_num_rows($stmt);
//            $Id=0;
//            if($num>0){
//                $row=  mysql_fetch_assoc($stmt);
//                $Id=$row['Id']+1;
//            }else{
//                $Id=1;
//            }
//        }else{
//            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
//            $db->ejecutar ("ROLLBACK");
//            $db->desconectar ();
//            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
//            return false;
//        }
//        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                " clsCADContabilidad->AltaGastosMovimientosIRPF()|| Id : ".$Id);
//        
//        //ahora hacemos la insercion del IRPF
//        //comprobamos si es asiento normal o abono
//        if($esAbono==='NO'){//asiento normal->el importe de IRPF es positivo
//            $strSQL="INSERT INTO tbretenciones_irpf (Id,IdAsiento,IdCliProv,BaseImponible,Retencion,ImporteRetencion,
//                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento,Clave)".
//                    " VALUES ($Id,$asiento,$IdCliProv,$lngCantidad,$lngPorcientoIRPF,$lngIRPF,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."','G')";
//        }else{//Abono->el importe del IRPF es negativo
//            $strSQL="INSERT INTO tbretenciones_irpf (Id,IdAsiento,IdCliProv,BaseImponible,Retencion,ImporteRetencion,
//                                                    Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento,Clave)".
//                    " VALUES ($Id,$asiento,$IdCliProv,-$lngCantidad,$lngPorcientoIRPF,-$lngIRPF,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."','G')";
//        }
//        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()|| SQL : ".$strSQL);
//        $stmt = $db->ejecutar ( $strSQL );
//        if(!$stmt){
//            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
//            $db->ejecutar ("ROLLBACK");
//            $db->desconectar ();
//            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                    " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<ROLLBACK");
//            return false;
//        }
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosIVA_VariosIRPF_VariasCuentas()<COMMIT");
        
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function AltaGastosMovimientosSinIVA($numAsiento,$idEmp,$strCuenta, $lngIngreso,
                                            $strCuentaCli, $lngCantidad, $datFecha,$optTipo,
                                            $strCuentaBancos,$strPeriodo, $lngEjercicio, $strConcepto, $esAbono, $strUsuario,$tipoAsiento)
    {
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosSinIVA() || START TRANSACTION");

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados()>");
        
        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }
        
        //realizo las inserciones en las tablas tbmovimientos y tbacumulados utilizando la funcion 'AltaGastosMovimientos_tbMovimientos_tbacumulados'
        $orden=$this->AltaGastosMovimientos_tbMovimientos_tbacumulados($idEmp, $strCuenta, $lngIngreso, $strCuentaCli, $lngCantidad, 0,
                                                                $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                                                $lngEjercicio, $strConcepto, $strUsuario, $db,1,$asiento,$esAbono,$tipoAsiento);
        if($orden==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosSinIVA()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados()<OK");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()>");
        
        //realizo las inserciones en las tablas tbmovimientos y tbacumulados tuilizando la funcion 'AltaGastosMovimientos_tbMovimientos_tbacumulados'
        $OK=$this->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago($idEmp, $strCuenta, $lngIngreso, $strCuentaCli, $lngCantidad, 0,
                                                                $datFecha, $optTipo, $strCuentaBancos, $strPeriodo,
                                                                $lngEjercicio, $strConcepto, $strUsuario, $db,$orden,$asiento,$esAbono,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaGastosMovimientosSinIVA()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientos_tbMovimientos_tbacumulados_Pago()<OK");
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGastosMovimientosSinIVA()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }   
    
    function AltaIngresosMovimientosSinIVA($numAsiento,$idEmp,$strCuenta, $lngIngreso,
                                            $strCuentaCli, $lngCantidad, $datFecha,$optTipo,
                                            $strCuentaBancos,$strPeriodo, $lngEjercicio, $strConcepto, $esAbono, $strUsuario,$tipoAsiento)
    {
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosSinIVA() || START TRANSACTION");

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientos_tbMovimientos_tbacumulados()>");
        
        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        if($numAsiento==0){
            $asiento=$this->numeroAsientoNuevo($db);
        }else{
            $asiento=$numAsiento;
        }

        //1º Cuenta 7 (Ingreso)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 1, $strCuenta, $DoH,
                $lngCantidad, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosSinIVA()<ROLLBACK");
            return false;
        }
        
        //2º Cuenta 43 (cliente)
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 2, $strCuentaCli, $DoH,
                $lngCantidad, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosMovimientosSinIVA()<ROLLBACK");
            return false;
        }
        //si se ha pagado se inserta
        if($optTipo==1){
            //3º Cuenta 43 (cliente)
            if($esAbono==='NO'){
                $DoH='H';
            }else{
                $DoH='D';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 3, $strCuentaCli, $DoH,
                    $lngCantidad, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosSinIVA()<ROLLBACK");
                return false;
            }
            
            //4º Cuenta 57 (banco o caja)
            if($esAbono==='NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, 4, $strCuentaBancos, $DoH,
                    $lngCantidad, 0, $datFecha, $strPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosSinIVA()<ROLLBACK");
                return false;
            }
        }
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosMovimientosSinIVA()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }   
    
    function AltaIngresosGastos($idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //tipo de Asiento es 2 (Manual)
        $tipoAsiento=2;
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosGastos($idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario) || START TRANSACTION");

        //averiguo el valor asiento de la tabla 'tbmovimientos' mas alto que haya
        $strSQL = 'SELECT asiento FROM tbmovimientos ORDER BY asiento DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosGastos($idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $asiento=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $asiento=$row['asiento']+1;
            }else{
                $asiento=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosGastos($idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosGastos($idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)|| Asiento : ".$asiento);
            
        //control de los numeros de movimientos
        $numMov=1;
        //recorro el array $movimienstosAsiento y voy insertando en la tabla 'tbmovimientos'
        // e insertando o actualizando en la tabla 'tbacumulados
        foreach ($movimientosAsiento as $movimiento) {
            //TABLA tbmovimientos
            //obtengo la informacion de la cuenta
            $cuenta=explode(" - ", $movimiento['Cuenta']); 
            //si no existe doy error (la busco en la funcion DatosCuenta donde le paso la conexion $db
            $grupo=substr($cuenta[0],0,1);
            $subGrupo2=substr($cuenta[0],0,2);
            $subGrupo4=substr($cuenta[0],0,4);
            
            //obtengo el idMovimiento
            $strSQL = "SELECT idMovimiento FROM tbmovimientos ORDER BY idMovimiento DESC LIMIT 0,1";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosGastos($idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $num=  mysql_num_rows($stmt);
                $idMovimiento=0;
                if($num>0){
                    $row=  mysql_fetch_assoc($stmt);
                    $idMovimiento=$row['idMovimiento']+1;
                }else{
                    $idMovimiento=1;
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosGastos($idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosGastos($idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)|| idMovimiento : ".$idMovimiento);

            $strSQL = "INSERT INTO tbmovimientos (IdMovimiento, idEmpresa, asiento, orden, idCuenta, Grupo, SubGrupo2, SubGrupo4, DoH, cantidad, " .
                      "Fecha, fechaApunte, periodo, ejercicio,concepto, strUsuario, activo,Borrado,TipoAsiento) " .
                      "VALUES (" . $idMovimiento . "," . $idEmp . "," . $asiento . ",".$numMov.",'" . $cuenta[0] . "'," . $grupo .
                      ", " . $subGrupo2 . ", " . $subGrupo4 . ",'".$movimiento['DoH']."'," . $movimiento['Cantidad'] . "," .
                      "now(),'" . fecha_to_DATETIME($datFecha) . "','" . $lngPeriodo . "'," . $lngEjercicio . ",'" . $movimiento['Concepto'] . "','" . $strUsuario . "',1,1,'$tipoAsiento')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIngresosGastos($idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)|| SQL : ".$strSQL);

            $stmt = $db->ejecutar ( $strSQL );
            if(!$stmt){
                //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosGastos($idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)<ROLLBACK");
                return false;
            }
            
            //avanzamos el control
            $numMov++;
        }
        
        
        //si se llega aqui es que todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIngresosGastos($idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)<COMMIT");

        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        
        return true;
    }
    
    function EditarIngresosGastos($Asiento,$datosAsientoOriginal,$idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarIngresosGastos($Asiento,$idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario) || START TRANSACTION");

        //recorro el array $movimienstosAsiento y voy insertando o actualizando en la tabla 'tbmovimientos'
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarIngresosGastos($Asiento,$idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario) || TABLA tbmovimientos");
        
        //lo primero que hago es borrar el asiento original de las tablas 'tbmovimientos'
        if(is_array($datosAsientoOriginal)){
            foreach ($datosAsientoOriginal as $mov) {
                //primero la tabla 'tbmovimientos'
                $strSQL = "UPDATE tbmovimientos SET Borrado=0 WHERE IdMovimiento=".$mov['IdMovimiento'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarIngresosGastos()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->EditarIngresosGastos()<ROLLBACK");
                    return false;
               }
            }
        }
        
        //ahora insertamos el asiento final en la tabla 'tbmovimientos'
        $numMov=1;        
        foreach ($movimientosAsiento as $movimiento) {
            //TABLA tbmovimientos
            //obtengo la informacion de la cuenta
            $cuenta=explode(" - ", $movimiento['Cuenta']);
            //si no existe doy error (la busco en la funcion DatosCuenta donde le paso la conexion $db
            $grupo=substr($cuenta[0],0,1);
            $subGrupo2=substr($cuenta[0],0,2);
            $subGrupo4=substr($cuenta[0],0,4);
            
            //obtengo el idMovimiento
            $strSQL = "SELECT idMovimiento FROM tbmovimientos ORDER BY idMovimiento DESC LIMIT 0,1";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarIngresosGastos($Asiento,$idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $num=  mysql_num_rows($stmt);
                $idMovimiento=0;
                if($num>0){
                    $row=  mysql_fetch_assoc($stmt);
                    $idMovimiento=$row['idMovimiento']+1;
                }else{
                    $idMovimiento=1;
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarIngresosGastos($Asiento,$idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarIngresosGastos($Asiento,$idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)|| idMovimiento : ".$idMovimiento);

            $strSQL = "INSERT INTO tbmovimientos (IdMovimiento, idEmpresa, asiento, orden, idCuenta, Grupo, SubGrupo2, SubGrupo4, DoH, cantidad, " .
                      "Fecha, fechaApunte, periodo, ejercicio,concepto, strUsuario, activo,Borrado,TipoAsiento) " .
                      "VALUES (" . $idMovimiento . "," . $idEmp . "," . $Asiento . ",".$numMov.",'" . $cuenta[0] . "'," . $grupo .
                      ", " . $subGrupo2 . ", " . $subGrupo4 . ",'".$movimiento['DoH']."'," . $movimiento['Cantidad'] . "," .
                      "now(),'" . fecha_to_DATETIME($datFecha) . "','" . $lngPeriodo . "'," . $lngEjercicio . ",'" . $movimiento['Concepto'] . "','" . $strUsuario . "',1,1,'2')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarIngresosGastos($Asiento,$idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
                
            if(!$stmt){
                //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarIngresosGastos($Asiento,$idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)<ROLLBACK");
                return false;
            }
            $numMov++;
        }
        
        //si hemos llegado hasta aqui es que esta todo OK por lo que damos COMMIT y devuelvo true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarIngresosGastos($Asiento,$idEmp,$movimientosAsiento,$datFecha,$lngPeriodo, $lngEjercicio, $strUsuario)<COMMIT");
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return true;
    }
    
    function ObtieneListaModAsiento($strCuenta,$lngPeriodo,$lngEjercicio,$datFechaInicio,$datFechaFin,$strOpcion,$lngCantidad){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //hago el select en la tabla 'tbcuenta'
        $strSQL="SELECT DISTINCT C.IdCuenta, C.NumCuenta, C.Nombre FROM tbcuenta C,tbmovimientos M WHERE C.NumCuenta=M.idCuenta AND C.Borrado=0 AND M.Borrado=1";

        //añado los filtros de la consulta
        if($strCuenta<>''){
            $strSQL = $strSQL . " AND CONCAT(C.NumCuenta,' - ',C.Nombre) LIKE '" . $strCuenta . "%'";
        }
        
        if($lngPeriodo<>''){
            $strSQL = $strSQL . " AND M.Periodo ='" . $lngPeriodo . "'";
        }
        
        if($lngEjercicio<>''){
            $strSQL = $strSQL . " AND M.ejercicio = " . $lngEjercicio;
        }
        
        if($datFechaInicio<>''){
            $strSQL = $strSQL . " AND M.fechaApunte >= '" . fecha_to_DATETIME($datFechaInicio)."'";
        }
        
        if($datFechaFin<>''){
            $strSQL = $strSQL . " AND M.fechaApunte <= '" . fecha_to_DATETIME($datFechaFin)."'";
        }
        
        if($strOpcion<>'' && $lngCantidad<>''){
            $strSQL = $strSQL . " AND M.cantidad " . $strOpcion .$lngCantidad;
        }
        
        //ordeno por cuenta
        $strSQL = $strSQL . " ORDER BY C.NumCuenta ASC";
        
        //echo $strSQL;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ObtieneListaModAsiento($strCuenta)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //introduzco los datos en un array y lo devuelvo
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ObtieneListaModAsiento($strCuenta)<TRUE");
            $resultado=array();
            $idx=0;
            while ($row=  mysql_fetch_array($stmt)){
                $resultado[$idx]=array(
                                    "IdCuenta"=>$row['IdCuenta'],
                                    "Cuenta"=>$row['NumCuenta'],
                                    "Nombre"=>$row['Nombre']
                                 );
                $idx++;
            }
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ObtieneListaModAsiento($strCuenta)<FALSE");
            return false;
        }
    }
    
    function ListadoAsientosCuenta($cuenta,$parametros){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //hago el select
        $strSQL="
                 SELECT M.IdMovimiento,DATE_FORMAT(M.fechaApunte,'%d/%m/%Y') AS Fecha,M.asiento,M.concepto,IF(M.DoH='D',M.cantidad,0) AS Debe,
                 IF(M.DoH='H',M.cantidad,0) AS Haber,IF(M.DoH='D',M.cantidad,-M.cantidad) AS Saldo,IF(ISNULL(P.Activo),1,P.Activo) AS ActivoPeriodo,M.TipoAsiento
                 FROM tbmovimientos M
                 LEFT JOIN tbperiodos_iva P ON (M.ejercicio=P.ejercicio AND M.periodo=P.periodo)
                 WHERE M.idCuenta='".$cuenta['Cuenta']."'
                 AND M.Borrado=1 AND M.Activo=1
                 ";

        //añado los filtros que vienen en los parametros
        if($parametros['Periodo']<>''){
            $strSQL=$strSQL." AND M.periodo='".$parametros['Periodo']."'";
        }
        if($parametros['Ejercicio']<>''){
            $strSQL=$strSQL." AND M.ejercicio='".$parametros['Ejercicio']."'";
        }
        if($parametros['FechaInicio']<>''){
            $strSQL=$strSQL." AND M.fechaApunte >= '" . fecha_to_DATETIME($parametros['FechaInicio'])."'";
        }
        if($parametros['FechaFin']<>''){
            $strSQL=$strSQL." AND M.fechaApunte <= '" . fecha_to_DATETIME($parametros['FechaFin'])."'";
        }
        if($parametros['Opcion']<>''){
            $strSQL=$strSQL." AND M.cantidad ". $parametros['Opcion'] . $parametros['Cantidad']."";
        }
        //ordenar
        $strSQL=$strSQL." ORDER BY M.fechaApunte,M.asiento";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoAsientosCuenta($cuenta,parametros)|| SQL : ".$strSQL);
        //echo $strSQL;
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //introduzco los datos en un array y lo devuelvo
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoAsientosCuenta($cuenta,parametros)<TRUE");
            $resultadoInt=array();
            $idx=0;
            while ($row=  mysql_fetch_array($stmt)){
                $resultadoInt[$idx]=array(
                                    "IdMovimiento"=>$row['IdMovimiento'],
                                    "Fecha"=>$row['Fecha'],
                                    "Asiento"=>$row['asiento'],
                                    "Concepto"=>$row['concepto'],
                                    "Debe"=>$row['Debe'],
                                    "Haber"=>$row['Haber'],
                                    "Saldo"=>$row['Saldo'],
                                    "ActivoPeriodo"=>$row['ActivoPeriodo'],
                                    "TipoAsiento"=>$row['TipoAsiento']
                                 );
                $idx++;
            }
            
            //ahora resumo en un asiento, a veces viene dos registros-ordenes (debe y haber) por asiento)
            $resultado='';
            $idx=1;//el numero 0 es el registro inicial
            
            //recorro el array y voy introduciendo en uno nuevo un resumen de este array
            $saldo=0;
            for($i=0;$i<count($resultadoInt);$i++){
                if(is_array($resultado)){
                    //recorro el array donde guardo el resultado
                    for($j=0;$j<count($resultado);$j++){
                        //primero vero si exite este registro en la tabla $resultado
                        $encontrado=false;
                        if($resultado[$j]['Asiento']==$resultadoInt[$i]['Asiento']){
                            $saldo=$saldo+$resultadoInt[$i]['Saldo'];
                            //si existe lo que hago es sumar
                            $resultado[$j]['Debe']=$resultado[$j]['Debe']+$resultadoInt[$i]['Debe'];
                            $resultado[$j]['Haber']=$resultado[$j]['Haber']+$resultadoInt[$i]['Haber'];
                            $resultado[$j]['Saldo']=$saldo;
                            $encontrado=true;
                        }
                    }
                    if($encontrado==false){
                        $saldo=$saldo+$resultadoInt[$i]['Saldo'];
                        //si no existe creo este registro y guardo todos los valores
                        $resultado[$idx]=array(
                                            "IdMovimiento"=>$resultadoInt[$i]['IdMovimiento'],
                                            "Fecha"=>$resultadoInt[$i]['Fecha'],
                                            "Asiento"=>$resultadoInt[$i]['Asiento'],
                                            "Concepto"=>$resultadoInt[$i]['Concepto'],
                                            "Debe"=>$resultadoInt[$i]['Debe'],
                                            "Haber"=>$resultadoInt[$i]['Haber'],
                                            "Saldo"=>$saldo,
                                            "ActivoPeriodo"=>$resultadoInt[$i]['ActivoPeriodo'],
                                            "TipoAsiento"=>$resultadoInt[$i]['TipoAsiento']
                                         );
                        $idx++;
                    }
                }else{
                    $saldo=$saldo+$resultadoInt[$i]['Saldo'];
                    //el primer registro se guarda
                    $resultado[0]=array(
                                        "IdMovimiento"=>$resultadoInt[$i]['IdMovimiento'],
                                        "Fecha"=>$resultadoInt[$i]['Fecha'],
                                        "Asiento"=>$resultadoInt[$i]['Asiento'],
                                        "Concepto"=>$resultadoInt[$i]['Concepto'],
                                        "Debe"=>$resultadoInt[$i]['Debe'],
                                        "Haber"=>$resultadoInt[$i]['Haber'],
                                        "Saldo"=>$saldo,
                                        "ActivoPeriodo"=>$resultadoInt[$i]['ActivoPeriodo'],
                                        "TipoAsiento"=>$resultadoInt[$i]['TipoAsiento']
                                     );
                }
            }
            
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoAsientosCuenta($cuenta,$parametros)<FALSE");
            return false;
        }
    }
    
    function leeAsiento($Asiento,$DoH){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //selecciono todos los movimientos de este asiento
        $strSQL="SELECT M.IdMovimiento,M.asiento,M.idCuenta,M.periodo,M.ejercicio,M.orden,M.concepto,M.cantidad,M.DoH,P.Activo
                 FROM tbmovimientos M
                 LEFT JOIN tbperiodos_iva P ON (M.ejercicio=P.ejercicio AND M.periodo=P.periodo)
                 WHERE M.asiento=$Asiento AND M.Borrado=1";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->leeAsiento($Asiento,$DoH)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );

        //compruebo que la consulta SQL es correcta, si lo es guardo los datos en un array, sino devuelvo false
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->leeAsiento($Asiento,$DoH)<TRUE");
            $resultado=array();
            $idx=1;
            while ($row=  mysql_fetch_array($stmt)){
                //comprobamos si cumple la condicion $DoH
                if($row['DoH']==$DoH){
                    //ahora vamos a buscar en la tabla 'tbcuenta' para escribir bien la cuenta (cuenta - nombre)
                    $strSQL="SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuenta
                             FROM tbcuenta
                             WHERE NumCuenta ='".$row['idCuenta']."'";
                    $stmtCuenta = $db->ejecutar ( $strSQL );
                    
                    $rowCuenta=mysql_fetch_array($stmtCuenta);

                    $resultado[$idx]=array(
                                        "IdMovimiento"=>$row['IdMovimiento'],
                                        "asiento"=>$row['asiento'],
                                        "cuenta"=>$rowCuenta['cuenta'],
                                        "periodo"=>$row['periodo'],
                                        "ejercicio"=>$row['ejercicio'],
                                        "orden"=>$row['orden'],
                                        "concepto"=>$row['concepto'],
                                        "cantidad"=>$row['cantidad'],
                                        "Activo"=>$row['Activo']
                                     );
                    $idx++;
                }
            }
            $db->desconectar ();
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->leeAsiento($Asiento,$DoH)<FALSE");
            return false;
        }
    }
    
    function leeAsientoFecha($Asiento){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        $strSQL="SELECT fechaApunte,periodo,ejercicio FROM tbmovimientos
                 WHERE asiento=$Asiento AND Borrado=1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->leeAsientoFecha($Asiento)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
            
        //compruebo que la consulta SQL es correcta, si lo es guardo los datos en un array, sino devuelvo false
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->leeAsientoFecha($Asiento)<TRUE");
            $resultado=array();
            $idx=1;
            while ($row=  mysql_fetch_array($stmt)){
                //mes en letras
                if($row['periodo']==1){
                    $periodo='ENERO';
                }else if($row['periodo']==2){
                    $periodo='FEBRERO';
                }else if($row['periodo']==3){
                    $periodo='MARZO';
                }else if($row['periodo']==4){
                    $periodo='ABRIL';
                }else if($row['periodo']==5){
                    $periodo='MAYO';
                }else if($row['periodo']==6){
                    $periodo='JUNIO';
                }else if($row['periodo']==7){
                    $periodo='JULIO';
                }else if($row['periodo']==8){
                    $periodo='AGOSTO';
                }else if($row['periodo']==9){
                    $periodo='SEPTIEMBRE';
                }else if($row['periodo']==10){
                    $periodo='OCTUBRE';
                }else if($row['periodo']==11){
                    $periodo='NOVIEMBRE';
                }else if($row['periodo']==12){
                    $periodo='DICIEMBRE';
                }else{
                    $periodo='';
                }
                $resultado[$idx]=array(
                                    "fecha"=>$row['fechaApunte'],
                                    "periodo"=>$periodo,
                                    "ejercicio"=>$row['ejercicio']
                                 );
                $idx++;
            }
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->leeAsientoFecha($Asiento)<FALSE");
            return false;
        }
    }
    
    function consultaCerradoIVA(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //extraigo los datos del año en curso
        $strSQL="SELECT * FROM tbiva ORDER BY Ejercicio,Trimestre";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->consultaCerradoIVA()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //compruebo que la consulta SQL es correcta, si lo es guardo los datos en un array, sino devuelvo false
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->consultaCerradoIVA()<TRUE");
            $resultado=array();
            $idx=1;
            while ($row=  mysql_fetch_array($stmt)){
                $resultado[$idx]=array(
                                    "IdIva"=>$row['IdIva'],
                                    "Ejercicio"=>$row['Ejercicio'],
                                    "Trimestre"=>$row['Trimestre'],
                                    "IVA_Repercutido"=>$row['IVA_Repercutido'],
                                    "IVA_Soportado"=>$row['IVA_Soportado'],
                                    "A_Compensar"=>-$row['A_Compensar']
                                 );
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       ' $resultado['.$idx.']: Ejercicio=>'.$resultado[$idx]["Ejercicio"].' - Trimestre=>'.$resultado[$idx]["Trimestre"].' - IVA_Repercutido=>'.$resultado[$idx]["IVA_Repercutido"].' - IVA_Soportado=>'.$resultado[$idx]["IVA_Soportado"].' - A_Compensar=>'.$resultado[$idx]["A_Compensar"]);
                $idx++;
            }
            
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->consultaCerradoIVA()<FALSE");
            return false;
        }
    }

    //TENGO QUE PLANTEARLA DE OTRA FORMA 22/11/2013
    function consultaAbiertoIVA(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //consulta para extraer los datos de IVA Repercutido (4770) y soportado (4720) segun los ejercicos y trimestres
        $strSQL="(SELECT IF(I.IdIva LIKE 'S%','Soportado','Repercutido') AS Tipo, M.ejercicio,
                    (CASE 
                    WHEN M.periodo IN (1,2,3) THEN 1
                    WHEN M.periodo IN (4,5,6) THEN 2
                    WHEN M.periodo IN (7,8,9) THEN 3
                    WHEN M.periodo IN (10,11,12) THEN 4
                    END) Trimestre,
                    ROUND(SUM(I.BaseImponible),2) AS Base,
                    ROUND(SUM(I.CuotaIVA),2) AS Cuota
                    FROM tbmovimientos_iva I,tbmovimientos M
                    WHERE I.IdAsiento=M.asiento
                    AND M.Borrado=1 
                    AND I.Borrado=1 
                    AND M.idCuenta LIKE '4720%' 
                    GROUP BY M.ejercicio,Trimestre)

                    UNION

                    (SELECT IF(I.IdIva LIKE 'S%','Soportado','Repercutido') AS Tipo,M.ejercicio,
                    (CASE 
                    WHEN M.periodo IN (1,2,3) THEN 1
                    WHEN M.periodo IN (4,5,6) THEN 2
                    WHEN M.periodo IN (7,8,9) THEN 3
                    WHEN M.periodo IN (10,11,12) THEN 4
                    END) Trimestre,
                    ROUND(SUM(I.BaseImponible),2) AS Base,
                    ROUND(SUM(I.CuotaIVA),2) AS Cuota
                    FROM tbmovimientos_iva I,tbmovimientos M
                    WHERE I.IdAsiento=M.asiento
                    AND M.Borrado=1 
                    AND I.Borrado=1 
                    AND M.idCuenta LIKE '4770%' 
                    GROUP BY M.ejercicio,Trimestre)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->consultaAbiertoIVA()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //compruebo que la consulta SQL es correcta, si lo es guardo los datos en un array, sino devuelvo false
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->consultaAbiertoIVA()<TRUE");
            $resultado=array();
            $idx=1;
            while ($row=  mysql_fetch_array($stmt)){
                $resultado[$idx]=array(
                                    "Tipo"=>$row['Tipo'],
                                    "Ejercicio"=>$row['ejercicio'],
                                    "Trimestre"=>$row['Trimestre'],
                                    "Base"=>$row['Base'],
                                    "Cuota"=>$row['Cuota']
                                 );
                $idx++;
            }
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->consultaAbiertoIVA()<FALSE");
            return false;
        }
    }

    function guardarTrimestre($ejercicio,$trimestre,$IVA_Rep,$IVA_Sop,$Saldo_Anterior){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestre() || START TRANSACTION");

        //primero guardo en la tabla tbiva
        
        //reviso que no haya insertado en la tabla algun dato con este ejercicio y trimestre
        $strSQL = "SELECT IdIva FROM tbiva WHERE Ejercicio=$ejercicio AND Trimestre=$trimestre";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestre()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            if($num>0){
                //existe ya registro por lo que cancela toda la operación, hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->guardarTrimestre()<ROLLBACK");
                return false;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestre()<ROLLBACK");
            return false;
        }
        
        //averiguo el valor mas alto de IdIva dela tabla tbiva
        $strSQL = 'SELECT IdIva FROM tbiva ORDER BY IdIva DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestre()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $idIVA=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idIVA=$row['IdIva']+1;
            }else{
                $idIVA=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestre()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestre()|| IdIva Nuevo : ".$idIVA);

        $A_Comp=$IVA_Rep-$IVA_Sop-$Saldo_Anterior;
        //echo $A_Comp;die;
        if($A_Comp>0){
            //si es positivo se guarda valor 0 (es a ingresar)
            $A_Comp=0;
        }else{
            //si es negativo, le cambio el signo
            $A_Comp=-$A_Comp;
        }
        //ahora hago la insercion del nuevo IVA trimestral
        $strSQL="INSERT INTO tbiva (IdIva,Ejercicio,Trimestre,IVA_Repercutido,IVA_Soportado,A_Compensar)
                 VALUES ($idIVA,$ejercicio,$trimestre,$IVA_Rep,$IVA_Sop,$A_Comp)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->guardarTrimestre()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestre()<ROLLBACK");
            return false;
        }
        
        //a continuacion guardo en la tabla tbperiodos_iva
        //hay que hacer tres inserciones, tres periodos (meses) por trimestre
        if($trimestre==1){
            $periodo1=1;
            $periodo2=2;
            $periodo3=3;
        }else if($trimestre==2){
            $periodo1=4;
            $periodo2=5;
            $periodo3=6;
        }else if($trimestre==3){
            $periodo1=7;
            $periodo2=8;
            $periodo3=9;
        }else if($trimestre==4){
            $periodo1=10;
            $periodo2=11;
            $periodo3=12;
        }
        
        //reviso que no haya insertado en la tabla algun dato con este ejercicio y trimestre
        $strSQL = "SELECT idPeriodo FROM tbperiodos_iva WHERE Ejercicio=$ejercicio
                   AND (Periodo=$periodo1 OR Periodo=$periodo2 OR Periodo=$periodo3)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestre()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            if($num>0){
                //existen ya registros por lo que cancela toda la operación, hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->guardarTrimestre()<ROLLBACK");
                return false;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestre()<ROLLBACK");
            return false;
        }
        
        //averiguo el valor mas alto de idPeriodo dela tabla tbperiodos_iva
        $strSQL = 'SELECT idPeriodo FROM tbperiodos_iva ORDER BY idPeriodo DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestre()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idPeriodo=$row['idPeriodo']+1;
            }else{
                $idPeriodo=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestre()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestre()|| idPeriodo Nuevo : ".$idPeriodo);

        //ahora hago la insercion del nuevo periodo cerrado
        $strSQL="INSERT INTO tbperiodos_iva (idPeriodo,ejercicio,periodo,Activo)
                 VALUES ($idPeriodo,$ejercicio,$periodo1,2)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->guardarTrimestre()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestre()<ROLLBACK");
            return false;
        }
        $idPeriodo++;
        $strSQL="INSERT INTO tbperiodos_iva (idPeriodo,ejercicio,periodo,Activo)
                 VALUES ($idPeriodo,$ejercicio,$periodo2,2)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->guardarTrimestre()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestre()<ROLLBACK");
            return false;
        }
        $idPeriodo++;
        $strSQL="INSERT INTO tbperiodos_iva (idPeriodo,ejercicio,periodo,Activo)
                 VALUES ($idPeriodo,$ejercicio,$periodo3,2)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->guardarTrimestre()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestre()<ROLLBACK");
            return false;
        }
        
        //si hemos llegado hasta aqui es que esta todo OK por lo que damos COMMIT y devuelvo true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestre()<COMMIT");
        return true;
    }
    
    function guardarTrimestreIRPF($ejercicio,$trimestre,$baseA,$retA,$baseG,$retG){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestreIRPF() || START TRANSACTION");

        //primero guardo en la tabla tbirpf
        
        //reviso que no haya insertado en la tabla algun dato con este ejercicio y trimestre
        $strSQL = "SELECT IdIrpf FROM tbirpf WHERE Ejercicio=$ejercicio AND Trimestre=$trimestre";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestreIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            if($num>0){
                //existe ya registro por lo que cancela toda la operación, hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->guardarTrimestreIRPF()<ROLLBACK");
                return false;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestreIRPF()<ROLLBACK");
            return false;
        }
        
        //averiguo el valor mas alto de IdIrpf dela tabla tbirpf
        $strSQL = 'SELECT IdIrpf FROM tbirpf ORDER BY IdIrpf DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestreIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $idIRPF=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idIRPF=$row['IdIrpf']+1;
            }else{
                $idIRPF=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestreIRPF()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestreIRPF()|| IdIrpf Nuevo : ".$idIRPF);

        //ahora hago la insercion del nuevo IRPF trimestral
        $strSQL="INSERT INTO tbirpf 
                 VALUES ($idIRPF,$ejercicio,$trimestre,$baseA,$retA,$baseG,$retG)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->guardarTrimestreIRPF()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestreIRPF()<ROLLBACK");
            return false;
        }
        
        
        //a continuacion guardo en la tabla tbperiodos_irpf
        //hay que hacer tres inserciones, tres periodos (meses) por trimestre
        if($trimestre==1){
            $periodo1=1;
            $periodo2=2;
            $periodo3=3;
        }else if($trimestre==2){
            $periodo1=4;
            $periodo2=5;
            $periodo3=6;
        }else if($trimestre==3){
            $periodo1=7;
            $periodo2=8;
            $periodo3=9;
        }else if($trimestre==4){
            $periodo1=10;
            $periodo2=11;
            $periodo3=12;
        }
        
        //reviso que no haya insertado en la tabla algun dato con este ejercicio y trimestre
        $strSQL = "SELECT idPeriodo FROM tbperiodos_irpf WHERE Ejercicio=$ejercicio
                   AND (Periodo=$periodo1 OR Periodo=$periodo2 OR Periodo=$periodo3)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestreIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            if($num>0){
                //existen ya registros por lo que cancela toda la operación, hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->guardarTrimestreIRPF()<ROLLBACK");
                return false;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestreIRPF()<ROLLBACK");
            return false;
        }
        
        //averiguo el valor mas alto de idPeriodo dela tabla tbperiodos_irpf
        $strSQL = 'SELECT idPeriodo FROM tbperiodos_irpf ORDER BY idPeriodo DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestreIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idPeriodo=$row['idPeriodo']+1;
            }else{
                $idPeriodo=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestreIRPF()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestreIRPF()|| idPeriodo Nuevo : ".$idPeriodo);

        //ahora hago la insercion del nuevo periodo cerrado
        $strSQL="INSERT INTO tbperiodos_irpf (idPeriodo,ejercicio,periodo,Activo)
                 VALUES ($idPeriodo,$ejercicio,$periodo1,2)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->guardarTrimestre()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestreIRPF()<ROLLBACK");
            return false;
        }
        $idPeriodo++;
        $strSQL="INSERT INTO tbperiodos_irpf (idPeriodo,ejercicio,periodo,Activo)
                 VALUES ($idPeriodo,$ejercicio,$periodo2,2)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->guardarTrimestreIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestreIRPF()<ROLLBACK");
            return false;
        }
        $idPeriodo++;
        $strSQL="INSERT INTO tbperiodos_irpf (idPeriodo,ejercicio,periodo,Activo)
                 VALUES ($idPeriodo,$ejercicio,$periodo3,2)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->guardarTrimestreIRPF()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarTrimestreIRPF()<ROLLBACK");
            return false;
        }
        
        //si hemos llegado hasta aqui es que esta todo OK por lo que damos COMMIT y devuelvo true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarTrimestreIRPF()<COMMIT");
        return true;
    }
    
    function consultaCerradoIRPF(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //extraigo los datos del año en curso
        $strSQL="SELECT * FROM tbirpf ORDER BY Ejercicio,Trimestre";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->consultaCerradoIRPF()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //compruebo que la consulta SQL es correcta, si lo es guardo los datos en un array, sino devuelvo false
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->consultaCerradoIRPF()<TRUE");
            $resultado='';
            while ($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->consultaCerradoIRPF()<FALSE");
            return false;
        }
    }
    
    function consultaCerradoAutonomo130(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //extraigo los datos del año en curso
        $strSQL="SELECT * FROM tbautonomo130 ORDER BY Ejercicio,Trimestre";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->consultaCerradoAutonomo130()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //compruebo que la consulta SQL es correcta, si lo es guardo los datos en un array, sino devuelvo false
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->consultaCerradoAutonomo130()<TRUE");
            $resultado='';
            while ($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->consultaCerradoAutonomo130()<FALSE");
            return false;
        }
    }
    
    function consultaAbiertoIRPF($clave){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //consulta para extraer los datos de IRPF (4751) segun los ejercicos y trimestres
        $strSQL="
                SELECT M.ejercicio,
                (CASE 
                WHEN M.periodo IN (1,2,3) THEN 1
                WHEN M.periodo IN (4,5,6) THEN 2
                WHEN M.periodo IN (7,8,9) THEN 3
                WHEN M.periodo IN (10,11,12) THEN 4
                END) Trimestre,
                ROUND(SUM(R.BaseImponible),2) AS Base,
                ROUND(SUM(R.ImporteRetencion),2) AS Cuota
                FROM tbretenciones_irpf R,tbmovimientos M
                WHERE R.IdAsiento=M.asiento
                AND M.Borrado=1 
                AND M.idCuenta LIKE '4751%'
                AND R.Clave='$clave'
                GROUP BY Trimestre
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->consultaAbiertoIVA()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //compruebo que la consulta SQL es correcta, si lo es guardo los datos en un array, sino devuelvo false
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->consultaAbiertoIRPF()<TRUE");
            $resultado=array();
            while ($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->consultaAbiertoIRPF()<FALSE");
            return false;
        }
    }
    
    function AltaEmpleado($post,$usuario)
    {
        require_once '../CN/clsCNConsultas.php';
        require_once '../CN/clsCNUsu.php';
        $clsCNConsultas=new clsCNConsultas();
        $clsCNConsultas->setStrBD($_SESSION['dbContabilidad']);
        $clsCNUsu=new clsCNUsu();
        $clsCNUsu->setStrBD($_SESSION['dbContabilidad']);


        
        //primero veo si hay datos en observaciones, si es asi los guardo como pregunta en el chat
        $IdPregunta='0';
        if(isset($post['strObservaciones'])){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " Alta Empleado");
            //compiamos al servidor el fichero adjuntado, si hay
            $OK = null;
            //compruebo que no haya habido error
            if($_FILES['doc']['error']==1){
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " Ha habido error en la subida.");
                $errorFile='Error al subir el fichero. ';
            }else{
                if($_FILES['doc']['error'] !== 4 && $_FILES['doc']['name'] !== '' && $_FILES['doc']['type'] === 'application/pdf'){
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " Tiene fichero adjunto: ".$_FILES['doc']['name']);
                    //le damos un nombre al fichero
                    //este nombre consta del lngIdUsuario+fecha(año+mes+dia+hora+min+seg)
                    date_default_timezone_set('Europe/Madrid');
                    $nombre=$_SESSION['usuario'].date('YmdHis');
                    $url="../doc/doc-".$_SESSION['base'].'/'.$nombre.'.pdf';
                    //sino existe este directorio lo crea
                    if(!file_exists("../doc/doc-".$_SESSION['base'])){
                        mkdir("../doc/doc-".$_SESSION['base']);
                    }
                    //compruebo que no sea superior a 1 MB (1048576)
                    if($_FILES['doc']['size']<1048576){
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " El fichero es menor de 1 MB: ".$_FILES['doc']['size']);
                        //subo a la carpeta de doc-EMPRESA el fichero seleccionado
                        if(move_uploaded_file($_FILES['doc']['tmp_name'], $url)){
                            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                   " El fichero ".$_FILES['doc']['name'].' a sido subido correctamente al servidor');
                            //damos de alta la consulta del cliente
                            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                   " Damos de alta en la BBDD la respuesta: clsCNConsultas->AltaPregunta(".$_SESSION['usuario'].",".$_POST['strConsulta'].",$url)>");
                            $OK = true;
                        }else{
                            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                   " El fichero ".$_FILES['doc']['name'].' NO a sido subido al servidor. Error en COPY');
                            $IdPregunta='0';
                            $errorFile='Error al subir el fichero: '.$_FILES['doc']['name'];
                            $OK = false;
                        }
                    }else{
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                               " El fichero es mayor de 1 MB: ".$_FILES['doc']['size']);
                        $errorFile=$_FILES['doc']['name'].': Este fichero supera 1MB de tamaño.';
                    }
                }else
                //revisar si hay fichero "Foto" a adjuntar (foto)
                if($_FILES['foto']['error'] !== 4 && $_FILES['foto']['name'] !== '' && $_FILES['foto']['type'] === 'image/jpeg'){
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['base'].', SesionID: '.  session_id().
                           " Tiene fichero (foto) adjunto: ".$_FILES['doc']['name']);

                    //genero el nombre del fichero 
                    date_default_timezone_set('Europe/Madrid');
                    $nombre=$_SESSION['usuario'].date('YmdHis');
                    $url="../doc/doc-".$_SESSION['base'].'/'.$nombre.'.jpg';

                    //sino existe este directorio lo crea
                    if(!file_exists("../doc/doc-" . $_SESSION['base'])){
                        mkdir("../doc/doc-" . $_SESSION['base']);
                    }

                    //subo a la carpeta de reclamacion el fichero seleccionado
                    if(move_uploaded_file($_FILES['foto']['tmp_name'], $url)){
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['base'].', SesionID: '.  session_id().
                           " El fichero ".$_FILES['foto']['name'].' a sido subido correctamente al servidor');
                        $OK = true;
                    }else{
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['base'].', SesionID: '.  session_id().
                               " El fichero ".$_FILES['foto']['name'].' NO a sido subido al servidor. Error en move_uploaded_file');
                        $OK = false;
                        $errorFile='Error al subir el fichero: '.$_FILES['foto']['name'];
                    }
                }else{//si no hay, insertamos
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " NO tiene fichero adjunto. ");
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " Damos de alta en la BBDD la respuesta: clsCNConsultas->AltaPregunta(".$_SESSION['usuario'].",".$_POST['strConsulta'].",'')>");
                    
                    //ahora comprobamos si $post['strObservaciones']<>'', si es asi introducimos el texto en
                    //el alta de la pregunta
                    if($post['strObservaciones']<>''){
                        $txtObservaciones = $post['strObservaciones'];
                    }else
                    //si estuviese vacio, indicamos un texto por defecto al dar de alta la pregunta    
                    {
                        $txtObservaciones = 'Se ha dado de alta correctamente el empleado en la base de datos';
                    }
                    $IdPregunta=$clsCNConsultas->AltaPregunta($_SESSION['usuario'],$txtObservaciones,'');
                }
                
                
                if($OK === true){
                    $IdPregunta=$clsCNConsultas->AltaPregunta($_SESSION['usuario'],$post['strObservaciones'],$url);
                }
            }
        }
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        
        
        //averiguo el valor mas alto de IdEmpleado de la tabla tbempleados
        $strSQL = 'SELECT IdEmpleado FROM tbempleados ORDER BY IdEmpleado DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaEmpleado()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $IdEmpleado=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $IdEmpleado=$row['IdEmpleado']+1;
            }else{
                $IdEmpleado=1;
            }
        }else{
            //si ha fallado la consulta hacemos false
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaEmpleado()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaEmpleado()|| IdEmpleado Nuevo : ".$IdEmpleado);
        
        //paso fechaAlta y fechaVtoContrato a datetime
        $fechaAlta = '';
        if($post['fechaAlta']<>''){
            $fechaAlta = fecha_to_DATETIME($post['fechaAlta']);
        }
        $fechaVtoContrato = '';
        if($post['fechaVtoContrato']<>''){
            $fechaVtoContrato = fecha_to_DATETIME($post['fechaVtoContrato']);
        }
        
        //preparo Horas
        $horas='';
        if($post['tipoJornada']==='Parcial'){
            if($post['HorasT']==='semanal'){
                $horasT='s';
            }else
            if($post['HorasT']==='diaria'){
                $horasT='d';
            }
            $horas=$post['HorasN'].' '.$horasT;
        }
        
        //ahora hacemos la inserción del empleado en la tabla tbempleados
        $strSQL="INSERT INTO tbempleados (IdEmpleado,NumEmpleado,nombre,apellido1,apellido2,tipoDocumento,numDocumento,numAfiliacion,
                                          calle,numero,piso,letra,codPostal,poblacion,provincia,fechaAlta,fechaVtoContrato,Categoria,tipoContrato,
                                          tipoJornada,Horas,SituacionFamiliar,Hijos,Observaciones,chatActualizado,Borrado,datFechaStatus,lngIdEmpleadoStatus)
                 VALUES ($IdEmpleado,'".$post['NumEmpleado']."','".$post['nombre']."','".$post['apellido1']."','".$post['apellido2']."','".$post['tipoDocumento']."','".$post['numDocumento']."','".$post['numAfiliacion']."',
                         '".$post['calle']."','".$post['numero']."','".$post['piso']."','".$post['letra']."','".$post['codPostal']."',
                         '".$post['poblacion']."','".$post['provincia']."','$fechaAlta','$fechaVtoContrato','".$post['Categoria']."','".$post['tipoContrato']."',
                         '".$post['tipoJornada']."','$horas','".$post['SituacionFamiliar']."','".$post['Hijos']."','$IdPregunta',0,
                         1,now(),$usuario)";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->AltaEmpleado()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos false
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaEmpleado()<ROLLBACK");
            return false;
        }
        
        
        //si hemos llegado hasta aqui es que esta todo OK por lo que devuelvo true
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaEmpleado()<TRUE");
        return true;
    } 
    
    function EditarEmpleado($post,$usuario)
    {
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //preparo Horas
        $horas='';
        if($post['tipoJornada']==='Parcial'){
            if($post['HorasT']==='semanal'){
                $horasT='s';
            }else
            if($post['HorasT']==='diaria'){
                $horasT='d';
            }
            $horas=$post['HorasN'].' '.$horasT;
        }
        
        //controlar fechas
        $fechaAlta='';
        if($post['fechaAlta']<>''){
            $fechaAlta=fecha_to_DATETIME($post['fechaAlta']);
        }
        $fechaBaja='';
        if($post['fechaBaja']<>''){
            $fechaAlta=fecha_to_DATETIME($post['fechaBaja']);
        }
        $fechaVtoContrato='';
        if($post['fechaVtoContrato']<>''){
            $fechaVtoContrato=fecha_to_DATETIME($post['fechaVtoContrato']);
        }
        
        //compruebo como llega el datos de chatActualizado
        $chatActualizado = '0';
        if($post['chatActualizado'] === 'on'){
            $chatActualizado = '1';
        }

        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarEmpleado() || START TRANSACTION");
        
        
        //actualizamos los datos del empleado
        $strSQL = "UPDATE tbempleados SET 
                   NumEmpleado='".$post['NumEmpleado']."',
                   nombre='".$post['nombre']."',
                   apellido1='".$post['apellido1']."',
                   apellido2='".$post['apellido2']."',
                   tipoDocumento='".$post['tipoDocumento']."',
                   numDocumento='".$post['numDocumento']."',
                   numAfiliacion='".$post['numAfiliacion']."',
                   calle='".$post['calle']."',
                   numero='".$post['numero']."',
                   piso='".$post['piso']."',
                   letra='".$post['letra']."',
                   codPostal='".$post['codPostal']."',
                   poblacion='".$post['poblacion']."',
                   provincia='".$post['provincia']."',
                   fechaAlta='".$fechaAlta."',
                   fechaBaja='".$fechaBaja."',
                   fechaVtoContrato='".$fechaVtoContrato."',
                   Categoria='".$post['Categoria']."',
                   tipoContrato='".$post['tipoContrato']."',
                   tipoJornada='".$post['tipoJornada']."',
                   Horas='".$horas."',
                   SituacionFamiliar='".$post['SituacionFamiliar']."',
                   Hijos=".$post['Hijos'].",
                   chatActualizado=".$chatActualizado.",
                   datFechaStatus=now(),
                   lngIdEmpleadoStatus='".$usuario."'
                   WHERE IdEmpleado=".$post['IdEmpleado'];
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarEmpleado()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarEmpleado()<ROLLBACK");
            return false;
        }

        //ahora comprobamos si $post[Hijos]=1 (que tiene hijos)
        //si lo es, grabamos las fechas de nacimientos en la tabla 'tbempl'tbempleados_hijos'
        if($post['Hijos']==='1'){
            //en esta tabla se guardan las fechas de nacimiento de los hijos
            //primero busco si tiene datos este empleado de antes y si los hay los borro (pongo Borrado=0)
            $strSQL = "UPDATE tbempleados_hijos SET
                       Borrado=0
                       WHERE IdEmpleado=".$post['IdEmpleado'];
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaEmpleado()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarEmpleado()<ROLLBACK");
                return false;
            }
            
            //segundo inserto las fechas de nacimiento de los hijos de este formulario
            //todos los post que empiezan por 'fechaN*' donde asterisco el un numero
            //recorro todo $post y los que emiecen pr fechaN lo incluyo e un array
            $fechasNacimiento='';
            foreach ($post as $propiedad => $valor) {
                if(substr($propiedad,0,6)==='fechaN'){
                    $fechasNacimiento[]=$valor;
                }
            }
            
            //ahora recorro este array y voy insertando las fechas de nacimiento
            for($i=0;$i<count($fechasNacimiento);$i++){
                //primero sacamos el IdHijos mas alto
                $strSQL = "
                           SELECT IF(ISNULL(MAX(IdHijos)),1,MAX(IdHijos)+1) AS IdHijos FROM tbempleados_hijos
                           ";
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaEmpleado()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->EditarEmpleado()<ROLLBACK");
                    return false;
                }
                
                $row =  mysql_fetch_array($stmt);
                $IdHijo =  $row['IdHijos'];
                
                $strSQL = "INSERT INTO tbempleados_hijos (IdHijos,IdEmpleado,fechaNacimiento,Borrado,
                                                          datFechaStatus,lngIdEmpleadoStatus)
                           VALUES ($IdHijo,".$post['IdEmpleado'].",'".$fechasNacimiento[$i]."',1,now(),".$usuario.")
                           ";

                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaEmpleado()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->EditarEmpleado()<ROLLBACK");
                    return false;
                }
            }
        }
        
        
        //si hemos llegado hasta aqui es que esta todo OK por lo que damos COMMIT y devuelvo true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarEmpleado()<COMMIT");
        
        return true;
    }
    
    function ListadoIncidenciasEmpleado($IdEmpleado){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //hago el select en la tabla 'tbempleados'
        $strSQL="
                SELECT * 
                FROM tbempleados_incidencias I,tbempleados_incidencias_listado L
                WHERE I.Borrado=1
                AND  I.IdIncidencia=L.IdIncidencia
                AND L.IdEmpleado=".$IdEmpleado;

        //SIN HACER LOS FILTROS
        //añado los filtros de la consulta
//        if($strDNINIE<>''){
//            $strSQL = $strSQL . " AND strDNINIE LIKE '%" . $strDNINIE . "%'";
//        }

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoIncidenciasEmpleado()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //introduzco los datos en un array y lo devuelvo
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoIncidenciasEmpleado()<TRUE");
            
            $resultado='';
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoIncidenciasEmpleado()<FALSE");
            return false;
        }
    }
    
    function ListadoEmpleados($get)
    {
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //hago el select en la tabla 'tbempleados'
        $strSQL="
                SELECT E.*,COUNT(I.IdEmpleado) AS Numero
                FROM tbempleados E LEFT JOIN tbempleados_incidencias_listado I
                ON E.IdEmpleado=I.IdEmpleado
                WHERE E.Borrado=1
                GROUP BY E.IdEmpleado
                ";
        
        //añado los filtros de la consulta
        
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoEmpleados()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //introduzco los datos en un array y lo devuelvo
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoEmpleados()<TRUE");
            
            $resultado='';
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            
            //ahora el array final le paso los filtros, los que no cumplan no los añado en el array final
            $resultFinal = '';
            if(is_array($resultado)){
                for ($i = 0; $i < count($resultado); $i++) {
                    //de principio, cumple
                    $cumple = 'SI';
                    //vamos haciendo las distintas comprobaciones, cuando una falle, ya no cumple
                    if($get['fechaAltaDesde']<>''){
                        $fechaAltaDesde = fecha_to_DATETIME($get['fechaAltaDesde']);
                        if(!($resultado[$i]['fechaAlta'] >= $fechaAltaDesde)){
                            $cumple = 'NO';
                        }
                    }

                    if($get['fechaAltaHasta']<>''){
                        $fechaAltaHasta = fecha_to_DATETIME($get['fechaAltaHasta']);
                        if(!($resultado[$i]['fechaAlta'] <= $fechaAltaHasta)){
                            $cumple = 'NO';
                        }
                    }

                    if($get['VtoContratoDesde']<>''){
                        $VtoContratoDesde = fecha_to_DATETIME($get['VtoContratoDesde']);
                        if(!($resultado[$i]['fechaVtoContrato'] >= $VtoContratoDesde)){
                            $cumple = 'NO';
                        }
                    }

                    if($get['VtoContratoHasta']<>''){
                        $VtoContratoHasta = fecha_to_DATETIME($get['VtoContratoHasta']);
                        if(!($resultado[$i]['fechaVtoContrato'] <= $VtoContratoHasta)){
                            $cumple = 'NO';
                        }
                    }

                    if($get['tipoContrato']<>''){
                        if(!($resultado[$i]['tipoContrato'] === $get['tipoContrato'])){
                            $cumple = 'NO';
                        }
                    }

                    if($get['categoria']<>''){
                        //este texto este contenido dentro del campo de categoria
                        $encontrado = stripos($resultado[$i]['Categoria'],$get['categoria']);
                        if($encontrado === false){
                            $cumple = 'NO';
                        }
                    }


                    //si cumple lo añadimos al array final
                    if($cumple === 'SI'){
                        $resultFinal[] = $resultado[$i];
                    }
                }
            }
            
            return $resultFinal;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoEmpleados()<FALSE");
            return false;
        }
    }
    
    function datosEmpleado($IdEmpleado){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //hago el select en la tabla 'tbempleados'
        $strSQL="SELECT * FROM tbempleados WHERE IdEmpleado=$IdEmpleado AND Borrado=1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosEmpleado()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        if(!$stmt){
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosEmpleado()<FALSE");
            return false;
        }
        
        $row=  mysql_fetch_array($stmt);
        $reg='';
        foreach($row as $propiedad=>$valor){
            if(!is_numeric($propiedad)){
                $reg[$propiedad]=$valor;
            }
        }
        //ahora arreglo la fecha de alta, baja y VtoContrato (viene en datetime)
        if(isset($reg['fechaAlta']) && $reg['fechaAlta']<>'0000-00-00 00:00:00'){
            $time = strtotime($reg['fechaAlta']);
            $reg['fechaAlta'] = date("d/m/Y", $time);                            
        }else
        if(isset($reg['fechaAlta']) && $reg['fechaAlta']==='0000-00-00 00:00:00'){
            $reg['fechaAlta'] = '';
        }
        if(isset($reg['fechaBaja']) && $reg['fechaBaja']<>'0000-00-00 00:00:00'){
            $time = strtotime($reg['fechaBaja']);
            $reg['fechaBaja'] = date("d/m/Y", $time);                            
        }else
        if(isset($reg['fechaBaja']) && $reg['fechaBaja']==='0000-00-00 00:00:00'){
            $reg['fechaBaja'] = '';
        }
        if(isset($reg['fechaVtoContrato']) && $reg['fechaVtoContrato']<>'0000-00-00 00:00:00'){
            $time = strtotime($reg['fechaVtoContrato']);
            $reg['fechaVtoContrato'] = date("d/m/Y", $time);                            
        }else
        if(isset($reg['fechaVtoContrato']) && $reg['fechaVtoContrato']==='0000-00-00 00:00:00'){
            $reg['fechaVtoContrato'] = '';
        }

        //ahora de Horas extraigo los dos campos que van, HorasN=horas y HorasT=tipo jornada
        if(isset($reg['Horas']) && $reg['Horas']<>''){
            $horas=explode(' ',$reg['Horas']);
            $reg['HorasN']=$horas[0];
            if($horas[1]==='s'){
                $reg['HorasT']='semanal';
            }else
            if($horas[1]==='d'){
                $reg['HorasT']='diaria';
            }
        }

        //ahora compruebo que tiene hijos el empleado $reg[Hijos]=1
        if($reg['Hijos']==='1'){
            //extraigo un listado de los nacimientos de los hijos
            $strSQL="SELECT fechaNacimiento FROM tbempleados_hijos WHERE IdEmpleado=$IdEmpleado AND Borrado=1";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosEmpleado()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if(!$stmt){
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->datosEmpleado()<FALSE");
                return false;
            }
            
            $j=0;
            while($row=  mysql_fetch_array($stmt)){
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad][$j]=$valor;
                        $j++;
                    }
                }
            }
        }


        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosEmpleado()<TRUE");
        return $reg;
    }
    
    function empleadoBorrar($id){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //actualizamos los datos del empleado
        $strSQL = "UPDATE tbempleados SET ".
                  "lngAltaBaja=0
                   WHERE IdEmpleado=".$id;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->empleadoBorrar($id)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->empleadoBorrar($id)<TRUE");
            return true;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->empleadoBorrar($id)<FALSE");
            return false;
        }
    }
    
    function ImpuestoIVA303Antiguo($lngEjercicio,$cmdCierre){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //vamos a preparar los calculos del impuesto
        
        if($cmdCierre=='Cierre 1T' || $cmdCierre=='1T'){
            $fechaInicio='01/'.$lngEjercicio;
            $fechaFin='03/'.$lngEjercicio;
            $Periodo='1T';
        }else if($cmdCierre=='Cierre 2T' || $cmdCierre=='2T'){
            $fechaInicio='04/'.$lngEjercicio;
            $fechaFin='06/'.$lngEjercicio;
            $Periodo='2T';
        }else if($cmdCierre=='Cierre 3T' || $cmdCierre=='3T'){
            $fechaInicio='07/'.$lngEjercicio;
            $fechaFin='09/'.$lngEjercicio;
            $Periodo='3T';
        }else if($cmdCierre=='Cierre 4T' || $cmdCierre=='4T'){
            $fechaInicio='10/'.$lngEjercicio;
            $fechaFin='12/'.$lngEjercicio;
            $Periodo='4T';
        }
        
        
        //los datos los incluiremos en un array
        $datosPresentar=array(
            "01"=>'',
            "02"=>'',
            "03"=>'',
            "04"=>'',
            "05"=>'',
            "06"=>'',
            "07"=>'',
            "08"=>'',
            "09"=>'',
            "21"=>'',
            "22a"=>'',
            "22b"=>'',
            "22c"=>'',
            "22d"=>'',
            "22aIVA"=>'',
            "22bIVA"=>'',
            "22cIVA"=>'',
            "22dIVA"=>'',
            "22"=>'',
            "23a"=>'',
            "23b"=>'',
            "23c"=>'',
            "23d"=>'',
            "23"=>'',
            "38"=>'',
            "41"=>'',
            "48"=>'',
            "Ejercicio"=>$lngEjercicio,
            "Trimestre"=>$Periodo
        );
        
        //Extraemos de la tabla 'tbmovimientos_iva' el IVA Repercutido o Devengado 4770
        $strSQL =  "SELECT I.Iva,ROUND(SUM(I.BaseImponible),2) AS Base,ROUND(SUM(I.CuotaIVA),2) AS Cuota
                    FROM tbmovimientos_iva I,tbmovimientos M
                    WHERE I.IdAsiento=M.asiento
                    AND M.idCuenta LIKE '4770%'
                    AND M.Borrado=1
                    AND I.Borrado=1
                    AND DATE_FORMAT(M.fechaApunte,'%m/%Y')>='".$fechaInicio."'
                    AND DATE_FORMAT(M.fechaApunte,'%m/%Y')<='".$fechaFin."'
                    GROUP BY I.Iva
                    ORDER BY I.Iva";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ImpuestoIVA303()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        $resultado=array();
        $idx=1;
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                if($row['Iva']<>'0'){
                    $resultado[$idx]=array(
                                "Iva"=>(float)$row['Iva'],
                                "Base"=>(float)$row['Base'],
                                "Cuota"=>(float)$row['Cuota']
                    );
                    $idx++;
                }
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ImpuestoIVA303() : Hay datos");
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ImpuestoIVA303()<FALSE");
            return false;
        }
        
        if(isset($resultado[1])){
            $datosPresentar['01']=$resultado[1]['Base'];
            $datosPresentar['02']=$resultado[1]['Iva'];
            $datosPresentar['03']=$resultado[1]['Cuota'];
        }else{
            $datosPresentar['01']='';
            $datosPresentar['02']='';
            $datosPresentar['03']='';
        }
        if(isset($resultado[2])){
            $datosPresentar['04']=$resultado[2]['Base'];
            $datosPresentar['05']=$resultado[2]['Iva'];
            $datosPresentar['06']=$resultado[2]['Cuota'];
        }else{
            $datosPresentar['04']='';
            $datosPresentar['05']='';
            $datosPresentar['06']='';
        }
        if(isset($resultado[3])){
            $datosPresentar['07']=$resultado[3]['Base'];
            $datosPresentar['08']=$resultado[3]['Iva'];
            $datosPresentar['09']=$resultado[3]["Cuota"];
        }else{
            $datosPresentar['07']='';
            $datosPresentar['08']='';
            $datosPresentar['09']='';
        }
        
        $datosPresentar["21"]=$datosPresentar['03']+$datosPresentar['06']+$datosPresentar['09'];
        
        //Extraemos de la tabla 'tbmovimientos_iva' el IVA Soportado o Deducible 4720
        $strSQL =  "SELECT I.Iva,ROUND(SUM(I.BaseImponible),2) AS Base,ROUND(SUM(I.CuotaIVA),2) AS Cuota
                    FROM tbmovimientos_iva I,tbmovimientos M
                    WHERE I.IdAsiento=M.asiento
                    AND M.idCuenta LIKE '4720%'
                    AND M.Borrado=1
                    AND I.Borrado=1
                    AND DATE_FORMAT(M.fechaApunte,'%m/%Y')>='".$fechaInicio."'
                    AND DATE_FORMAT(M.fechaApunte,'%m/%Y')<='".$fechaFin."'
                    GROUP BY I.Iva
                    ORDER BY I.Iva";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ImpuestoIVA303()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        $resultado2=array();
        $idx=1;
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $resultado2[$idx]=array(
                            "Iva"=>$row['Iva'],
                            "Base"=>$row['Base'],
                            "Cuota"=>$row['Cuota']
                );
                $idx++;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ImpuestoIVA303() : Hay datos");
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ImpuestoIVA303()<FALSE");
            return false;
        }
        
        //los datos estan dispuestos de esta forma
        // 22a  22aIVA  23a
        // 22b  22bIVA  23b
        // 22c  22cIVA  23c
        // 22d  22dIVA  23d
        // ================
        // 22           23
       
        //guardo los datos en el array
        if(isset($resultado2[1])){
            $datosPresentar['22a']=$resultado2[1]['Base'];
            $datosPresentar['22aIVA']=$resultado2[1]['Iva'];
            $datosPresentar['23a']=$resultado2[1]['Cuota'];
        }else{
            $datosPresentar['22a']='';
            $datosPresentar['22aIVA']='';
            $datosPresentar['23a']='';
        }
        if(isset($resultado2[2])){
            $datosPresentar['22b']=$resultado2[2]['Base'];
            $datosPresentar['22bIVA']=$resultado2[2]['Iva'];
            $datosPresentar['23b']=$resultado2[2]['Cuota'];
        }else{
            $datosPresentar['22b']='';
            $datosPresentar['22bIVA']='';
            $datosPresentar['23b']='';
        }
        if(isset($resultado2[3])){
            $datosPresentar['22c']=$resultado2[3]['Base'];
            $datosPresentar['22cIVA']=$resultado2[3]['Iva'];
            $datosPresentar['23c']=$resultado2[3]['Cuota'];
        }else{
            $datosPresentar['22c']='';
            $datosPresentar['22cIVA']='';
            $datosPresentar['23c']='';
        }
        if(isset($resultado2[4])){
            $datosPresentar['22d']=$resultado2[4]['Base'];
            $datosPresentar['22dIVA']=$resultado2[4]['Iva'];
            $datosPresentar['23d']=$resultado2[4]['Cuota'];
        }else{
            $datosPresentar['22d']='';
            $datosPresentar['22dIVA']='';
            $datosPresentar['23d']='';
        }
        
        $datosPresentar["22"]=$datosPresentar['22a']+$datosPresentar['22b']+$datosPresentar['22c']+$datosPresentar['22d'];
        $datosPresentar["23"]=$datosPresentar['23a']+$datosPresentar['23b']+$datosPresentar['23c']+$datosPresentar['23d'];
        
        $datosPresentar['38']=$datosPresentar['21']-$datosPresentar['23'];
        
        //La casilla 41 (Cuotas a c compensar de periodos anteriores), este dato loextraigo del último registro
        //de la tabla 'tbiva'
        //Extraemos de la tabla 'tbmovimientos_iva' el IVA Soportado o Deducible 4720
        $strSQL =  "SELECT A_Compensar FROM tbiva ORDER BY IdIva DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ImpuestoIVA303()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        $row=  mysql_fetch_array($stmt);
        
        $datosPresentar['41']=$row['A_Compensar'];
        
        $datosPresentar['48']=$datosPresentar['38']-$datosPresentar['41'];
        
        //Por último formateamos todos los número del array en forma de contabilidad
        $datosPresentar['01']=formateaNumeroContabilidad($datosPresentar['01']);
        $datosPresentar['02']=formateaNumeroContabilidad($datosPresentar['02']);
        $datosPresentar['03']=formateaNumeroContabilidad($datosPresentar['03']);
        $datosPresentar['04']=formateaNumeroContabilidad($datosPresentar['04']);
        $datosPresentar['05']=formateaNumeroContabilidad($datosPresentar['05']);
        $datosPresentar['06']=formateaNumeroContabilidad($datosPresentar['06']);
        $datosPresentar['07']=formateaNumeroContabilidad($datosPresentar['07']);
        $datosPresentar['08']=formateaNumeroContabilidad($datosPresentar['08']);
        $datosPresentar['09']=formateaNumeroContabilidad($datosPresentar['09']);
        $datosPresentar['21']=formateaNumeroContabilidad($datosPresentar['21']);
        $datosPresentar['22a']=formateaNumeroContabilidad($datosPresentar['22a']);
        $datosPresentar['22b']=formateaNumeroContabilidad($datosPresentar['22b']);
        $datosPresentar['22c']=formateaNumeroContabilidad($datosPresentar['22c']);
        $datosPresentar['22d']=formateaNumeroContabilidad($datosPresentar['22d']);
        $datosPresentar['22aIVA']=formateaNumeroContabilidad($datosPresentar['22aIVA']);
        $datosPresentar['22bIVA']=formateaNumeroContabilidad($datosPresentar['22bIVA']);
        $datosPresentar['22cIVA']=formateaNumeroContabilidad($datosPresentar['22cIVA']);
        $datosPresentar['22dIVA']=formateaNumeroContabilidad($datosPresentar['22dIVA']);
        $datosPresentar['22']=formateaNumeroContabilidad($datosPresentar['22']);
        $datosPresentar['23a']=formateaNumeroContabilidad($datosPresentar['23a']);
        $datosPresentar['23b']=formateaNumeroContabilidad($datosPresentar['23b']);
        $datosPresentar['23c']=formateaNumeroContabilidad($datosPresentar['23c']);
        $datosPresentar['23d']=formateaNumeroContabilidad($datosPresentar['23d']);
        $datosPresentar['23']=formateaNumeroContabilidad($datosPresentar['23']);
        $datosPresentar['38']=formateaNumeroContabilidad($datosPresentar['38']);
        $datosPresentar['41']=formateaNumeroContabilidad($datosPresentar['41']);
        $datosPresentar['48']=formateaNumeroContabilidad($datosPresentar['48']);
        
        //si todo a ido correctamente devuelvo los resultados 
        return $datosPresentar;
    }

    function ImpuestoIVA303($lngEjercicio,$cmdCierre){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //vamos a preparar los calculos del impuesto
        
        if($cmdCierre=='Cierre 1T' || $cmdCierre=='1T'){
            $fechaInicio='01/'.$lngEjercicio;
            $fechaFin='03/'.$lngEjercicio;
            $Periodo='1T';
            $mes1 = '01';
            $mes2 = '02';
            $mes3 = '03';
        }else if($cmdCierre=='Cierre 2T' || $cmdCierre=='2T'){
            $fechaInicio='04/'.$lngEjercicio;
            $fechaFin='06/'.$lngEjercicio;
            $Periodo='2T';
            $mes1 = '04';
            $mes2 = '05';
            $mes3 = '06';
        }else if($cmdCierre=='Cierre 3T' || $cmdCierre=='3T'){
            $fechaInicio='07/'.$lngEjercicio;
            $fechaFin='09/'.$lngEjercicio;
            $Periodo='3T';
            $mes1 = '07';
            $mes2 = '08';
            $mes3 = '09';
        }else if($cmdCierre=='Cierre 4T' || $cmdCierre=='4T'){
            $fechaInicio='10/'.$lngEjercicio;
            $fechaFin='12/'.$lngEjercicio;
            $Periodo='4T';
            $mes1 = '10';
            $mes2 = '11';
            $mes3 = '12';
        }
        
        
        //los datos los incluiremos en un array
        $datosPresentar=array(
            "01"=>'',
            "02"=>'',
            "03"=>'',
            "04"=>'',
            "05"=>'',
            "06"=>'',
            "07"=>'',
            "08"=>'',
            "09"=>'',
            "27"=>'',
            "28a"=>'',
            "28b"=>'',
            "28c"=>'',
            "28d"=>'',
            "28aIVA"=>'',
            "28bIVA"=>'',
            "28cIVA"=>'',
            "28dIVA"=>'',
            "28"=>'',
            "29a"=>'',
            "29b"=>'',
            "29c"=>'',
            "29d"=>'',
            "29"=>'',
            "46"=>'',
            "67"=>'',
            "71"=>'',
            "Ejercicio"=>$lngEjercicio,
            "Trimestre"=>$Periodo
        );
        
        //Extraemos de la tabla 'tbmovimientos_iva' el IVA Repercutido o Devengado 4770
        $strSQL =  "SELECT I.Iva,ROUND(SUM(I.BaseImponible),2) AS Base,ROUND(SUM(I.CuotaIVA),2) AS Cuota
                    FROM tbmovimientos_iva I,tbmovimientos M
                    WHERE I.IdAsiento=M.asiento
                    AND M.idCuenta LIKE '4770%'
                    AND M.Borrado=1
                    AND I.Borrado=1
                    AND DATE_FORMAT(M.fechaApunte,'%Y')='".$lngEjercicio."'
                    AND (DATE_FORMAT(M.fechaApunte,'%m')='".$mes1."'
                    OR DATE_FORMAT(M.fechaApunte,'%m')='".$mes2."'
                    OR DATE_FORMAT(M.fechaApunte,'%m')='".$mes3."')
                    GROUP BY I.Iva
                    ORDER BY I.Iva";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ImpuestoIVA303()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        $resultado=array();
        $idx=1;
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                if($row['Iva']<>'0'){
                    $resultado[$idx]=array(
                                "Iva"=>(float)$row['Iva'],
                                "Base"=>(float)$row['Base'],
                                "Cuota"=>(float)$row['Cuota']
                    );
                    $idx++;
                }
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ImpuestoIVA303() : Hay datos");
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ImpuestoIVA303()<FALSE");
            return false;
        }
        
        if(isset($resultado[1])){
            $datosPresentar['01']=$resultado[1]['Base'];
            $datosPresentar['02']=$resultado[1]['Iva'];
            $datosPresentar['03']=$resultado[1]['Cuota'];
        }else{
            $datosPresentar['01']='';
            $datosPresentar['02']='';
            $datosPresentar['03']='';
        }
        if(isset($resultado[2])){
            $datosPresentar['04']=$resultado[2]['Base'];
            $datosPresentar['05']=$resultado[2]['Iva'];
            $datosPresentar['06']=$resultado[2]['Cuota'];
        }else{
            $datosPresentar['04']='';
            $datosPresentar['05']='';
            $datosPresentar['06']='';
        }
        if(isset($resultado[3])){
            $datosPresentar['07']=$resultado[3]['Base'];
            $datosPresentar['08']=$resultado[3]['Iva'];
            $datosPresentar['09']=$resultado[3]["Cuota"];
        }else{
            $datosPresentar['07']='';
            $datosPresentar['08']='';
            $datosPresentar['09']='';
        }
        
        $datosPresentar["27"]=$datosPresentar['03']+$datosPresentar['06']+$datosPresentar['09'];
        
        //Extraemos de la tabla 'tbmovimientos_iva' el IVA Soportado o Deducible 4720
        $strSQL =  "SELECT I.Iva,ROUND(SUM(I.BaseImponible),2) AS Base,ROUND(SUM(I.CuotaIVA),2) AS Cuota
                    FROM tbmovimientos_iva I,tbmovimientos M
                    WHERE I.IdAsiento=M.asiento
                    AND M.idCuenta LIKE '4720%'
                    AND M.Borrado=1
                    AND I.Borrado=1
                    AND DATE_FORMAT(M.fechaApunte,'%Y')='".$lngEjercicio."'
                    AND (DATE_FORMAT(M.fechaApunte,'%m')='".$mes1."'
                    OR DATE_FORMAT(M.fechaApunte,'%m')='".$mes2."'
                    OR DATE_FORMAT(M.fechaApunte,'%m')='".$mes3."')
                    GROUP BY I.Iva
                    ORDER BY I.Iva";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ImpuestoIVA303()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        $resultado2=array();
        $idx=1;
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $resultado2[$idx]=array(
                            "Iva"=>(float)$row['Iva'],
                            "Base"=>(float)$row['Base'],
                            "Cuota"=>(float)$row['Cuota']
                );
                $idx++;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ImpuestoIVA303() : Hay datos");
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ImpuestoIVA303()<FALSE");
            return false;
        }
        
        //los datos estan dispuestos de esta forma
        // 28a  28aIVA  29a
        // 28b  28bIVA  29b
        // 28c  28cIVA  29c
        // 28d  28dIVA  29d
        // ================
        // 28           29
       
        //guardo los datos en el array
        if(isset($resultado2[1])){
            $datosPresentar['28a']=$resultado2[1]['Base'];
            $datosPresentar['28aIVA']=$resultado2[1]['Iva'];
            $datosPresentar['29a']=$resultado2[1]['Cuota'];
        }else{
            $datosPresentar['28a']='';
            $datosPresentar['28aIVA']='';
            $datosPresentar['29a']='';
        }
        if(isset($resultado2[2])){
            $datosPresentar['28b']=$resultado2[2]['Base'];
            $datosPresentar['28bIVA']=$resultado2[2]['Iva'];
            $datosPresentar['29b']=$resultado2[2]['Cuota'];
        }else{
            $datosPresentar['28b']='';
            $datosPresentar['28bIVA']='';
            $datosPresentar['29b']='';
        }
        if(isset($resultado2[3])){
            $datosPresentar['28c']=$resultado2[3]['Base'];
            $datosPresentar['28cIVA']=$resultado2[3]['Iva'];
            $datosPresentar['29c']=$resultado2[3]['Cuota'];
        }else{
            $datosPresentar['28c']='';
            $datosPresentar['28cIVA']='';
            $datosPresentar['29c']='';
        }
        if(isset($resultado2[4])){
            $datosPresentar['28d']=$resultado2[4]['Base'];
            $datosPresentar['28dIVA']=$resultado2[4]['Iva'];
            $datosPresentar['29d']=$resultado2[4]['Cuota'];
        }else{
            $datosPresentar['28d']='';
            $datosPresentar['28dIVA']='';
            $datosPresentar['29d']='';
        }
        
        $datosPresentar["28"]=$datosPresentar['28a']+$datosPresentar['28b']+$datosPresentar['28c']+$datosPresentar['28d'];
        $datosPresentar["29"]=$datosPresentar['29a']+$datosPresentar['29b']+$datosPresentar['29c']+$datosPresentar['29d'];
        
        $datosPresentar['46']=$datosPresentar['27']-$datosPresentar['29'];
        
        //La casilla 67 (Cuotas a compensar de periodos anteriores), este dato lo extraigo del último registro
        //de la tabla 'tbiva'
        //Extraemos de la tabla 'tbmovimientos_iva' el IVA Soportado o Deducible 4720
        $strSQL =  "SELECT A_Compensar FROM tbiva ORDER BY IdIva DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ImpuestoIVA303()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        $row=  mysql_fetch_array($stmt);
        
        $datosPresentar['67']=$row['A_Compensar'];
        
        $datosPresentar['71']=$datosPresentar['46']-$datosPresentar['67'];
        
        //Por último formateamos todos los número del array en forma de contabilidad
        $datosPresentar['01']=formateaNumeroContabilidad($datosPresentar['01']);
        $datosPresentar['02']=formateaNumeroContabilidad($datosPresentar['02']);
        $datosPresentar['03']=formateaNumeroContabilidad($datosPresentar['03']);
        $datosPresentar['04']=formateaNumeroContabilidad($datosPresentar['04']);
        $datosPresentar['05']=formateaNumeroContabilidad($datosPresentar['05']);
        $datosPresentar['06']=formateaNumeroContabilidad($datosPresentar['06']);
        $datosPresentar['07']=formateaNumeroContabilidad($datosPresentar['07']);
        $datosPresentar['08']=formateaNumeroContabilidad($datosPresentar['08']);
        $datosPresentar['09']=formateaNumeroContabilidad($datosPresentar['09']);
        $datosPresentar['27']=formateaNumeroContabilidad($datosPresentar['27']);
        $datosPresentar['28a']=formateaNumeroContabilidad($datosPresentar['28a']);
        $datosPresentar['28b']=formateaNumeroContabilidad($datosPresentar['28b']);
        $datosPresentar['28c']=formateaNumeroContabilidad($datosPresentar['28c']);
        $datosPresentar['28d']=formateaNumeroContabilidad($datosPresentar['28d']);
        $datosPresentar['28aIVA']=formateaNumeroContabilidad($datosPresentar['28aIVA']);
        $datosPresentar['28bIVA']=formateaNumeroContabilidad($datosPresentar['28bIVA']);
        $datosPresentar['28cIVA']=formateaNumeroContabilidad($datosPresentar['28cIVA']);
        $datosPresentar['28dIVA']=formateaNumeroContabilidad($datosPresentar['28dIVA']);
        $datosPresentar['28']=formateaNumeroContabilidad($datosPresentar['28']);
        $datosPresentar['29a']=formateaNumeroContabilidad($datosPresentar['29a']);
        $datosPresentar['29b']=formateaNumeroContabilidad($datosPresentar['29b']);
        $datosPresentar['29c']=formateaNumeroContabilidad($datosPresentar['29c']);
        $datosPresentar['29d']=formateaNumeroContabilidad($datosPresentar['29d']);
        $datosPresentar['29']=formateaNumeroContabilidad($datosPresentar['29']);
        $datosPresentar['46']=formateaNumeroContabilidad($datosPresentar['46']);
        $datosPresentar['67']=formateaNumeroContabilidad($datosPresentar['67']);
        $datosPresentar['71']=formateaNumeroContabilidad($datosPresentar['71']);
        
        //si todo a ido correctamente devuelvo los resultados 
        return $datosPresentar;
    }
    
    function periodo($lngPeriodo){
        if($lngPeriodo==='1'){
            $strPeriodo='ENERO';
        }else if($lngPeriodo==='2'){
            $strPeriodo='FEBRERO';
        }else if($lngPeriodo==='3'){
            $strPeriodo='MARZO';
        }else if($lngPeriodo==='4'){
            $strPeriodo='ABRIL';
        }else if($lngPeriodo==='5'){
            $strPeriodo='MAYO';
        }else if($lngPeriodo==='6'){
            $strPeriodo='JUNIO';
        }else if($lngPeriodo==='7'){
            $strPeriodo='JULIO';
        }else if($lngPeriodo==='8'){
            $strPeriodo='AGOSTO';
        }else if($lngPeriodo==='9'){
            $strPeriodo='SEPTIEMBRE';
        }else if($lngPeriodo==='10'){
            $strPeriodo='OCTUBRE';
        }else if($lngPeriodo==='11'){
            $strPeriodo='NOVIEMBRE';
        }else if($lngPeriodo==='12'){
            $strPeriodo='DICIEMBRE';
        }else{
            $strPeriodo='';
        }        

        return $strPeriodo;
    }
    
    private function averiguarTipoAsiento($asiento,$db){
        //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 6
        $strSQL =  "
                    SELECT TipoAsiento
                    FROM tbmovimientos
                    WHERE asiento=$asiento
                    AND Borrado=1    
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->averiguarTipoAsiento()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $row=  mysql_fetch_array($stmt);
            $result=$row['TipoAsiento'];
        }else{
            $result=false;
        }
        
        //devuelvo de resultado
        return $result;
    }
    
    
    //NO VALE     20-4-2015
    //ESTA ES LA NUEVA FUNCION CON TODOS LOS TIPOS Y TESTEADO             19-4-2015
    function DatosAsiento2($Asiento,$tipoAsiento,$esAbono){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //averiguo el tipo de asiento
        $IG=$this->averiguarTipoAsiento($Asiento, $db);

        //si es SF (00N y 00A)[Gasto]
        if($IG==='00N' || $IG==='00A'){
            
            
            
        }
        else
        //si es CFIVA1SIRPF (01N y 01A)[Gasto]
        if($IG==='01N' || $IG==='01A'){
            
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuentas 2 y 6 
            $strSQL =  "SELECT idCuenta,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '2%' OR idCuenta LIKE '6%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            //sale un listado con una o mas cuentas 7
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            $datos['cuentas']=$resultado;
            
            //ahora formateo todas las cantidades de las cuentas y hago la suma del total
            for ($i2 = 0; $i2 < count($datos['cuentas']); $i2++) {
                $datos['lngCantidad'] = (float)$datos['lngCantidad']+$datos['cuentas'][$i2]['cantidad'];
                //formateo la cantidad
                if($esAbono==='NO'){
                    $datos['cuentas'][$i2]['lngCantidadContabilidad'] = formateaNumeroContabilidad($datos['cuentas'][$i2]['cantidad']);
                }else{
                    $datos['cuentas'][$i2]['lngCantidadContabilidad'] = formateaNumeroContabilidad(-$datos['cuentas'][$i2]['cantidad']);
                }
                $datos['lngCantidadContabilidad'] = formateaNumeroContabilidad($datos['lngCantidad']);
                        
                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$datos['cuentas'][$i2]['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                if($stmt){
                    $row=  mysql_fetch_array($stmt);
                }

                $datos['cuentas'][$i2]['strCuenta']=$row['cuentas'];
            }
            $datos['lngEjercicio']=$resultado[0]['ejercicio'];
            $datos['lngPeriodo']=$resultado[0]['periodo'];
            $datos['strPeriodo']=$this->periodo($resultado[0]['periodo']);
            $datos['strConcepto']=$resultado[0]['concepto'];
            $datos['datFecha']=$resultado[0]['Fecha'];
            $datos['Borrado']=$resultado[0]['Borrado'];

            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 43
            //si es Normal DoH=H y si es Abono DoH=D
            if($IG==='11N'){
                $DoH='D';
            }else if($IG==='11A'){
                $DoH='H';
            }
            
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND DoH='$DoH'    
                        AND Borrado=1    
                        AND (idCuenta LIKE '43%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIngreso']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
            
            $datos['strCuentaCli']=$row['cuentas'];

            //ahora extraigo los datos de la cuenta IVA 
            //para sacar el lngPorcientoSin y lngIva vamos a la tabla 'tbmovimientos_iva'
            $strSQL =  "SELECT Iva,CuotaIVA
                        FROM tbmovimientos_iva
                        WHERE IdAsiento=$Asiento
                        AND Borrado=1";    
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            
            $datos['lngPorcientoSin']=$row['Iva'];
            $datos['lngIva']=$row['CuotaIVA'];
            if($esAbono==='NO'){
                $datos['lngIvaContabilidad']=  formateaNumeroContabilidad($row['CuotaIVA']);
            }else{
                $datos['lngIvaContabilidad']=  formateaNumeroContabilidad(-$row['CuotaIVA']);
            }
            
            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;
                
                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];

            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }
            
            
        }

        
        
        $db->desconectar ();
        
        
        //devuelvo los datos
        return $datos;
    }
    
    
    function DatosAsiento($Asiento,$tipoAsiento,$esAbono){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        
        //array donde guardo los datos
        $datos="";
        //averiguo si es gasto o ingreso
        $IG=$this->averiguarTipoAsiento($Asiento, $db);
        
        
        //segun el tipoAsiento 
        //Sin Factura
//        if($tipoAsiento==='SF'){
            
        //si es SF (00N y 00A)[Gasto]
        if($IG==='00N' || $IG==='00A'){
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
            $strSQL =  "SELECT idCuenta,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '2%' OR idCuenta LIKE '6%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIngreso']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            $datos['lngEjercicio']=$row['ejercicio'];
            $datos['lngPeriodo']=$row['periodo'];
            $datos['strPeriodo']=$this->periodo($row['periodo']);
            $datos['strConcepto']=$row['concepto'];
            $datos['datFecha']=$row['Fecha'];
            $datos['Borrado']=$row['Borrado'];

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }

            $datos['strCuenta']=$row['cuentas'];

            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
            //si es SF (00N y 00A)[Gasto]
            //si es Normal DoH=H y si es Abono DoH=D
            if($IG==='00N'){
                $DoH='H';
            }else if($IG==='00A'){
                $DoH='D';
            }

            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND DoH='$DoH'    
                        AND (idCuenta LIKE '40%' OR idCuenta LIKE '41%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngCantidad']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngCantidadContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngCantidadContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }

            $datos['strCuentaCli']=$row['cuentas'];

            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;

                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];

            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }

            $db->desconectar ();

            //devuelvo los datos
            return $datos;
        }
        else
            
        //si es CFIVA1SIRPF (01N y 01A)[Gasto]
        if($IG==='01N' || $IG==='01A'){
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
            $strSQL =  "SELECT idCuenta,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '2%' OR idCuenta LIKE '6%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            
            $datos['lngCantidad']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngCantidadContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngCantidadContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            $datos['lngEjercicio']=$row['ejercicio'];
            $datos['lngPeriodo']=$row['periodo'];
            $datos['strPeriodo']=$this->periodo($row['periodo']);
            $datos['strConcepto']=$row['concepto'];
            $datos['datFecha']=$row['Fecha'];
            $datos['Borrado']=$row['Borrado'];
            
            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
            
            $datos['strCuenta']=$row['cuentas'];
            
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 40 o 41
            //si es Normal DoH=H y si es Abono DoH=D
            if($IG==='01N'){
                $DoH='H';
            }else if($IG==='01A'){
                $DoH='D';
            }
            
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND DoH='$DoH'    
                        AND Borrado=1    
                        AND (idCuenta LIKE '40%' OR idCuenta LIKE '41%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIngreso']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
            
            $datos['strCuentaCli']=$row['cuentas'];

            //ahora extraigo los datos de la cuenta IVA 
            //para sacar el lngPorcientoSin y lngIva vamos a la tabla 'tbmovimientos_iva'
            $strSQL =  "SELECT Iva,CuotaIVA
                        FROM tbmovimientos_iva
                        WHERE IdAsiento=$Asiento
                        AND Borrado=1";    
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            
            $datos['lngPorcientoSin']=$row['Iva'];
            $datos['lngIva'] = abs($row['CuotaIVA']);
            if($esAbono==='NO'){
                $datos['lngIvaContabilidad']=  formateaNumeroContabilidad($datos['lngIva']);
            }else{
                $datos['lngIvaContabilidad']=  formateaNumeroContabilidad(-$datos['lngIva']);
            }
            
            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;
                
                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];

            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }
            
            $db->desconectar ();

            //devuelvo los datos
            return $datos;
        }
        
        else
        //si es CFIVA1CIRPF (02N y 02A)[Gasto]
        if($IG==='02N' || $IG==='02A'){
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 6
            $strSQL =  "SELECT idCuenta,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '2%' OR idCuenta LIKE '6%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngCantidad1']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngCantidadContabilidad1']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngCantidadContabilidad1']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            $datos['lngEjercicio']=$row['ejercicio'];
            $datos['lngPeriodo']=$row['periodo'];
            $datos['strPeriodo']=$this->periodo($row['periodo']);
            $datos['strConcepto']=$row['concepto'];
            $datos['datFecha']=$row['Fecha'];
            $datos['Borrado']=$row['Borrado'];

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }

            $datos['strCuenta']=$row['cuentas'];

            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 40 o 41
            //si es Normal DoH=H y si es Abono DoH=D
            if($IG==='02N'){
                $DoH='H';
            }else if($IG==='02A'){
                $DoH='D';
            }

            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND DoH='$DoH'    
                        AND Borrado=1    
                        AND (idCuenta LIKE '40%' OR idCuenta LIKE '41%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIngreso']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngTotalContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngTotalContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
               $row=  mysql_fetch_array($stmt);
            }
            $datos['strCuentaCli']=$row['cuentas'];

            //ahora extraigo los datos de la cuenta IVA 
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '4720%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIva1']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIvaContabilidad1']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIvaContabilidad1']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //para sacar el lngPorciento1 vamos a la tabla 'tbmovimientos_iva'
            $strSQL =  "SELECT Iva
                        FROM tbmovimientos_iva
                        WHERE IdAsiento=$Asiento
                        AND Borrado=1";    
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngPorciento1']=$row['Iva'];

            //ahora extraigo los datos de la cuenta IRPF 
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '4751%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIRPF']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIRPFContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIRPFContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            $datos['lngPorcientoIRPF']=round($datos['lngIRPF']/$datos['lngCantidad1']*100,0);

            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;

                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];

            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }

            $db->desconectar ();

            //devuelvo los datos
            return $datos;
        }
        
        else
        //si es CFIVAV (03N y 03A)[Gasto]
        if($IG==='03N' || $IG==='03A'){
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
            $strSQL =  "SELECT idCuenta,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '2%' OR idCuenta LIKE '6%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            
            $datos['lngCantidadTotal']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngCantidadContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngCantidadContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            $datos['lngEjercicio']=$row['ejercicio'];
            $datos['lngPeriodo']=$row['periodo'];
            $datos['strPeriodo']=$this->periodo($row['periodo']);
            $datos['strConcepto']=$row['concepto'];
            $datos['datFecha']=$row['Fecha'];
            $datos['Borrado']=$row['Borrado'];
            
            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
            
            $datos['strCuenta']=$row['cuentas'];
            
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 40 o 41
            //si es Normal DoH=H y si es Abono DoH=D
            if($IG==='03N'){
                $DoH='H';
            }else if($IG==='03A'){
                $DoH='D';
            }
            
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND DoH='$DoH'    
                        AND Borrado=1    
                        AND (idCuenta LIKE '40%' OR idCuenta LIKE '41%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['Total']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['ContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['ContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
            
            $datos['strCuentaCli']=$row['cuentas'];
            
            //ahora extraigo los datos de la cuenta IVA
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '4720%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIvaTotal']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIvaContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIvaContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            
            //para sacar el lngPorciento1 vamos a la tabla 'tbmovimientos_iva'
            $strSQL =  "SELECT BaseImponible,Iva,CuotaIVA
                        FROM tbmovimientos_iva
                        WHERE IdAsiento=$Asiento
                        AND Borrado=1";    
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $num=1;
            while($row=  mysql_fetch_array($stmt)){
                if($esAbono==='NO'){
                    $datos['lngCantidad'.$num]=$row['BaseImponible'];
                    $datos['lngCantidadContabilidad'.$num]=  formateaNumeroContabilidad($row['BaseImponible']);
                    $datos['lngPorciento'.$num]=$row['Iva'];
                    $datos['lngIva'.$num]=$row['CuotaIVA'];
                    $datos['lngIvaContabilidad'.$num]=  formateaNumeroContabilidad($row['CuotaIVA']);
                }else{
                    $datos['lngCantidad'.$num]=-$row['BaseImponible'];
                    $datos['lngCantidadContabilidad'.$num]=  formateaNumeroContabilidad($row['BaseImponible']);
                    $datos['lngPorciento'.$num]=$row['Iva'];
                    $datos['lngIva'.$num]=-$row['CuotaIVA'];
                    $datos['lngIvaContabilidad'.$num]=  formateaNumeroContabilidad($row['CuotaIVA']);
                }
                $num++;
            }
            
            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;
                
                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];

            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }
        
            $db->desconectar ();

            //devuelvo los datos
            return $datos;
        }
        
        else
        //si es CFIVAVCIRPF (04N y 04A)[Gasto]
        if($IG==='04N' || $IG==='04A'){
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
            $strSQL =  "SELECT idCuenta,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '2%' OR idCuenta LIKE '6%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            
            $datos['lngCantidadTotal']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngCantidadContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngCantidadContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            $datos['lngEjercicio']=$row['ejercicio'];
            $datos['lngPeriodo']=$row['periodo'];
            $datos['strPeriodo']=$this->periodo($row['periodo']);
            $datos['strConcepto']=$row['concepto'];
            $datos['datFecha']=$row['Fecha'];
            $datos['Borrado']=$row['Borrado'];
            
            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
        
            $datos['strCuenta']=$row['cuentas'];
            
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 40 o 41
            //si es Normal DoH=H y si es Abono DoH=D
            if($IG==='04N'){
                $DoH='H';
            }else if($IG==='04A'){
                $DoH='D';
            }
            
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND DoH='$DoH'    
                        AND Borrado=1    
                        AND (idCuenta LIKE '40%' OR idCuenta LIKE '41%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['Total']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['ContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['ContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
            
            $datos['strCuentaCli']=$row['cuentas'];
            
            //ahora extraigo los datos de la cuenta IVA
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '4720%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIvaTotal']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIvaContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIvaContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            
            //para sacar el lngPorciento1 vamos a la tabla 'tbmovimientos_iva'
            $strSQL =  "SELECT BaseImponible,Iva,CuotaIVA
                        FROM tbmovimientos_iva
                        WHERE IdAsiento=$Asiento
                        AND Borrado=1";    
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $num=1;
            while($row=  mysql_fetch_array($stmt)){
                if($esAbono==='NO'){
                    $datos['lngCantidad'.$num]=$row['BaseImponible'];
                    $datos['lngCantidadContabilidad'.$num]=  formateaNumeroContabilidad($row['BaseImponible']);
                    $datos['lngPorciento'.$num]=$row['Iva'];
                    $datos['lngIva'.$num]=$row['CuotaIVA'];
                    $datos['lngIvaContabilidad'.$num]=  formateaNumeroContabilidad($row['CuotaIVA']);
                }else{
                    $datos['lngCantidad'.$num]=-$row['BaseImponible'];
                    $datos['lngCantidadContabilidad'.$num]=  formateaNumeroContabilidad($row['BaseImponible']);
                    $datos['lngPorciento'.$num]=$row['Iva'];
                    $datos['lngIva'.$num]=-$row['CuotaIVA'];
                    $datos['lngIvaContabilidad'.$num]=  formateaNumeroContabilidad($row['CuotaIVA']);
                }
                $num++;
            }
            
            //ahora extraigo los datos de la cuenta IRPF 
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '4751%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIRPF']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIRPFContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIRPFContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            
            $datos['lngPorcientoIRPF']=round($datos['lngIRPF']/$datos['lngCantidadTotal']*100,0);
            
            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;
                
                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];

            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }
        
        
            $db->desconectar ();

            //devuelvo los datos
            return $datos;
        }

        //si es SF (10N y 10A)[Ingreso]
        else
        if($IG==='10N' || $IG==='10A'){
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
            $strSQL =  "SELECT idCuenta,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '7%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIngreso']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            $datos['lngEjercicio']=$row['ejercicio'];
            $datos['lngPeriodo']=$row['periodo'];
            $datos['strPeriodo']=$this->periodo($row['periodo']);
            $datos['strConcepto']=$row['concepto'];
            $datos['datFecha']=$row['Fecha'];
            $datos['Borrado']=$row['Borrado'];

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }

            $datos['strCuenta']=$row['cuentas'];

            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
            //si es Normal DoH=D y si es Abono DoH=H
            if($IG==='10N'){
                $DoH='D';
            }else if($IG==='10A'){
                $DoH='H';
            }

            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND DoH='$DoH'    
                        AND (idCuenta LIKE '43%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngCantidad']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngCantidadContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngCantidadContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }

            $datos['strCuentaCli']=$row['cuentas'];

            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;

                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];

            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }
            
            
            $db->desconectar ();

            //devuelvo los datos
            return $datos;
        }
        
        else
        //si es CFIVA1SIRPF (11N y 11A)[Ingreso]
        if($IG==='11N' || $IG==='11A'){
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
            $strSQL =  "SELECT idCuenta,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '7%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngCantidad']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngCantidadContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngCantidadContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            $datos['lngEjercicio']=$row['ejercicio'];
            $datos['lngPeriodo']=$row['periodo'];
            $datos['strPeriodo']=$this->periodo($row['periodo']);
            $datos['strConcepto']=$row['concepto'];
            $datos['datFecha']=$row['Fecha'];
            $datos['Borrado']=$row['Borrado'];

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }

            $datos['strCuenta']=$row['cuentas'];

            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 43
            //si es Normal DoH=H y si es Abono DoH=D
            if($IG==='11N'){
                $DoH='D';
            }else if($IG==='11A'){
                $DoH='H';
            }

            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND DoH='$DoH'    
                        AND Borrado=1    
                        AND (idCuenta LIKE '43%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIngreso']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }

            $datos['strCuentaCli']=$row['cuentas'];

            //ahora extraigo los datos de la cuenta IVA 
            //para sacar el lngPorcientoSin y lngIva vamos a la tabla 'tbmovimientos_iva'
            $strSQL =  "SELECT Iva,CuotaIVA
                        FROM tbmovimientos_iva
                        WHERE IdAsiento=$Asiento
                        AND Borrado=1";    
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngPorcientoSin']=$row['Iva'];
            $datos['lngIva'] = abs($row['CuotaIVA']);
            if($esAbono==='NO'){
                $datos['lngIvaContabilidad']=  formateaNumeroContabilidad($datos['lngIva']);
            }else{
                $datos['lngIvaContabilidad']=  formateaNumeroContabilidad(-$datos['lngIva']);
            }

            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;

                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];

            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }

        
            $db->desconectar ();

            //devuelvo los datos
            return $datos;
        }

        else
        //si es CFIVA1CIRPF (12N y 12A)[Ingreso]
        if($IG==='12N' || $IG==='12A'){
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 6
            $strSQL =  "SELECT idCuenta,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '7%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngCantidad1']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngCantidadContabilidad1']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngCantidadContabilidad1']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            $datos['lngEjercicio']=$row['ejercicio'];
            $datos['lngPeriodo']=$row['periodo'];
            $datos['strPeriodo']=$this->periodo($row['periodo']);
            $datos['strConcepto']=$row['concepto'];
            $datos['datFecha']=$row['Fecha'];
            $datos['Borrado']=$row['Borrado'];

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }

            $datos['strCuenta']=$row['cuentas'];

            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 43
            if($IG==='12N'){
                $DoH='D';
            }else if($IG==='12A'){
                $DoH='H';
            }

            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND DoH='$DoH'    
                        AND Borrado=1    
                        AND (idCuenta LIKE '43%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIngreso']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngTotalContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngTotalContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
               $row=  mysql_fetch_array($stmt);
            }
            $datos['strCuentaCli']=$row['cuentas'];

            //ahora extraigo los datos de la cuenta IVA 
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1
                        AND idCuenta LIKE '4770%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIva1']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIvaContabilidad1']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIvaContabilidad1']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //para sacar el lngPorciento1 vamos a la tabla 'tbmovimientos_iva'
            $strSQL =  "SELECT Iva
                        FROM tbmovimientos_iva
                        WHERE IdAsiento=$Asiento
                        AND Borrado=1";    
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngPorciento1']=$row['Iva'];

            //ahora extraigo los datos de la cuenta IRPF 
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '4730%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIRPF']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIRPFContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIRPFContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            $datos['lngPorcientoIRPF']=round($datos['lngIRPF']/$datos['lngCantidad1']*100,0);

            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;

                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];

            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }
        
        
            $db->desconectar ();

            //devuelvo los datos
            return $datos;
        }
        
        else
        //si es CFIVAV (13N y 13A)[Ingreso]
        if($IG==='13N' || $IG==='13A'){
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
            $strSQL =  "SELECT idCuenta,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '7%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            
            $datos['lngCantidadTotal']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngCantidadContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngCantidadContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            $datos['lngEjercicio']=$row['ejercicio'];
            $datos['lngPeriodo']=$row['periodo'];
            $datos['strPeriodo']=$this->periodo($row['periodo']);
            $datos['strConcepto']=$row['concepto'];
            $datos['datFecha']=$row['Fecha'];
            $datos['Borrado']=$row['Borrado'];
            
            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
            
            $datos['strCuenta']=$row['cuentas'];
            
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 43
            if($IG==='13N'){
                $DoH='D';
            }else if($IG==='13A'){
                $DoH='H';
            }
            
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND DoH='$DoH'    
                        AND Borrado=1    
                        AND (idCuenta LIKE '43%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['Total']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['ContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['ContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
            
            $datos['strCuentaCli']=$row['cuentas'];
            
            //ahora extraigo los datos de la cuenta IVA
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '4770%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIvaTotal']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIvaContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIvaContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            
            //para sacar el lngPorciento1 vamos a la tabla 'tbmovimientos_iva'
            $strSQL =  "SELECT BaseImponible,Iva,CuotaIVA
                        FROM tbmovimientos_iva
                        WHERE IdAsiento=$Asiento
                        AND Borrado=1";    
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $num=1;
            while($row=  mysql_fetch_array($stmt)){
                if($esAbono==='NO'){
                    $datos['lngCantidad'.$num]=$row['BaseImponible'];
                    $datos['lngCantidadContabilidad'.$num]=  formateaNumeroContabilidad($row['BaseImponible']);
                    $datos['lngPorciento'.$num]=$row['Iva'];
                    $datos['lngIva'.$num]=$row['CuotaIVA'];
                    $datos['lngIvaContabilidad'.$num]=  formateaNumeroContabilidad($row['CuotaIVA']);
                }else{
                    $datos['lngCantidad'.$num]=-$row['BaseImponible'];
                    $datos['lngCantidadContabilidad'.$num]=  formateaNumeroContabilidad($row['BaseImponible']);
                    $datos['lngPorciento'.$num]=$row['Iva'];
                    $datos['lngIva'.$num]=-$row['CuotaIVA'];
                    $datos['lngIvaContabilidad'.$num]=  formateaNumeroContabilidad($row['CuotaIVA']);
                }
                $num++;
            }
            
            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;
                
                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];

            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }
        
        
            $db->desconectar ();

            //devuelvo los datos
            return $datos;
        }
        
        else
        //si es CFIVAVCIRPF (14N y 14A)[Ingreso]
        if($IG==='14N' || $IG==='14A'){
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
            $strSQL =  "SELECT idCuenta,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '7%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            
            $datos['lngCantidadTotal']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngCantidadContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngCantidadContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            $datos['lngEjercicio']=$row['ejercicio'];
            $datos['lngPeriodo']=$row['periodo'];
            $datos['strPeriodo']=$this->periodo($row['periodo']);
            $datos['strConcepto']=$row['concepto'];
            $datos['datFecha']=$row['Fecha'];
            $datos['Borrado']=$row['Borrado'];
            
            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
        
            $datos['strCuenta']=$row['cuentas'];
            
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 43
            if($IG==='14N'){
                $DoH='D';
            }else if($IG==='14A'){
                $DoH='H';
            }
            
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND DoH='$DoH'    
                        AND Borrado=1    
                        AND (idCuenta LIKE '43%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['Total']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['ContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['ContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
            
            $datos['strCuentaCli']=$row['cuentas'];
            
            //ahora extraigo los datos de la cuenta IVA
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '4770%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIvaTotal']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIvaContabilidadTotal']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIvaContabilidadTotal']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            
            //para sacar el lngPorciento1 vamos a la tabla 'tbmovimientos_iva'
            $strSQL =  "SELECT BaseImponible,Iva,CuotaIVA
                        FROM tbmovimientos_iva
                        WHERE IdAsiento=$Asiento
                        AND Borrado=1";    
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $num=1;
            while($row=  mysql_fetch_array($stmt)){
                if($esAbono==='NO'){
                    $datos['lngCantidad'.$num]=$row['BaseImponible'];
                    $datos['lngCantidadContabilidad'.$num]=  formateaNumeroContabilidad($row['BaseImponible']);
                    $datos['lngPorciento'.$num]=$row['Iva'];
                    $datos['lngIva'.$num]=$row['CuotaIVA'];
                    $datos['lngIvaContabilidad'.$num]=  formateaNumeroContabilidad($row['CuotaIVA']);
                }else{
                    $datos['lngCantidad'.$num]=-$row['BaseImponible'];
                    $datos['lngCantidadContabilidad'.$num]=  formateaNumeroContabilidad($row['BaseImponible']);
                    $datos['lngPorciento'.$num]=$row['Iva'];
                    $datos['lngIva'.$num]=-$row['CuotaIVA'];
                    $datos['lngIvaContabilidad'.$num]=  formateaNumeroContabilidad($row['CuotaIVA']);
                }
                $num++;
            }
            
            //ahora extraigo los datos de la cuenta IRPF 
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '4730%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIRPF']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIRPFContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIRPFContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }
            
            $datos['lngPorcientoIRPF']=round($datos['lngIRPF']/$datos['lngCantidadTotal']*100,0);
            
            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;
                
                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];

            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }
        
        
            $db->desconectar ();

            //devuelvo los datos
            return $datos;
        }
        
        else
        //si es CFIVA1SIRPFVC 15x, 16x, 17x y 18x [Ingreso]
        if($IG==='15N' || $IG==='15N2' || $IG==='16N' || $IG==='16N2'
           || $IG==='17N' || $IG==='17N2' || $IG==='18N' || $IG==='18N2'
           || $IG==='15A' || $IG==='15A2' || $IG==='16A' || $IG==='16A2'
           || $IG==='17A' || $IG==='17A2' || $IG==='18A' || $IG==='18A2'     ){
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 7
            $strSQL =  "SELECT IdMovimiento,idCuenta,cantidad,saldo AS cuota,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND (idCuenta LIKE '7%')";
                
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            //sale un listado con una o mas cuentas 7
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=trim($valor);
                    }
                }
                $resultado[]=$reg;
            }
            $datos['cuentas']=$resultado;
            
            //ahora formateo todas las cantidades de las cuentas y hago la suma del total
            for ($i2 = 0; $i2 < count($datos['cuentas']); $i2++) {
                $datos['lngCantidad'] = (float)$datos['lngCantidad']+$datos['cuentas'][$i2]['cantidad'];
                $datos['lngIva'] = (float)$datos['lngIva']+$datos['cuentas'][$i2]['cuota'];
                //formateo la cantidad y cuota
                if($esAbono==='NO'){
                    $datos['cuentas'][$i2]['lngCantidadContabilidad'] = formateaNumeroContabilidad($datos['cuentas'][$i2]['cantidad']);
                    $datos['cuentas'][$i2]['lngIvaContabilidad'] = formateaNumeroContabilidad($datos['cuentas'][$i2]['cuota']);
                    $datos['lngCantidadContabilidad'] = formateaNumeroContabilidad($datos['lngCantidad']);
                    $datos['lngIvaContabilidad'] = formateaNumeroContabilidad($datos['lngIva']);
                }else{
                    $datos['cuentas'][$i2]['lngCantidadContabilidad'] = formateaNumeroContabilidad(-$datos['cuentas'][$i2]['cantidad']);
                    $datos['cuentas'][$i2]['lngIvaContabilidad'] = formateaNumeroContabilidad(-$datos['cuentas'][$i2]['cuota']);
                    $datos['lngCantidadContabilidad'] = formateaNumeroContabilidad(-$datos['lngCantidad']);
                    $datos['lngIvaContabilidad'] = formateaNumeroContabilidad(-$datos['lngIva']);
                }
                        
                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$datos['cuentas'][$i2]['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                if($stmt){
                    $row=  mysql_fetch_array($stmt);
                }

                $datos['cuentas'][$i2]['strCuenta']=$row['cuentas'];
            }
            $datos['lngEjercicio']=$resultado[0]['ejercicio'];
            $datos['lngPeriodo']=$resultado[0]['periodo'];
            $datos['strPeriodo']=$this->periodo($resultado[0]['periodo']);
            $datos['strConcepto']=$resultado[0]['concepto'];
            $datos['datFecha']=$resultado[0]['Fecha'];
            $datos['Borrado']=$resultado[0]['Borrado'];
            
            
            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 43
            if($IG==='15N' || $IG==='15N2' || $IG==='16N' || $IG==='16N2'
               || $IG==='17N' || $IG==='17N2' || $IG==='18N' || $IG==='18N2'){
                $DoH='D';
            }else 
            if($IG==='15A' || $IG==='15A2' || $IG==='16A' || $IG==='16A2'
               || $IG==='17A' || $IG==='17A2' || $IG==='18A' || $IG==='18A2'){
                $DoH='H';
            }
            
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND DoH='$DoH'    
                        AND Borrado=1    
                        AND (idCuenta LIKE '43%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIngreso']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
            }

            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                        FROM tbcuenta
                        WHERE NumCuenta=".$row['idCuenta'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
            }
            
            $datos['strCuentaCli']=$row['cuentas'];

            //ahora extraigo los datos de la cuenta IRPF 4730 (si hubiere) 
            if($IG==='15N' || $IG==='15N2' || $IG==='16N' || $IG==='16N2'
               || $IG==='17N' || $IG==='17N2' || $IG==='18N' || $IG==='18N2'){
                $DoH='D';
            }else 
            if($IG==='15A' || $IG==='15A2' || $IG==='16A' || $IG==='16A2'
               || $IG==='17A' || $IG==='17A2' || $IG==='18A' || $IG==='18A2'){
                $DoH='H';
            }
            
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND DoH='$DoH'    
                        AND Borrado=1    
                        AND (idCuenta LIKE '4730%')";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);

            $datos['lngIngreso']=$row['cantidad'];
            if($esAbono==='NO'){
                $datos['lngIRPFContabilidad'] = formateaNumeroContabilidad($row['cantidad']);
            }else{
                $datos['lngIRPFContabilidad'] = formateaNumeroContabilidad(-$row['cantidad']);
            }
            //% IRPF
            $datos['lngPorcientoIRPF'] = round($row['cantidad'] / $datos['lngCantidad'] * 100,0);
            
            
            //por ultimo extraigo los datos del banco 57 si hubiere
            $strSQL =  "SELECT idCuenta,cantidad
                        FROM tbmovimientos
                        WHERE asiento=$Asiento
                        AND Borrado=1    
                        AND idCuenta LIKE '57%'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $row=  mysql_fetch_array($stmt);
            if($row==true){
                $datos['optTipo']=1;
                
                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
                            FROM tbcuenta
                            WHERE NumCuenta=".$row['idCuenta'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
                $stmt = $db->ejecutar ( $strSQL );
                $row=  mysql_fetch_array($stmt);

                $datos['strCuentaBancos']=$row['cuentas'];
            }
            //no hay banco
            else{
                $datos['optTipo']=0;
            }

            //tipo de asiento
            $datos['TipoAsiento'] = $IG;
            
            $db->desconectar ();

            //devuelvo los datos
            return $datos;
        }
//        else
//        //si es CFIVA1SIRPFVC 15x, 16x, 17x y 18x [Ingreso]
//        if($IG==='15A' || $IG==='15A2' || $IG==='16A' || $IG==='16A2'
//           || $IG==='17A' || $IG==='17A2' || $IG==='18A' || $IG==='18A2'){
//            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 7
//            $strSQL =  "SELECT idCuenta,cantidad,saldo AS cuota,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
//                        FROM tbmovimientos
//                        WHERE asiento=$Asiento
//                        AND Borrado=1    
//                        AND (idCuenta LIKE '7%')";
//                
//            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
//            $stmt = $db->ejecutar ( $strSQL );
//            
//            //sale un listado con una o mas cuentas 7
//            while($row=mysql_fetch_array($stmt)){
//                $reg='';
//                foreach($row as $propiedad=>$valor){
//                    if(!is_numeric($propiedad)){
//                        $reg[$propiedad]=trim($valor);
//                    }
//                }
//                $resultado[]=$reg;
//            }
//            $datos['cuentas']=$resultado;
//            
//            //ahora formateo todas las cantidades de las cuentas y hago la suma del total
//            for ($i2 = 0; $i2 < count($datos['cuentas']); $i2++) {
//                $datos['lngCantidad'] = (float)$datos['lngCantidad']+$datos['cuentas'][$i2]['cantidad'];
//                $datos['lngIva'] = (float)$datos['lngIva']+$datos['cuentas'][$i2]['cuota'];
//                //formateo la cantidad y cuota
//                if($esAbono==='NO'){
//                    $datos['cuentas'][$i2]['lngCantidadContabilidad'] = formateaNumeroContabilidad($datos['cuentas'][$i2]['cantidad']);
//                    $datos['cuentas'][$i2]['lngIvaContabilidad'] = formateaNumeroContabilidad($datos['cuentas'][$i2]['cuota']);
//                }else{
//                    $datos['cuentas'][$i2]['lngCantidadContabilidad'] = formateaNumeroContabilidad(-$datos['cuentas'][$i2]['cantidad']);
//                    $datos['cuentas'][$i2]['lngIvaContabilidad'] = formateaNumeroContabilidad(-$datos['cuentas'][$i2]['cuota']);
//                }
//                $datos['lngCantidadContabilidad'] = formateaNumeroContabilidad($datos['lngCantidad']);
//                $datos['lngIvaContabilidad'] = formateaNumeroContabilidad($datos['lngIva']);
//                        
//                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
//                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
//                            FROM tbcuenta
//                            WHERE NumCuenta=".$datos['cuentas'][$i2]['idCuenta'];
//                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
//                $stmt = $db->ejecutar ( $strSQL );
//                if($stmt){
//                    $row=  mysql_fetch_array($stmt);
//                }
//
//                $datos['cuentas'][$i2]['strCuenta']=$row['cuentas'];
//            }
//            $datos['lngEjercicio']=$resultado[0]['ejercicio'];
//            $datos['lngPeriodo']=$resultado[0]['periodo'];
//            $datos['strPeriodo']=$this->periodo($resultado[0]['periodo']);
//            $datos['strConcepto']=$resultado[0]['concepto'];
//            $datos['datFecha']=$resultado[0]['Fecha'];
//            $datos['Borrado']=$resultado[0]['Borrado'];
//            
//            
//            //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta 43
//            if($IG==='15N' || $IG==='15N2' || $IG==='16N' || $IG==='16N2'
//               || $IG==='17N' || $IG==='17N2' || $IG==='18N' || $IG==='18N2'){
//                $DoH='D';
//            }else 
//            if($IG==='15A' || $IG==='15A2' || $IG==='16A' || $IG==='16A2'
//               || $IG==='17A' || $IG==='17A2' || $IG==='18A' || $IG==='18A2'){
//                $DoH='H';
//            }
//            
//            $strSQL =  "SELECT idCuenta,cantidad
//                        FROM tbmovimientos
//                        WHERE asiento=$Asiento
//                        AND DoH='$DoH'    
//                        AND Borrado=1    
//                        AND (idCuenta LIKE '43%')";
//            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
//            $stmt = $db->ejecutar ( $strSQL );
//            $row=  mysql_fetch_array($stmt);
//
//            $datos['lngIngreso']=$row['cantidad'];
//            if($esAbono==='NO'){
//                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad($row['cantidad']);
//            }else{
//                $datos['lngIngresoContabilidad']=  formateaNumeroContabilidad(-$row['cantidad']);
//            }
//
//            //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
//            $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
//                        FROM tbcuenta
//                        WHERE NumCuenta=".$row['idCuenta'];
//            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
//            $stmt = $db->ejecutar ( $strSQL );
//            if($stmt){
//                $row=  mysql_fetch_array($stmt);
//            }
//            
//            $datos['strCuentaCli']=$row['cuentas'];
//
//            //ahora extraigo los datos de la cuenta IRPF 4730 (si hubiere) 
//            if($IG==='15N' || $IG==='15N2' || $IG==='16N' || $IG==='16N2'
//               || $IG==='17N' || $IG==='17N2' || $IG==='18N' || $IG==='18N2'){
//                $DoH='D';
//            }else 
//            if($IG==='15A' || $IG==='15A2' || $IG==='16A' || $IG==='16A2'
//               || $IG==='17A' || $IG==='17A2' || $IG==='18A' || $IG==='18A2'){
//                $DoH='H';
//            }
//            
//            $strSQL =  "SELECT idCuenta,cantidad
//                        FROM tbmovimientos
//                        WHERE asiento=$Asiento
//                        AND DoH='$DoH'    
//                        AND Borrado=1    
//                        AND (idCuenta LIKE '4730%')";
//            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
//            $stmt = $db->ejecutar ( $strSQL );
//            $row=  mysql_fetch_array($stmt);
//
//            $datos['lngIngreso']=$row['cantidad'];
//            if($esAbono==='NO'){
//                $datos['lngIRPFContabilidad'] = formateaNumeroContabilidad($row['cantidad']);
//            }else{
//                $datos['lngIRPFContabilidad'] = formateaNumeroContabilidad(-$row['cantidad']);
//            }
//            //% IRPF
//            $datos['lngPorcientoIRPF'] = round($row['cantidad'] / $datos['lngCantidad'] * 100,0);
//            
//            
//            //por ultimo extraigo los datos del banco 57 si hubiere
//            $strSQL =  "SELECT idCuenta,cantidad
//                        FROM tbmovimientos
//                        WHERE asiento=$Asiento
//                        AND Borrado=1    
//                        AND idCuenta LIKE '57%'";
//            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                    " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
//            $stmt = $db->ejecutar ( $strSQL );
//            $row=  mysql_fetch_array($stmt);
//            if($row==true){
//                $datos['optTipo']=1;
//                
//                //ahora extraigo el nombre que se presenta en el campo (NumCuenta + Nombre de la tabla 'tbcuenta')
//                $strSQL =  "SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuentas
//                            FROM tbcuenta
//                            WHERE NumCuenta=".$row['idCuenta'];
//                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                        " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);
//                $stmt = $db->ejecutar ( $strSQL );
//                $row=  mysql_fetch_array($stmt);
//
//                $datos['strCuentaBancos']=$row['cuentas'];
//            }
//            //no hay banco
//            else{
//                $datos['optTipo']=0;
//            }
//
//            //tipo de asiento
//            $datos['TipoAsiento'] = $IG;
//            
//            $db->desconectar ();
//
//            //devuelvo los datos
//            return $datos;
//        }
        
    }
    
    function DarAltaBajaAsiento($Asiento,$opcion){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        if($opcion==='Baja'){
            $opt=0;
        }else{
            $opt=1;
        }
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaAsiento($Asiento) || START TRANSACTION");
        
        
        //primero se suman o restan los datos de este asiento de la tabla de acumulados
        $strSQL =  "SELECT ejercicio, periodo,idCuenta,DoH,cantidad
                    FROM tbmovimientos
                    WHERE asiento=$Asiento
                    AND Borrado=1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaAsiento($Asiento)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        //guardo estos datos en un array
        $asientoBorrar='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $asientoBorrar[]=array(
                    'Ejercicio'=>$row['ejercicio'],
                    'Periodo'=>$row['periodo'],
                    'Cuenta'=>$row['idCuenta'],
                    'DoH'=>$row['DoH'],
                    'Cantidad'=>$row['cantidad']
                );
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaAsiento($Asiento)<ROLLBACK");
            return false;
        }
        
        //se da de baja el asiento
        //se pone el campo Borrado=0 en la tabla 'tbmovimientos'
        $strSQL =  "UPDATE tbmovimientos SET
                    Borrado=$opt
                    WHERE asiento=".$Asiento;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaAsiento($Asiento)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaAsiento($Asiento)<ROLLBACK");
            return false;
        }
        
        //se pone el campo Borrado=0 en la tabla 'tbmovimientos_iva'
        //(sino hay no hace nada porque con la clausula WHERE no encontraria nada)
        $strSQL =  "UPDATE tbmovimientos_iva SET
                    Borrado=$opt
                    WHERE IdAsiento=".$Asiento;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaAsiento($Asiento)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaAsiento($Asiento)<ROLLBACK");
            return false;
        }

        //se pone el campo Borrado=0 en la tabla 'tbretenciones_irpf'
        //(sino hay no hace nada porque con la clausula WHERE no encontraria nada)
        $strSQL =  "UPDATE tbretenciones_irpf SET
                    Borrado=$opt
                    WHERE IdAsiento=".$Asiento;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaAsiento($Asiento)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaAsiento($Asiento)<ROLLBACK");
            return false;
        }

        
        //si hemos llegado hasta aqui es que esta todo OK por lo que damos COMMIT y devuelvo true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaAsiento($Asiento)<COMMIT");
        
        return true;
    }
    
    function DarAltaBajaPresupuesto($id,$opcion){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        if($opcion==='alta'){
            $op=1;
        }else{
            $op=0;
        }

        //(sino hay no hace nada porque con la clausula WHERE no encontraria nada)
        $strSQL =  "UPDATE tbmispresupuestos SET
                    Borrado=$op
                    WHERE IdPresupuesto=".$id;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaPresupuesto($id)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaPresupuesto($id)<FALSE");
            return false;
        }
        
        //si hemos llegado hasta aqui es que esta todo OK por lo que devuelvo true
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaPresupuesto($id)<TRUE");
        
        return true;
    }
    
    function DarAltaBajaFactura($id,$opcion){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        if($opcion==='alta'){
            $op=1;
        }else{
            $op=0;
        }
        
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaFactura($id,$opcion) || START TRANSACTION");
        
        //1- Hay que dar de baja/alta la factura (cambiar en la tabla 'tbmisfacturas' el campo 'Borrado' a 0 o 1 (baja/alta)
        //2- si esta factura viene de un presupuesto descontar/contar (baja/alta) esta factura en la tabla 'tbmispresupuestoslineas'
        //en los campos 'CantidadFAC y CantidadPEN, ImporteFAC e ImportePEN y CUotaIvaFAC y CuotaIvaPEN

        //1- (sino hay no hace nada porque con la clausula WHERE no encontraria nada)
        $strSQL =  "UPDATE tbmisfacturas SET
                    Borrado=$op
                    WHERE IdFactura=".$id;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaFactura($id)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaFactura($id)<FALSE");
            return false;
        }
        
        //2- busco en la tabla 'tbmisfacturas' IdPresupuesto
        $strSQL =  "
                    SELECT IdPresupuesto
                    FROM tbmisfacturas
                    WHERE IdFactura=".$id
                   ;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaFactura($id)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaFactura($id)<FALSE");
            return false;
        }
    
        $num=  mysql_num_rows($stmt);
        if($num>0){
            $row=  mysql_fetch_assoc($stmt);
            $IdPresupuesto=$row['IdPresupuesto'];
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaFactura($id)<FALSE");
            return false;
        }
            
        // si $IdPresupuesto=0 no tiene relacion la factura con el presupuesto
        if($IdPresupuesto<>0){
            //busco las facturas relacionadas con este presupuesto
            $strSQL =  "
                        SELECT IdFactura
                        FROM tbmisfacturas
                        WHERE IdPresupuesto=$IdPresupuesto
                        AND Borrado=1
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaFactura($id)|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DarAltaBajaFactura($id)<FALSE");
                return false;
            }
                
            $facturasEmitidasAnt='';
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $facturasEmitidasAnt[]=$reg;
            }
        
            //recorro todas las facturas que hayamos encontrado
            if(is_array($facturasEmitidasAnt)){
                $facturasEmitidasAntDatos='';
                for($i1=0;$i1<count($facturasEmitidasAnt);$i1++){
                    $strSQL = "
                               SELECT L.IdPresupLineas,L.CantidadPED,L.ImportePED,L.CuotaIvaPED 
                               FROM tbmisfacturaslineas L,tbmisfacturas F
                               WHERE L.IdFactura=".$facturasEmitidasAnt[$i1]['IdFactura']."
                               AND L.IdFactura=F.IdFactura
                               AND F.Borrado=1
                               ";
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->DarAltaBajaFactura()|| SQL : ".$strSQL);
                    $stmt = $db->ejecutar ( $strSQL );
                    if($stmt){
                        $num=  mysql_num_rows($stmt);
                        //veo si hay facturas anteriores emitidas
                        if($num>0){//si hay, las sumo
                            while($row=  mysql_fetch_array($stmt)){
                                $reg='';
                                foreach($row as $propiedad=>$valor){
                                    if(!is_numeric($propiedad)){
                                        $reg[$propiedad]=$valor;
                                    }
                                }
                                //$facturasEmitidasAntDatos[$facturasEmitidasAnt[$i1]][]=$reg;
                                $facturasEmitidasAntDatos[]=$reg;
                            }
                        }
                    }else{
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->DarAltaBajaFactura()<ROLLBACK");
                        return 'false';
                    }
                }
            }

            //ahora voy sumando y actualizando la tabla 'tbmispresupuestoslineas' 
            //recorro las facturas y las sumo por IdPresupLineas, lo guardo en un array
            $resultado=$facturasEmitidasAntDatos;
            //recorro las lineas de cada factura
            for($i=0;$i<count($resultado);$i++){
                //vamos a sumar los valores de CantidadPED, ImportePED y CuotaIvaPED
                $datos='';
                $idx=1;
                if(is_array($resultado)){
                    for($i=0;$i<count($resultado);$i++){
                        //veo si existe el array tiene algun dato (es array propiamente dicho)
                        if(is_array($datos)){
                            //busco si el registro existe en el array $datos (IdPresupLineas)
                            for($j=1;$j<=count($datos);$j++){
                                $encontrado='NO';
                                //si existe la IdPresupLineas, actualizo los datos
                                if($datos[$j]['IdPresupLineas']===$resultado[$i]['IdPresupLineas']){
                                    $datos[$j]['CantidadPED']=$datos[$j]['CantidadPED']+$resultado[$i]['CantidadPED'];
                                    $datos[$j]['ImportePED']=$datos[$j]['ImportePED']+$resultado[$i]['ImportePED'];
                                    $datos[$j]['CuotaIvaPED']=$datos[$j]['CuotaIvaPED']+$resultado[$i]['CuotaIvaPED'];
                                    $encontrado='SI';
                                    break;
                                }
                            }
                            //compruebo si se encontro antes la IdPresupLineas
                            //si no se encontro es que no existe por lo que hay que insertarla
                            if($encontrado==='NO'){
                                $datos[$idx]=array(
                                    'IdPresupLineas'=>$resultado[$i]['IdPresupLineas'],
                                    'CantidadPED'=>$resultado[$i]['CantidadPED'],
                                    'ImportePED'=>$resultado[$i]['ImportePED'],
                                    'CuotaIvaPED'=>$resultado[$i]['CuotaIvaPED'],
                                );
                                $idx++;
                            }
                        }
                        //si no es array es que esta vacio, se inserta este dato
                        else{
                            $datos[$idx]=array(
                                'IdPresupLineas'=>$resultado[$i]['IdPresupLineas'],
                                'CantidadPED'=>$resultado[$i]['CantidadPED'],
                                'ImportePED'=>$resultado[$i]['ImportePED'],
                                'CuotaIvaPED'=>$resultado[$i]['CuotaIvaPED'],
                            );
                            $idx++;
                        }
                    }
                }
            }

            //ahora voy a actualizar las lineas del presupuesto
            //como $datos son las sumas de todas las facturas anteriores por IdPresupLineas
            //en esta suma pueden no aparecer lineas que si estan en el presupuesto
            //guardo en un array estas lineas para despues poder indicar las que no aparecen pero que si estan 
            //en el presupuesto como GenFacPed=NO y Facturada=T
            $lineasPresupuestoFacturadas='';
            if(is_array($datos)){
                //CantidadFAC, ImporteFAC, CuotaIvaFAC, CantidadPEN, ImportePEN y CuotaIvaPEN
                //recorro las IdPresupLineas de cada factura
                for($ii=1;$ii<=count($datos);$ii++){
                    //recorro las lineas del presupuesto y actualizo sus valores
                    //primero recojo sus valores de CantidadPED, ImportePED y CuotaIvaPED
                    $strSQL = "
                               SELECT CantidadPED, ImportePED, CuotaIvaPED
                               FROM tbmispresupuestoslineas
                               WHERE IdPresupLineas=".$datos[$ii]['IdPresupLineas']."
                               ";
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->DarAltaBajaFactura()<ROLLBACK");
                        return 'false';
                    }
                    $row=  mysql_fetch_array($stmt);
                    //CantidadFAC=CantidadPED y CantidadPEN=CantidadPED-CantidadFAC e idem com Importe y CuotaIva
                    $CantidadFAC=$datos[$ii]['CantidadPED'];
                    $CantidadPEN=$row['CantidadPED']-$datos[$ii]['CantidadPED'];
                    if($CantidadPEN<0){
                        $CantidadPEN=0;
                    }
                    $ImporteFAC=$datos[$ii]['ImportePED'];
                    $ImportePEN=$row['ImportePED']-$datos[$ii]['ImportePED'];
                    if($ImportePEN<0){
                        $ImportePEN=0;
                    }
                    $CuotaIvaFAC=$datos[$ii]['CuotaIvaPED'];
                    $CuotaIvaPEN=$row['CuotaIvaPED']-$datos[$ii]['CuotaIvaPED'];
                    if($CuotaIvaPEN<0){
                        $CuotaIvaPEN=0;
                    }

                    //el campo Facturada (T=Total, Parcial y NF)
                    //si ImportePEN=0, es T, sino es M
                    $Facturada='M';//Parcial
                    if($ImportePEN==0){
                        $Facturada='T';
                    }

                    $strSQL = "
                               UPDATE tbmispresupuestoslineas
                               SET CantidadFAC=$CantidadFAC,
                               ImporteFAC=$ImporteFAC,
                               CuotaIvaFAC=$CuotaIvaFAC,
                               CantidadPEN=$CantidadPEN,
                               ImportePEN=$ImportePEN,
                               CuotaIvaPEN=$CuotaIvaPEN,
                               Facturada='$Facturada'
                               WHERE IdPresupLineas=".$datos[$ii]['IdPresupLineas']."
                               ";
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->DarAltaBajaFactura()<ROLLBACK");
                        return 'false';
                    }
                    $lineasPresupuestoFacturadas[]=$datos[$ii]['IdPresupLineas'];
                }
            }

            //primero extraigo las lineas del presupuesto
            $strSQL = "
                       SELECT IdPresupLineas
                       FROM tbmispresupuestoslineas
                       WHERE IdPresupuesto=$IdPresupuesto
                       ";
            $stmt = $db->ejecutar ( $strSQL );
            $lineasPresupuesto='';
            if($stmt){
                $num=  mysql_num_rows($stmt);
                //veo si hay facturas anteriores emitidas
                if($num>0){//si hay, las sumo
                    while($row=  mysql_fetch_array($stmt)){
                        $reg='';
                        foreach($row as $propiedad=>$valor){
                            if(!is_numeric($propiedad)){
                                $lineasPresupuesto[]=$valor;
                            }
                        }
                    }
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DarAltaBajaFactura()<ROLLBACK");
                return 'false';
            }

            //ahora busco las lineas sin facturar
            $lineasSinFacturar='';
            for($i=0;$i<count($lineasPresupuesto);$i++){
                $lineaSinFacturar=array("numero"=>"","Esta"=>"");// SI/NO
                $lineaSinFacturar["numero"]=$lineasPresupuesto[$i];
                $lineaSinFacturar["Esta"]="NO";
                for($ii=0;$ii<count($lineasPresupuestoFacturadas);$ii++){
                    if($lineasPresupuesto[$i]==$lineasPresupuestoFacturadas[$ii]){
                        $lineaSinFacturar["Esta"]="SI";
                        break;
                    }
                }
                $lineasSinFacturar[]=$lineaSinFacturar;
            }

            //ahora estas lineas sin facturar les cambio los campos GenFacPed=NO y Facturada=NF
            //e indico su campo CantidadPEN=CantidadPED y CantidadFAC=0, idem con Importe y CuotaIva
            foreach($lineasSinFacturar as $propiedad=>$valor){
                if($valor['Esta']==='NO'){
                    //primero extraigo CantidadPED, ImportePED y CuotaIvaPED
                    $strSQL = "
                               SELECT CantidadPED, ImportePED, CuotaIvaPED 
                               FROM tbmispresupuestoslineas
                               WHERE IdPresupLineas=".$valor['numero']."
                               ";
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->DarAltaBajaFactura()<ROLLBACK");
                        return 'false';
                    }
                    $row=  mysql_fetch_array($stmt);
                    $CantidadPEDIni=$row['CantidadPED'];
                    $ImportePEDIni=$row['ImportePED'];
                    $CuotaIvaPEDIni=$row['CuotaIvaPED'];
                    
                    
                    $strSQL = "
                               UPDATE tbmispresupuestoslineas
                               SET GenFacPed='NO',
                               Facturada='NF',
                               CantidadPEN=$CantidadPEDIni,
                               CantidadFAC=0,
                               ImportePEN=$ImportePEDIni,
                               ImporteFAC=0,
                               CuotaIvaPEN=$CuotaIvaPEDIni,
                               CuotaIvaFAC=0
                               WHERE IdPresupLineas=".$valor['numero']."
                               ";
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->DarAltaBajaFactura()<ROLLBACK");
                        return 'false';
                    }
                }
            }
//            }
        }// final del $id
        
        
        //si hemos llegado hasta aqui es que esta todo OK por lo que damos COMMIT y devuelvo true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaFactura($id)<TRUE");
        
        return true;
    }
    
    function DarAltaBajaPedido($id,$opcion){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        if($opcion==='alta'){
            $op=1;
        }else{
            $op=0;
        }
        
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaPedido($id,$opcion) || START TRANSACTION");
        
        //1- Hay que dar de baja/alta el pedido (cambiar en la tabla 'tbmispedidos' el campo 'Borrado' a 0 o 1 (baja/alta)
        //2- si este pedido viene de un presupuesto descontar/contar (baja/alta) este pedido en la tabla 'tbmispresupuestoslineas'
        //en los campos 'CantidadFAC y CantidadPEN, ImporteFAC e ImportePEN y CuotaIvaFAC y CuotaIvaPEN

        //1- (sino hay no hace nada porque con la clausula WHERE no encontraria nada)
        $strSQL =  "UPDATE tbmispedidos SET
                    Borrado=$op
                    WHERE IdPedido=".$id;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaPedido($id)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaPedido($id)<FALSE");
            return false;
        }
        
        //2- busco en la tabla 'tbmispedidos' IdPresupuesto
        $strSQL =  "
                    SELECT IdPresupuesto
                    FROM tbmispedidos
                    WHERE IdPedido=".$id
                   ;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaPedido($id)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaPedido($id)<FALSE");
            return false;
        }

        $num=  mysql_num_rows($stmt);
        if($num>0){
            $row=  mysql_fetch_assoc($stmt);
            $IdPresupuesto=$row['IdPresupuesto'];
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaPedido($id)<FALSE");
            return false;
        }
            
        // si $IdPresupuesto=0 no tiene relacion la factura con el presupuesto
        if($IdPresupuesto<>0){
            //busco los pedidos relacionadas con este presupuesto
            $strSQL =  "
                        SELECT IdPedido
                        FROM tbmispedidos
                        WHERE IdPresupuesto=$IdPresupuesto
                        AND Borrado=1
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DarAltaBajaPedido($id)|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DarAltaBajaPedido($id)<FALSE");
                return false;
            }
                
            $pedidosEmitidosAnt='';
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $pedidosEmitidosAnt[]=$reg;
            }
        
            //recorro todas los pedidos que hayamos encontrado
            if(is_array($pedidosEmitidosAnt)){
                $pedidosEmitidosAntDatos='';
                for($i1=0;$i1<count($pedidosEmitidosAnt);$i1++){
                    $strSQL = "
                               SELECT L.IdPresupLineas,L.CantidadPED,L.ImportePED,L.CuotaIvaPED 
                               FROM tbmispedidoslineas L,tbmispedidos F
                               WHERE L.IdPedido=".$pedidosEmitidosAnt[$i1]['IdPedido']."
                               AND L.IdPedido=F.IdPedido
                               AND F.Borrado=1
                               ";
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->DarAltaBajaPedido()|| SQL : ".$strSQL);
                    $stmt = $db->ejecutar ( $strSQL );
                    if($stmt){
                        $num=  mysql_num_rows($stmt);
                        //veo si hay facturas anteriores emitidas
                        if($num>0){//si hay, las sumo
                            while($row=  mysql_fetch_array($stmt)){
                                $reg='';
                                foreach($row as $propiedad=>$valor){
                                    if(!is_numeric($propiedad)){
                                        $reg[$propiedad]=$valor;
                                    }
                                }
                                $pedidosEmitidosAntDatos[]=$reg;
                            }
                        }
                    }else{
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->DarAltaBajaPedido()<ROLLBACK");
                        return 'false';
                    }
                }
            }

            //ahora voy sumando y actualizando la tabla 'tbmispresupuestoslineas' 
            //recorro los pdidos y los sumo por IdPresupLineas, lo guardo en un array
            $resultado=$pedidosEmitidosAntDatos;
            //recorro las lineas de cada factura
            for($i=0;$i<count($resultado);$i++){
                //vamos a sumar los valores de CantidadPED, ImportePED y CuotaIvaPED
                $datos='';
                $idx=1;
                if(is_array($resultado)){
                    for($i=0;$i<count($resultado);$i++){
                        //veo si existe el array tiene algun dato (es array propiamente dicho)
                        if(is_array($datos)){
                            //busco si el registro existe en el array $datos (IdPresupLineas)
                            for($j=1;$j<=count($datos);$j++){
                                $encontrado='NO';
                                //si existe la IdPresupLineas, actualizo los datos
                                if($datos[$j]['IdPresupLineas']===$resultado[$i]['IdPresupLineas']){
                                    $datos[$j]['CantidadPED']=$datos[$j]['CantidadPED']+$resultado[$i]['CantidadPED'];
                                    $datos[$j]['ImportePED']=$datos[$j]['ImportePED']+$resultado[$i]['ImportePED'];
                                    $datos[$j]['CuotaIvaPED']=$datos[$j]['CuotaIvaPED']+$resultado[$i]['CuotaIvaPED'];
                                    $encontrado='SI';
                                    break;
                                }
                            }
                            //compruebo si se encontro antes la IdPresupLineas
                            //si no se encontro es que no existe por lo que hay que insertarla
                            if($encontrado==='NO'){
                                $datos[$idx]=array(
                                    'IdPresupLineas'=>$resultado[$i]['IdPresupLineas'],
                                    'CantidadPED'=>$resultado[$i]['CantidadPED'],
                                    'ImportePED'=>$resultado[$i]['ImportePED'],
                                    'CuotaIvaPED'=>$resultado[$i]['CuotaIvaPED'],
                                );
                                $idx++;
                            }
                        }
                        //si no es array es que esta vacio, se inserta este dato
                        else{
                            $datos[$idx]=array(
                                'IdPresupLineas'=>$resultado[$i]['IdPresupLineas'],
                                'CantidadPED'=>$resultado[$i]['CantidadPED'],
                                'ImportePED'=>$resultado[$i]['ImportePED'],
                                'CuotaIvaPED'=>$resultado[$i]['CuotaIvaPED'],
                            );
                            $idx++;
                        }
                    }
                }
            }

            //ahora voy a actualizar las lineas del presupuesto
            //como $datos son las sumas de todas los pedidos anteriores por IdPresupLineas
            //en esta suma pueden no aparecer lineas que si estan en el presupuesto
            //guardo en un array estas lineas para despues poder indicar las que no aparecen pero que si estan 
            //en el presupuesto como GenPedPre=NO y Pedido=T
            $lineasPresupuestoPedidos='';
            if(is_array($datos)){
                //CantidadFAC, ImporteFAC, CuotaIvaFAC, CantidadPEN, ImportePEN y CuotaIvaPEN
                //recorro las IdPresupLineas de cada pedido
                for($ii=1;$ii<=count($datos);$ii++){
                    //recorro las lineas del presupuesto y actualizo sus valores
                    //primero recojo sus valores de CantidadPED, ImportePED y CuotaIvaPED
                    $strSQL = "
                               SELECT CantidadPED, ImportePED, CuotaIvaPED
                               FROM tbmispresupuestoslineas
                               WHERE IdPresupLineas=".$datos[$ii]['IdPresupLineas']."
                               ";
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->DarAltaBajaPedido()<ROLLBACK");
                        return 'false';
                    }
                    $row=  mysql_fetch_array($stmt);
                    //CantidadFAC=CantidadPED y CantidadPEN=CantidadPED-CantidadFAC e idem com Importe y CuotaIva
                    $CantidadFAC=$datos[$ii]['CantidadPED'];
                    $CantidadPEN=$row['CantidadPED']-$datos[$ii]['CantidadPED'];
                    if($CantidadPEN<0){
                        $CantidadPEN=0;
                    }
                    $ImporteFAC=$datos[$ii]['ImportePED'];
                    $ImportePEN=$row['ImportePED']-$datos[$ii]['ImportePED'];
                    if($ImportePEN<0){
                        $ImportePEN=0;
                    }
                    $CuotaIvaFAC=$datos[$ii]['CuotaIvaPED'];
                    $CuotaIvaPEN=$row['CuotaIvaPED']-$datos[$ii]['CuotaIvaPED'];
                    if($CuotaIvaPEN<0){
                        $CuotaIvaPEN=0;
                    }

                    //el campo Facturada (T=Total, Parcial y NF)
                    //si ImportePEN=0, es T, sino es M
                    $Facturada='M';//Parcial
                    if($ImportePEN==0){
                        $Facturada='T';
                    }

                    $strSQL = "
                               UPDATE tbmispresupuestoslineas
                               SET CantidadFAC=$CantidadFAC,
                               ImporteFAC=$ImporteFAC,
                               CuotaIvaFAC=$CuotaIvaFAC,
                               CantidadPEN=$CantidadPEN,
                               ImportePEN=$ImportePEN,
                               CuotaIvaPEN=$CuotaIvaPEN,
                               Facturada='$Facturada'
                               WHERE IdPresupLineas=".$datos[$ii]['IdPresupLineas']."
                               ";
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->DarAltaBajaPedido()<ROLLBACK");
                        return 'false';
                    }
                    $lineasPresupuestoPedidos[]=$datos[$ii]['IdPresupLineas'];
                }
            }

            //primero extraigo las lineas del presupuesto
            $strSQL = "
                       SELECT IdPresupLineas
                       FROM tbmispresupuestoslineas
                       WHERE IdPresupuesto=$IdPresupuesto
                       ";
            $stmt = $db->ejecutar ( $strSQL );
            $lineasPresupuesto='';
            if($stmt){
                $num=  mysql_num_rows($stmt);
                //veo si hay facturas anteriores emitidas
                if($num>0){//si hay, las sumo
                    while($row=  mysql_fetch_array($stmt)){
                        $reg='';
                        foreach($row as $propiedad=>$valor){
                            if(!is_numeric($propiedad)){
                                $lineasPresupuesto[]=$valor;
                            }
                        }
                    }
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->DarAltaBajaPedido()<ROLLBACK");
                return 'false';
            }

            //ahora busco las lineas sin pedido
            $lineasSinPedidos='';
            for($i=0;$i<count($lineasPresupuesto);$i++){
                $lineaSinPedidos=array("numero"=>"","Esta"=>"");// SI/NO
                $lineaSinPedidos["numero"]=$lineasPresupuesto[$i];
                $lineaSinPedidos["Esta"]="NO";
                for($ii=0;$ii<count($lineasPresupuestoPedidos);$ii++){
                    if($lineasPresupuesto[$i]==$lineasPresupuestoPedidos[$ii]){
                        $lineaSinPedidos["Esta"]="SI";
                        break;
                    }
                }
                $lineasSinPedidos[]=$lineaSinPedidos;
            }

            //ahora estas lineas sin pedidos les cambio los campos GenPedPre=NO y Pedido=NP
            //e indico su campo CantidadPEN=CantidadPED y CantidadFAC=0, idem con Importe y CuotaIva
            foreach($lineasSinPedidos as $propiedad=>$valor){
                if($valor['Esta']==='NO'){
                    //primero extraigo CantidadPED, ImportePED y CuotaIvaPED
                    $strSQL = "
                               SELECT CantidadPED, ImportePED, CuotaIvaPED 
                               FROM tbmispresupuestoslineas
                               WHERE IdPresupLineas=".$valor['numero']."
                               ";
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->DarAltaBajaPedido()<ROLLBACK");
                        return 'false';
                    }
                    $row=  mysql_fetch_array($stmt);
                    $CantidadPEDIni=$row['CantidadPED'];
                    $ImportePEDIni=$row['ImportePED'];
                    $CuotaIvaPEDIni=$row['CuotaIvaPED'];
                    
                    
                    $strSQL = "
                               UPDATE tbmispresupuestoslineas
                               SET GenPedPre='NO',
                               Pedido='NP',
                               CantidadPEN=$CantidadPEDIni,
                               CantidadFAC=0,
                               ImportePEN=$ImportePEDIni,
                               ImporteFAC=0,
                               CuotaIvaPEN=$CuotaIvaPEDIni,
                               CuotaIvaFAC=0
                               WHERE IdPresupLineas=".$valor['numero']."
                               ";
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->DarAltaBajaPedido()<ROLLBACK");
                        return 'false';
                    }
                }
            }
//            }
        }// final del $id
        
        
        //si hemos llegado hasta aqui es que esta todo OK por lo que damos COMMIT y devuelvo true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DarAltaBajaPedido($id)<TRUE");
        
        return true;
    }
    
    function LeeResultados($fechaForm){

        //donde voy a guardar los datos
        $datos=array(
            'ingresos'=>'',
            'ingresosTotal'=>'',
            'gastos'=>'',
            'gastosTotal'=>''
        );

        
        //ingresos 7
        $ListadoCuentas=$this->LeeCuentas('7');
        
        $ingresos=0;
        foreach($ListadoCuentas as $cuentas){
            $ingresos=$this->ListadoAsientosCuenta($cuentas,0);
            
            //realizo la suma de los ingresos
            $datos['ingresosTotal']=$datos['ingresosTotal']+$ingresos[count($ingresos)-1]['Saldo'];
            
            //leo el nombre de las cuentas 7
            $strSQL = "
                        SELECT C.Nombre 
                        FROM tbcuenta C WHERE C.Borrado=0 AND C.NumCuenta = '".$cuentas["Cuenta"]."'
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->LeeResultados()|| SQL : ".$strSQL);
            
            require_once '../general/'.$_SESSION['mapeo'];
            $db = new Db();
            $db->conectar($this->getStrBD());
            $stmt = $db->ejecutar ( $strSQL );
            $db->desconectar();

            if($stmt){
                while($row=  mysql_fetch_array($stmt)){
                    $datos['ingresos'][]=array(
                                                'nombre'=>$row['Nombre'],
                                                'cantidad'=>-$ingresos[count($ingresos)-1]['Saldo'],
                                        );
                }
            }
        }
        
        //gastos 6
        $ListadoCuentas=$this->LeeCuentas('6');
        
        $gastos=0;
        foreach($ListadoCuentas as $cuentas){
            $gastos=$this->ListadoAsientosCuenta($cuentas,0);
            
            //realizo la suma de los ingresos
            $datos['gastosTotal']=$datos['gastosTotal']+$gastos[count($gastos)-1]['Saldo'];
            
            //leo el nombre de las cuentas 6
            $strSQL = "
                        SELECT C.Nombre 
                        FROM tbcuenta C WHERE C.Borrado=0 AND C.NumCuenta = '".$cuentas["Cuenta"]."'
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->LeeResultados()|| SQL : ".$strSQL);
            
            require_once '../general/'.$_SESSION['mapeo'];
            $db = new Db();
            $db->conectar($this->getStrBD());
            $stmt = $db->ejecutar ( $strSQL );
            $db->desconectar();

            if($stmt){
                while($row=  mysql_fetch_array($stmt)){
                    $datos['gastos'][]=array(
                                                'nombre'=>$row['Nombre'],
                                                'cantidad'=>$gastos[count($gastos)-1]['Saldo'],
                                        );
                }
            }
        }
        
        
        return $datos;
    }
    
    function LeeCuentas($parametro){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //leo los datos de la tesoreria. Bancos 5720
        $strSQL = "
                    SELECT DISTINCT(idCuenta)
                    FROM tbmovimientos
                    WHERE Borrado=1
                    AND idCuenta LIKE '$parametro%'
                    ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->LeeTesoreria()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        $cuentasBancos='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $cuentasBancos[]=array(
                    "Cuenta"=>$row['idCuenta']
                    );
            }
        }

        return $cuentasBancos;
    }
    
    //NO VALE 25/11/2013
    function LeeTesoreria($fechaForm){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //donde voy a guardar los datos
        $datos=array(
            'caja'=>0,
            'bancos'=>0
        );
        
        //leo los datos de la tesoreria. Cajas 5700
        $strSQL = "
                    SELECT
                    IF(M.DoH='D',M.cantidad,0) AS Debe, 
                    IF(M.DoH='H',M.cantidad,0) AS Haber 
                    FROM tbmovimientos M
                    WHERE M.Borrado=1
                    AND M.fechaApunte<='".fecha_to_DATETIME($fechaForm)."'
                    AND M.idCuenta LIKE '5700%'
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->LeeTesoreria()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $datos['caja']=$datos['caja']+$row['Debe']-$row['Haber'];
            }
        }
        
        //extraigo un listado de los datos de la tesoreria. Bancos 5720
        $strSQL = "
                    SELECT
                    IF(M.DoH='D',M.cantidad,0) AS Debe, 
                    IF(M.DoH='H',M.cantidad,0) AS Haber 
                    FROM tbmovimientos M
                    WHERE M.Borrado=1
                    AND M.fechaApunte<='".fecha_to_DATETIME($fechaForm)."'
                    AND M.idCuenta LIKE '5720%'
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->LeeTesoreria()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //ahora sumo por bancos el debe y el haber
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $datos['bancos']=$datos['bancos']+$row['Debe']-$row['Haber'];
            }
        }
        
        return $datos;
    }

    //BORRAR, NO LO USO 26/11/2014
    //SIN HACER, VER CON JM COMO SE CALCULAN
    function LeeImpuestos($fechaForm){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //donde voy a guardar los datos
        $datos=array(
            'IVA'=>'',
            'IRPF'=>''
        );
        
        //IVA
        
        
        
        
                
        return $datos;
    }
    
    //SIN HACER, VER CON JM COMO SE CALCULAN
    function LeeAlquileres($fechaForm){
//        require_once '../general/'.$_SESSION['mapeo'];
//        $db = new Db();
//        $db->conectar($this->getStrBD());
        
        //donde voy a guardar los datos
        $datos=array(
            'alquileres'=>'',
        );

        
        
//        $db->desconectar ();
        
        
        $datos['alquileres'][]=array(
                            'cantidad'=>'xxxxxx',
                            );

        
        return $datos;
    }
    
    function LeePagos($fechaForm){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        require_once '../CN/clsCNDefault2.php';
        $clsCNDefault2 = new clsCNDefault2();
        $claseEmpresa=$clsCNDefault2->claseEmpresa($_SESSION['idEmp']);
        
        //SIN HACER 27/11/2014
        $datos='';
        if($claseEmpresa==='Autonomo'){
            $datos['tituloPagos']='Pagos a Cuenta';
            
        }else{
            $datos['tituloPagos']='Sociedades (Ejercicio Actual)';
        }
        
        

        
        
        $db->desconectar ();
        
        
        $datos['alquileres'][]=array(
                            'cantidad'=>'xxxxxx',
                            );

        
        return $datos;
    }
    
    function CobrosPagosPendientes($cuentas,$fechaForm){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //extrae las cuentas que son a filtrar de la consulta SQL
        $cuentas=explode('/',$cuentas);
        $strSQL = "(SELECT M.idCuenta,C.Nombre,M.DoH,round(sum(M.cantidad),2) AS cantidad
                   FROM tbmovimientos M,tbcuenta C
                   WHERE M.Borrado=1
                   AND C.Borrado=0
                   AND M.idCuenta=C.NumCuenta
                   AND M.fechaApunte<='".fecha_to_DATETIME($fechaForm)."' AND (";
        
        //indicams las cuentas que hayas en el filtro
        for($i=0;$i<count($cuentas);$i++){
            $strSQL=$strSQL." M.idCuenta like '".$cuentas[$i]."%'";
            if($i<(count($cuentas)-1)){
                $strSQL=$strSQL." OR";
            }
        }
        //ahora preparo las dos subconsultas, una para el debe y otra para el haber
        $strSQL_Debe=$strSQL.") AND M.DoH='D'";
        $strSQL_Haber=$strSQL.") AND M.DoH='H'";
        
        //termino agrupo las cuentas
        $strSQL_Debe=$strSQL_Debe." GROUP BY M.idCuenta)";
        $strSQL_Haber=$strSQL_Haber." GROUP BY M.idCuenta)";
        
        //termino la contulta uniendolas
        $strSQL=$strSQL_Debe.' UNION '.$strSQL_Haber.' ORDER BY Nombre,DoH';
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->CobrosPagosPendientes()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            $datos='';
            while($row=  mysql_fetch_array($stmt)){
                //recorro el resultado de la consulta y lo voy insertando en un array
                //compruebo que es array, sino es que todavia esta vacio
                if(is_array($datos)){
                    //primero compruebo que este o no insertada la cuenta
                    $encontrado='NO';
                    for($j=0;$j<count($datos);$j++){
                        if($row['Nombre']===$datos[$j]['cuenta']){
                            //si lo esta sumo la cantidad al campo debe o haber
                            if($row['DoH']==='D'){
                                $datos[$j]['debe']=$datos[$j]['debe']+$row['cantidad'];
                            }else{
                                $datos[$j]['haber']=$datos[$j]['haber']+$row['cantidad'];
                            }
                            //aqui vemos si se a pagado o no
                            //si las cuentas empiezan por 43 es cobro, se cogen las 5 resultados positivos mas altos
                            //si las cuentas empiezan por 40 o 41 es pago, se cogen las 5 resultados negativos mas altos
                            $dif=$datos[$j]['debe']-$datos[$j]['haber'];
                            $datos[$j]['diferencia']=$dif;
                            $encontrado='SI';
                            break;
                        }
                    }     
                    if($encontrado==='NO'){
                        //no a encontrado cuenta, la creo e inserto la cantidad en debe o haber
                        $debe=0;
                        $haber=0;
                        if($row['DoH']==='D'){
                            $debe=$row['cantidad'];
                        }else{
                            $haber=$row['cantidad'];
                        }
                        $dif=$debe-$haber;
                        $datos[]=array(
                            'idCuenta'=>$row['idCuenta'],
                            'cuenta'=>$row['Nombre'],
                            'debe'=>$debe,
                            'haber'=>$haber,
                            'diferencia'=>$dif,
                        );
                    }
                }else{
                    //es el primer dato que se introduce en el array $datos
                    $debe=0;
                    $haber=0;
                    if($row['DoH']==='D'){
                        $debe=$row['cantidad'];
                    }else{
                        $haber=$row['cantidad'];
                    }
                    $dif=$debe-$haber;
                    $datos[]=array(
                        'idCuenta'=>$row['idCuenta'],
                        'cuenta'=>$row['Nombre'],
                        'debe'=>$debe,
                        'haber'=>$haber,
                        'diferencia'=>$dif,
                    );
                }
            }
            
            //ahora ordeno este array segun la diferencia de mayor a menor
            //array_multisort($datos[]['diferencia'], SORT_DESC, SORT_NUMERIC);
            if(is_array($datos)){
                if($cuentas[0]==='43'){//cuentas 43
                    $datos=$this->orderMultiDimensionalArray($datos, 'diferencia', true);
                }else{//cuentas 40 y 41
                    $datos=$this->orderMultiDimensionalArray($datos, 'diferencia', false);
                }
            }
        }else{
            return false;
        }
        
        return $datos;
    }
    
    //funcion para ordenar un array multidimensional
    public function orderMultiDimensionalArray ($toOrderArray, $field, $inverse = false) {  
        $position = array();  
        $newRow = array();  
        foreach ($toOrderArray as $key => $row) {  
                $position[$key]  = $row[$field];  
                $newRow[$key] = $row;  
        }  
        if ($inverse) {  
            arsort($position);  
        }  
        else {  
            asort($position);  
        }  
        $returnArray = array();  
        foreach ($position as $key => $pos) {       
            $returnArray[] = $newRow[$key];  
        }  
        return $returnArray;  
    }  

    function DatosCuentaParaResultados($cuenta){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL='SELECT IdCuenta,NumCuenta,Nombre FROM tbcuenta WHERE NumCuenta="'.trim($cuenta['idCuenta']).'"';
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->DatosCuentaParaResultados()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            $row=  mysql_fetch_array($stmt);
            $resultado=array(
                'IdCuenta'=>$row['IdCuenta'],
                'Cuenta'=>$row['NumCuenta'],
                'Nombre'=>$row['Nombre'],
            );
            return $resultado;
        }else{
            return false;
        }
    }
    
    function PerceptoresIRPF($lngEjercicio,$Periodo,$clave){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL="
                SELECT M.ejercicio,
                (CASE 
                WHEN M.periodo IN (1,2,3) THEN 1
                WHEN M.periodo IN (4,5,6) THEN 2
                WHEN M.periodo IN (7,8,9) THEN 3
                WHEN M.periodo IN (10,11,12) THEN 4
                END) Trimestre,R.IdCliProv
                FROM tbretenciones_irpf R,tbmovimientos M
                WHERE R.IdAsiento=M.asiento
                AND M.Borrado=1 
                AND M.idCuenta LIKE '4751%' 
                AND R.Clave='$clave'
                GROUP BY Trimestre,R.IdCliProv
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->DatosCuentaParaResultados()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            //he sacado un listado con los IdCliProv que han hecho facturas con IRPF
            //ahora los cuento
            //array compuesto de 3 campos: Ejercicio+Trimestre+Contar
            $contar='';
            for($i=0;$i<count($resultado);$i++){
                //busco ejercicio y trimestre en el array $contar
                //si existe aumento el valor del campo 'Contar'+1
                if(is_array($contar)){
                    for($j=0;$j<count($contar);$j++){
                        $encontrado='NO';
                        if($resultado[$i]['ejercicio']===$contar[$j]['Ejercicio'] &&
                                $resultado[$i]['Trimestre']===$contar[$j]['Trimestre']){
                            $contar[$j]['Contar']=$contar[$j]['Contar']+1;
                            $encontrado='SI';
                        }
                    }
                    //sino lo ha encontrado se hace una nueva inserción
                    if($encontrado==='NO'){
                        if(isset($resultado[$i]['ejercicio'])){
                            $ejercicio=$resultado[$i]['ejercicio'];
                        }else{
                            $ejercicio=$lngEjercicio;
                        }
                        if(isset($resultado[$i]['Trimestre'])){
                            $trimestre=$resultado[$i]['Trimestre'];
                        }else{
                            $trimestre=$Periodo;
                        }
                        $contar[]=array(
                            'Ejercicio'=>$ejercicio,
                            'Trimestre'=>$trimestre,
                            'Contar'=>1
                        );
                    }
                }
                //sino es array es que esta vacio, insertamos el nuevo valor
                else{
                    if(isset($resultado[$i]['ejercicio'])){
                        $ejercicio=$resultado[$i]['ejercicio'];
                    }else{
                        $ejercicio=$lngEjercicio;
                    }
                    if(isset($resultado[$i]['Trimestre'])){
                        $trimestre=$resultado[$i]['Trimestre'];
                    }else{
                        $trimestre=$Periodo;
                    }
                    $contar[]=array(
                        'Ejercicio'=>$ejercicio,
                        'Trimestre'=>$trimestre,
                        'Contar'=>1
                    );
                }
            }
            
            //ahora devuelvo el resultado del trimestre y ejercicio pedido
            $resultado=false;
            for($i=0;$i<count($contar);$i++){
                if($contar[$i]['Ejercicio']===$lngEjercicio && $contar[$i]['Trimestre']===substr($Periodo,0,1)){
                    $resultado=$contar[$i]['Contar'];
                }
            }
            return $resultado;
        }else{
            return false;
        }
    }        
        
    //HABRA QUE BORRAR (COMFIRMAR) 29/10/2013
    function calculoDatosIRPF_A($lngEjercicio,$Periodo){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        if($Periodo==='1T'){
            $trimestre=1;
        }else if($Periodo==='2T'){
            $trimestre=2;
        }else if($Periodo==='3T'){
            $trimestre=3;
        }else if($Periodo==='4T'){
            $trimestre=4;
        }
        
        //consulta para extraer los datos de IRPF (4751) segun los ejercicos y trimestres
        $strSQL="
                SELECT M.ejercicio,
                (CASE 
                WHEN M.periodo IN (1,2,3) THEN 1
                WHEN M.periodo IN (4,5,6) THEN 2
                WHEN M.periodo IN (7,8,9) THEN 3
                WHEN M.periodo IN (10,11,12) THEN 4
                END) Trimestre,
                ROUND(SUM(R.BaseImponible),2) AS Base,
                ROUND(SUM(R.ImporteRetencion),2) AS Cuota
                FROM tbretenciones_irpf R,tbmovimientos M
                WHERE R.IdAsiento=M.asiento
                AND M.Borrado=1 
                AND M.idCuenta LIKE '4751%'
                AND R.Clave='A'
                GROUP BY Trimestre
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->DatosCuentaParaResultados()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            //busco el resultado del ejercicio y periodo
            $resFinal='';
            for($i=0;$i<count($resultado);$i++){
                if($resultado[$i]['ejercicio']===$lngEjercicio && $resultado[$i]['Trimestre']===(string)$trimestre){
                    $resFinal=$resultado[$i];
                    break;
                }
            }
            
            return $resFinal;
        }else{
            return false;
        }
    }
    
    function AsientoEditable($ejercicio,$periodo){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //por ultimo veo si se puede o no editar el asiento (IVA, IRPF)
        $strSQL =  "SELECT Activo
                    FROM tbperiodos_iva
                    WHERE ejercicio=".$ejercicio.
                    " AND periodo=".$periodo;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DatosAsiento()|| SQL : ".$strSQL);

        $stmt = $db->ejecutar ( $strSQL );
        $resultado='SI';
        if($stmt){
            $row=  mysql_fetch_array($stmt);
            if($row['Activo']==='2' || $row['Activo']==='3'){
                $resultado='NO';
            }
        }else{
            $resultado='SI';
        }
        return $resultado;
    }
    
    function consultaAbiertoAutonomo130($lngEjercicio){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //consulta para extraer los datos de resultados desde inicio de año hasta la fecha indicada
        //Resultados=Ingresos (7) - Gastos (6) por trimestres
        $trimestre=array(
                "Ingresos"=>'',
                "Gastos"=>'',
                "Resultado"=>'',
                "Cuota"=>'',
                "CuotaAnt"=>'',
                "Liquidacion"=>''
            );
        $datos=array(
            "1T"=>$trimestre,
            "2T"=>$trimestre,
            "3T"=>$trimestre,
            "4T"=>$trimestre
        );
        
        //1T
        $fechaInicio='01/01/'.$lngEjercicio;
        $fechaFin='31/03/'.$lngEjercicio;
        
        $datos['1T']['Ingresos']=$this->sumaCuentaPeriodo($db,7,$fechaInicio,$fechaFin);
        $datos['1T']['Gastos']=$this->sumaCuentaPeriodo($db,6,$fechaInicio,$fechaFin);
        $datos['1T']['Resultado']=$datos['1T']['Ingresos']-$datos['1T']['Gastos'];

        $cuota=$this->calcularCuota('Porcentaje Autonomo',$fechaInicio,$fechaFin,$db);
        
        $datos['1T']['Cuota']=round($datos['1T']['Resultado']*$cuota,2);
        if($datos['1T']['Cuota']<0){
            $datos['1T']['Cuota']=0;
        }
        $datos['1T']['CuotaAnt']=0;//1T
        $datos['1T']['Liquidacion']=$datos['1T']['Cuota'];
        
        //2T (1T y 2T acumulados)
        $fechaInicio='01/01/'.$lngEjercicio;
        $fechaFin='30/06/'.$lngEjercicio;
        $cuota=$this->calcularCuota('Porcentaje Autonomo','01/04/'.$lngEjercicio,$fechaFin,$db);
        
        $datos['2T']['Ingresos']=$this->sumaCuentaPeriodo($db,7,$fechaInicio,$fechaFin);
        $datos['2T']['Gastos']=$this->sumaCuentaPeriodo($db,6,$fechaInicio,$fechaFin);
        $datos['2T']['Resultado']=$datos['2T']['Ingresos']-$datos['2T']['Gastos'];
        $datos['2T']['Cuota']=round($datos['2T']['Resultado']*$cuota,2);
        if($datos['2T']['Cuota']<0){
            $datos['2T']['Cuota']=0;
        }
        $datos['2T']['CuotaAnt']=$datos['1T']['Liquidacion'];
        $datos['2T']['Liquidacion']=$datos['2T']['Cuota']-$datos['2T']['CuotaAnt'];
        if($datos['2T']['Liquidacion']<0){
            $datos['2T']['Liquidacion']=0;
        }
        
        //3T (1T, 2T y 3T acumulados)
        $fechaInicio='01/01/'.$lngEjercicio;
        $fechaFin='30/09/'.$lngEjercicio;
        $cuota=$this->calcularCuota('Porcentaje Autonomo','01/07/'.$lngEjercicio,$fechaFin,$db);
        
        $datos['3T']['Ingresos']=$this->sumaCuentaPeriodo($db,7,$fechaInicio,$fechaFin);
        $datos['3T']['Gastos']=$this->sumaCuentaPeriodo($db,6,$fechaInicio,$fechaFin);
        $datos['3T']['Resultado']=$datos['3T']['Ingresos']-$datos['3T']['Gastos'];
        $datos['3T']['Cuota']=round($datos['3T']['Resultado']*$cuota,2);
        if($datos['3T']['Cuota']<0){
            $datos['3T']['Cuota']=0;
        }
        $datos['3T']['CuotaAnt']=$datos['2T']['CuotaAnt']+$datos['2T']['Liquidacion'];
        $datos['3T']['Liquidacion']=$datos['3T']['Cuota']-$datos['3T']['CuotaAnt'];
        if($datos['3T']['Liquidacion']<0){
            $datos['3T']['Liquidacion']=0;
        }
        
        //4T (1T, 2T, 3T y 4T acumulados)
        $fechaInicio='01/01/'.$lngEjercicio;
        $fechaFin='31/12/'.$lngEjercicio;
        $cuota=$this->calcularCuota('Porcentaje Autonomo','01/10/'.$lngEjercicio,$fechaFin,$db);
        
        $datos['4T']['Ingresos']=$this->sumaCuentaPeriodo($db,7,$fechaInicio,$fechaFin);
        $datos['4T']['Gastos']=$this->sumaCuentaPeriodo($db,6,$fechaInicio,$fechaFin);
        $datos['4T']['Resultado']=$datos['4T']['Ingresos']-$datos['4T']['Gastos'];
        $datos['4T']['Cuota']=round($datos['4T']['Resultado']*$cuota,2);
        if($datos['4T']['Cuota']<0){
            $datos['4T']['Cuota']=0;
        }
        $datos['4T']['CuotaAnt']=$datos['3T']['CuotaAnt']+$datos['3T']['Liquidacion'];
        $datos['4T']['Liquidacion']=$datos['4T']['Cuota']-$datos['4T']['CuotaAnt'];
        if($datos['4T']['Liquidacion']<0){
            $datos['4T']['Liquidacion']=0;
        }
        $db->desconectar();
        
        //devolvemos resultados
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->consultaAbiertoAutonomo130()<Devuelvo datos ");
        return $datos;
    }
    
    function calcularCuotaLlamada($parametroBuscar,$fechaInicio,$fechaFin){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $parametro=$this->calcularCuota($parametroBuscar, $fechaInicio, $fechaFin, $db);
        $db->desconectar();
        return $parametro;
    }
    
    function calcularCuota($parametroBuscar,$fechaInicio,$fechaFin,$db){
        
        //extraigo el % de porcentaje de autonomos (de la tabla  'tbparametros_generales')
        $strSQL="
                SELECT valor,ValidoDesde,ValidoHasta
                FROM tbparametros_generales
                WHERE nombre ='$parametroBuscar'
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->consultaAbiertoAutonomo130()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
        }
        
        //paso a DATETIME
        $fechaInicio=fecha_to_DATETIME($fechaInicio);
        $fechaFin=fecha_to_DATETIME($fechaFin);
        
        //ahora busco en este array por fechas que este valido este parametro 'Porcentaje Autonomo'
        if(is_array($resultado)){
            for($i=0;$i<count($resultado);$i++){
                //si ValidoHasta = null , solo hay que combrobar que $fechaInicio>=ValidoDesde
                if($resultado[$i]['ValidoHasta']==null){
                    if($fechaInicio >= $resultado[$i]['ValidoDesde']){
                        $cuota=(Float)$resultado[$i]['valor'];
                        $cuota=(Float)($cuota/100);
                    }
                }else{
                //si ValidoHasta tiene valor 
                    //hay que ver que $fechaInicio>=ValidoDesde y $fechaFin<=ValidoHasta
                    if(($fechaInicio >= $resultado[$i]['ValidoDesde']) && ($fechaFin <= $resultado[$i]['ValidoHasta'])){
                        $cuota=(Float)$resultado[$i]['valor'];
                        $cuota=(Float)($cuota/100);
                    }
                }
            }
        }
        //sino no hay array es que no se a encntrado nada, por defecto se pone 0
        else{
            $cuota=0;
        }
        return $cuota;
    }
        
    private function sumaCuentaPeriodo($db,$cuenta,$fechaInicio,$fechaFin){
        $strSQL="
                SELECT round(sum(M.cantidad),2) AS cantidad
                FROM tbmovimientos M
                WHERE M.idCuenta LIKE '$cuenta%'
                AND M.fechaApunte>='".fecha_to_DATETIME($fechaInicio)."'
                AND M.fechaApunte<='".fecha_to_DATETIME($fechaFin)."'
                AND M.Borrado=1            
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->sumaCuentaPeriodo()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        //compruebo que la consulta SQL es correcta, si lo es guardo los datos en un array, sino devuelvo false
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->sumaCuentaPeriodo()<TRUE");
            $row=  mysql_fetch_array($stmt);
            $resultado=0;
            if($row['cantidad']<>null){
                $resultado=$row['cantidad'];
            }
            return (Float) $resultado;
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->sumaCuentaPeriodo()<FALSE");
            return 0;
        }
    }
    
    function guardarAutonomo130($Ejercicio,$numTrimestre,$casilla01,$casilla02,
                                $casilla03,$casilla04,$casilla05,$casilla06){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //averiguo el valor mas alto de IdEmpleado de la tabla tbempleados
        $strSQL = 'SELECT IdAut130 FROM tbautonomo130 ORDER BY IdAut130 DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarAutonomo130()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $IdAut130=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $IdAut130=$row['IdAut130']+1;
            }else{
                $IdAut130=1;
            }
        }else{
            //si ha fallado la consulta DEVOLVEMOS false
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarAutonomo130()<FALSE");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarAutonomo130()|| IdAut130 Nuevo : ".$IdAut130);
        
        $strSQL="
                INSERT INTO tbautonomo130
                VALUES ($IdAut130,$Ejercicio,$numTrimestre,$casilla01,$casilla02,$casilla03,$casilla04,$casilla05,$casilla06)
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->guardarAutonomo130()|| SQL : ".$strSQL);

        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la insercion DEVOLVEMOS false
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->guardarAutonomo130()<FALSE");
            return false;
        }
        
        //si hemos llegado hasta aqui es que esta todo OK por lo que devuelvo true
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarAutonomo130()<TRUE");
        return true;
    }
    
    function ListadoModContactos($strNomEmpresa,$strNombre,$strCIF,$strApellidos,$lngCP,$strCiudad){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBDCliente());

        //hago el select en la tabla 'tbmiscontactos' y 'tbcuenta'
        $strSQL="
                SELECT CO.IdContacto,CO.IdCliProv,CO.NombreEmpresa,CO.Ciudad,CO.NombreContacto,CO.ApellidosContacto,CO.FormaPagoHabitual,CU.NumCuenta
                FROM tbmiscontactos CO LEFT JOIN tbcuenta CU ON CU.IdCuenta=CO.IdCuenta
                WHERE (CO.Borrado=1 OR CU.Borrado=0)
                ";

        //añado los filtros de la consulta
        if($strNomEmpresa <> ''){
            $strSQL = $strSQL . " AND CO.NombreEmpresa LIKE '%" . $strNomEmpresa . "%'";
        }
        
        if($strNombre <> ''){
            $strSQL = $strSQL . " AND CO.NombreContacto LIKE '%" . $strNombre . "%'";
        }
        
        if($strCIF <> ''){
            $strSQL = $strSQL . " AND CO.CIF LIKE '" . $strCIF . "%'";
        }
        
        if($strApellidos <> ''){
            $strSQL = $strSQL . " AND CO.ApellidosContacto LIKE '%" . $strApellidos . "%'";
        }
        
        if($lngCP <> ''){
            $strSQL = $strSQL . " AND CO.CodPostal LIKE '" . $lngCP . "%'";
        }
        
        if($strCiudad <> ''){
            $strSQL = $strSQL . " AND CO.Ciudad LIKE '" . $strCiudad . "%'";
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoModContactos()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        //introduzco los datos en un array y lo devuelvo
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoModContactos()<TRUE");
            $resultado=array();
            
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoModContactos()<FALSE");
            return false;
        }
        
        //ahora veo si el campo 'IdCliProv' tiene datos (distinto de 0 o NULL), si es asi es que esta cuenta
        //está guardada en BBDD contabilidad (tbcliprov y tbrelacioncliprov) y por tanto es cliente por lo que no aparece
        //en este listado (ya aparece en el listado de clientes)

        //recorro el array y busco la cuenta segun el IdCliProv
        $resultFinal='';
        for($i=0;$i<count($resultado);$i++){
            if(($resultado[$i]['IdCliProv']===NULL || $resultado[$i]['IdCliProv']==='0')){
                $resultFinal[]=$resultado[$i];
            }
        }
        
        
        return $resultFinal;
    }

    function DatosContacto($IdContacto){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //extraigo los datos del contacto de la tabla 'tbmiscontactos'
        $strSQL="
                SELECT CO.*,CU.NumCuenta
                FROM tbmiscontactos CO LEFT JOIN tbcuenta CU ON CU.IdCuenta=CO.IdCuenta
                WHERE (CO.Borrado=1
                OR CU.Borrado=0)
                AND CO.IdContacto=".$IdContacto
                ;

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->DatosContacto($IdContacto)|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
//        $db->desconectar ();
        
        //introduzco los datos en un array y lo devuelvo
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->DatosContacto($IdContacto)<TRUE");
            
            $row=  mysql_fetch_array($stmt);
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            
            //busco si tiene presupuestos
            $strSQL = "
                        SELECT IdPresupuesto
                        FROM tbmispresupuestos
                        WHERE Contacto_Cliente='CO.$IdContacto' AND Borrado = 1
                      ";

            $stmt = $db->ejecutar ( $strSQL );
            $db->desconectar ();

            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->DatosContacto($IdContacto)|| SQL : ".$strSQL);

            $reg['TienePresupuestos']='NO';
            $num=  mysql_num_rows($stmt);
            if($num>0){
                $reg['TienePresupuestos']='SI';
            }else{
                $reg['TienePresupuestos']='NO';
            }
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->DatosContacto($IdContacto)<FALSE");
            return false;
        }
        
        return $reg;
    }
    
    function EditarContacto($usuario,$IdContacto,$strNomEmpresa,$strCIF,$strDireccion,$strMunicipio,$lngCP,$strProvincia,$strNombre,
                                        $strApellidos,$strTelefono,$strMovil,$strEmail,$strNotas,$strFormaPago){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarContacto() || START TRANSACTION");
        
        //actualizo los datos del contacto en la tabla 'tbmiscontactos'
        //actualizamos los datos del empleado
        $strSQL = "UPDATE tbmiscontactos SET ".
                  "NombreEmpresa='".$strNomEmpresa."',
                   CIF='".$strCIF."',
                   Direccion='".$strDireccion."',
                   Ciudad='".$strMunicipio."',
                   CodPostal='".$lngCP."',
                   Provincia='".$strProvincia."',
                   NombreContacto='".$strNombre."',
                   ApellidosContacto='".$strApellidos."',
                   Telefono='".$strTelefono."',
                   TelefonoMovil='".$strMovil."',
                   Correo='".$strEmail."',
                   Notas='".mysql_real_escape_string($strNotas)."',
                   FormaPagoHabitual='".$strFormaPago."',
                   datFechaStatus=now(),
                   lngIdEmpleadoStatus='".$usuario."'
                   WHERE IdContacto=".$IdContacto;
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarContacto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarContacto()<FALSE");
            return false;
        }
            
        //ahora si hay datos en el campo tbmiscontactos.IdCuenta, actualizo la tabla tbcuenta
        $strSQL = "SELECT IdCuenta FROM tbmiscontactos 
                   WHERE IdContacto=".$IdContacto;
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarContacto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarContacto()<FALSE");
            return false;
        }
        
        $row=mysql_fetch_array($stmt);

        if($row['IdCuenta']<>NULL){
            $strSQL = "UPDATE tbcuenta
                       SET Nombre='$strNomEmpresa'
                       WHERE Borrado=0
                       AND IdCuenta=".$row['IdCuenta'];

            $stmt = $db->ejecutar ( $strSQL );

            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarContacto()<FALSE");
                return false;
            }
        }
        
        //si hemos llegado hasta aqui es que esta todo OK por lo que damos COMMIT y devuelvo true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarContacto()<TRUE");
        
        return true;
    }

    function AltaContacto($usuario,$strNomEmpresa,$strCIF,$strDireccion,$strMunicipio,$lngCP,$strProvincia,$strNombre,
                                        $strApellidos,$strTelefono,$strMovil,$strEmail,$strNotas,$strFormaPago){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //averiguo el valor mas alto de IdContacto de la tabla tbmiscontactos
        $strSQL = 'SELECT IdContacto FROM tbmiscontactos ORDER BY IdContacto DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaContacto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $IdContacto=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $IdContacto=$row['IdContacto']+1;
            }else{
                $IdContacto=1;
            }
        }else{
            //si ha fallado la consulta DEVOLVEMOS false
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaContacto()<FALSE");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaContacto()|| IdContacto Nuevo : ".$IdContacto);
        
        //campo $lngCP si viene vacio introducir NULL
        if($lngCP===''){
            $lngCP='NULL';
        }
        
        //ahora hacemos la inserción del contacto
        $strSQL="INSERT INTO tbmiscontactos (IdContacto,IdCliProv,NombreEmpresa,CIF,Direccion,Ciudad,CodPostal,
                                          Provincia,NombreContacto,ApellidosContacto,Telefono,TelefonoMovil,Correo,
                                          Notas,FormaPagoHabitual,Borrado,datFechaStatus,lngIdEmpleadoStatus)
                 VALUES ($IdContacto,0,'$strNomEmpresa','$strCIF','$strDireccion','$strMunicipio',$lngCP,
                         '$strProvincia','$strNombre','$strApellidos','$strTelefono','$strMovil','$strEmail',
                '".mysql_real_escape_string($strNotas)."','$strFormaPago',1,now(),$usuario)";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->AltaContacto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la insercion DEVOLVEMOS false
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaContacto()<FALSE");
            return false;
        }
        
        //si hemos llegado hasta aqui es que esta todo OK por lo que devuelvo true
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaContacto()<TRUE");
        return $IdContacto;
    }

    function leerIdCliProv_tbcliprov($strCIF){
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL = "
                    SELECT IdCliProv
                    FROM tbcliprov
                    WHERE CIF='$strCIF'
                    AND Borrado=0
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->leerIdCliProv_tbcliprov()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar ();
        if($stmt){
            $row=  mysql_fetch_assoc($stmt);
            $IdCliProv=$row['IdCliProv'];
        }else{
            //si ha fallado la consulta DEVOLVEMOS false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->leerIdCliProv_tbcliprov()<FALSE");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->leerIdCliProv_tbcliprov()|| tbcliprov.IdCliProv : ".$IdCliProv);
        
        return $IdCliProv;
    }
    
    function Actualizar_tbmiscontactos_IdCliProv_IdContacto($IdCliProv,$IdContacto){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //actualizo en la tabla 'tbmiscontactos' el IDCliProv del contacto IdContacto
        $strSQL = "UPDATE tbmiscontactos SET ".
                  "IdCliProv=".$IdCliProv."
                   WHERE IdContacto=".$IdContacto;
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->Actualizar_tbmiscontactos_IdCliProv_IdContacto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            return true;
        }else{
            return false;
        }
    }
    
    function AltaClienteExistente($IdCliProv,$strNomEmpresa,$strCIF,$lngCP,$strDireccion,
                                   $strMunicipio,$strProvincia,$strEmail,$strTelefono,
                                   $lngCodigo,$numCuenta,$numEmpresa,$cliProv){
        //conexion BBDD contabilidad
        require_once '../general/conexion.php';
        $dbG = new DbC();
        $dbG->conectar($this->getStrBD());
        
        //primero insertamos en la tabla 'tbrelacioncliprov' de la BBDD contabilidad
        //buscamos el numero mas alto de 'IdRelacionCliProv'
        $strSQL='SELECT IdRelacionCliProv FROM tbrelacioncliprov ORDER BY IdRelacionCliProv DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->AltaClienteExistente()|| SQL : ".$strSQL);
        $stmt1 = $dbG->ejecutar ( $strSQL );
        if($stmt1){
            $num1=  mysql_num_rows($stmt1);
            $IdRelacionCliProv=0;
            if($num1>0){
                $row=  mysql_fetch_assoc($stmt1);
                $IdRelacionCliProv=$row['IdRelacionCliProv']+1;
            }else{
                $IdRelacionCliProv=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $dbG->ejecutar ("ROLLBACK");
            $dbG->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->AltaClienteExistente()<ROLLBACK");
            return false;
        }
        
        // Y ahora hacemos la insercion
        $strSQL="INSERT INTO tbrelacioncliprov (IdRelacionCliProv, IdEmpresa, Codigo, IdCliProv,Borrado,CliProv)
                 VALUES ( " . $IdRelacionCliProv . " , " . $numEmpresa . ",'" . $lngCodigo . "'," . $IdCliProv . ", '0' , " . $cliProv . ")";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->AltaClienteExistente()|| SQL : ".$strSQL);
        $stmt2 = $dbG->ejecutar ( $strSQL );
        
        if(!$stmt2){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $dbG->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->AltaClienteExistente()<FALSE");
            return false;
        }
        
        //guardo la IdRelacionCliProv por si falla poder deshacer esta insercion
        //preparo la consulta por si falla esta transaccion para poder desaherla
        $strSQLDeshacer1="DELETE FROM tbrelacioncliprov WHERE IdRelacionCliProv=".$IdRelacionCliProv;
        
        //segundo inserto la cuenta en la tabla 'tbcuenta' de la BBDD cliente
        require_once '../general/'.$_SESSION['mapeo'];
        $dbCliente = new Db();
        $dbCliente->conectar($this->getStrBD());
        
        $strSQL='SELECT IdCuenta FROM tbcuenta ORDER BY IdCuenta DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->AltaClienteExistente()|| SQL : ".$strSQL);
        $stmt3 = $dbCliente->ejecutar ( $strSQL );
        if($stmt3){
            $num2=  mysql_num_rows($stmt3);
            $numeroCuenta=0;
            if($num2>0){
                $row=  mysql_fetch_assoc($stmt3);
                $numeroCuenta=$row['IdCuenta']+1;
            }else{
                $numeroCuenta=1;
            }
        }else{
            //si ha fallado la consulta borramos la insercion en la BBDD contabilidad en la tabla 
            //'tbrelacioncliprov' segun el campo IdRelacionCliProv y DEVOLVEMOS false
            $dbCliente->desconectar ();
            //vuelvo a conectarme a la BBDD contabilidad
            $dbG->conectar($this->getStrBD());
            //borramos los datos de la tabla 'tbrelacioncliprov'
            $stmtB1=$dbG->ejecutar($strSQLDeshacer1);
            $dbG->desconectar();
            if($stmtB1==true){
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->AltaClienteExistente()<ERROR (se deshace la insercion de la tabla 'tbrelacioncliprov' por el campo IdRelacionCLiProv=$IdRelacionCliProv");
            }else{
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->AltaClienteExistente()<ERROR: NO SE HA BORRADO LOS DATOS ORIGINALES DE LA TABLA 'tbrelacioncliprov' por el campo IdRelacionCLiProv=$IdRelacionCliProv");
            }
            return false;
        }
        
        // Y ahora hacemos la insercion
        $strSQL="INSERT INTO tbcuenta (IdCuenta, NumCuenta, Grupo, SubGrupo2, SubGrupo4, Nombre, Borrado)
                 VALUES (" . $numeroCuenta . " , '" . $numCuenta . "'," . substr($numCuenta,0,1) . "," . substr($numCuenta,0,2) .
                 "," . substr($numCuenta,0,4) . ",'$strNomEmpresa',0)";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->AltaClienteExistente()|| SQL : ".$strSQL);
        $stmt4 = $dbCliente->ejecutar ( $strSQL );
        
        if(!$stmt4){
            //si ha fallado la insercion, borramos la insercion en la BBDD contabilidad en la tabla 
            //'tbrelacioncliprov' segun el campo IdRelacionCliProv y DEVOLVEMOS false
            $dbCliente->desconectar ();
            //vuelvo a conectarme a la BBDD contabilidad
            $dbG->conectar($this->getStrBD());
            //borramos los datos de la tabla 'tbrelacioncliprov'
            $stmtB1=$dbG->ejecutar($strSQLDeshacer1);
            $dbG->desconectar();
            if($stmtB1==true){
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->AltaClienteExistente()<ERROR (se deshace la insercion de la tabla 'tbrelacioncliprov' por el campo IdRelacionCLiProv=$IdRelacionCliProv");
            }else{
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->AltaClienteExistente()<ERROR: NO SE HA BORRADO LOS DATOS ORIGINALES DE LA TABLA 'tbrelacioncliprov' por el campo IdRelacionCLiProv=$IdRelacionCliProv");
            }
            return false;
        }
        
        //-------------------------------------------------------------
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $dbCliente->desconectar ();
        $dbG->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADUsu->Contabilidad->AltaClienteExistente()<COMMIT");
        return true;
    }

    function contactoBorrar($id){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();
        require_once '../general/conexion.php';
        $dbG = new DbC();

        //primero borro de la tabla 'tbmiscontactos'
        $strSQL = "UPDATE tbmiscontactos " .
                  "SET Borrado=0" .
                  " WHERE IdContacto =" . $id;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->contactoBorrar($id)|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBD());
        $stmt = $dbC->ejecutar ( $strSQL );
        if(!$stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->contactoBorrar($id)<FALSE");
            $dbC->desconectar();
            return false;
        }
        //prepardo la consulta para desaher la actualizacion anterior por si falla esta funcion
        $strSQLDeshacer1 = "UPDATE tbmiscontactos " .
                  "SET Borrado=1" .
                  " WHERE IdContacto =" . $id;
        
        //ahora compruebo si tbmiscontactos.IdCliProv es 0 o null = contacto o sino no es cliente (numero <>0)
        $strSQL="SELECT IdCliProv FROM tbmiscontactos WHERE IdContacto=".$id;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->contactoBorrar($id)|| SQL : ".$strSQL);
        $stmt = $dbC->ejecutar ( $strSQL );
        $row=  mysql_fetch_array($stmt);
        $dbC->desconectar();
        if(!($row['IdCliProv']==0 || $row['IdCliProv']==null)){
            // es cliente
            //hay que borrar en las tablas 'tbcuenta' y 'tbrelacioncliprov' 
            //primero en la tabla 'tbrelacioncliprov' con el IdCliProv averiguo la cuenta
            //(campo CliProv=0 que es cliente y campo codigo, con estos tengo el numero de cuenta)
            $dbG->conectar($this->getStrBD());
            
            $strSQL = "SELECT IdRelacionCliProv,codigo " .
                      "FROM tbrelacioncliprov" .
                      " WHERE Borrado=0 AND CliProv=0 AND IdEmpresa=".$_SESSION['idEmp']
                    . " AND IdCliProv =" . $row['IdCliProv'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->contactoBorrar($id)|| SQL : ".$strSQL);
            
            $stmt = $dbG->ejecutar ( $strSQL );
            $dbG->desconectar();
            
            if(!$stmt){
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->contactoBorrar($id)<FALSE");
                //como ha fallado la consulta el resto de la funcion ya no es valido
                //deshacemos las operaciones hechas contra la BBDD
                $dbC->conectar($this->getStrBD());
                $stmt2 = $dbC->ejecutar ( $strSQLDeshacer1 );
                $dbC->desconectar();
                if($stmt2){
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->contactoBorrar($id)<ERROR (se deshace el borrado de la tabla 'tbmiscontactos' por el campo IdContacto=$id");
                }else{
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->contactoBorrar()<ERROR: NO SE HA ACTUALIZADO LOS DATOS ORIGINALES DE LA TABLA 'tbmiscontactos' por el campo IdContacto=$id");
                }
                return false;
            }
            
            //ahora borro este registro de la tabla 'tbrelacioncliprov'
            $row=  mysql_fetch_array($stmt);
            $IdRCliProv=$row['IdRelacionCliProv'];
            $cuenta='4300'.$row['codigo'];
            
            $strSQL = "UPDATE tbrelacioncliprov " .
                      "SET Borrado=1" .
                      " WHERE IdRelacionCliProv=".$IdRCliProv;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->contactoBorrar($id)|| SQL : ".$strSQL);
            
            $dbG->conectar($this->getStrBD());
            $stmt = $dbG->ejecutar ( $strSQL );
            $dbG->desconectar();
            
            //preparo la consulta para desaher la actualizacion anterior por si falla esta funcion
            $strSQLDeshacer2 = "UPDATE tbrelacioncliprov " .
                               "SET Borrado=0" .
                               " WHERE IdRelacionCliProv=".$IdRCliProv;
            
            if(!$stmt){
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->contactoBorrar($id)<FALSE");
                //como ha fallado la consulta el resto de la funcion ya no es valido
                //deshacemos las operaciones hechas contra la BBDD (solo strSQLDeshacer1 ya que esta ha fallado
                $dbC->conectar($this->getStrBD());
                $stmt1 = $dbC->ejecutar ( $strSQLDeshacer1 );
                $dbC->desconectar();
                if($stmt1){
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->contactoBorrar($id)<ERROR (se deshace el borrado de la tabla 'tbmiscontactos' por el campo IdContacto=$id");
                }else{
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->contactoBorrar()<ERROR: NO SE HA ACTUALIZADO LOS DATOS ORIGINALES DE LA TABLA 'tbmiscontactos' por el campo IdContacto=$id");
                }
                return false;
            }
            
            //ahora borro este registro de la tabla 'tbcuenta'
            $strSQL = "UPDATE tbcuenta " .
                      "SET Borrado=1" .
                      " WHERE NumCuenta='$cuenta'";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->contactoBorrar($id)|| SQL : ".$strSQL);
            
            $dbC->conectar($this->getStrBD());
            $stmt = $dbC->ejecutar ( $strSQL );
            $dbC->desconectar();
            
            if(!$stmt){
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->contactoBorrar($id)<FALSE");
                //como ha fallado la consulta el resto de la funcion ya no es valido
                //deshacemos las operaciones hechas contra la BBDD (solo strSQLDeshacer1 y strSQLDeshacer2 ya que esta ha fallado
                $dbC->conectar($this->getStrBD());
                $stmt1 = $dbC->ejecutar ( $strSQLDeshacer1 );
                $dbC->desconectar();
                if($stmt1){
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->contactoBorrar($id)<ERROR (se deshace el borrado de la tabla 'tbmiscontactos' por el campo IdContacto=$id");
                }else{
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->contactoBorrar()<ERROR: NO SE HA ACTUALIZADO LOS DATOS ORIGINALES DE LA TABLA 'tbmiscontactos' por el campo IdContacto=$id");
                }
                $dbG->conectar($this->getStrBD());
                $stmt2 = $dbG->ejecutar ( $strSQLDeshacer2 );
                $dbG->desconectar();
                if($stmt2){
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->contactoBorrar($id)<ERROR (se deshace el borrado de la tabla 'tbrelacioncliprov'");
                }else{
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->contactoBorrar()<ERROR: NO SE HA ACTUALIZADO LOS DATOS ORIGINALES DE LA TABLA 'tbrelacioncliprov' por el campo IdRelacionCliProv=".$IdRCliProv);
                }
                return false;
            }
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->contactoBorrar()<TRUE");
        
        //si todas las operaciones estan correctas devolvemos true
        return true;
    }

    function listadoClientes(){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();
        
        //segundo leo los clientes que tengo en la tabla 'tbcuenta'
        $strSQL = "
                    SELECT NumCuenta,Nombre AS NombreEmpresa FROM tbcuenta WHERE NumCuenta LIKE '4300%' AND Borrado=0
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->listadoClientes()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBD());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();
        
        //introduzco los datos en un array $clientes
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->listadoClientes()<TRUE");
            
            $clientes='';
            
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $clientes[]=$reg;
            }
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->listadoContactos()<FALSE");
            return false;
        }

        return $clientes;
    }
    
    
    function listadoContactos(){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();
        $dbC->conectar($this->getStrBD());

        //primero busco en la tabla 'tbmiscontactos'
        $strSQL = "SELECT IdContacto,NombreEmpresa,NombreContacto,ApellidosContacto FROM tbmiscontactos WHERE Borrado=1 AND IdCliProv=0";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->listadoContactos()|| SQL : ".$strSQL);
        $stmt = $dbC->ejecutar ( $strSQL );
        
        //introduzco los datos en un array $contactos
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->listadoContactos()<TRUE");

            $contactos='';
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $contactos[]=$reg;
            }
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->listadoContactos()<FALSE");
            return false;
        }
        
        //segundo leo los clientes que tengo en la tabla 'tbcuenta'
        $strSQL = "
                    SELECT NumCuenta,Nombre AS NombreEmpresa FROM tbcuenta WHERE NumCuenta LIKE '4300%' AND Borrado=0
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->listadoContactos()|| SQL : ".$strSQL);
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();
        
        //introduzco los datos en un array $clientes
        if($stmt){
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->listadoContactos()<TRUE");
            
            $clientes='';
            
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $clientes[]=$reg;
            }
        }else{
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->listadoContactos()<FALSE");
            return false;
        }

        //ahora preparo un array resultado de los dos arrays $contactos y $clientes
        $resultado='';
        $i=0;
        if(is_array($contactos)){
            foreach($contactos as $contacto){
                foreach($contacto as $propiedad=>$valor){
                    $resultado[$i][$propiedad]=$valor;
                }
                $i++;
            }
        }
        if(is_array($clientes)){
            foreach($clientes as $cliente){
                foreach($cliente as $propiedad=>$valor){
                    $resultado[$i][$propiedad]=$valor;
                }
                $i++;
            }
        }
        
        return $resultado;
    }
    
    function EditarFactura($usuario,$post){
        //lo primero que hacemos es guardar todas las lineas de factura en un array
        //buscamos todo lo que comienze por 'cantidad..'
        
        $lineasPresupuesto='';
        foreach($post as $propiedad=>$valor){
            //si $propiedad = 'cantidad..' recojo el resto de datos en el array
            //(cantidad,concepto,importe,iva,cuota)
            
            //busco cantidad 
            if(substr($propiedad,0,13)==='idPresupLinea'){
                //extraigo en numero de cantidad para buscar el resto de valores que terminen en ese numero 
                //(son de la misma linea de factura)
                $num=substr($propiedad,13,3);
                //concepto
                $propConcepto='concepto'.$num;
                $valorConcepto=$post[$propConcepto];
                //cambio las comillas simples si hay por dobles, me da error sino al leer este dato el formulario html
                $valorConcepto = str_replace("'", "\"", $valorConcepto);
                
                //IdArticulo
                $propIdArticulo='IdArticulo'.$num;
                $valorIdArticulo=$post[$propIdArticulo];
                
                //cantidad
                $propCantidad='cantidadHidden'.$num;
                $valorCantidad=$post[$propCantidad];
                if($valorCantidad === ''){
                    $valorCantidad = 0;
                }
                
                //cuentaArticulo
                $propCuenta='cuenta'.$num;
                $valorCuenta=$post[$propCuenta];
                
                //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
                $cuentaContable=$this->Parametro_general('cuentaContable',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
                
                //esta vacio, se le asigna la cuenta por defecto
                if($valorCuenta === '' || $valorCuenta === '0'){
                    $valorCuenta=$cuentaContable;
                }
                
                //importe
                $propImporte='importe'.$num;
                $valorImporte=$post[$propImporte];
                //importe unidad (precio)
                $propPrecio='precio'.$num;
                $valorPrecio=$post[$propPrecio];
                
                //iva
                $propIVA='iva'.$num;
                $valorIVA=$post[$propIVA];
                
                //cuota
                $propCuota='cuota'.$num;
                $valorCuota=$post[$propCuota];
                
                //si vienen vacias las vble $valor y $valorImporte, les asigno 0
                if($valor===''){
                    $valor=0;
                }
                if($valorPrecio===''){
                    $valorPrecio=0;
                }
                
                //compruebo que la cuota viene bien (importe * IVA / 100), sino la recalculo
                //por si del formulario viene mal 
                $comprobarImporte = desFormateaNumeroContabilidad($valorImporte);
                $comprobarCuota = desFormateaNumeroContabilidad($valorCuota);
                $cuotaCalculada = round($comprobarImporte * $valorIVA,2);
                
                if((int)($comprobarCuota * 100) !== (int)($cuotaCalculada)){
                    $cuotaCalculada = (float) $cuotaCalculada / 100;
                    $valorCuota = formateaNumeroContabilidad($cuotaCalculada);
                }
                
                //ahora guardo el valor en el array
                $lineasPresupuesto[]=array(
                    "idPresupLinea"=>$post['idPresupLinea'.$num],
                    "numLineaPresup"=>$post['numLineaPresup'.$num],
                    "idPedidoLinea"=>$post['idPedidoLinea'.$num],
                    "numLineaPedido"=>$post['numLineaPedido'.$num],
                    "cantidad"=>$valorCantidad,
                    "IdArticulo"=>$valorIdArticulo,
                    "cuentaArticulo"=>$valorCuenta,
                    "concepto"=>$valorConcepto,
                    "importeUnidad"=>desFormateaNumeroContabilidad($valorPrecio),
                    "importe"=>desFormateaNumeroContabilidad($valorImporte),
                    "IVA"=>desFormateaNumeroContabilidad($valorIVA),
                    "cuota"=>desFormateaNumeroContabilidad($valorCuota),
                );
            }
        }
        
        //hay que guardar los datos en las tablas 'tbmispresupuestos' y 'tbmispresupuestoslineas'
        
        //guardo el numero de proyecto con este formato '20140001' donde las 4 primeras cifras son el año y las 4 ultimas la numeracion
        //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
        $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        
        //ahora segun el tipo de contador calculo en nuevo numero
        $numeroNuevoPresupuesto = $post['numPresupuestoBBDD'];
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        
        $strSQL = "SELECT Estado,Situacion,asiento FROM tbmisfacturas WHERE IdFactura=".$post['IdFactura'];
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $EstadoSituacion='';
        if($stmt){
            $num=  mysql_num_rows($stmt);
            //veo si hay facturas anteriores emitidas
            if($num>0){//si hay, las sumo
                while($row=  mysql_fetch_array($stmt)){
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $EstadoSituacion[$propiedad]=$valor;
                        }
                    }
                }
            }
        }else{
            //si ha fallado la consulta hacemos DEVOLVEMOS false
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarFactura()<ROLLBACK");
            return 'false';
        }
        
        
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarFactura() || START TRANSACTION");

        //obtengo el idFactura
        $strSQL = "SELECT idFactura FROM tbmisfacturas ORDER BY idFactura DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $idFactura=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idFactura=$row['idFactura']+1;
            }else{
                $idFactura=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarFactura()<ROLLBACK");
            return 'false';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarFactura()|| idFactura : ".$idFactura);

        //si existe $post['IdPresupuesto'] y es distinto de vacio, lo pongo, sino inserto 0
        $IdPresup=0;
        if(isset($post['IdPresupuesto']) && $post['IdPresupuesto']<>''){
            $IdPresup=$post['IdPresupuesto'];
        }
        
        //si existe $post['IdPedido'] y es distinto de vacio, lo pongo, sino inserto 0
        $IdPedido=0;
        if(isset($post['IdPedido']) && $post['IdPedido']<>''){
            $IdPedido=$post['IdPedido'];
        }
        
        //controlosi viene vacio el dato $post['validez']
        if(!isset($post['validez']) || $post['validez'] === ''){
            $post['validez']=0;
        }

        //formateo la fecha, viene 2015/03/03 y la paso a DATETIME
        $fechaFactura = explode('/',$post['fechaPresup']);
        //compruebo si la ultima viene el año (4 numeros)
        if(strlen($fechaFactura[2]) == 4){
            $fechaFactura = $post['fechaPresup'];
        }else{
            $fechaFactura = $fechaFactura[2].'/'.$fechaFactura[1].'/'.$fechaFactura[0];
        }
        
        //inserto en la tabla 'tbmisfacturas'
        $strSQL = "
                    INSERT INTO tbmisfacturas (IdFactura,NumFactura,IdPresupuesto,IdPedido,Cliente,FechaFactura,
                                FechaVtoFactura,FormaPago,Estado,Retencion,lngIdUsuario,Borrado,Situacion,asiento,Referencia,CC_Trans,esAbono) 
                    VALUES ($idFactura,'".$numeroNuevoPresupuesto."',".$IdPresup.",".$IdPedido.",'".$post['Contacto']."','".fecha_to_DATETIME($fechaFactura)."',ADDDATE('".fecha_to_DATETIME($fechaFactura)."',".$post['validez']."),
                            '".$post['FormaPagoHabitual']."','".$EstadoSituacion['Estado']."',".$post['irpf'].",$usuario,1,
                   '".$EstadoSituacion['Situacion']."','".$EstadoSituacion['asiento']."','".$post['Referencia']."','".$post['CC_Trans']."','".$post['esAbono']."')
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->EditarFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarFactura()<ROLLBACK");
            return 'false';
        }

        //ahora vamos a insertar las lineas de la factura (una insercion por cada linea) en la tabla 'tbmisfacturaslineas'
        //recorro el array $lineasPresupuesto
        for($i=0;$i<count($lineasPresupuesto);$i++){
            //saco el numero line nuevo
            $numLinea=$this->numeroFacturaLineaNueva($db);
            
            //si existe $lineasPresupuesto[$i]['idPresupLinea'] y es distinto de vacio, lo pongo, sino inserto 0
            $IdPresupL=0;
            if(isset($lineasPresupuesto[$i]['idPresupLinea']) && $lineasPresupuesto[$i]['idPresupLinea']<>''){
                $IdPresupL=$lineasPresupuesto[$i]['idPresupLinea'];
            }
            
            $numLineaPresup=0;
            if(isset($lineasPresupuesto[$i]['numLineaPresup']) && $lineasPresupuesto[$i]['numLineaPresup']<>''){
                $numLineaPresup=$lineasPresupuesto[$i]['numLineaPresup'];
            }
            
            //si existe $lineasPresupuesto[$i]['idPedidoLinea'] y es distinto de vacio, lo pongo, sino inserto 0
            $IdPedidoL=0;
            if(isset($lineasPresupuesto[$i]['idPedidoLinea']) && $lineasPresupuesto[$i]['idPedidoLinea']<>''){
                $IdPedidoL=$lineasPresupuesto[$i]['idPedidoLinea'];
            }
            
            $numLineaPedido=0;
            if(isset($lineasPresupuesto[$i]['numLineaPedido']) && $lineasPresupuesto[$i]['numLineaPedido']<>''){
                $numLineaPedido=$lineasPresupuesto[$i]['numLineaPedido'];
            }
            

            //controlo el IdArticulo
            //si este viene vacio es NULL
            $IdArticulo = $lineasPresupuesto[$i]['IdArticulo'];
            if($IdArticulo === ''){
                $IdArticulo = 'NULL';
            }
            
            //controlo el cuentaArticulo
            //si este viene vacio es NULL
            $cuentaArticulo = $lineasPresupuesto[$i]['cuentaArticulo'];
            if($cuentaArticulo === ''){
                $cuentaArticulo = 'NULL';
            }

            
            $numLineaFact=$i+1;
            //inserto en la tabla 'tbmisfacturaslineas'
            $strSQL = "
                        INSERT INTO tbmisfacturaslineas (IdFacturaLineas,IdFactura,NumLineaFactura,NumLineaPresup,IdPresupLineas,NumLineaPedido,IdPedidoLineas,IdArticulo,cuentaArticulo,DescripcionProducto,
                                    TipoIVA,CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,ImportePEN,
                                    CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN,GenFacPed,Facturada) 
                        VALUES ($numLinea,$idFactura,$numLineaFact,$numLineaPresup,$IdPresupL,$numLineaPedido,$IdPedidoL,$IdArticulo,$cuentaArticulo,'".$lineasPresupuesto[$i]['concepto']."',".$lineasPresupuesto[$i]['IVA'].",".$lineasPresupuesto[$i]['cantidad'].",
                                0,0,".$lineasPresupuesto[$i]['importeUnidad'].",".$lineasPresupuesto[$i]['importe'].",0,0,".$lineasPresupuesto[$i]['cuota'].",0,0,'NO','NF')
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->EditarFactura()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarFactura()<ROLLBACK");
                return 'false';
            }
        }

        
        //ahora busco todos los pedidos y facturas que haya asociadas a este presupuesto (que se emitirieron anteriormente, si hay)
        //si $IdPresup=0 es que el pedido no tiene relaccion con el presupuesto
        if($IdPresup>0){
            //extraigo las facturas que tengan este presupuesto
            $facturasEmitidasAntDatos='';
            $strSQL = "
                        SELECT L.IdPresupLineas,ROUND(SUM(L.CantidadPED),2) AS CantidadPED,
                        ROUND(SUM(L.ImportePED),2) AS ImportePED,
                        ROUND(SUM(L.CuotaIvaPED),2) AS CuotaIvaPED
                        FROM tbmisfacturaslineas L,tbmisfacturas F
                        WHERE F.IdFactura=L.IdFactura
                        AND F.Borrado=1
                        AND F.IdPresupuesto=$IdPresup
                        GROUP BY L.IdPresupLineas
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $num=  mysql_num_rows($stmt);
                //veo si hay pedidos anteriores emitidos
                if($num>0){//si hay, las sumo
                    while($row=  mysql_fetch_array($stmt)){
                        $reg='';
                        foreach($row as $propiedad=>$valor){
                            if(!is_numeric($propiedad)){
                                $reg[$propiedad]=$valor;
                            }
                        }
                        //$facturasEmitidasAntDatos[$facturasEmitidasAnt[$i1]][]=$reg;
                        $facturasEmitidasAntDatos[]=$reg;
                    }
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarPedido()<ROLLBACK");
                return 'false';
            }
                
            //y ahora extraigo los pedidos que tengan este presupuesto
            $pedidosEmitidosAntDatos='';
            $strSQL = "
                        SELECT L.IdPresupLineas,ROUND(SUM(L.CantidadPED),2) AS CantidadPED,
                        ROUND(SUM(L.ImportePED),2) AS ImportePED,
                        ROUND(SUM(L.CuotaIvaPED),2) AS CuotaIvaPED
                        FROM tbmispedidoslineas L,tbmispedidos F
                        WHERE F.IdPedido=L.IdPedido
                        AND F.Borrado=1
                        AND F.IdPresupuesto=$IdPresup
                        GROUP BY L.IdPresupLineas                
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $num=  mysql_num_rows($stmt);
                //veo si hay pedidos anteriores emitidos
                if($num>0){//si hay, las sumo
                    while($row=  mysql_fetch_array($stmt)){
                        $reg='';
                        foreach($row as $propiedad=>$valor){
                            if(!is_numeric($propiedad)){
                                $reg[$propiedad]=$valor;
                            }
                        }
                        //$facturasEmitidasAntDatos[$facturasEmitidasAnt[$i1]][]=$reg;
                        $pedidosEmitidosAntDatos[]=$reg;
                    }
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarPedido()<ROLLBACK");
                return 'false';
            }
                
            $resultado = $facturasEmitidasAntDatos;
            if(is_array($resultado)){
                //hay datos en $resultados
                if(is_array($pedidosEmitidosAntDatos)){
                    for ($p = 0; $p < count($pedidosEmitidosAntDatos); $p++) {
                        for ($f = 0; $f < count($resultado); $f++) {
                            $encontrado = 'NO';
                            //si esta linea el IdPresupLineas es el mismo se suma
                            if($pedidosEmitidosAntDatos[$p]['IdPresupLineas'] === $resultado[$f]['IdPresupLineas']){
                                $resultado[$f]['CantidadPED'] = $resultado[$f]['CantidadPED'] + $pedidosEmitidosAntDatos[$p]['CantidadPED'];
                                $resultado[$f]['ImportePED'] = $resultado[$f]['ImportePED'] + $pedidosEmitidosAntDatos[$p]['ImportePED'];
                                $resultado[$f]['CuotaIvaPED'] = $resultado[$f]['CuotaIvaPED'] + $pedidosEmitidosAntDatos[$p]['CuotaIvaPED'];
                                $encontrado = 'SI';
                                break;
                            }
                        }
                        if($encontrado === 'NO'){
                            $row['IdPresupLineas'] = $pedidosEmitidosAntDatos[$p]['IdPresupLineas'];
                            $row['CantidadPED'] = $pedidosEmitidosAntDatos[$p]['CantidadPED'];
                            $row['ImportePED'] = $pedidosEmitidosAntDatos[$p]['ImportePED'];
                            $row['CuotaIvaPED'] = $pedidosEmitidosAntDatos[$p]['CuotaIvaPED'];
                            $resultado[]=$row;
                        }
                    }
                }
            }else{
                //no hay datos en $resultados
                if(is_array($pedidosEmitidosAntDatos)){
                    $resultado = $pedidosEmitidosAntDatos;
                }
            }
        }

        //ahora voy sumando y actualizando la tabla 'tbmispresupuestoslineas' 
        //recorro las facturas y las sumo por IdPresupLineas, lo guardo en un array
        //$resultado=$facturasEmitidasAntDatos;
        //recorro las lineas de cada factura
        for($i=0;$i<count($resultado);$i++){
            //vamos a sumar los valores de CantidadPED, ImportePED y CuotaIvaPED
            $datos='';
            $idx=1;
            if(is_array($resultado)){
                for($i=0;$i<count($resultado);$i++){
                    //veo si existe el array tiene algun dato (es array propiamente dicho)
                    if(is_array($datos)){
                        //busco si el registro existe en el array $datos (IdPresupLineas)
                        for($j=1;$j<=count($datos);$j++){
                            $encontrado='NO';
                            //si existe la IdPresupLineas, actualizo los datos
                            if($datos[$j]['IdPresupLineas']===$resultado[$i]['IdPresupLineas']){
                                $datos[$j]['CantidadPED']=$datos[$j]['CantidadPED']+$resultado[$i]['CantidadPED'];
                                $datos[$j]['ImportePED']=$datos[$j]['ImportePED']+$resultado[$i]['ImportePED'];
                                $datos[$j]['CuotaIvaPED']=$datos[$j]['CuotaIvaPED']+$resultado[$i]['CuotaIvaPED'];
                                $encontrado='SI';
                                break;
                            }
                        }
                        //compruebo si se encontro antes la IdPresupLineas
                        //si no se encontro es que no existe por lo que hay que insertarla
                        if($encontrado==='NO'){
                            $datos[$idx]=array(
                                'IdPresupLineas'=>$resultado[$i]['IdPresupLineas'],
                                'CantidadPED'=>$resultado[$i]['CantidadPED'],
                                'ImportePED'=>$resultado[$i]['ImportePED'],
                                'CuotaIvaPED'=>$resultado[$i]['CuotaIvaPED'],
                            );
                            $idx++;
                        }
                    }
                    //si no es array es que esta vacio, se inserta este dato
                    else{
                        $datos[$idx]=array(
                            'IdPresupLineas'=>$resultado[$i]['IdPresupLineas'],
                            'CantidadPED'=>$resultado[$i]['CantidadPED'],
                            'ImportePED'=>$resultado[$i]['ImportePED'],
                            'CuotaIvaPED'=>$resultado[$i]['CuotaIvaPED'],
                        );
                        $idx++;
                    }
                }
            }
        }
            
        //ahora voy a actualizar las lineas del presupuesto
        //como $datos son las sumas de todas las facturas anteriores por IdPresupLineas
        //en esta suma pueden no aparecer lineas que si estan en el presupuesto
        //guardo en un array estas lineas para despues poder indicar las que no aparecen pero que si estan 
        //en el presupuesto como GenFacPed=NO y Facturada=T
        $lineasPresupuestoFacturadas='';
        if(is_array($datos)){
            //CantidadFAC, ImporteFAC, CuotaIvaFAC, CantidadPEN, ImportePEN y CuotaIvaPEN
            //recorro las IdPresupLineas de cada factura
            for($ii=1;$ii<=count($datos);$ii++){
                //recorro las lineas del presupuesto y actualizo sus valores
                //primero recojo sus valores de CantidadPED, ImportePED y CuotaIvaPED
                $strSQL = "
                           SELECT CantidadPED, ImportePED, CuotaIvaPED
                           FROM tbmispresupuestoslineas
                           WHERE IdPresupLineas=".$datos[$ii]['IdPresupLineas']."
                           ";
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->EditarFactura()<ROLLBACK");
                    return 'false';
                }
                $row=  mysql_fetch_array($stmt);
                //CantidadFAC=CantidadPED y CantidadPEN=CantidadPED-CantidadFAC e idem com Importe y CuotaIva
                $CantidadFAC=$datos[$ii]['CantidadPED'];
                $CantidadPEN=round($row['CantidadPED']-$datos[$ii]['CantidadPED'],2);
                if($CantidadPEN<0){
                    $CantidadPEN=0;
                }
                $ImporteFAC=$datos[$ii]['ImportePED'];
                $ImportePEN=round($row['ImportePED']-$datos[$ii]['ImportePED'],2);
                if($ImportePEN<0){
                    $ImportePEN=0;
                }
                $CuotaIvaFAC=$datos[$ii]['CuotaIvaPED'];
                $CuotaIvaPEN=round($row['CuotaIvaPED']-$datos[$ii]['CuotaIvaPED'],2);
                if($CuotaIvaPEN<0){
                    $CuotaIvaPEN=0;
                }
                
                //el campo Facturada (T=Total, Parcial y NF)
                //si ImportePEN=0, es T, sino es M
                $Facturada='M';//Parcial
                if($ImportePEN==0){
                    $Facturada='T';
                }else if($ImporteFAC==0){
                    $Facturada='NF';
                }
                
                //el campo GenFacPed (Si/NO)
                //si $Facturada es T o M= SI, sino NO
                if($Facturada=='T' || $Facturada=='M'){
                    $GenFacPed='SI';
                }else{
                    $GenFacPed='NO';
                }
                
                $strSQL = "
                           UPDATE tbmispresupuestoslineas
                           SET CantidadFAC=$CantidadFAC,
                           ImporteFAC=$ImporteFAC,
                           CuotaIvaFAC=$CuotaIvaFAC,
                           CantidadPEN=$CantidadPEN,
                           ImportePEN=$ImportePEN,
                           CuotaIvaPEN=$CuotaIvaPEN,
                           Facturada='$Facturada',
                           GenFacPed='$GenFacPed'
                           WHERE IdPresupLineas=".$datos[$ii]['IdPresupLineas']."
                           ";
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->EditarFactura()<ROLLBACK");
                    return 'false';
                }
                $lineasPresupuestoFacturadas[]=$datos[$ii]['IdPresupLineas'];
            }
        }

        //primero extraigo las lineas del presupuesto
        $strSQL = "
                   SELECT IdPresupLineas
                   FROM tbmispresupuestoslineas
                   WHERE IdPresupuesto=".$post['IdPresupuesto']."
                   ";
        $stmt = $db->ejecutar ( $strSQL );
        $lineasPresupuesto='';
        if($stmt){
            $num=  mysql_num_rows($stmt);
            //veo si hay facturas anteriores emitidas
            if($num>0){//si hay, las sumo
                while($row=  mysql_fetch_array($stmt)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $lineasPresupuesto[]=$valor;
                        }
                    }
                }
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarFactura()<ROLLBACK");
            return 'false';
        }

        //ahora busco las lineas sin facturar
        $lineasSinFacturar='';
        for($i=0;$i<count($lineasPresupuesto);$i++){
            $lineaSinFacturar=array("numero"=>"","Esta"=>"");// SI/NO
            $lineaSinFacturar["numero"]=$lineasPresupuesto[$i];
            $lineaSinFacturar["Esta"]="NO";
            for($ii=0;$ii<count($lineasPresupuestoFacturadas);$ii++){
                if($lineasPresupuesto[$i]==$lineasPresupuestoFacturadas[$ii]){
                    $lineaSinFacturar["Esta"]="SI";
                    break;
                }
            }
            $lineasSinFacturar[]=$lineaSinFacturar;
        }

        //ahora estas lineas sin facturar les cambio los campos GenFacPed=NO y Facturada=NF
        foreach($lineasSinFacturar as $propiedad=>$valor){
            if($valor['Esta']==='NO'){
                $strSQL = "
                           UPDATE tbmispresupuestoslineas
                           SET GenFacPed='NO',
                           Facturada='NF'
                           WHERE IdPresupLineas=".$valor['numero']."
                           ";
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->EditarFactura()<ROLLBACK");
                    return 'false';
                }
            }
        }
        
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarFactura()|| COMMIT");
        
        $db->desconectar ();
        
        //todo correcto, devuelvo el IdFactura
        return $idFactura;
    }

    function AltaPedido($usuario,$post){
        //lo primero que hacemos es guardar todas las lineas del pedido en un array
        //buscamos todo lo que comienze por 'idPresupLinea..'
        
        $lineasPresupuesto='';
        foreach($post as $propiedad=>$valor){
            //si $propiedad = 'cantidad..' recojo el resto de datos en el array
            //(cantidad,concepto,importe,iva,cuota)
            
            //busco cantidad 
            if(substr($propiedad,0,13)==='idPedidoLinea'){
                //extraigo en numero de cantidad para buscar el resto de valores que terminen en ese numero 
                //(son de la misma linea de factura)
                $num=substr($propiedad,13,3);
                //concepto
                $propConcepto='concepto'.$num;
                $valorConcepto=$post[$propConcepto];
                //cambio las comillas simples si hay por dobles, me da error sino al leer este dato el formulario html
                $valorConcepto = str_replace("'", "\"", $valorConcepto);
                
                //IdArticulo
                $propIdArticulo='IdArticulo'.$num;
                $valorIdArticulo=$post[$propIdArticulo];
                
                //cantidad
                $propCantidad='cantidadHidden'.$num;
                $valorCantidad=$post[$propCantidad];
                if($valorCantidad === ''){
                    $valorCantidad = 0;
                }
                
                //importe
                $propImporte='importe'.$num;
                $valorImporte=$post[$propImporte];
                //importe unidad (precio)
                $propPrecio='precio'.$num;
                $valorPrecio=$post[$propPrecio];
                
                //iva
                $propIVA='iva'.$num;
                $valorIVA=$post[$propIVA];
                
                //cuota
                $propCuota='cuota'.$num;
                $valorCuota=$post[$propCuota];
                
                //si vienen vacias las vble $valor y $valorImporte, les asigno 0
                if($valor===''){
                    $valor=0;
                }
                if($valorPrecio===''){
                    $valorPrecio=0;
                }
                
                //compruebo que la cuota viene bien (importe * IVA / 100), sino la recalculo
                //por si del formulario viene mal 
                $comprobarImporte = desFormateaNumeroContabilidad($valorImporte);
                $comprobarCuota = desFormateaNumeroContabilidad($valorCuota);
                $cuotaCalculada = round($comprobarImporte * $valorIVA,2);
                
                if((int)($comprobarCuota * 100) !== (int)($cuotaCalculada)){
                    $cuotaCalculada = (float) $cuotaCalculada / 100;
                    $valorCuota = formateaNumeroContabilidad($cuotaCalculada);
                }
                
                //ahora guardo el valor en el array
                $lineasPresupuesto[]=array(
                    "idPedidoLinea"=>$post['idPedidoLinea'.$num],
                    "cantidad"=>  $valorCantidad, 
                    "concepto"=>$valorConcepto,
                    "IdArticulo"=>$valorIdArticulo,
                    "importeUnidad"=>desFormateaNumeroContabilidad($valorPrecio),
                    "importe"=>desFormateaNumeroContabilidad($valorImporte),
                    "IVA"=>desFormateaNumeroContabilidad($valorIVA),
                    "cuota"=>desFormateaNumeroContabilidad($valorCuota),
                );
            }
        }
        
        //hay que guardar los datos en las tablas 'tbmispedidos' y 'tbmispedidoslineas'
        
        //guardo el numero de proyecto con este formato '20140001' donde las 4 primeras cifras son el año y las 4 ultimas la numeracion
        //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
        $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        
        //ahora segun el tipo de contador calculo en nuevo numero
        $numeroNuevoPedido = $post['numPresupuestoBBDD'];
//        switch ($tipoContador) {
//            case 'simple':
////                while(strlen($post['numPedido'])<4){
////                    $post['numPedido']='0'.$post['numPedido'];
////                }
//                $numeroNuevoPedido= $post['numPedido'];
//                break;
//            case 'compuesto1':
//                //ahora formateo el numero de presupuesto para que tenga 4 cifras
//                $numPedido=explode('/',$post['numPedido']);
//
//                while(strlen($numPedido[0])<4){
//                    $numPedido[0]='0'.$numPedido[0];
//                }
//                $numeroNuevoPedido=$numPedido[1].$numPedido[0];
//                break;
//            case 'compuesto2':
//                //ahora formateo el numero de presupuesto para que tenga 4 cifras
//                $numPedido=explode('/',$post['numPedido']);
//
//                while(strlen($numPedido[1])<4){
//                    $numPedido[1]='0'.$numPedido[1];
//                }
//                $numeroNuevoPedido=$numPedido[0].$numPedido[1];
//                break;
//            default://ningun contador
//                break;
//        }
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaPedido() || START TRANSACTION");
        
        //obtengo el idPedido
        $strSQL = "SELECT idPedido FROM tbmispedidos ORDER BY idPedido DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaPedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $idPedido=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idPedido=$row['idPedido']+1;
            }else{
                $idPedido=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaPedido()<ROLLBACK");
            return 'false';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaPedido()|| idFactura : ".$idPedido);

        //si existe $post['IdPresupuesto'] y es distinto de vacio, lo pongo, sino inserto 0
        $IdPresup=0;
        if(isset($post['IdPresupuesto']) && $post['IdPresupuesto']<>''){
            $IdPresup=$post['IdPresupuesto'];
        }
        
        //inserto en la tabla 'tbmispedidos'
        $strSQL = "
                    INSERT INTO tbmispedidos (IdPedido,NumPedido,IdPresupuesto,Cliente,FechaPedido,
                                FechaVtoPedido,FormaPago,FechaFinalizacion,Estado,Retencion,lngIdUsuario,Borrado,
                                TipoFactura,DiaPeriodica,FrecuenciaPeriodica,FechaProximaFacturaPeriodica,CC_Trans,Referencia) 
                    VALUES ($idPedido,'".$numeroNuevoPedido."',".$IdPresup.",'".$post['Contacto']."','".fecha_to_DATETIME($post['FechaPedido'])."','".fecha_to_DATETIME($post['FechaVtoPedido'])."',
                            '".$post['FormaPagoHabitual']."','".fecha_to_DATETIME($post['FechaFinalizacion'])."','Aceptado',".$post['irpf'].",$usuario,1,
                   '".$post['TipoFactura']."','".$post['DiaPeriodica']."','".$post['FrecuenciaPeriodica']."','".fecha_to_DATETIME($post['FechaProximaFacturaPeriodica'])."','".$post['CC_Recibos']."','".$post['Referencia']."')
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->AltaPedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaPedido()<ROLLBACK");
            return 'false';
        }
        
        //ahora vamos a insertar las lineas del pedido (una insercion por cada linea) en la tabla 'tbmispedidoslineas'
        //recorro el array $lineasPresupuesto
        for($i=0;$i<count($lineasPresupuesto);$i++){
            //si existe $lineasPresupuesto[$i]['idPresupLinea'] y es distinto de vacio, lo pongo, sino inserto 0
            $IdPresupL=0;
            if(isset($lineasPresupuesto[$i]['idPresupLinea']) && $lineasPresupuesto[$i]['idPresupLinea']<>''){
                $IdPresupL=$lineasPresupuesto[$i]['idPresupLinea'];
            }


            //controlo el IdArticulo
            //si este viene vacio es NULL
            $IdArticulo = $lineasPresupuesto[$i]['IdArticulo'];
            if($IdArticulo === ''){
                $IdArticulo = 'NULL';
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->AltaPedidos()|| IdArticulo : ".$IdArticulo);
            
            //saco el numero linea nuevo
            $numLinea=$this->numeroPedidoLineaNueva($db);
            $numLineaPresup=0;
            $numLineaPedido=$i+1;
            //inserto en la tabla 'tbmispedidoslineas'
            $strSQL = "
                        INSERT INTO tbmispedidoslineas (IdPedidoLineas,IdPedido,NumLineaPedido,NumLineaPresup,IdPresupLineas,IdArticulo,DescripcionProducto,
                                    TipoIVA,CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,ImportePEN,
                                    CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN,GenFacPed,Facturada) 
                        VALUES ($numLinea,$idPedido,$numLineaPedido,$numLineaPresup,".$IdPresupL.",$IdArticulo,'".$lineasPresupuesto[$i]['concepto']."',".$lineasPresupuesto[$i]['IVA'].",".$lineasPresupuesto[$i]['cantidad'].",
                                0,".$lineasPresupuesto[$i]['cantidad'].",".$lineasPresupuesto[$i]['importeUnidad'].",".$lineasPresupuesto[$i]['importe'].",0,".$lineasPresupuesto[$i]['importe'].",".$lineasPresupuesto[$i]['cuota'].",0,".$lineasPresupuesto[$i]['cuota'].",'NO','NF')
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->AltaPedido()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaPedido()<ROLLBACK");
                return 'false';
            }
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaPedido()<COMMIT");
        
        $db->desconectar ();
        
        //todo correcto, devuelvo el IdPedido
        return $idPedido;
    }
    
    function AltaFactura($usuario,$post){
        //lo primero que hacemos es guardar todas las lineas de factura en un array
        //buscamos todo lo que comienze por 'cantidad..'
        
        $lineasPresupuesto='';
        foreach($post as $propiedad=>$valor){
            //si $propiedad = 'cantidad..' recojo el resto de datos en el array
            //(cantidad,concepto,importe,iva,cuota)
            
            //busco cantidad 
            if(substr($propiedad,0,13)==='idPresupLinea'){
                //extraigo en numero de cantidad para buscar el resto de valores que terminen en ese numero 
                //(son de la misma linea de factura)
                $num=substr($propiedad,13,3);
                //concepto
                $propConcepto='concepto'.$num;
                $valorConcepto=$post[$propConcepto];
                //cambio las comillas simples si hay por dobles, me da error sino al leer este dato el formulario html
                $valorConcepto = str_replace("'", "\"", $valorConcepto);
                
                //IdArticulo
                $propIdArticulo='IdArticulo'.$num;
                $valorIdArticulo=$post[$propIdArticulo];
                
                //cantidad
                $propCantidad='cantidadHidden'.$num;
                $valorCantidad=$post[$propCantidad];
                if($valorCantidad === ''){
                    $valorCantidad = 0;
                }
                
                //cuentaArticulo
                $propCuenta='cuenta'.$num;
                $valorCuenta=$post[$propCuenta];

                //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
                $cuentaContable=$this->Parametro_general('cuentaContable',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
                
                //esta vacio, se le asigna la cuenta por defecto
                if($valorCuenta === '' || $valorCuenta === '0'){
                    $valorCuenta=$cuentaContable;
                }
                
                //importe
                $propImporte='importe'.$num;
                $valorImporte=$post[$propImporte];
                //importe unidad (precio)
                $propPrecio='precio'.$num;
                $valorPrecio=$post[$propPrecio];
                
                //iva
                $propIVA='iva'.$num;
                $valorIVA=$post[$propIVA];
                
                //cuota
                $propCuota='cuota'.$num;
                $valorCuota=$post[$propCuota];
                
                //si vienen vacias las vble $valor y $valorImporte, les asigno 0
                if($valor===''){
                    $valor=0;
                }
                if($valorPrecio===''){
                    $valorPrecio=0;
                }
                
                //compruebo que la cuota viene bien (importe * IVA / 100), sino la recalculo
                //por si del formulario viene mal 
                $comprobarImporte = desFormateaNumeroContabilidad($valorImporte);
                $comprobarCuota = desFormateaNumeroContabilidad($valorCuota);
                $cuotaCalculada = round($comprobarImporte * $valorIVA,2);
                
                if((int)($comprobarCuota * 100) !== (int)($cuotaCalculada)){
                    $cuotaCalculada = (float) $cuotaCalculada / 100;
                    $valorCuota = formateaNumeroContabilidad($cuotaCalculada);
                }
                
                //ahora guardo el valor en el array
                $lineasPresupuesto[]=array(
                    "idPresupLinea"=>$post['idPresupLinea'.$num],
                    "cantidad"=>  $valorCantidad, 
                    "concepto"=>$valorConcepto,
                    "IdArticulo"=>$valorIdArticulo,
                    "cuentaArticulo"=>$valorCuenta,
                    "importeUnidad"=>desFormateaNumeroContabilidad($valorPrecio),
                    "importe"=>desFormateaNumeroContabilidad($valorImporte),
                    "IVA"=>desFormateaNumeroContabilidad($valorIVA),
                    "cuota"=>desFormateaNumeroContabilidad($valorCuota),
                );
            }
        }
        
        //hay que guardar los datos en las tablas 'tbmisfacturas' y 'tbmisfacturaslineas'
        
        //guardo el numero de proyecto con este formato '20140001' donde las 4 primeras cifras son el año y las 4 ultimas la numeracion
        //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
        $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        
        //ahora segun el tipo de contador calculo en nuevo numero
        $numeroNuevoPresupuesto = numeroFormateado($post['numPresupuesto'],$tipoContador);
//        switch ($tipoContador) {
//            case 'simple':
////                while(strlen($post['numFactura'])<4){
////                    $post['numFactura']='0'.$post['numFactura'];
////                }
//                $numeroNuevoPresupuesto= $post['numPresupuesto'];
//                break;
//            case 'compuesto1':
//                //ahora formateo el numero de presupuesto para que tenga 4 cifras
//                $numPresupuesto=explode('/',$post['numPresupuesto']);
//
//                while(strlen($numPresupuesto[0])<4){
//                    $numPresupuesto[0]='0'.$numPresupuesto[0];
//                }
//                $numeroNuevoPresupuesto=$numPresupuesto[1].$numPresupuesto[0];
//                break;
//            case 'compuesto2':
//                //ahora formateo el numero de presupuesto para que tenga 4 cifras
//                $numPresupuesto=explode('/',$post['numPresupuesto']);
//
//                while(strlen($numPresupuesto[1])<4){
//                    $numPresupuesto[1]='0'.$numPresupuesto[1];
//                }
//                $numeroNuevoPresupuesto=$numPresupuesto[0].$numPresupuesto[1];
//                break;
//            default://ningun contador
//                break;
//        }
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaFactura() || START TRANSACTION");
        
        //obtengo el idFactura
        $strSQL = "SELECT idFactura FROM tbmisfacturas ORDER BY idFactura DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $idFactura=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idFactura=$row['idFactura']+1;
            }else{
                $idFactura=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaFactura()<ROLLBACK");
            return 'false';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaFactura()|| idFactura : ".$idFactura);

        //si existe $post['IdPresupuesto'] y es distinto de vacio, lo pongo, sino inserto 0
        $IdPresup=0;
        if(isset($post['IdPresupuesto']) && $post['IdPresupuesto']<>''){
            $IdPresup=$post['IdPresupuesto'];
        }
        
        //controlosi viene vacio el dato $post['validez']
        if($post['validez']===''){
            $post['validez']=0;
        }
        
        if($post['fechaPresup'] === ''){
            //sino hay fecha, pongo el dia de hoy
            $post['fechaPresup'] = date('d/m/Y');
        }
        
        //inserto en la tabla 'tbmisfacturas'
        $strSQL = "
                    INSERT INTO tbmisfacturas (IdFactura,NumFactura,IdPresupuesto,Cliente,FechaFactura,
                                FechaVtoFactura,FormaPago,Estado,Retencion,lngIdUsuario,Borrado,Situacion,Referencia,CC_Trans) 
                    VALUES ($idFactura,'".$numeroNuevoPresupuesto."',".$IdPresup.",'".$post['Contacto']."','".fecha_to_DATETIME($post['fechaPresup'])."',ADDDATE('".fecha_to_DATETIME($post['fechaPresup'])."',".$post['validez']."),
                            '".$post['FormaPagoHabitual']."','Emitida',".$post['irpf'].",$usuario,1,'En plazo','".$post['Referencia']."','".$post['CC_Trans']."')
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->AltaFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaFactura()<ROLLBACK");
            return 'false';
        }
        
        //ahora vamos a insertar las lineas de la factura (una insercion por cada linea) en la tabla 'tbmisfacturaslineas'
        //recorro el array $lineasPresupuesto
        for($i=0;$i<count($lineasPresupuesto);$i++){
            //si existe $lineasPresupuesto[$i]['idPresupLinea'] y es distinto de vacio, lo pongo, sino inserto 0
            $IdPresupL=0;
            if(isset($lineasPresupuesto[$i]['idPresupLinea']) && $lineasPresupuesto[$i]['idPresupLinea']<>''){
                $IdPresupL=$lineasPresupuesto[$i]['idPresupLinea'];
            }


            //controlo el IdArticulo
            //si este viene vacio es NULL
            $IdArticulo = $lineasPresupuesto[$i]['IdArticulo'];
            if($IdArticulo === ''){
                $IdArticulo = 'NULL';
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->AltaFactura()|| IdArticulo : ".$IdArticulo);
            
            //controlo el cuentaArticulo
            //si este viene vacio es NULL
            $cuentaArticulo = $lineasPresupuesto[$i]['cuentaArticulo'];
            if($cuentaArticulo === ''){
                $cuentaArticulo = 'NULL';
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->AltaFactura()|| cuentaArticulo : ".$cuentaArticulo);
            
            
            //saco el numero linea nuevo
            $numLinea=$this->numeroFacturaLineaNueva($db);
            $numLineaPresup=0;
            $numLineaFact=$i+1;
            //inserto en la tabla 'tbmisfacturaslineas'
            $strSQL = "
                        INSERT INTO tbmisfacturaslineas (IdFacturaLineas,IdFactura,NumLineaFactura,NumLineaPresup,IdPresupLineas,IdArticulo,cuentaArticulo,DescripcionProducto,
                                    TipoIVA,CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,ImportePEN,
                                    CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN,GenFacPed,Facturada) 
                        VALUES ($numLinea,$idFactura,$numLineaFact,$numLineaPresup,".$IdPresupL.",$IdArticulo,$cuentaArticulo,'".$lineasPresupuesto[$i]['concepto']."',".$lineasPresupuesto[$i]['IVA'].",".$lineasPresupuesto[$i]['cantidad'].",
                                0,0,".$lineasPresupuesto[$i]['importeUnidad'].",".$lineasPresupuesto[$i]['importe'].",0,0,".$lineasPresupuesto[$i]['cuota'].",0,0,'NO','NF')
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->AltaFactura()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaFactura()<ROLLBACK");
                return 'false';
            }
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaFactura()<COMMIT");
        
        $db->desconectar ();
        
        //todo correcto, devuelvo el IdFactura
        return $idFactura;
    }
    
    function AltaPresupuesto($usuario,$post,$AltaEdicion){
        //lo primero que hacemos es guardar todas las lineas del presupuesto en un array
        //buscamos todo lo que comienze por 'IdPresupLinea..'
        
        $lineasPresupuesto='';
        foreach($post as $propiedad=>$valor){
            //si $propiedad = 'cantidad..' recojo el resto de datos en el array
            //(cantidad,concepto,importe,iva,cuota)
            
            //busco cantidad 
            if(substr($propiedad,0,13)==='IdPresupLinea'){
                //extraigo en numero de cantidad para buscar el resto de valores que terminen en ese numero 
                //(son de la misma linea de factura)
                $num=substr($propiedad,13,3);
                //IdPresupLinea
                $propIdPresupLinea='IdPresupLinea'.$num;
                $valorIdPresupLinea=$post[$propIdPresupLinea];
                //numLineaPresup
                $propNumLineaPresup='numLineaPresup'.$num;
                $valorNumLineaPresup=$post[$propNumLineaPresup];
                //IdArticulo
                $propIdArticulo='IdArticulo'.$num;
                $valorIdArticulo=$post[$propIdArticulo];
                //concepto
                $propConcepto='concepto'.$num;
                $valorConcepto=$post[$propConcepto];
                //cambio las comillas simples si hay por dobles, me da error sino al leer este dato el formulario html
                $valorConcepto = str_replace("'", "\"", $valorConcepto);
                //importe
                $propImporte='importe'.$num;
                $valorImporte=$post[$propImporte];
                //importe unidad (precio)
                $propPrecio='precio'.$num;
                $valorPrecio=$post[$propPrecio];
                
                //cantidad
                $propCantidad='cantidadHidden'.$num;
                $valorCantidad=$post[$propCantidad];
                if($valorCantidad === ''){
                    $valorCantidad = 0;
                }
                
                //iva
                $propIVA='iva'.$num;
                $valorIVA=$post[$propIVA];
                
                //cuota
                $propCuota='cuota'.$num;
                $valorCuota=$post[$propCuota];
                
                //si vienen vacias las vble $valor y $valorImporte, les asigno 0
                if($valor===''){
                    $valor=0;
                }
                if($valorPrecio===''){
                    $valorPrecio=0;
                }
                
                //compruebo que la cuota viene bien (importe * IVA / 100), sino la recalculo
                //por si del formulario viene mal 
                $comprobarImporte = desFormateaNumeroContabilidad($valorImporte);
                $comprobarCuota = desFormateaNumeroContabilidad($valorCuota);
                $cuotaCalculada = $comprobarImporte * $valorIVA;
                
                if((int)($comprobarCuota * 100) !== (int)($cuotaCalculada)){
                    $cuotaCalculada = (float) $cuotaCalculada / 100;
                    $valorCuota = formateaNumeroContabilidad($cuotaCalculada);
                }
                
                //ahora guardo el valor en el array
                $lineasPresupuesto[]=array(
                    "IdPresupLinea"=>$valorIdPresupLinea,
                    "numLineaPresup"=>$valorNumLineaPresup,
                    "IdArticulo"=>$valorIdArticulo,
                    "cantidad"=>$valorCantidad, 
                    "concepto"=>$valorConcepto,
                    "importeUnidad"=>desFormateaNumeroContabilidad($valorPrecio),
                    "importe"=>desFormateaNumeroContabilidad($valorImporte),
                    "IVA"=>desFormateaNumeroContabilidad($valorIVA),
                    "cuota"=>desFormateaNumeroContabilidad($valorCuota),
                );
            }
        }
        
        //hay que guardar los datos en las tablas 'tbmispresupuestos' y 'tbmispresupuestoslineas'
        
        //guardo el numero de proyecto con este formato '20140001' donde las 4 primeras cifras son el año y las 4 ultimas la numeracion
        //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
        $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        
        //ahora segun el tipo de contador calculo en nuevo numero
        $numeroNuevoPresupuesto = $post['numPresupuestoBBDD'];
//        switch ($tipoContador) {
//            case 'simple':
////                while(strlen($post['numPresupuesto'])<4){
////                    $post['numPresupuesto']='0'.$post['numPresupuesto'];
////                }
//                $numeroNuevoPresupuesto=$post['numPresupuesto'];
//                break;
//            case 'compuesto1':
//                //ahora formateo el numero de presupuesto para que tenga 4 cifras
//                $numPresupuesto=explode('/',$post['numPresupuesto']);
//
//                while(strlen($numPresupuesto[0])<4){
//                    $numPresupuesto[0]='0'.$numPresupuesto[0];
//                }
//                $numeroNuevoPresupuesto=$numPresupuesto[1].$numPresupuesto[0];
//                break;
//            case 'compuesto2':
//                //ahora formateo el numero de presupuesto para que tenga 4 cifras
//                $numPresupuesto=explode('/',$post['numPresupuesto']);
//
//                while(strlen($numPresupuesto[1])<4){
//                    $numPresupuesto[1]='0'.$numPresupuesto[1];
//                }
//                $numeroNuevoPresupuesto=$numPresupuesto[0].$numPresupuesto[1];
//                break;
//            default://ningun contador
//                break;
//        }
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //$AltaEdicion=Edicion hay que extraer los datos del presupuesto ($post[IdPresupuesto])
        $lineasPresupuestoAnt='';
        if($AltaEdicion==='Edicion'){
            //extraigo las lineas del IdPresupuesto
            $strSQL = "
                        SELECT L.IdPresupLineas,L.CantidadFAC,L.ImporteFAC,L.CuotaIvaFAC,L.GenFacPed,L.Facturada,L.GenPedPre,L.Pedido
                        FROM tbmispresupuestos P, tbmispresupuestoslineas L
                        WHERE P.IdPresupuesto=L.IdPresupuesto
                        AND P.IdPresupuesto=".$post['IdPresupuesto']."
                      ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                while($row=  mysql_fetch_array($stmt)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $reg[$propiedad]=$valor;
                        }
                    }
                    $lineasPresupuestoAnt[]=$reg;
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
                return 'false';
            }
        }
        
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaPresupuesto() || START TRANSACTION");
        
        //obtengo el idPresupuesto
        $strSQL = "SELECT idPresupuesto FROM tbmispresupuestos ORDER BY idPresupuesto DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $idPresupuesto=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idPresupuesto=$row['idPresupuesto']+1;
            }else{
                $idPresupuesto=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
            return 'false';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaPresupuesto()|| idMovimiento : ".$idPresupuesto);

        //extraigo el estado de este presupuesto
        $EstadoPresupuesto='Pendiente';
        if($post['IdPresupuesto']<>'Nuevo'){
            $strSQL = "
                        SELECT Estado
                        FROM tbmispresupuestos
                        WHERE IdPresupuesto=".$post['IdPresupuesto']."
                      ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_array($stmt);
                $EstadoPresupuesto=$row['Estado'];
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
                return 'false';
            }
        }
        
        $validez=0;
        if($post['validez']<>''){
            $validez=$post['validez'];
        }
        
        $irpf=0;
        if($post['irpf']<>''){
            $irpf=$post['irpf'];
        }
        
        //inserto en la tabla 'tbmispresupuestos'
        $strSQL = "
                    INSERT INTO tbmispresupuestos (IdPresupuesto,NumPresupuesto,Contacto_Cliente,FechaPresupuesto,
                                FechaVtoPresupuesto,FormaPago,Estado,Retencion,lngIdUsuario,Proforma,Borrado) 
                    VALUES ($idPresupuesto,'".$numeroNuevoPresupuesto."','".$post['Contacto']."',NOW(),ADDDATE(NOW(),".$validez."),
                            '".$post['FormaPagoHabitual']."','$EstadoPresupuesto',".$irpf.",$usuario,".$post['Proforma'].",1)
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
            return 'false';
        }
        
        //ahora vamos a insertar las lineas del presupuesto (una insercion por cada linea) en la tabla 'tbmispresupuestoslineas'
        //recorro el array $lineasPresupuesto
        for($i=0;$i<count($lineasPresupuesto);$i++){
            $CantidadPED=$lineasPresupuesto[$i]['cantidad'];
            if($CantidadPED === ''){
                $CantidadPED=0;
            }
            $CantidadFAC=0;
            $CantidadPEN=$lineasPresupuesto[$i]['cantidad'];
            $ImportePED=$lineasPresupuesto[$i]['importe'];
            $ImporteFAC=0;
            $ImportePEN=$lineasPresupuesto[$i]['importe'];
            $CuotaIvaPED=$lineasPresupuesto[$i]['cuota'];
            $CuotaIvaFAC=0;
            $CuotaIvaPEN=$lineasPresupuesto[$i]['cuota'];
            $GenFacPed='NO';
            $Facturada='NF';
            $GenPedPre='NO';
            $Pedido='NP';
            
            //veo los datos con respecto a los antiguos
            if(is_array($lineasPresupuestoAnt)){
                for($ii=0;$ii<count($lineasPresupuestoAnt);$ii++){
                    if($lineasPresupuesto[$i]['IdPresupLinea']===$lineasPresupuestoAnt[$ii]['IdPresupLineas']){
                        //existe linea del presupuesto anterior, es una edicion,
                        //CantidadFAC, ImporteFAC y CuotaIvaFAC se copia del antiguo
                        $CantidadFAC=$lineasPresupuestoAnt[$ii]['CantidadFAC'];
                        $ImporteFAC=$lineasPresupuestoAnt[$ii]['ImporteFAC'];
                        $CuotaIvaFAC=$lineasPresupuestoAnt[$ii]['CuotaIvaFAC'];

                        //CantidadPEN, ImportePEN y CuotaIvaPEN se calcula de nuevo (PEN=PED-FAC)
                        //si saliese negativo se pone 0
                        $CantidadPEN=round($CantidadPED-$CantidadFAC,2);
                        if($CantidadPEN<0){
                            $CantidadPEN=0;
                        }
                        $ImportePEN=round($ImportePED-$ImporteFAC,2);
                        if($ImportePEN<0){
                            $ImportePEN=0;
                        }
                        $CuotaIvaPEN=round($CuotaIvaPED-$CuotaIvaFAC,2);
                        if($CuotaIvaPEN<0){
                            $CuotaIvaPEN=0;
                        }

                        //GenFacPed copio el antiguo
                        $GenFacPed=$lineasPresupuestoAnt[$ii]['GenFacPed'];

                        //GenPedPre copio el antiguo
                        $GenPedPre=$lineasPresupuestoAnt[$ii]['GenPedPre'];
                        
                        if($GenFacPed==='SI'){
                            //Facturada, si ImporteFAC=0 indicamos 'NF', si ImportePEN=0 indicamos T, sino indicamos 'M'
                            //Pedido, copiamos el que viene de antes
                            if($ImporteFAC==0){
                                $Facturada='NF';
                            }else if($ImportePEN==0){
                                $Facturada='T';
                            }else{
                                $Facturada='M';
                            }
                            $Pedido=$lineasPresupuestoAnt[$ii]['Pedido'];
                        }else
                        if($GenPedPre==='SI'){
                            //Facturada, copiamos el que viene de antes
                            //Pedido, si ImporteFAC=0 indicamos 'NF', si ImportePEN=0 indicamos T, sino indicamos 'M'
                            if($ImporteFAC==0){
                                $Pedido='NP';
                            }else if($ImportePEN==0){
                                $Pedido='T';
                            }else{
                                $Pedido='M';
                            }
                            $Facturada=$lineasPresupuestoAnt[$ii]['Facturada'];
                        }
                        
                        break;
                    }
                }
            }

            //controlo el IdArticulo
            //si este viene vacio es NULL
            $IdArticulo = $lineasPresupuesto[$i]['IdArticulo'];
            if($IdArticulo === ''){
                $IdArticulo = 'NULL';
            }
            
            //saco el numero linea nuevo
            $numLinea=$this->numeroPresupuestoLineaNuevo($db);
            $numLineaPresup=$i+1;
            //inserto en la tabla 'tbmispresupuestoslineas'
            $strSQL = "
                        INSERT INTO tbmispresupuestoslineas (IdPresupLineas,IdPresupuesto,NumLineaPresup,IdArticulo,DescripcionProducto,
                                    TipoIVA,CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,ImportePEN,
                                    CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN,GenFacPed,Facturada,GenPedPre,Pedido) 
                        VALUES ($numLinea,$idPresupuesto,$numLineaPresup,".$IdArticulo.",'".$lineasPresupuesto[$i]['concepto']."',".$lineasPresupuesto[$i]['IVA'].",$CantidadPED,
                                $CantidadFAC,$CantidadPEN,".$lineasPresupuesto[$i]['importeUnidad'].",$ImportePED,$ImporteFAC,$ImportePEN,$CuotaIvaPED,$CuotaIvaFAC,$CuotaIvaPEN,'$GenFacPed','$Facturada','$GenPedPre','$Pedido')
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
                return 'false';
            }
        }
        
        
        
        //ahora busco si este presupuesto tiene ya facturas asociadas a el 
        //si es asi debo actualizar el IdPresupuesto de la tabla 'tbmisfacturas' y las IdPresupLineas de 'tbmisfacturaslineas'
        $listaFacturasActualizar='';
        //primero compruebo si el dato $post['IdPresupuesto']=Nuevo (es presupuesto nuevo por lo que no tiene facturas asociadas logicamente)
        if($post['IdPresupuesto']<>'Nuevo'){
            //actualizo el IdPresupuesto en la tabla tbmisfacturas
            $strSQL = "
                        SELECT IdFactura
                        FROM tbmisfacturas
                        WHERE IdPresupuesto=".$post['IdPresupuesto']."
                      ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                while($row=  mysql_fetch_array($stmt)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $reg[$propiedad]=$valor;
                        }
                    }
                    $listaFacturasActualizar[]=$reg;
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
                return 'false';
            }

            if(is_array($listaFacturasActualizar)){
                for($i=0;$i<count($listaFacturasActualizar);$i++){
                    $strSQL = "
                                UPDATE tbmisfacturas
                                SET IdPresupuesto=$idPresupuesto
                                WHERE IdFactura=".$listaFacturasActualizar[$i]['IdFactura']."
                              ";
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
                        return 'false';
                    }
                    
                    //ahora actualizo también las IdPresupLineas de la tabla 'tbmisfacturaslineas'
                    //como las IdPresupLineas que voy a insertar en la tabla 'tbmisfacturas lineas tienen numeracion nueva
                    //para poder saber que IdPresupLineas va en la IdFacturaLineas
                    //igualamos los campos de numeracion interna del presupuesto y la factura
                    //tbmispresupuestoslineas.NumLineaPresup=tbmisfacturaslineas.NumLineaFactura
                    $strSQL = "
                                SELECT FL.IdFacturaLineas, PL.IdPresupLineas
                                FROM tbmispresupuestoslineas PL,tbmisfacturas F,tbmisfacturaslineas FL
                                WHERE PL.IdPresupuesto=$idPresupuesto
                                AND PL.IdPresupuesto=F.IdPresupuesto
                                AND F.IdFactura=FL.IdFactura
                                AND PL.NumLineaPresup=FL.NumLineaPresup
                              ";
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
                    $stmt = $db->ejecutar ( $strSQL );
                    $listaFacturaLineasActualizar='';
                    if($stmt){
                        while($row=  mysql_fetch_array($stmt)){
                            $reg='';
                            foreach($row as $propiedad=>$valor){
                                if(!is_numeric($propiedad)){
                                    $reg[$propiedad]=$valor;
                                }
                            }
                            $listaFacturaLineasActualizar[]=$reg;
                        }
                    }else{
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
                        return 'false';
                    }

                    if(is_array($listaFacturaLineasActualizar)){
                        for($ii=0;$ii<count($listaFacturaLineasActualizar);$ii++){
                            $strSQL = "
                                        UPDATE tbmisfacturaslineas
                                        SET IdPresupLineas=".$listaFacturaLineasActualizar[$ii]['IdPresupLineas']."
                                        WHERE IdFacturaLineas=".$listaFacturaLineasActualizar[$ii]['IdFacturaLineas']."
                                      ";
                            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                    " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
                            $stmt = $db->ejecutar ( $strSQL );
                            if(!$stmt){
                                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                                $db->ejecutar ("ROLLBACK");
                                $db->desconectar ();
                                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                        " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
                                return 'false';
                            }
                        }
                    }
                }
            }
        }
        
        
        //por ultimo busco si este presupuesto tiene ya pdidos asociados a el 
        //si es asi debo actualizar el IdPresupuesto de la tabla 'tbmispedidos' y las IdPresupLineas de 'tbmispedidoslineas'
        $listaPedidosActualizar='';
        //primero compruebo si el dato $post['IdPresupuesto']=Nuevo (es presupuesto nuevo por lo que no tiene pedidos asociados logicamente)
        if($post['IdPresupuesto']<>'Nuevo'){
            //actualizo el IdPresupuesto en la tabla tbmispedidos
            $strSQL = "
                        SELECT IdPedido
                        FROM tbmispedidos
                        WHERE IdPresupuesto=".$post['IdPresupuesto']."
                      ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                while($row=  mysql_fetch_array($stmt)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $reg[$propiedad]=$valor;
                        }
                    }
                    $listaPedidosActualizar[]=$reg;
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
                return 'false';
            }

            if(is_array($listaPedidosActualizar)){
                for($i=0;$i<count($listaPedidosActualizar);$i++){
                    $strSQL = "
                                UPDATE tbmispedidos
                                SET IdPresupuesto=$idPresupuesto
                                WHERE IdPedido=".$listaPedidosActualizar[$i]['IdPedido']."
                              ";
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
                        return 'false';
                    }
                    
                    //ahora actualizo también las IdPresupLineas de la tabla 'tbmispedidoslineas'
                    //como las IdPresupLineas que voy a insertar en la tabla 'tbmispedidos' lineas tienen numeracion nueva
                    //para poder saber que IdPresupLineas va en la IdPedidoLineas
                    //igualamos los campos de numeracion interna del presupuesto y el pedido
                    //tbmispresupuestoslineas.NumLineaPresup=tbmispedidoslineas.NumLineaPedido
                    $strSQL = "
                                SELECT FL.IdPedidoLineas, PL.IdPresupLineas
                                FROM tbmispresupuestoslineas PL,tbmispedidos F,tbmispedidoslineas FL
                                WHERE PL.IdPresupuesto=$idPresupuesto
                                AND PL.IdPresupuesto=F.IdPresupuesto
                                AND F.IdPedido=FL.IdPedido
                                AND PL.NumLineaPresup=FL.NumLineaPresup
                              ";
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
                    $stmt = $db->ejecutar ( $strSQL );
                    $listaPedidoLineasActualizar='';
                    if($stmt){
                        while($row=  mysql_fetch_array($stmt)){
                            $reg='';
                            foreach($row as $propiedad=>$valor){
                                if(!is_numeric($propiedad)){
                                    $reg[$propiedad]=$valor;
                                }
                            }
                            $listaPedidoLineasActualizar[]=$reg;
                        }
                    }else{
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
                        return 'false';
                    }

                    if(is_array($listaPedidoLineasActualizar)){
                        for($ii=0;$ii<count($listaPedidoLineasActualizar);$ii++){
                            $strSQL = "
                                        UPDATE tbmispedidoslineas
                                        SET IdPresupLineas=".$listaPedidoLineasActualizar[$ii]['IdPresupLineas']."
                                        WHERE IdPedidoLineas=".$listaPedidoLineasActualizar[$ii]['IdPedidoLineas']."
                                      ";
                            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                    " clsCADContabilidad->AltaPresupuesto()|| SQL : ".$strSQL);
                            $stmt = $db->ejecutar ( $strSQL );
                            if(!$stmt){
                                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                                $db->ejecutar ("ROLLBACK");
                                $db->desconectar ();
                                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                        " clsCADContabilidad->AltaPresupuesto()<ROLLBACK");
                                return 'false';
                            }
                        }
                    }
                }
            }
        }

        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaPresupuesto()<COMMIT");
        
        $db->desconectar ();
        
        //todo correcto, devuelvo el IdPresupuesto
        return $idPresupuesto;
    }

    function EditarPedido($usuario,$post){
        //lo primero que hacemos es guardar todas las lineas de factura en un array
        //buscamos todo lo que comienze por 'cantidad..'
        
        $lineasPresupuesto='';
        foreach($post as $propiedad=>$valor){
            //si $propiedad = 'cantidad..' recojo el resto de datos en el array
            //(cantidad,concepto,importe,iva,cuota)
            
            //busco cantidad 
            if(substr($propiedad,0,13)==='idPedidoLinea'){
                //extraigo en numero de cantidad para buscar el resto de valores que terminen en ese numero 
                //(son de la misma linea de factura)
                $num=substr($propiedad,13,3);
                //IdPedidoLinea
                $propIdPedidoLinea='idPedidoLinea'.$num;
                $valorIdPedidoLinea=$post[$propIdPedidoLinea];
                //numLineaPedido
                $propNumLineaPedido='numLineaPedido'.$num;
                $valorNumLineaPedido=$post[$propNumLineaPedido];
                
                //concepto
                $propConcepto='concepto'.$num;
                $valorConcepto=$post[$propConcepto];
                //cambio las comillas simples si hay por dobles, me da error sino al leer este dato el formulario html
                $valorConcepto = str_replace("'", "\"", $valorConcepto);
                
                //IdArticulo
                $propIdArticulo='IdArticulo'.$num;
                $valorIdArticulo=$post[$propIdArticulo];
                
                //cantidad
                $propCantidad='cantidadHidden'.$num;
                $valorCantidad=$post[$propCantidad];
                if($valorCantidad === ''){
                    $valorCantidad = 0;
                }
                
                //importe
                $propImporte='importe'.$num;
                $valorImporte=$post[$propImporte];
                //importe unidad (precio)
                $propPrecio='precio'.$num;
                $valorPrecio=$post[$propPrecio];
                
                //iva
                $propIVA='iva'.$num;
                $valorIVA=$post[$propIVA];
                
                //cuota
                $propCuota='cuota'.$num;
                $valorCuota=$post[$propCuota];
                
                //si vienen vacias las vble $valor y $valorImporte, les asigno 0
                if($valor===''){
                    $valor=0;
                }
                if($valorPrecio===''){
                    $valorPrecio=0;
                }
                
                //compruebo que la cuota viene bien (importe * IVA / 100), sino la recalculo
                //por si del formulario viene mal 
                $comprobarImporte = desFormateaNumeroContabilidad($valorImporte);
                $comprobarCuota = desFormateaNumeroContabilidad($valorCuota);
                $cuotaCalculada = round($comprobarImporte * $valorIVA,2);
                
                if((int)($comprobarCuota * 100) !== (int)($cuotaCalculada)){
                    $cuotaCalculada = (float) $cuotaCalculada / 100;
                    $valorCuota = formateaNumeroContabilidad($cuotaCalculada);
                }
                
                //ahora guardo el valor en el array
                $lineasPresupuesto[]=array(
                    "idPedidoLinea"=>$valorIdPedidoLinea,
                    "numLineaPedido"=>$valorNumLineaPedido,
                    "cantidad"=>$valorCantidad,
                    "IdArticulo"=>$valorIdArticulo,
                    "concepto"=>$valorConcepto,
                    "importeUnidad"=>desFormateaNumeroContabilidad($valorPrecio),
                    "importe"=>desFormateaNumeroContabilidad($valorImporte),
                    "IVA"=>desFormateaNumeroContabilidad($valorIVA),
                    "cuota"=>desFormateaNumeroContabilidad($valorCuota),
                );
            }
        }
        
        //hay que guardar los datos en las tablas 'tbmispedidos' y 'tbmispedidoslineas'
        
        //guardo el numero de proyecto con este formato '20140001' donde las 4 primeras cifras son el año y las 4 ultimas la numeracion
        //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
        $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        
        //ahora segun el tipo de contador calculo en nuevo numero
        $numeroNuevoPedido = $post['numPresupuestoBBDD'];
//        switch ($tipoContador) {
//            case 'simple':
////                while(strlen($post['numPedido'])<4){
////                    $post['numPedido']='0'.$post['numPedido'];
////                }
//                $numeroNuevoPedido= $post['numPedido'];
//                break;
//            case 'compuesto1':
//                //ahora formateo el numero de presupuesto para que tenga 4 cifras
//                $numPedido=explode('/',$post['numPedido']);
//
//                while(strlen($numPedido[0])<4){
//                    $numPedido[0]='0'.$numPedido[0];
//                }
//                $numeroNuevoPedido=$numPedido[1].$numPedido[0];
//                break;
//            case 'compuesto2':
//                //ahora formateo el numero de presupuesto para que tenga 4 cifras
//                $numPedido=explode('/',$post['numPedido']);
//
//                while(strlen($numPedido[1])<4){
//                    $numPedido[1]='0'.$numPedido[1];
//                }
//                $numeroNuevoPedido=$numPedido[0].$numPedido[1];
//                break;
//            default://ningun contador
//                break;
//        }
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        
        $lineasPedidoAnt='';
        //extraigo las lineas del IdPedido
        $strSQL = "
                    SELECT L.IdPedidoLineas,L.IdPresupLineas,L.NumLineaPresup,L.CantidadFAC,L.ImporteFAC,L.CuotaIvaFAC,L.GenFacPed,L.Facturada
                    FROM tbmispedidos P, tbmispedidoslineas L
                    WHERE P.IdPedido=L.IdPedido
                    AND P.IdPedido=".$post['IdPedido']."
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $lineasPedidoAnt[]=$reg;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarPedido()<ROLLBACK");
            return 'false';
        }
        
        
        $strSQL = "SELECT Estado FROM tbmispedidos WHERE IdPedido=".$post['IdPedido'];
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $EstadoSituacion='';
        if($stmt){
            $num=  mysql_num_rows($stmt);
            //veo si hay facturas anteriores emitidas
            if($num>0){//si hay, las sumo
                while($row=  mysql_fetch_array($stmt)){
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $EstadoSituacion[$propiedad]=$valor;
                        }
                    }
                }
            }
        }else{
            //si ha fallado la consulta hacemos DEVOLVEMOS false
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarPedido()<ROLLBACK");
            return 'false';
        }
        
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarPedido() || START TRANSACTION");

        //obtengo el idPedido
        $strSQL = "SELECT idPedido FROM tbmispedidos ORDER BY idPedido DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $idPedido=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idPedido=$row['idPedido']+1;
            }else{
                $idPedido=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarPedido()<ROLLBACK");
            return 'false';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarPedido()|| idPedido : ".$idPedido);

        //si existe $post['IdPresupuesto'] y es distinto de vacio, lo pongo, sino inserto 0
        $IdPresup=0;
        if(isset($post['IdPresupuesto']) && $post['IdPresupuesto']<>''){
            $IdPresup=$post['IdPresupuesto'];
        }
        
        //inserto en la tabla 'tbmispedidos'
        $strSQL = "
                    INSERT INTO tbmispedidos (IdPedido,NumPedido,IdPresupuesto,Cliente,FechaPedido,
                                FechaVtoPedido,FormaPago,FechaFinalizacion,Estado,Retencion,lngIdUsuario,Borrado,
                                TipoFactura,DiaPeriodica,FrecuenciaPeriodica,FechaProximaFacturaPeriodica,CC_Trans,Referencia) 
                    VALUES ($idPedido,'".$numeroNuevoPedido."',".$IdPresup.",'".$post['Contacto']."','".fecha_to_DATETIME($post['FechaPedido'])."','".fecha_to_DATETIME($post['FechaVtoPedido'])."',
                            '".$post['FormaPagoHabitual']."','".fecha_to_DATETIME($post['FechaFinalizacion'])."','".$EstadoSituacion['Estado']."',".$post['irpf'].",$usuario,1,
                   '".$post['TipoFactura']."','".$post['DiaPeriodica']."','".$post['FrecuenciaPeriodica']."','".fecha_to_DATETIME($post['FechaProximaFacturaPeriodica'])."','".$post['CC_Recibos']."','".$post['Referencia']."')
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarPedido()<ROLLBACK");
            return 'false';
        }

        //ahora vamos a insertar las lineas del pedido (una insercion por cada linea) en la tabla 'tbmispedidoslineas'
        //recorro el array $lineasPresupuesto
        for($i=0;$i<count($lineasPresupuesto);$i++){
            $CantidadPED=$lineasPresupuesto[$i]['cantidad'];
            if($CantidadPED === ''){
                $CantidadPED=0;
            }
            $CantidadFAC=0;
            $CantidadPEN=$lineasPresupuesto[$i]['cantidad'];
            $ImportePED=$lineasPresupuesto[$i]['importe'];
            $ImporteFAC=0;
            $ImportePEN=$lineasPresupuesto[$i]['importe'];
            $CuotaIvaPED=$lineasPresupuesto[$i]['cuota'];
            $CuotaIvaFAC=0;
            $CuotaIvaPEN=$lineasPresupuesto[$i]['cuota'];
            $GenFacPed='NO';
            $Facturada='NF';
//            $GenPedPre='NO';
//            $Pedido='NP';
            
            //veo los datos con respecto a los antiguos
            if(is_array($lineasPedidoAnt)){
                for($ii=0;$ii<count($lineasPedidoAnt);$ii++){
                    if($lineasPresupuesto[$i]['idPedidoLinea']===$lineasPedidoAnt[$ii]['IdPedidoLineas']){
                        //existe linea del presupuesto anterior, es una edicion,
                        //CantidadFAC, ImporteFAC y CuotaIvaFAC se copia del antiguo
                        $CantidadFAC=$lineasPedidoAnt[$ii]['CantidadFAC'];
                        $ImporteFAC=$lineasPedidoAnt[$ii]['ImporteFAC'];
                        $CuotaIvaFAC=$lineasPedidoAnt[$ii]['CuotaIvaFAC'];

                        //CantidadPEN, ImportePEN y CuotaIvaPEN se calcula de nuevo (PEN=PED-FAC)
                        //si saliese negativo se pone 0
                        $CantidadPEN=round($CantidadPED-$CantidadFAC,2);
                        if($CantidadPEN<0){
                            $CantidadPEN=0;
                        }
                        $ImportePEN=round($ImportePED-$ImporteFAC,2);
                        if($ImportePEN<0){
                            $ImportePEN=0;
                        }
                        $CuotaIvaPEN=round($CuotaIvaPED-$CuotaIvaFAC,2);
                        if($CuotaIvaPEN<0){
                            $CuotaIvaPEN=0;
                        }

                        //GenFacPed copio el antiguo
                        $GenFacPed=$lineasPedidoAnt[$ii]['GenFacPed'];
                        $IdPresupLineas=$lineasPedidoAnt[$ii]['IdPresupLineas'];
                        $NumLineaPresup=$lineasPedidoAnt[$ii]['NumLineaPresup'];

                        if($GenFacPed==='SI'){
                            //Facturada, si ImporteFAC=0 indicamos 'NF', si ImportePEN=0 indicamos T, sino indicamos 'M'
                            //Pedido, copiamos el que viene de antes
                            if($ImporteFAC==0){
                                $Facturada='NF';
                            }else if($ImportePEN==0){
                                $Facturada='T';
                            }else{
                                $Facturada='M';
                            }
                        }
                        break;
                    }
                }
            }
            
            
            //si existe $lineasPresupuesto[$i]['idPresupLinea'] y es distinto de vacio, lo pongo, sino inserto 0
            $IdPresupL=0;
            if(isset($lineasPresupuesto[$i]['idPresupLinea']) && $lineasPresupuesto[$i]['idPresupLinea']<>''){
                $IdPresupL=$lineasPresupuesto[$i]['idPresupLinea'];
            }
            
            //saco el numero linea nuevo
            $numLinea=$this->numeroPedidoLineaNueva($db);
            $numLineaPedido=0;
            if(isset($lineasPresupuesto[$i]['numLineaPedido']) && $lineasPresupuesto[$i]['numLineaPedido']<>''){
                $numLineaPedido=$lineasPresupuesto[$i]['numLineaPedido'];
            }
            
            

            //controlo el IdArticulo
            //si este viene vacio es NULL
            $IdArticulo = $lineasPresupuesto[$i]['IdArticulo'];
            if($IdArticulo === ''){
                $IdArticulo = 'NULL';
            }
            
            $numLineaPedido=$i+1;
            //inserto en la tabla 'tbmispedidoslineas'
            $strSQL = "
                        INSERT INTO tbmispedidoslineas (IdPedidoLineas,IdPedido,NumLineaPedido,NumLineaPresup,IdPresupLineas,IdArticulo,DescripcionProducto,
                                    TipoIVA,CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,ImportePEN,
                                    CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN,GenFacPed,Facturada) 
                        VALUES ($numLinea,$idPedido,$numLineaPedido,$NumLineaPresup,".$IdPresupLineas.",$IdArticulo,'".$lineasPresupuesto[$i]['concepto']."',".$lineasPresupuesto[$i]['IVA'].",".$CantidadPED.",
                                ".$CantidadFAC.",".$CantidadPEN.",".$lineasPresupuesto[$i]['importeUnidad'].",".$ImportePED.",".$ImporteFAC.",".$ImportePEN.",".$CuotaIvaPED.",".$CuotaIvaFAC.",".$CuotaIvaPEN.",'$GenFacPed','$Facturada')
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarPedido()<ROLLBACK");
                return 'false';
            }
        }

        
        //ahora busco todos los pedidos y facturas que haya asociadas a este presupuesto (que se emitirieron anteriormente, si hay)
        //si $IdPresup=0 es que el pedido no tiene relaccion con el presupuesto
        if($IdPresup>0){
            //extraigo las facturas que tengan este presupuesto
            $facturasEmitidasAntDatos='';
            $strSQL = "
                        SELECT L.IdPresupLineas,ROUND(SUM(L.CantidadPED),2) AS CantidadPED,
                        ROUND(SUM(L.ImportePED),2) AS ImportePED,
                        ROUND(SUM(L.CuotaIvaPED),2) AS CuotaIvaPED
                        FROM tbmisfacturaslineas L,tbmisfacturas F
                        WHERE F.IdFactura=L.IdFactura
                        AND F.Borrado=1
                        AND F.IdPresupuesto=$IdPresup
                        GROUP BY L.IdPresupLineas
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $num=  mysql_num_rows($stmt);
                //veo si hay pedidos anteriores emitidos
                if($num>0){//si hay, las sumo
                    while($row=  mysql_fetch_array($stmt)){
                        $reg='';
                        foreach($row as $propiedad=>$valor){
                            if(!is_numeric($propiedad)){
                                $reg[$propiedad]=$valor;
                            }
                        }
                        //$facturasEmitidasAntDatos[$facturasEmitidasAnt[$i1]][]=$reg;
                        $facturasEmitidasAntDatos[]=$reg;
                    }
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarPedido()<ROLLBACK");
                return 'false';
            }
                
            //y ahora extraigo los pedidos que tengan este presupuesto
            $pedidosEmitidosAntDatos='';
            $strSQL = "
                        SELECT L.IdPresupLineas,ROUND(SUM(L.CantidadPED),2) AS CantidadPED,
                        ROUND(SUM(L.ImportePED),2) AS ImportePED,
                        ROUND(SUM(L.CuotaIvaPED),2) AS CuotaIvaPED
                        FROM tbmispedidoslineas L,tbmispedidos F
                        WHERE F.IdPedido=L.IdPedido
                        AND F.Borrado=1
                        AND F.IdPresupuesto=$IdPresup
                        GROUP BY L.IdPresupLineas                
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $num=  mysql_num_rows($stmt);
                //veo si hay pedidos anteriores emitidos
                if($num>0){//si hay, las sumo
                    while($row=  mysql_fetch_array($stmt)){
                        $reg='';
                        foreach($row as $propiedad=>$valor){
                            if(!is_numeric($propiedad)){
                                $reg[$propiedad]=$valor;
                            }
                        }
                        //$facturasEmitidasAntDatos[$facturasEmitidasAnt[$i1]][]=$reg;
                        $pedidosEmitidosAntDatos[]=$reg;
                    }
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarPedido()<ROLLBACK");
                return 'false';
            }
                
            $resultado = $facturasEmitidasAntDatos;
            if(is_array($resultado)){
                //hay datos en $resultados
                if(is_array($pedidosEmitidosAntDatos)){
                    for ($p = 0; $p < count($pedidosEmitidosAntDatos); $p++) {
                        for ($f = 0; $f < count($resultado); $f++) {
                            $encontrado = 'NO';
                            //si esta linea el IdPresupLineas es el mismo se suma
                            if($pedidosEmitidosAntDatos[$p]['IdPresupLineas'] === $resultado[$f]['IdPresupLineas']){
                                $resultado[$f]['CantidadPED'] = $resultado[$f]['CantidadPED'] + $pedidosEmitidosAntDatos[$p]['CantidadPED'];
                                $resultado[$f]['ImportePED'] = $resultado[$f]['ImportePED'] + $pedidosEmitidosAntDatos[$p]['ImportePED'];
                                $resultado[$f]['CuotaIvaPED'] = $resultado[$f]['CuotaIvaPED'] + $pedidosEmitidosAntDatos[$p]['CuotaIvaPED'];
                                $encontrado = 'SI';
                                break;
                            }
                        }
                        if($encontrado === 'NO'){
                            $row['IdPresupLineas'] = $pedidosEmitidosAntDatos[$p]['IdPresupLineas'];
                            $row['CantidadPED'] = $pedidosEmitidosAntDatos[$p]['CantidadPED'];
                            $row['ImportePED'] = $pedidosEmitidosAntDatos[$p]['ImportePED'];
                            $row['CuotaIvaPED'] = $pedidosEmitidosAntDatos[$p]['CuotaIvaPED'];
                            $resultado[]=$row;
                        }
                    }
                }
            }else{
                //no hay datos en $resultados
                if(is_array($pedidosEmitidosAntDatos)){
                    $resultado = $pedidosEmitidosAntDatos;
                }
            }
        }
        
            
        //ahora voy sumando y actualizando la tabla 'tbmispresupuestoslineas' 
        //recorro los pedidos y las sumo por IdPresupLineas, lo guardo en un array
        //$resultado=$pedidosEmitidosAntDatos;
        //recorro las lineas de cada factura
        for($i=0;$i<count($resultado);$i++){
            //vamos a sumar los valores de CantidadPED, ImportePED y CuotaIvaPED
            $datos='';
            $idx=1;
            if(is_array($resultado)){
                for($i=0;$i<count($resultado);$i++){
                    //veo si existe el array tiene algun dato (es array propiamente dicho)
                    if(is_array($datos)){
                        //busco si el registro existe en el array $datos (IdPresupLineas)
                        for($j=1;$j<=count($datos);$j++){
                            $encontrado='NO';
                            //si existe la IdPresupLineas, actualizo los datos
                            if($datos[$j]['IdPresupLineas']===$resultado[$i]['IdPresupLineas']){
                                $datos[$j]['CantidadPED']=$datos[$j]['CantidadPED']+$resultado[$i]['CantidadPED'];
                                $datos[$j]['ImportePED']=$datos[$j]['ImportePED']+$resultado[$i]['ImportePED'];
                                $datos[$j]['CuotaIvaPED']=$datos[$j]['CuotaIvaPED']+$resultado[$i]['CuotaIvaPED'];
                                $encontrado='SI';
                                break;
                            }
                        }
                        //compruebo si se encontro antes la IdPresupLineas
                        //si no se encontro es que no existe por lo que hay que insertarla
                        if($encontrado==='NO'){
                            $datos[$idx]=array(
                                'IdPresupLineas'=>$resultado[$i]['IdPresupLineas'],
                                'CantidadPED'=>$resultado[$i]['CantidadPED'],
                                'ImportePED'=>$resultado[$i]['ImportePED'],
                                'CuotaIvaPED'=>$resultado[$i]['CuotaIvaPED'],
                            );
                            $idx++;
                        }
                    }
                    //si no es array es que esta vacio, se inserta este dato
                    else{
                        $datos[$idx]=array(
                            'IdPresupLineas'=>$resultado[$i]['IdPresupLineas'],
                            'CantidadPED'=>$resultado[$i]['CantidadPED'],
                            'ImportePED'=>$resultado[$i]['ImportePED'],
                            'CuotaIvaPED'=>$resultado[$i]['CuotaIvaPED'],
                        );
                        $idx++;
                    }
                }
            }
        }
            
        //ahora voy a actualizar las lineas del presupuesto
        //como $datos son las sumas de todos los pedidos anteriores por IdPresupLineas
        //en esta suma pueden no aparecer lineas que si estan en el presupuesto
        //guardo en un array estas lineas para despues poder indicar las que no aparecen pero que si estan 
        //en el presupuesto como GenPedPre=NO y Pedido=T
        $lineasPresupuestoPedidos='';
        if(is_array($datos)){
            //CantidadFAC, ImporteFAC, CuotaIvaFAC, CantidadPEN, ImportePEN y CuotaIvaPEN
            //recorro las IdPresupLineas de cada factura
            for($ii=1;$ii<=count($datos);$ii++){
                //recorro las lineas del presupuesto y actualizo sus valores
                //primero recojo sus valores de CantidadPED, ImportePED y CuotaIvaPED
                $strSQL = "
                           SELECT CantidadPED, ImportePED, CuotaIvaPED
                           FROM tbmispresupuestoslineas
                           WHERE IdPresupLineas=".$datos[$ii]['IdPresupLineas']."
                           ";
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->EditarPedido()<ROLLBACK");
                    return 'false';
                }
                $row=  mysql_fetch_array($stmt);
                //CantidadFAC=CantidadPED y CantidadPEN=CantidadPED-CantidadFAC e idem com Importe y CuotaIva
                $CantidadFAC=$datos[$ii]['CantidadPED'];
                $CantidadPEN=round($row['CantidadPED']-$datos[$ii]['CantidadPED'],2);
                if($CantidadPEN<0){
                    $CantidadPEN=0;
                }
                $ImporteFAC=$datos[$ii]['ImportePED'];
                $ImportePEN=round($row['ImportePED']-$datos[$ii]['ImportePED'],2);
                if($ImportePEN<0){
                    $ImportePEN=0;
                }
                $CuotaIvaFAC=$datos[$ii]['CuotaIvaPED'];
                $CuotaIvaPEN=round($row['CuotaIvaPED']-$datos[$ii]['CuotaIvaPED'],2);
                if($CuotaIvaPEN<0){
                    $CuotaIvaPEN=0;
                }
                
                //el campo Pedido (T=Total, Parcial y NP)
                //si ImportePEN=0, es T, sino es M
                $Pedido='M';//Parcial
                if($ImportePEN==0){
                    $Pedido='T';
                }else if($ImporteFAC==0){
                    $Pedido='NP';
                }
                
                //el campo GenPedPre (Si/NO)
                //si $Pedido es T o M= SI, sino NO
                if($Pedido=='T' || $Pedido=='M'){
                    $GenPedPre='SI';
                }else{
                    $GenPedPre='NO';
                }
                
                $strSQL = "
                           UPDATE tbmispresupuestoslineas
                           SET CantidadFAC=$CantidadFAC,
                           ImporteFAC=$ImporteFAC,
                           CuotaIvaFAC=$CuotaIvaFAC,
                           CantidadPEN=$CantidadPEN,
                           ImportePEN=$ImportePEN,
                           CuotaIvaPEN=$CuotaIvaPEN,
                           Pedido='$Pedido',
                           GenPedPre='$GenPedPre'
                           WHERE IdPresupLineas=".$datos[$ii]['IdPresupLineas']."
                           ";
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->EditarPedido()<ROLLBACK");
                    return 'false';
                }
                $lineasPresupuestoPedidos[]=$datos[$ii]['IdPresupLineas'];
            }
        }

        //primero extraigo las lineas del presupuesto
        $strSQL = "
                   SELECT IdPresupLineas
                   FROM tbmispresupuestoslineas
                   WHERE IdPresupuesto=".$post['IdPresupuesto']."
                   ";
        $stmt = $db->ejecutar ( $strSQL );
        $lineasPresupuesto='';
        if($stmt){
            $num=  mysql_num_rows($stmt);
            //veo si hay pedidos anteriores emitidos
            if($num>0){//si hay, las sumo
                while($row=  mysql_fetch_array($stmt)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $lineasPresupuesto[]=$valor;
                        }
                    }
                }
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarPedido()<ROLLBACK");
            return 'false';
        }

        //ahora busco las lineas sin pedir
        $lineasSinPedir='';
        for($i=0;$i<count($lineasPresupuesto);$i++){
            $lineaSinPedir=array("numero"=>"","Esta"=>"");// SI/NO
            $lineaSinPedir["numero"]=$lineasPresupuesto[$i];
            $lineaSinPedir["Esta"]="NO";
            for($ii=0;$ii<count($lineasPresupuestoPedidos);$ii++){
                if($lineasPresupuesto[$i]==$lineasPresupuestoPedidos[$ii]){
                    $lineaSinPedir["Esta"]="SI";
                    break;
                }
            }
            $lineasSinPedir[]=$lineaSinPedir;
        }

        //ahora estas lineas sin facturar les cambio los campos GenFacPed=NO y Facturada=NF
        foreach($lineasSinPedir as $propiedad=>$valor){
            if($valor['Esta']==='NO'){
                $strSQL = "
                           UPDATE tbmispresupuestoslineas
                           SET GenPedPre='NO',
                           Pedido='NP'
                           WHERE IdPresupLineas=".$valor['numero']."
                           ";
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->EditarPedido()<ROLLBACK");
                    return 'false';
                }
            }
        }
        

        //ahora busco si este pedido tiene ya facturas asociadas a el 
        //si es asi debo actualizar el IdPedido de la tabla 'tbmisfacturas' y las IdPedidoLineas de 'tbmisfacturaslineas'
        $listaFacturasActualizar='';
        //primero compruebo si el dato $post['IdPedido']=Nuevo (es pedido nuevo por lo que no tiene facturas asociadas logicamente)
        if($post['IdPedido']<>'Nuevo'){
            //actualizo el IdPedido en la tabla tbmisfacturas
            $strSQL = "
                        SELECT IdFactura
                        FROM tbmisfacturas
                        WHERE IdPedido=".$post['IdPedido']."
                      ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                while($row=  mysql_fetch_array($stmt)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $reg[$propiedad]=$valor;
                        }
                    }
                    $listaFacturasActualizar[]=$reg;
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->EditarPedido()<ROLLBACK");
                return 'false';
            }

            if(is_array($listaFacturasActualizar)){
                for($i=0;$i<count($listaFacturasActualizar);$i++){
                    $strSQL = "
                                UPDATE tbmisfacturas
                                SET IdPedido=$idPedido
                                WHERE IdFactura=".$listaFacturasActualizar[$i]['IdFactura']."
                              ";
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->EditarPedido()<ROLLBACK");
                        return 'false';
                    }
                    
                    //ahora actualizo también las IdPedidoLineas de la tabla 'tbmisfacturaslineas'
                    //como las IdPedidoLineas que voy a insertar en la tabla 'tbmisfacturas' lineas tienen numeracion nueva
                    //para poder saber que IdPedidoLineas va en la IdFacturaLineas
                    //igualamos los campos de numeracion interna del pedido y la factura
                    //tbmispedidoslineas.NumLineaPedido=tbmisfacturaslineas.NumLineaFactura
                    $strSQL = "
                                SELECT FL.IdFacturaLineas, PL.IdPedidoLineas
                                FROM tbmispedidoslineas PL,tbmisfacturas F,tbmisfacturaslineas FL
                                WHERE PL.IdPedido=$idPedido
                                AND PL.IdPedido=F.IdPedido
                                AND F.IdFactura=FL.IdFactura
                                AND PL.NumLineaPedido=FL.NumLineaPedido                        
                              ";
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
                    $stmt = $db->ejecutar ( $strSQL );
                    $listaFacturaLineasActualizar='';
                    if($stmt){
                        while($row=  mysql_fetch_array($stmt)){
                            $reg='';
                            foreach($row as $propiedad=>$valor){
                                if(!is_numeric($propiedad)){
                                    $reg[$propiedad]=$valor;
                                }
                            }
                            $listaFacturaLineasActualizar[]=$reg;
                        }
                    }else{
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->EditarPedido()<ROLLBACK");
                        return 'false';
                    }

                    if(is_array($listaFacturaLineasActualizar)){
                        for($ii=0;$ii<count($listaFacturaLineasActualizar);$ii++){
                            $strSQL = "
                                        UPDATE tbmisfacturaslineas
                                        SET IdPedidoLineas=".$listaFacturaLineasActualizar[$ii]['IdPedidoLineas']."
                                        WHERE IdFacturaLineas=".$listaFacturaLineasActualizar[$ii]['IdFacturaLineas']."
                                      ";
                            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                    " clsCADContabilidad->EditarPedido()|| SQL : ".$strSQL);
                            $stmt = $db->ejecutar ( $strSQL );
                            if(!$stmt){
                                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                                $db->ejecutar ("ROLLBACK");
                                $db->desconectar ();
                                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                        " clsCADContabilidad->EditarPedido()<ROLLBACK");
                                return 'false';
                            }
                        }
                    }
                }
            }
        }
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarPedido()|| COMMIT");
        
        $db->desconectar ();
        
        //todo correcto, devuelvo el IdFactura
        return $idPedido;
    }

    private function numeroPresupuestoLineaNuevo($db){
        //averiguo el numero de linea de presupuesto de la tabla 'tbmispresupuestoslineas' mas alto que haya
        $strSQL = 'SELECT IdPresupLineas FROM tbmispresupuestoslineas ORDER BY IdPresupLineas DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->numeroPresupuestoLineaNuevo()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $lineaPresup=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $lineaPresup=$row['IdPresupLineas']+1;
            }else{
                $lineaPresup=1;
            }
        }else{
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->numeroPresupuestoLineaNuevo()<FALSE");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->numeroPresupuestoLineaNuevo()|| Nº Linea : ".$lineaPresup);
        return $lineaPresup;
    }
    
    function ListadoFacturas($strNomContacto,$estado,$ejercicio){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();
        require_once '../general/conexion.php';
        $dbG = new DbC();
        
        
        //listo los presupuestos de la tabla 'tbmisfacturas'
        $strSQL = "SELECT IdFactura,NumFactura,IdPresupuesto,IdPedido,Cliente,DATE_FORMAT(FechaFactura,'%d/%m/%Y') AS FechaFactura"
                . ",DATE_FORMAT(FechaVtoFactura,'%d/%m/%Y') AS FechaVtoFactura,FormaPago,Retencion,Estado,Situacion,lngIdUsuario,Borrado,esAbono FROM tbmisfacturas WHERE Borrado=1";
        
        //ahora incluyo el filtro de $estado
        if($estado<>''){
            $strSQL = $strSQL." AND Estado='$estado'";
        }
        
        //ahora incluyo el filtro de $estado
        if($ejercicio<>''){
            $strSQL = $strSQL." AND DATE_FORMAT(FechaFactura,'%Y')=$ejercicio";
        }else{
            $strSQL = $strSQL." AND DATE_FORMAT(FechaFactura,'%Y')=".date('Y');
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoFacturas()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();

        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoFacturas()<FALSE");
            return false;
        }
        $listado='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            //inluyo el campo nombreContacto y totalImporte
            $reg['nombreContacto']='';
            $reg['totalImporte']='';
            $listado[]=$reg;
        }

        //extraigo los PDF que hay en la carpeta 'facturasEnviadas'
        $directorio = opendir("../facturasEnviadas"); //ruta actual
        $PDF_guardados='';
        $ii=0;
        while ($archivo = readdir($directorio)) //obtenemos un archivo y luego otro sucesivamente
        {
            if (!is_dir($archivo))//verificamos si es o no un directorio
            {
                $PDF_guardados[$ii]['archivo']=$archivo;
                $PDF_guardados[$ii]['fecha']=date("d/m/Y", filemtime("../facturasEnviadas/".$archivo));
                $ii++;
            }
        }        

        // preparo un array con los codigos y nombre del cliente
        $strSQL = "
                   SELECT R.codigo,C.nombre
                   FROM tbrelacioncliprov R,tbcliprov C
                   WHERE IdEmpresa=".$_SESSION['idEmp'].
                   " AND R.Borrado=0   
                   AND R.IdCliProv=C.IdCliProv
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoFacturas()|| SQL : ".$strSQL);
        $dbG->conectar($this->getStrBD());
        $stmt = $dbG->ejecutar ( $strSQL );
        $dbG->desconectar();

        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoFacturas()<FALSE");
            return false;
        }
        
        $clientesNombres='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            $clientesNombres[]=$reg;
        }
        
        
        //el listado le añado informacion del cliente y del total importe que se busca en la BBDD
        if(is_array($listado)){
            for($i=0;$i<count($listado);$i++){
                //1- busco el nombre Empresa del contacto o cliente segun su campo Contacto_Cliente
                //busco en la tabla 'tbcliprov'
                //como el numero que tenemos es Ej: CL.430000006, tenemos 4300 que es cliente y 00006 que es el numero
                //en la tabla 'tbrelacioncliprov' tenemos el campo IdEmpresa=$_SESSION[idEmp]
                //codigo=00006 y CliProv=0, y por supuesto Borrado=0
                //si coinciden estas clausulas hemos encontrado el IdCliProv y en la tabla 'tbcliprov' extraeremos los datos
//                $codigo=substr($listado[$i]['Cliente'],4,5);
                $codigo=$listado[$i]['Cliente'];
                
                $listado[$i]['nombreContacto']='';
                foreach($clientesNombres as $unCliente){
                    if($unCliente['codigo']===$codigo){
                        $listado[$i]['nombreContacto']=$unCliente['nombre'];
                        break;
                    }
                }
                    
                //2- busco el total de la factura
                //busco en la tabla 'tbmisfacturaslineas' segun el campo idFactura los campos 'ImportePED' y 'CuotaIvaPED'
                //y los sumamos 
                $strSQL = "SELECT ImportePED,CuotaIvaPED FROM tbmisfacturaslineas WHERE IdFactura=".$listado[$i]['IdFactura'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->ListadoFacturas()|| SQL : ".$strSQL);

                $dbC->conectar($this->getStrBDCliente());
                $stmt = $dbC->ejecutar ( $strSQL );
                $dbC->desconectar();

                if(!$stmt){
                    //devolvemos false
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->ListadoFacturas()<FALSE");
                    return false;
                }
                $importeLineas='';
                while($row=  mysql_fetch_array($stmt)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $reg[$propiedad]=$valor;
                        }
                    }
                    $importeLineas[]=$reg;
                }
                //sumo los valores extraidos
                $sumaImporte=0;
                $sumaCuota=0;
                for($ii=0;$ii<count($importeLineas);$ii++){
                    $sumaImporte=$sumaImporte+$importeLineas[$ii]['ImportePED'];
                    $sumaCuota=$sumaCuota+$importeLineas[$ii]['CuotaIvaPED'];
                }
                $listado[$i]['totalImporte']=$sumaImporte+$sumaCuota-round(($sumaImporte*$listado[$i]['Retencion']/100),2);
                
                //3- indico si hay fichero PDF en la carpeta 'facturasEnviadas'
                //busco en el array $PDF_guardados
                //por defecto indico 'NO'
                $listado[$i]['existePDF']='NO';
                if($PDF_guardados<>''){
                    for($jj=0;$jj<count($PDF_guardados);$jj++){
                        $ejercicio=substr($listado[$i]['NumFactura'],0,4);
                        $numero=substr($listado[$i]['NumFactura'],4,4);
                        //$archivoPDF='Factura_'.$_SESSION['idEmp'].'-'.$ejercicio.'-'.$numero.'.pdf';
                        $archivoPDF='Factura_'.$_SESSION['idEmp'].'-'.$listado[$i]['NumFactura'].'.pdf';
                        if($PDF_guardados[$jj]['archivo']===$archivoPDF){
                            $listado[$i]['existePDF']=$PDF_guardados[$jj]['fecha'];
                            break;
                        }
                    }
                }
                
                //4a- Busco en numero de presupuesto
                if($listado[$i]['IdPresupuesto']<>0){
                    $strSQL = "SELECT NumPresupuesto FROM tbmispresupuestos WHERE IdPresupuesto=".$listado[$i]['IdPresupuesto'];
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->ListadoFacturas()|| SQL : ".$strSQL);

                    $dbC->conectar($this->getStrBDCliente());
                    $stmt = $dbC->ejecutar ( $strSQL );
                    $dbC->desconectar();

                    if(!$stmt){
                        //devolvemos false
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                               " clsCADContabilidad->ListadoFacturas()<FALSE");
                        return false;
                    }
                    $row=  mysql_fetch_array($stmt);
                    $listado[$i]['NumPresupuesto']=$row['NumPresupuesto'];
                }else{
                    $listado[$i]['NumPresupuesto']='0';
                }
                
                //4b- Busco en numero de pedido
                if($listado[$i]['IdPedido']<>0){
                    $strSQL = "SELECT NumPedido FROM tbmispedidos WHERE IdPedido=".$listado[$i]['IdPedido'];
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->ListadoFacturas()|| SQL : ".$strSQL);

                    $dbC->conectar($this->getStrBDCliente());
                    $stmt = $dbC->ejecutar ( $strSQL );
                    $dbC->desconectar();

                    if(!$stmt){
                        //devolvemos false
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                               " clsCADContabilidad->ListadoFacturas()<FALSE");
                        return false;
                    }
                    $row=  mysql_fetch_array($stmt);
                    $listado[$i]['NumPedido']=$row['NumPedido'];
                }else{
                    $listado[$i]['NumPedido']='0';
                }
            }
        
            //ahora solo queda ver si el filtro $strNomContacto existe y se aplica
            $listadoFinal='';
            if($strNomContacto<>''){
                //recorremos el array e incluimos en un nuevo array los registros que cumplan el filtro
                for($i=0;$i<count($listado);$i++){
                    //compruebo si el campo nombreContacto esta la cadena de texto que viene en $strNomContacto
                    if(stristr($listado[$i]['nombreContacto'],$strNomContacto)==true){
                        //si lo cumple se incluye en el nuevo array
                        $listadoFinal[]=$listado[$i];
                    }
                }
            }else{
                $listadoFinal=$listado;
            }
        }else{
            //no ha encontrado nada
            return '';
        }
        
        return $listadoFinal;
    }

    function ListadoFacturasDetalleIVA($get){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();
        require_once '../general/conexion.php';
        $dbG = new DbC();
        
        
        //listo los presupuestos de la tabla 'tbmisfacturas'
        $strSQL = "SELECT IdFactura,NumFactura,IdPresupuesto,IdPedido,Cliente,DATE_FORMAT(FechaFactura,'%d/%m/%Y') AS FechaFactura"
                . ",DATE_FORMAT(FechaVtoFactura,'%d/%m/%Y') AS FechaVtoFactura,FormaPago,Retencion,Estado,Situacion,lngIdUsuario,Borrado FROM tbmisfacturas WHERE Borrado=1";
        
        //ahora incluyo el filtro de $estado
        if($get['estado']<>''){
            $strSQL = $strSQL." AND Estado='".$get['estado']."'";
        }
        
        //ahora incluyo el filtro de $estado
        if($get['ejercicio']<>''){
            $strSQL = $strSQL." AND DATE_FORMAT(FechaFactura,'%Y')=".$get['ejercicio'];
        }else{
            $strSQL = $strSQL." AND DATE_FORMAT(FechaFactura,'%Y')=".date('Y');
        }
        
        if($get['datFechaInicio']<>''){
            $strSQL = $strSQL . " AND FechaFactura >= '" . fecha_to_DATETIME($get['datFechaInicio'])."'";
        }
        
        if($get['datFechaFin']<>''){
            $strSQL = $strSQL . " AND FechaFactura <= '" . fecha_to_DATETIME_F($get['datFechaFin'])."'";
        }
        
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoFacturasDetalleIVA()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();

        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoFacturasDetalleIVA()<FALSE");
            return false;
        }
        
        $listado='';
        while($row = mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            
            //var_dump($reg);die;
            
            //incluyo el resto de campos a presentar que debo de buscar en otras tablas o clacular
            //busco el cliente en la tabla 'tbcuenta'
            $strSQL = "
                        SELECT C.Nombre
                        FROM tbcuenta C
                        WHERE C.NumCuenta='".$reg['Cliente']."'
                        AND C.Borrado = 0
                      ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoFacturasDetalleIVA()|| SQL : ".$strSQL);

            $dbC->conectar($this->getStrBDCliente());
            $stmtCli = $dbC->ejecutar ( $strSQL );
            $dbC->desconectar();

            if(!$stmtCli){
                //devolvemos false
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->ListadoFacturasDetalleIVA()<FALSE");
                return false;
            }
            $rowCli = mysql_fetch_array($stmtCli);
            $reg['Cliente'] = $rowCli['Nombre'];

            //ahora calculo la base imponible
            //busco en la tabla 'tbmisfacturaslineas' segun el campo idFactura los campos 'ImportePED'(Base Imponible) y 'CuotaIvaPED' (Cuota IVA)
            //y los sumamos 
            $strSQL = "SELECT ImportePED,CuotaIvaPED FROM tbmisfacturaslineas WHERE IdFactura=".$reg['IdFactura'];
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoFacturasDetalleIVA()|| SQL : ".$strSQL);

            $dbC->conectar($this->getStrBDCliente());
            $stmtIL = $dbC->ejecutar ( $strSQL );
            $dbC->desconectar();

            if(!$stmtIL){
                //devolvemos false
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->ListadoFacturasDetalleIVA()<FALSE");
                return false;
            }
            $importeLineas='';
            while($rowIL = mysql_fetch_array($stmtIL)){
                $regIL='';
                foreach($rowIL as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $regIL[$propiedad]=$valor;
                    }
                }
                $importeLineas[]=$regIL;
            }
            //sumo los valores extraidos
            $sumaImporte=0;
            $sumaCuota=0;
            for($ii=0;$ii<count($importeLineas);$ii++){
                $sumaImporte = $sumaImporte + $importeLineas[$ii]['ImportePED'];
                $sumaCuota = $sumaCuota + $importeLineas[$ii]['CuotaIvaPED'];
            }
            $reg['BaseImponible'] = $sumaImporte;
            $reg['cuotaIVA'] = $sumaCuota;
            $reg['totalImporte'] = $sumaImporte+$sumaCuota-round(($sumaImporte*$reg['Retencion']/100),2);
            
            $listado[]=$reg;
        }

        //var_dump($listado);die;
        
        //el listado le añado informacion del cliente y del total importe que se busca en la BBDD
        if(is_array($listado)){
            //ahora solo queda ver si el filtro $strNomContacto existe y se aplica
            $listadoFinal='';
            if($get['strNomContacto']<>''){
                //recorremos el array e incluimos en un nuevo array los registros que cumplan el filtro
                for($i=0;$i<count($listado);$i++){
                    //compruebo si el campo nombreContacto esta la cadena de texto que viene en $strNomContacto
                    if(stristr($listado[$i]['Cliente'],$get['strNomContacto']) == true){
                        //si lo cumple se incluye en el nuevo array
                        $listadoFinal[]=$listado[$i];
                    }
                }
            }else{
                $listadoFinal=$listado;
            }
        }else{
            //no ha encontrado nada
            return '';
        }
        
        return $listadoFinal;
    }

    function ListadoPedidosAFacturar($strNomContacto,$estado,$filtroFecha){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();
        require_once '../general/conexion.php';
        $dbG = new DbC();

        //listo los pedidos de la tabla 'tbmispedidos'
        $strSQL = "SELECT IdPedido,NumPedido,Cliente,DATE_FORMAT(FechaProximaFacturaPeriodica,'%d/%m/%Y') AS FechaProximaFacturaPeriodica"
                . ",DATE_FORMAT(FechaVtoPedido,'%d/%m/%Y') AS FechaVtoPedido,DATE_FORMAT(FechaFinalizacion,'%d/%m/%Y') AS FechaFinalizacion,Estado,TipoFactura,Retencion,lngIdUsuario FROM tbmispedidos WHERE Borrado=1";
        
        //ahora incluyo el filtro de $estado
        if($estado<>''){
            $strSQL = $strSQL." AND Estado='$estado'";
        }
        
        //ahora incluyo el filtro de $filtroFecha
        if($filtroFecha === '30dias' || $filtroFecha == null){
            $strSQL = $strSQL." AND FechaProximaFacturaPeriodica <= ADDDATE(NOW(),+30)";
        }
        
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoPedidosAFacturar()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();

        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoPedidosAFacturar()<FALSE");
            return false;
        }
        $listado='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            //inluyo el campo nombreContacto y totalImporte
            $reg['nombreContacto']='';
            $reg['totalImporte']='';
            $retencion = $reg['Retencion'];
            //controlo si la fecha es '0000-00-00..' la indico vacia
            if($reg['FechaProximaFacturaPeriodica'] === '00/00/0000'){
                $reg['FechaProximaFacturaPeriodica'] = '';
            }
            if($reg['FechaVtoPedido'] === '00/00/0000'){
                $reg['FechaVtoPedido'] = '';
            }
            if($reg['FechaFinalizacion'] === '00/00/0000'){
                $reg['FechaFinalizacion'] = '';
            }
            
            //aqui indico el texto del listado en el campo 'Facturar'
            //Puede ser:
            // Puntual +check
            // Periodico +check
            // Terminado
            
            $FF = explode('/',$reg['FechaFinalizacion']);
            $FF = $FF[2].$FF[1].$FF[0];
            $FPF = explode('/',$reg['FechaProximaFacturaPeriodica']);
            $FPF = $FPF[2].$FPF[1].$FPF[0];
            //guardo esta fecha proxima factura periodica ord, para poder ordenar
            $reg['FechaProximaFacturaPeriodicaOrd'] = $FPF;
            $hoy = explode('/',date("d/m/Y")); 
            $hoy = $hoy[2].$hoy[1].$hoy[0];
            
            //si $FPF esta vacio o null o 0000-00-00.... es que esta terminado este pedido
            if($FPF === '' || $FPF === null || $FPF === '0000-00-00 00:00:00'){
                $reg['accion'] = "Terminado";
            }else{
                //extraigo la diferencia entre FF y FPF
                $dif = (int)$FF-(int)$FPF; 

                //existe FechaFinalizacion y esta es menor que FechaProximaFacturaPeriodica 
                if($FF !== '' && $dif < 0){
                    $reg['accion'] = "Terminado";
                }else{
                    if($reg['TipoFactura'] === 'Periodica'){
                        $reg['accion'] = 'Periodica <input type="checkbox" id="check'.$reg['IdPedido'].'" name="'.$reg['IdPedido'].'" onchange="indicarAccion(this,'.$reg['IdPedido'].');" />';
                    }else
                    if($reg['TipoFactura'] === 'Puntual'){
                        $reg['accion'] = 'Puntual <input type="checkbox" id="check'.$reg['IdPedido'].'" name="'.$reg['IdPedido'].'" onchange="indicarAccion(this,'.$reg['IdPedido'].');" />';
                    }
                }
            }
            
            $listado[]=$reg;
        }
        
        //preparamos un array con los contactos, con los IdContacto ($contacto[1]) y nombre 
        $strSQL = "
                    SELECT IdContacto,NombreEmpresa FROM tbmiscontactos
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoPedidosAFacturar()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();

        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoPedidosAFacturar()<FALSE");
            return false;
        }
        
        $contactosNombres='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            $contactosNombres[]=$reg;
        }
        
        
        // preparo un array con los codigos y nombre del cliente
        $strSQL = "
                    SELECT R.codigo,C.nombre
                    FROM tbrelacioncliprov R,tbcliprov C
                    WHERE IdEmpresa=".$_SESSION['idEmp']."
                    AND R.Borrado=0   
                    AND R.IdCliProv=C.IdCliProv
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoPedidosAFacturar()|| SQL : ".$strSQL);
        $dbG->conectar($this->getStrBD());
        $stmt = $dbG->ejecutar ( $strSQL );
        $dbG->desconectar();

        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoPedidosAFacturar()<FALSE");
            return false;
        }
        
        $clientesNombres='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            $clientesNombres[]=$reg;
        }
        
        
        //el listado le añado informacion del cliente y del total importe que se busca en la BBDD
        if(is_array($listado)){
            for($i=0;$i<count($listado);$i++){
                //1- busco el nombre Empresa del contacto o cliente segun su campo Contacto_Cliente
                //$contacto=explode('.',$listado[$i]['Cliente']);
                $contacto=$listado[$i]['Cliente'];
                //si es CO= Contacto busco en la tabla 'tbmiscontactos', si CL= cliente, buscaria en la tabla 'tbcliprov'
//                if($contacto[0]==='CO'){
//                    $listado[$i]['nombreContacto']='';
//                    foreach($contactosNombres as $unContacto){
//                        if($unContacto['IdContacto']===$contacto[1]){
//                            $listado[$i]['nombreContacto']=$unContacto['NombreEmpresa'];
//                            break;
//                        }
//                    }
//                }else
//                if($contacto[0]==='CL'){
                    //busco en la tabla 'tbcliprov'
                    //como el numero que tenemos es Ej: CL.430000006, tenemos 4300 que es cliente y 00006 que es el numero
                    //en la tabla 'tbrelacioncliprov' tenemos el campo IdEmpresa=$_SESSION[idEmp]
                    //codigo=00006 y CliProv=0, y por supuesto Borrado=0
                    //si coinciden estas clausulas hemos encontrado el IdCliProv y en la tabla 'tbcliprov' extraeremos los datos
                    //$codigo=substr($contacto[1],4,5);
                    $codigo=$contacto;
                    
                    $listado[$i]['nombreContacto']='';
                    foreach($clientesNombres as $unCliente){
                        if($unCliente['codigo']===$codigo){
                            $listado[$i]['nombreContacto']=$unCliente['nombre'];
                            break;
                        }
                    }
//                }
                
                
                //2- busco el total del pedido
                //busco en la tabla 'tbmispedidoslineas' segun el campo idPedido los campos 'ImportePED' y 'CuotaIvaPED'
                //y los sumamos 
                $strSQL = "SELECT ImportePED,CuotaIvaPED,Facturada FROM tbmispedidoslineas WHERE IdPedido=".$listado[$i]['IdPedido'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->ListadoPedidos()|| SQL : ".$strSQL);

                $dbC->conectar($this->getStrBDCliente());
                $stmt = $dbC->ejecutar ( $strSQL );
                $dbC->desconectar();

                if(!$stmt){
                    //devolvemos false
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->ListadoPedidos()<FALSE");
                    return false;
                }
                $importeLineas='';
                while($row=  mysql_fetch_array($stmt)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $reg[$propiedad]=$valor;
                        }
                    }
                    $importeLineas[]=$reg;
                }
                //sumo los valores extraidos e indico si la factura es facturada o no
                //(es facturada cuando tiene todas sus lineas en SI)
                $sumaImporte=0;
                $sumaCuota=0;
                //ahora vemos si la factura esta facturada total=SI, parcial=Parcial o no esta facturada=NO
                //como tenemos que comparar todas las lineas para saberlo, sabemos que si todas las lineas son
                //NF es que no esta facturada (Caso 1), si todas estan en T es factura total (Caso 2), y para el resto de convinaciones
                //es una factura parcial (Caso 3)
                //para poder saberlo hago tres contadores que guardan los valores de cada estado
                $contNF=0;
                $contT=0;
                $contParcial=0;
                for($ii=0;$ii<count($importeLineas);$ii++){
                    $sumaImporte=$sumaImporte+$importeLineas[$ii]['ImportePED'];
                    $sumaCuota=$sumaCuota+$importeLineas[$ii]['CuotaIvaPED'];
                    //voy contando según la opción facturada
                    if($importeLineas[$ii]['Facturada']==='NF'){
                        $contNF++;
                    }
                    if($importeLineas[$ii]['Facturada']==='T'){
                        $contT++;
                    }
                    if($importeLineas[$ii]['Facturada']==='M'){
                        $contParcial++;
                    }
                }
                //facturadas
                //Caso 1 [NO](no facturada)
                if($contT===0 && $contParcial===0){
                    $listado[$i]['GenFacPed']='NO';
                }else
                //Caso 2 [SI](facturada total)
                if($contNF===0 && $contParcial===0){
                    $listado[$i]['GenFacPed']='SI';
                }
                //Caso 3 [Parcial](facturada parcial) , el resto de casos
                else{
                    $listado[$i]['GenFacPed']='Parcial';
                }
                $listado[$i]['totalImporte']=$sumaImporte+$sumaCuota-round(($sumaImporte*$retencion/100),2);
            }
        
            //ahora solo queda ver si el filtro $strNomContacto existe y se aplica
            $listadoFinal='';
            if($strNomContacto<>''){
                //recorremos el array e incluimos en un nuevo array los registros que cumplan el filtro
                for($i=0;$i<count($listado);$i++){
                    //compruebo si el campo nombreContacto esta la cadena de texto que viene en $strNomContacto
                    if(stristr($listado[$i]['nombreContacto'],$strNomContacto)==true){
                        //si lo cumple se incluye en el nuevo array
                        $listadoFinal[]=$listado[$i];
                    }
                }
            }else{
                $listadoFinal=$listado;
            }
        }else{
            //no ha encontrado nada
            return '';
        }
        
        return $listadoFinal;
    }
    
    function ListadoPedidos($strNomContacto,$estado){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();
        require_once '../general/conexion.php';
        $dbG = new DbC();
        
        
        //listo los pedidos de la tabla 'tbmispedidos'
        $strSQL = "SELECT IdPedido,NumPedido,IdPresupuesto,Cliente,DATE_FORMAT(FechaPedido,'%d/%m/%Y') AS FechaPedido"
                . ",DATE_FORMAT(FechaVtoPedido,'%d/%m/%Y') AS FechaVtoPedido,FormaPago,Retencion,Estado,lngIdUsuario,TipoFactura,Borrado FROM tbmispedidos WHERE Borrado=1";
        
        //ahora incluyo el filtro de $strFormaPago
        if($estado<>''){
            $strSQL = $strSQL." AND Estado='$estado' ORDER BY IdPedido ASC";
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoPedidos()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();

        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoPedidos()<FALSE");
            return false;
        }
        $listado='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            //inluyo el campo nombreContacto y totalImporte
            $reg['nombreContacto']='';
            $reg['totalImporte']='';
            //controlo si la fecha es '000-00-00..' la indico vacia
            if($reg['FechaPedido'] === '00/00/0000'){
                $reg['FechaPedido'] = '';
            }
            if($reg['FechaVtoPedido'] === '00/00/0000'){
                $reg['FechaVtoPedido'] = '';
            }
            $listado[]=$reg;
        }

        //extraigo los PDF que hay en la carpeta 'pedidosEnviados'
        $directorio = opendir("../pedidosEnviados"); //ruta actual
        $PDF_guardados='';
        $ii=0;
        while ($archivo = readdir($directorio)) //obtenemos un archivo y luego otro sucesivamente
        {
            if (!is_dir($archivo))//verificamos si es o no un directorio
            {
                $PDF_guardados[$ii]['archivo']=$archivo;
                $PDF_guardados[$ii]['fecha']=date("d/m/Y", filemtime("../pedidosEnviados/".$archivo));
                $ii++;
            }
        }        

        
        //preparamos un array con los contactos, con los IdContacto ($contacto[1]) y nombre 
        $strSQL = "
                    SELECT IdContacto,NombreEmpresa FROM tbmiscontactos
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoPedidos()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();

        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoPedidos()<FALSE");
            return false;
        }
        
        $contactosNombres='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            $contactosNombres[]=$reg;
        }
        
        
        // preparo un array con los codigos y nombre del cliente
        $strSQL = "
                    SELECT R.codigo,C.nombre
                    FROM tbrelacioncliprov R,tbcliprov C
                    WHERE IdEmpresa=".$_SESSION['idEmp']."
                    AND R.Borrado=0   
                    AND R.IdCliProv=C.IdCliProv
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoPedidos()|| SQL : ".$strSQL);
        $dbG->conectar($this->getStrBD());
        $stmt = $dbG->ejecutar ( $strSQL );
        $dbG->desconectar();

        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoPedidos()<FALSE");
            return false;
        }
        
        $clientesNombres='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            $clientesNombres[]=$reg;
        }
        
        
        //el listado le añado informacion del cliente y del total importe que se busca en la BBDD
        if(is_array($listado)){
            for($i=0;$i<count($listado);$i++){
                //1- busco el nombre Empresa del contacto o cliente segun su campo Contacto_Cliente
                //$contacto=explode('.',$listado[$i]['Cliente']);
                $contacto=$listado[$i]['Cliente'];
                //si es CO= Contacto busco en la tabla 'tbmiscontactos', si CL= cliente, buscaria en la tabla 'tbcliprov'
//                if($contacto[0]==='CO'){
//                    $listado[$i]['nombreContacto']='';
//                    foreach($contactosNombres as $unContacto){
//                        if($unContacto['IdContacto']===$contacto[1]){
//                            $listado[$i]['nombreContacto']=$unContacto['NombreEmpresa'];
//                            break;
//                        }
//                    }
//                }else
//                if($contacto[0]==='CL'){
                    //busco en la tabla 'tbcliprov'
                    //como el numero que tenemos es Ej: CL.430000006, tenemos 4300 que es cliente y 00006 que es el numero
                    //en la tabla 'tbrelacioncliprov' tenemos el campo IdEmpresa=$_SESSION[idEmp]
                    //codigo=00006 y CliProv=0, y por supuesto Borrado=0
                    //si coinciden estas clausulas hemos encontrado el IdCliProv y en la tabla 'tbcliprov' extraeremos los datos
                    //$codigo=substr($contacto[1],4,5);
                    $codigo=$contacto;
                    
                    $listado[$i]['nombreContacto']='';
                    foreach($clientesNombres as $unCliente){
                        if($unCliente['codigo']===$codigo){
                            $listado[$i]['nombreContacto']=$unCliente['nombre'];
                            break;
                        }
                    }
//                }
                
                
                //2- busco el total del pedido
                //busco en la tabla 'tbmispedidoslineas' segun el campo idPedido los campos 'ImportePED' y 'CuotaIvaPED'
                //y los sumamos 
                $strSQL = "SELECT ImportePED,CuotaIvaPED,Facturada FROM tbmispedidoslineas WHERE IdPedido=".$listado[$i]['IdPedido'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->ListadoPedidos()|| SQL : ".$strSQL);

                $dbC->conectar($this->getStrBDCliente());
                $stmt = $dbC->ejecutar ( $strSQL );
                $dbC->desconectar();

                if(!$stmt){
                    //devolvemos false
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->ListadoPedidos()<FALSE");
                    return false;
                }
                $importeLineas='';
                while($row=  mysql_fetch_array($stmt)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $reg[$propiedad]=$valor;
                        }
                    }
                    $importeLineas[]=$reg;
                }
                //sumo los valores extraidos e indico si la factura es facturada o no
                //(es facturada cuando tiene todas sus lineas en SI)
                $sumaImporte=0;
                $sumaCuota=0;
                //ahora vemos si la factura esta facturada total=SI, parcial=Parcial o no esta facturada=NO
                //como tenemos que comparar todas las lineas para saberlo, sabemos que si todas las lineas son
                //NF es que no esta facturada (Caso 1), si todas estan en T es factura total (Caso 2), y para el resto de convinaciones
                //es una factura parcial (Caso 3)
                //para poder saberlo hago tres contadores que guardan los valores de cada estado
                $contNF=0;
                $contT=0;
                $contParcial=0;
                for($ii=0;$ii<count($importeLineas);$ii++){
                    $sumaImporte=$sumaImporte+$importeLineas[$ii]['ImportePED'];
                    $sumaCuota=$sumaCuota+$importeLineas[$ii]['CuotaIvaPED'];
                    //voy contando según la opción facturada
                    if($importeLineas[$ii]['Facturada']==='NF'){
                        $contNF++;
                    }
                    if($importeLineas[$ii]['Facturada']==='T'){
                        $contT++;
                    }
                    if($importeLineas[$ii]['Facturada']==='M'){
                        $contParcial++;
                    }
                }
                //facturadas
                //Caso 1 [NO](no facturada)
                if($contT===0 && $contParcial===0){
                    $listado[$i]['GenFacPed']='NO';
                }else
                //Caso 2 [SI](facturada total)
                if($contNF===0 && $contParcial===0){
                    $listado[$i]['GenFacPed']='SI';
                }
                //Caso 3 [Parcial](facturada parcial) , el resto de casos
                else{
                    $listado[$i]['GenFacPed']='Parcial';
                }
                $listado[$i]['totalImporte']=$sumaImporte+$sumaCuota-round(($sumaImporte*$listado[$i]['Retencion']/100),2);
                
                //3- indico si hay fichero PDF en la carpeta 'pedidosEnviados'
                //busco en el array $PDF_guardados
                //por defecto indico 'NO'
                $listado[$i]['existePDF']='NO';
                if($PDF_guardados<>''){
                    for($jj=0;$jj<count($PDF_guardados);$jj++){
                        $ejercicio=substr($listado[$i]['NumPedido'],0,4);
                        $numero=substr($listado[$i]['NumPedido'],4,4);
                        //$archivoPDF='Pedido_'.$_SESSION['idEmp'].'-'.$ejercicio.'-'.$numero.'.pdf';
                        $archivoPDF='Pedido_'.$_SESSION['idEmp'].'-'.$listado[$i]['NumPedido'].'.pdf';
                        if($PDF_guardados[$jj]['archivo']===$archivoPDF){
                            $listado[$i]['existePDF']=$PDF_guardados[$jj]['fecha'];
                            break;
                        }
                    }
                }
                
                //4- Busco en numero de presupuesto
                if($listado[$i]['IdPresupuesto']<>0){
                    $strSQL = "SELECT NumPresupuesto FROM tbmispresupuestos WHERE IdPresupuesto=".$listado[$i]['IdPresupuesto'];
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->ListadoPedidos()|| SQL : ".$strSQL);

                    $dbC->conectar($this->getStrBDCliente());
                    $stmt = $dbC->ejecutar ( $strSQL );
                    $dbC->desconectar();

                    if(!$stmt){
                        //devolvemos false
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                               " clsCADContabilidad->ListadoPedidos()<FALSE");
                        return false;
                    }
                    $row=  mysql_fetch_array($stmt);
                    $listado[$i]['NumPresupuesto']=$row['NumPresupuesto'];
                }else{
                    $listado[$i]['NumPresupuesto']='0';
                }
            }
        
            //ahora solo queda ver si el filtro $strNomContacto existe y se aplica
            $listadoFinal='';
            if($strNomContacto<>''){
                //recorremos el array e incluimos en un nuevo array los registros que cumplan el filtro
                for($i=0;$i<count($listado);$i++){
                    //compruebo si el campo nombreContacto esta la cadena de texto que viene en $strNomContacto
                    if(stristr($listado[$i]['nombreContacto'],$strNomContacto)==true){
                        //si lo cumple se incluye en el nuevo array
                        $listadoFinal[]=$listado[$i];
                    }
                }
            }else{
                $listadoFinal=$listado;
            }
        }else{
            //no ha encontrado nada
            return '';
        }
        
        return $listadoFinal;
    }
    
    
    function ListadoPresupuestos($strNomContacto,$estado){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();
        require_once '../general/conexion.php';
        $dbG = new DbC();
        
        
        //listo los presupuestos de la tabla 'tbmispresupuestos'
        $strSQL = "SELECT IdPresupuesto,NumPresupuesto,Contacto_Cliente,DATE_FORMAT(FechaPresupuesto,'%d/%m/%Y') AS FechaPresupuesto"
                . ",DATE_FORMAT(FechaVtoPresupuesto,'%d/%m/%Y') AS FechaVtoPresupuesto,FormaPago,Retencion,Estado,lngIdUsuario,Borrado FROM tbmispresupuestos WHERE Borrado=1";
        
        //ahora incluyo el filtro de $strFormaPago
        if($estado<>''){
            // si es Aceptado que filtre por Aceptado y Pendiente (por defecto)
            if($estado==='Aceptado'){
                $strSQL = $strSQL." AND (Estado='Aceptado' OR Estado='Pendiente') ";
            }else{
                $strSQL = $strSQL." AND Estado='$estado'";
            }
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoPresupuestos()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();
        
        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoPresupuestos()<FALSE");
            return false;
        }
        $listado='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            //inluyo el campo nombreContacto y totalImporte
            $reg['nombreContacto']='';
            $reg['totalImporte']='';
            $listado[]=$reg;
        }

        //extraigo los PDF que hay en la carpeta 'presupuestosEnviados'
        $directorio = opendir("../presupuestosEnviados"); //ruta actual
        $PDF_guardados='';
        $ii=0;
        while ($archivo = readdir($directorio)) //obtenemos un archivo y luego otro sucesivamente
        {
            if (!is_dir($archivo))//verificamos si es o no un directorio
            {
                $PDF_guardados[$ii]['archivo']=$archivo;
                $PDF_guardados[$ii]['fecha']=date("d/m/Y", filemtime("../presupuestosEnviados/".$archivo));
                $ii++;
            }
        }
        
        
        //preparamos un array con los contactos, con los IdContacto ($contacto[1]) y nombre 
        $strSQL = "
                    SELECT IdContacto,NombreEmpresa FROM tbmiscontactos
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoPresupuestos()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();

        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoPresupuestos()<FALSE");
            return false;
        }
        
        $contactosNombres='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            $contactosNombres[]=$reg;
        }
        
        
        // preparo un array con los codigos y nombre del cliente
        $strSQL = "
                    SELECT R.codigo,C.nombre
                    FROM tbrelacioncliprov R,tbcliprov C
                    WHERE IdEmpresa=".$_SESSION['idEmp']."
                    AND R.Borrado=0   
                    AND R.IdCliProv=C.IdCliProv
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ListadoFacturas()|| SQL : ".$strSQL);
        $dbG->conectar($this->getStrBD());
        $stmt = $dbG->ejecutar ( $strSQL );
        $dbG->desconectar();

        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ListadoFacturas()<FALSE");
            return false;
        }
        
        $clientesNombres='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            $clientesNombres[]=$reg;
        }
        
       
        //el listado le añado informacion del cliente y del total importe que se busca en la BBDD
        if(is_array($listado)){
            for($i=0;$i<count($listado);$i++){
                //1- busco el nombre Empresa del contacto o cliente segun su campo Contacto_Cliente
                $contacto=explode('.',$listado[$i]['Contacto_Cliente']);
                //si es CO= Contacto busco en la tabla 'tbmiscontactos', si CL= cliente, buscaria en la tabla 'tbcliprov'
                if($contacto[0]==='CO'){
                    $listado[$i]['nombreContacto']='';
                    foreach($contactosNombres as $unContacto){
                        if($unContacto['IdContacto']===$contacto[1]){
                            $listado[$i]['nombreContacto']=$unContacto['NombreEmpresa'];
                            break;
                        }
                    }
                }else
                if($contacto[0]==='CL'){
                    //busco en la tabla 'tbcliprov'
                    //como el numero que tenemos es Ej: CL.430000006, tenemos 4300 que es cliente y 00006 que es el numero
                    //en la tabla 'tbrelacioncliprov' tenemos el campo IdEmpresa=$_SESSION[idEmp]
                    //codigo=00006 y CliProv=0, y por supuesto Borrado=0
                    //si coinciden estas clausulas hemos encontrado el IdCliProv y en la tabla 'tbcliprov' extraeremos los datos
                    //$codigo=substr($contacto[1],4,5);
                    $codigo=$contacto[1];
                    
                    $listado[$i]['nombreContacto']='';
                    foreach($clientesNombres as $unCliente){
                        if($unCliente['codigo']===$codigo){
                            $listado[$i]['nombreContacto']=$unCliente['nombre'];
                            break;
                        }
                    }
                }

                //2- busco el total del presupuesto
                //busco en la tabla 'tbmispresupuestoslineas' segun el campo idPresupuesto los campos 'ImportePED' y 'CuotaIvaPED'
                //y los sumamos 
                $strSQL = "SELECT ImportePED,ImportePEN,CuotaIvaPED,Facturada,Pedido FROM tbmispresupuestoslineas WHERE IdPresupuesto=".$listado[$i]['IdPresupuesto'];
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->ListadoPresupuestos()|| SQL : ".$strSQL);

                $dbC->conectar($this->getStrBDCliente());
                $stmt = $dbC->ejecutar ( $strSQL );
                $dbC->desconectar();

                if(!$stmt){
                    //devolvemos false
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->ListadoPresupuestos()<FALSE");
                    return false;
                }
                $importeLineas='';
                while($row=  mysql_fetch_array($stmt)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $reg[$propiedad]=$valor;
                        }
                    }
                    $importeLineas[]=$reg;
                }
                //sumo los valores extraidos e indico si la factura es facturada o no
                //(es facturada cuando tiene todas sus lineas en SI)
                $sumaImporte=0;
                $sumaCuota=0;
                $sumaImportePEN=0;
                //ahora vemos si la factura esta facturada total=SI, parcial=Parcial o no esta facturada=NO
                //como tenemos que comparar todas las lineas para saberlo, sabemos que si todas las lineas son
                //NF es que no esta facturada (Caso 1), si todas estan en T es factura total (Caso 2), y para el resto de convinaciones
                //es una factura parcial (Caso 3)
                //para poder saberlo hago tres contadores que guardan los valores de cada estado
                $contNF=0;
                $contT=0;
                $contParcial=0;
                $contNP=0;
                $contTP=0;
                $contParcialP=0;
                for($ii=0;$ii<count($importeLineas);$ii++){
                    $sumaImporte=$sumaImporte+$importeLineas[$ii]['ImportePED'];
                    $sumaCuota=$sumaCuota+$importeLineas[$ii]['CuotaIvaPED'];
                    $sumaImportePEN=$sumaImportePEN+$importeLineas[$ii]['ImportePEN'];
                    //voy contando según la opción facturada
                    if($importeLineas[$ii]['Facturada']==='NF'){
                        $contNF++;
                    }
                    if($importeLineas[$ii]['Facturada']==='T'){
                        $contT++;
                    }
                    if($importeLineas[$ii]['Facturada']==='M'){
                        $contParcial++;
                    }
                    //voy contando según la opción pedido
                    if($importeLineas[$ii]['Pedido']==='NP'){
                        $contNP++;
                    }
                    if($importeLineas[$ii]['Pedido']==='T'){
                        $contTP++;
                    }
                    if($importeLineas[$ii]['Pedido']==='M'){
                        $contParcialP++;
                    }
                }
                //facturadas
                //Caso 1 [NO](no facturada)
                if($contT===0 && $contParcial===0){
                    $listado[$i]['GenFacPed']='NO';
                }else
                //Caso 2 [SI](facturada total)
                if($contNF===0 && $contParcial===0){
                    $listado[$i]['GenFacPed']='SI';
                }
                //Caso 3 [Parcial](facturada parcial) , el resto de casos
                else{
                    $listado[$i]['GenFacPed']='Parcial';
                }
                //pedidos
                //Caso 1 [NO](no pedido)
                if($contTP===0 && $contParcialP===0){
                    $listado[$i]['GenPedPre']='NO';
                }else
                //Caso 2 [SI](pedido total)
                if($contNP===0 && $contParcialP===0){
                    $listado[$i]['GenPedPre']='SI';
                }
                //Caso 3 [Parcial](pedido parcial) , el resto de casos
                else{
                    $listado[$i]['GenPedPre']='Parcial';
                }
                
                //puede un presupuesto estar facturada una parte y hecho pedido la otra parte
                //para saber si esta echo totalmente comprobamos que la suma de los importePED=0
                //si es asi esta totalmente (facturada+pedido)
                if($sumaImportePEN === 0){
                    $listado[$i]['TotalFacturadaPedido']='SI';
                }else{
                    $listado[$i]['TotalFacturadaPedido']='NO';
                }
                
                $listado[$i]['totalImporte']=$sumaImporte+$sumaCuota-round(($sumaImporte*$listado[$i]['Retencion']/100),2);
                
                //3- indico si hay fichero PDF en la carpeta 'presupuestosEnviados'
                //busco en el array $PDF_guardados
                //por defecto indico 'NO'
                $listado[$i]['existePDF']='NO';
                if($PDF_guardados<>''){
                    for($jj=0;$jj<count($PDF_guardados);$jj++){
                        $ejercicio=substr($listado[$i]['NumPresupuesto'],0,4);
                        $numero=substr($listado[$i]['NumPresupuesto'],4,4);
                        //$archivoPDF='Presupuesto_'.$_SESSION['idEmp'].'-'.$ejercicio.'-'.$numero.'.pdf';
                        $archivoPDF='Presupuesto_'.$_SESSION['idEmp'].'-'.$listado[$i]['NumPresupuesto'].'.pdf';
                        if($PDF_guardados[$jj]['archivo']===$archivoPDF){
                            $listado[$i]['existePDF']=$PDF_guardados[$jj]['fecha'];
                            break;
                        }
                    }
                }
            }
        
            //ahora solo queda ver si el filtro $strNomContacto existe y se aplica
            $listadoFinal='';
            if($strNomContacto<>''){
                //recorremos el array e incluimos en un nuevo array los registros que cumplan el filtro
                for($i=0;$i<count($listado);$i++){
                    //compruebo si el campo nombreContacto esta la cadena de texto que viene en $strNomContacto
                    if(stristr($listado[$i]['nombreContacto'],$strNomContacto)==true){
                        //si lo cumple se incluye en el nuevo array
                        $listadoFinal[]=$listado[$i];
                    }
                }
            }else{
                $listadoFinal=$listado;
            }
        }else{
            //no ha encontrado nada
            return '';
        }
        
        return $listadoFinal;
    }
    
    function datosNuestraEmpresaPresupuesto(){
        require_once '../general/conexion.php';
        $dbG = new DbC();
        
        //extraigo primero los datos de la tabla 'tbempresas'
        $strSQL = "SELECT strSesion,direccion,CP,municipio,provincia,email1,telefono,strCIF FROM tbempresas WHERE IdEmpresa=".$_SESSION['idEmp'];
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosNuestraEmpresaPresupuesto()|| SQL : ".$strSQL);
        $dbG->conectar($this->getStrBD());
        $stmt = $dbG->ejecutar ( $strSQL );
        $dbG->desconectar();
        
        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosNuestraEmpresaPresupuesto()<FALSE");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        foreach($row as $propiedad=>$valor){
            if(!is_numeric($propiedad)){
                $reg[$propiedad]=$valor;
            }
        }
        
        return $reg;
    }
    
//    function datosNuestraEmpresaPedido(){
//        require_once '../general/conexion.php';
//        $dbG = new DbC();
//        
//        //extraigo primero los datos de la tabla 'tbempresas'
//        $strSQL = "SELECT strSesion,direccion,CP,municipio,provincia,email1,telefono,strCIF FROM tbempresas WHERE IdEmpresa=".$_SESSION['idEmp'];
//        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//               " clsCADContabilidad->datosNuestraEmpresaPedido()|| SQL : ".$strSQL);
//        $dbG->conectar($this->getStrBD());
//        $stmt = $dbG->ejecutar ( $strSQL );
//        $dbG->desconectar();
//        
//        if(!$stmt){
//            //devolvemos false
//            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                   " clsCADContabilidad->datosNuestraEmpresaPresupuesto()<FALSE");
//            return false;
//        }
//        $row=  mysql_fetch_array($stmt);
//        foreach($row as $propiedad=>$valor){
//            if(!is_numeric($propiedad)){
//                $reg[$propiedad]=$valor;
//            }
//        }
//        
//        return $reg;
//    }
    
    function datosFactura($IdFactura){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();
        require_once '../general/conexion.php';
        $dbG = new DbC();

        
        //extraigo primero los datos de la tabla 'tbmisfacturas'
        $strSQL = "SELECT NumFactura,IdPresupuesto,IdPedido,Cliente,DATE_FORMAT(FechaFactura,'%Y/%m/%d') AS FechaFactura"
                . ",DATE_FORMAT(FechaVtoFactura,'%Y/%m/%d') AS FechaVtoFactura,FormaPago,Estado,Retencion,Situacion,Referencia,CC_Trans,lngIdUsuario,Borrado,esAbono FROM tbmisfacturas WHERE IdFactura=".$IdFactura;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosFactura()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();
        
        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosFactura()<FALSE");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        foreach($row as $propiedad=>$valor){
            if(!is_numeric($propiedad)){
                $reg[$propiedad]=$valor;
            }
        }
        
        //guardo los datos en el array final
        //primero formateo el numero de factura que se presenta en pantalla del formulario
        //el numero esta guardado en la BBDD como '20140005' donde las 4 primeras cifras son el año
        //y las 4 últimas son el número en si
        //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
        $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        $txtPie=$this->Parametro_general('Texto Pie',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        //si existen datos en la CC_Trans, cojo ese dato y si esta vacio cojo el de tbparametros_generales
        $CC_Trans = $this->Parametro_general('CCTrans',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        if($reg['CC_Trans'] !== ''){
            $CC_Trans = $reg['CC_Trans'];
        }
        
        //ahora segun el tipo de contador calculo en nuevo numero
        $numFactura = numeroDesformateado($reg['NumFactura'],$tipoContador);
        
        $datosFinales=array(
            "NumFactura"=>$numFactura,
            "NumFacturaBBDD"=>$reg['NumFactura'],
            "IdPresupuesto"=>$reg['IdPresupuesto'],
            "IdPedido"=>$reg['IdPedido'],
            "Cliente"=>$reg['Cliente'],
            "NombreEmpresa"=>'',
            "Retencion"=>$reg['Retencion'],
            "FormaPago"=>$reg['FormaPago'],
            "DetalleFactura"=>'',
            "Validez"=>0,
            "FechaFactura"=>$reg['FechaFactura'],
            "Borrado"=>$reg['Borrado'],
            "Estado"=>$reg['Estado'],
            "Situacion"=>$reg['Situacion'],
            "Referencia"=>$reg['Referencia'],
            "CC_Trans"=>$CC_Trans,
            "TxtPie"=>$txtPie,
            "esAbono"=>$reg['esAbono'],
        );
        
        //ahora calculo la validez de la factura (diferencia en dias entre FechaVtoFactura y FechaFactura
        //la funcion strtotime extrae un numero en segundos
        //$uno=strtotime($reg['FechaVtoFactura']);
        //$dos=strtotime($reg['FechaFactura']);
        $validez=strtotime($reg['FechaVtoFactura'])-strtotime($reg['FechaFactura']);
        $validez=round($validez/86400);//24 horas x 60 minutos x 60 segundos = 86400 segundo/dia
        $datosFinales['Validez']=$validez;
        
        //ahora extraigo los datos de las lineas de la factura (tbmisfacturaslineas)
        $strSQL = "
                    SELECT L.IdFacturaLineas,L.NumLineaFactura,L.NumLineaPresup,L.IdPresupLineas,L.NumLineaPedido,L.IdPedidoLineas,L.IdArticulo,L.cuentaArticulo,L.CantidadPED AS cantidad,L.DescripcionProducto AS concepto,
                    L.ImporteUnidad AS precio,L.ImportePED AS importe,L.TipoIVA as iva,L.CuotaIvaPED AS cuota
                    FROM tbmisfacturas F,tbmisfacturaslineas L
                    WHERE F.IdFactura=L.IdFactura
                    AND F.IdFactura=$IdFactura
                    ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosFactura()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();
        
        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosFactura()<FALSE");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosFactura()|| Consulta OK. Llego a datosLineas");
        $datosLineas='';
        while($row = mysql_fetch_array($stmt)){
            $reg = '';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            //ahora añado los totales (cuota + importe)
            $reg['total']=$reg['cuota']+$reg['importe'];
            $datosLineas[]=$reg;
        }
        $datosFinales['DetalleFactura']=$datosLineas;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosFactura()|| Meto en datosFinales el datosLineas");
        
        //ahora averiguo el nombre de la empresa

        //la informacion que extraemos esta en dos tablas, dbContabilidad.tbcliprov y dbCliente.tbmiscontactos
        //y se busca de esta forma
        //1-Cliente: tbmiscontactos.NombreContacto + tbmiscontactos.ApellidosContacto
        //2-NombreEmpresa: tbcliprov.nombre
        //3-CIF: tbcliprov.CIF
        //4-direccion: tbcliprov.direccion
        //5-poblacion: tbcliprov.municipio
        //6-FormaPagoHabitual: tbmiscontactos.FormaPagoHabitual
        //7-Correo: tbmiscontactos.Correo

        //array donde guardo los datos
        $datos=array(
                "Cliente"=>'',
                "NombreEmpresa"=>'',
                "CIF"=>'',
                "direccion"=>'',
                "FormaPagoHabitual"=>'',
                "Correo"=>'',
        );

        //primero hago la consulta en dbContabilidad.tbcliprov y estraigo los campos 2, 3 y 4
        //el numero de la cuenta en la tabla tbrelacioncliprov esta dividido en dos partes
        //4300=0 se guarda en CliProv y  el resto '00005' se guarda en 'codigo'
//        $codigo=substr($datosFinales['Cliente'],-5);
        $codigo=$datosFinales['Cliente'];
        $query="
                        SELECT C.nombre AS NombreEmpresa,C.CIF,
                        C.direccion,CONCAT(C.CP,' - ',C.municipio) AS poblacion,C.provincia,C.Correo,C.IdCliProv
                        FROM tbrelacioncliprov R, tbcliprov C
                        WHERE C.IdCliProv=R.IdCliProv
                        AND R.Borrado=0
                        AND R.IdEmpresa=".$_SESSION['idEmp']."
                        AND R.codigo='$codigo'
                        ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosFactura()|| SQL : ".$query);

        $dbG->conectar($this->getStrBD());
        $result=$dbG->ejecutar($query);
        $dbG->desconectar();

        if(!$result){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosFactura()<FALSE");
            return false;
        }

        if($result){
                $count= mysql_num_rows($result);
                if($count>0){
                        $row= mysql_fetch_array($result);
                        $datos['NombreEmpresa']=$row['NombreEmpresa'];//2
                        $datos['CIF']=$row['CIF'];//3
                        $datos['direccion']=$row['direccion'];//4
                        $datos['poblacion']=$row['poblacion'];//5
                        $datos['provincia']=$row['provincia'];//6
                        $datos['Correo']=$row['Correo'];//7 ??

                        $IdCliProv=$row['IdCliProv'];

                        //ahora hago la consulta contra la tabla dbCliente.tbmiscontactos
                        //y extraigo si encuentro los campos 1 y 5
                        $query="
                                        SELECT CONCAT(C.NombreContacto,' ',C.ApellidosContacto) AS Cliente,C.FormaPagoHabitual,C.Correo
                                        FROM tbmiscontactos C
                                        WHERE C.IdCliProv =$IdCliProv
                                        AND Borrado=1
                                        ";
                        $dbC->conectar($this->getStrBDCliente());
                        $result2=$dbC->ejecutar($query);
                        $dbC->desconectar();
                        if($result2){
                                $count= mysql_num_rows($result2);
                                if($count>0){
                                        $row= mysql_fetch_array($result2);
                                        $datos['Cliente']=$row['Cliente'];
                                        $datos['FormaPagoHabitual']=$row['FormaPagoHabitual'];
                                        //si existe este dato (que viene de dbContabilidad.tbcliprov,no lo grabo
                                        //sino existe pues si lo grabo
                                        if($datos['Correo'] === ''){
                                            $datos['Correo']=$row['Correo'];
                                        }
                                }
                        }else{
                                //devolvemos false
                                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                        " clsCADContabilidad->datosFactura()<FALSE");
                                return false;
                        }
                }
        }
        $datosFinales['NombreEmpresa']=$datos['NombreEmpresa'];
        $datosFinales['CIFEmpresa']=$datos['CIF'];
        $datosFinales['ContactoEmpresa']=$datos['Cliente'];
        $datosFinales['DireccionEmpresa']=$datos['direccion'];
        $datosFinales['PoblacionEmpresa']=$datos['poblacion'];
        $datosFinales['ProvinciaEmpresa']=$datos['provincia'];
        $datosFinales['Correo']=$datos['Correo'];
        
        
        return $datosFinales;
    }

    function datosPedido($IdPedido){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();
        require_once '../general/conexion.php';
        $dbG = new DbC();

        
        //extraigo primero los datos de la tabla 'tbmispedidos'
        $strSQL = "SELECT NumPedido,IdPresupuesto,Cliente,DATE_FORMAT(FechaPedido,'%d/%m/%Y') AS FechaPedido"
                . ",DATE_FORMAT(FechaVtoPedido,'%d/%m/%Y') AS FechaVtoPedido,FormaPago,DATE_FORMAT(FechaFinalizacion,'%d/%m/%Y') AS FechaFinalizacion"
                . ",Estado,Retencion,lngIdUsuario,Borrado,TipoFactura,DiaPeriodica,FrecuenciaPeriodica,CC_Trans,Referencia,CC_Trans"
                . ",DATE_FORMAT(FechaProximaFacturaPeriodica,'%d/%m/%Y') AS FechaProximaFacturaPeriodica FROM tbmispedidos WHERE IdPedido=".$IdPedido;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosPedido()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();
        
        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPedido()<FALSE");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        foreach($row as $propiedad=>$valor){
            if(!is_numeric($propiedad)){
                $reg[$propiedad]=$valor;
            }
        }
        //compruebo los campos 'FechaPedido', 'FechaVtoPedido' y 'FechaFinalizacion'
        if($reg['FechaPedido'] === '00/00/0000'){
            $reg['FechaPedido'] = '';
        }
        if($reg['FechaVtoPedido'] === '00/00/0000'){
            $reg['FechaVtoPedido'] = '';
        }
        if($reg['FechaFinalizacion'] === '00/00/0000'){
            $reg['FechaFinalizacion'] = '';
        }
        
        //guardo los datos en el array final
        //primero formateo el numero del pedido que se presenta en pantalla del formulario
        //el numero esta guardado en la BBDD como '20140005' donde las 4 primeras cifras son el año
        //y las 4 últimas son el número en si
        //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
        $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        $txtPie=$this->Parametro_general('Texto Pie',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        
        //ahora segun el tipo de contador calculo en nuevo numero
        $numPedido = numeroDesformateado($reg['NumPedido'],$tipoContador);
        
//        switch ($tipoContador) {
//            case 'simple':
//                $numPedido=$reg['NumPedido'];
//                break;
//            case 'compuesto1':
//                $num=substr($reg['NumPedido'],4,4);
//                while(substr($num,0,1)==='0'){
//                    $num=substr($num,1);
//                }
//                $ejercicio=substr($reg['NumPedido'],0,4);
//                $numPedido=$num.'/'.$ejercicio;
//                break;
//            case 'compuesto2':
//                $num=substr($reg['NumPedido'],4,4);
//                while(substr($num,0,1)==='0'){
//                    $num=substr($num,1);
//                }
//                $ejercicio=substr($reg['NumPedido'],0,4);
//                $numPedido=$ejercicio.'/'.$num;
//                break;
//            default://ningun contador
//                $numPedido=$reg['NumPedido'];
//                break;
//        }
        
        
        $datosFinales=array(
            "NumPedido"=>$numPedido,
            "NumPedidoBBDD"=>$reg['NumPedido'],
            "IdPresupuesto"=>$reg['IdPresupuesto'],
            "Cliente"=>$reg['Cliente'],
            "NombreEmpresa"=>'',
            "Retencion"=>$reg['Retencion'],
            "FormaPago"=>$reg['FormaPago'],
            "DetalleFactura"=>'',
            "FechaPedido"=>$reg['FechaPedido'],
            "FechaVtoPedido"=>$reg['FechaVtoPedido'],
            "FechaFinalizacion"=>$reg['FechaFinalizacion'],
            "Borrado"=>$reg['Borrado'],
            "Estado"=>$reg['Estado'],
            "TipoFactura"=>$reg['TipoFactura'],
            "DiaPeriodica"=>$reg['DiaPeriodica'],
            "FrecuenciaPeriodica"=>$reg['FrecuenciaPeriodica'],
            "FechaProximaFacturaPeriodica"=>$reg['FechaProximaFacturaPeriodica'],
            "CC_Trans"=>$reg['CC_Trans'],
            "Referencia"=>$reg['Referencia'],
        );
        
//        //ahora calculo la validez del pedido (diferencia en dias entre FechaVtoPedido y FechaPedido
//        //la funcion strtotime extrae un numero en segundos
//        //$uno=strtotime($reg['FechaVtoPedido']);
//        //$dos=strtotime($reg['FechaPedido']);
//        $validez=strtotime($reg['FechaVtoPedido'])-strtotime($reg['FechaPedido']);
//        $validez=round($validez/86400);//24 horas x 60 minutos x 60 segundos = 86400 segundo/dia
//        $datosFinales['Validez']=$validez;
        
        //ahora extraigo los datos de las lineas del pedido (tbmispedidoslineas)
        $strSQL = "
                    SELECT L.IdPedidoLineas,L.NumLineaPedido,L.NumLineaPresup,L.IdPresupLineas,L.IdArticulo,L.CantidadPED AS cantidad,L.DescripcionProducto AS concepto,
                    L.ImporteUnidad AS precio,L.ImportePED AS importe,L.TipoIVA as iva,L.CuotaIvaPED AS cuota
                    FROM tbmispedidos F,tbmispedidoslineas L
                    WHERE F.IdPedido=L.IdPedido
                    AND F.IdPedido=$IdPedido
                    ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosPedido()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();
        
        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPedido()<FALSE");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosPedido()|| Consulta OK. Llego a datosLineas");
        $datosLineas='';
        while($row = mysql_fetch_array($stmt)){
            $reg = '';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            //ahora añado los totales (cuota + importe)
            $reg['total']=$reg['cuota']+$reg['importe'];
            $datosLineas[]=$reg;
        }
        $datosFinales['DetalleFactura']=$datosLineas;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosPedido()|| Meto en datosFinales el datosLineas");
        
        //ahora averiguo el nombre de la empresa

        //la informacion que extraemos esta en dos tablas, dbContabilidad.tbcliprov y dbCliente.tbmiscontactos
        //y se busca de esta forma
        //1-Cliente: tbmiscontactos.NombreContacto + tbmiscontactos.ApellidosContacto
        //2-NombreEmpresa: tbcliprov.nombre
        //3-CIF: tbcliprov.CIF
        //4-direccion: tbcliprov.direccion
        //5-poblacion: tbcliprov.municipio
        //6-FormaPagoHabitual: tbmiscontactos.FormaPagoHabitual
        //7-Correo: tbmiscontactos.Correo

        //array donde guardo los datos
        $datos=array(
                "Cliente"=>'',
                "NombreEmpresa"=>'',
                "CIF"=>'',
                "direccion"=>'',
                "FormaPagoHabitual"=>'',
                "Correo"=>'',
        );
        
        
        //ahora averiguo el nombre de la empresa
        //$contacto=explode('.',$datosFinales['Cliente']);
        $contacto=array(
                        0 => 'CL',
                        1 => $datosFinales['Cliente']
                        );
        if($contacto[0]==='CO'){//contacto
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPedido()|| Es un CONTACTO");
            //busco en la tabla tbcontactos
            $strSQL="
                    SELECT CONCAT(M.NombreContacto,' ',M.ApellidosContacto) AS Cliente,M.NombreEmpresa,
                    M.CIF,M.direccion,CONCAT(M.CodPostal,' - ',M.Ciudad) AS poblacion,M.Provincia,M.FormaPagoHabitual,M.Correo
                    FROM tbmiscontactos M
                    WHERE M.Borrado=1 
                    AND M.IdCliProv=0 
                    AND M.IdContacto=".$contacto[1]
                    ;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPresupuesto()|| SQL : ".$strSQL);
            $dbC->conectar($this->getStrBDCliente());
            $stmt = $dbC->ejecutar ( $strSQL );
            $dbC->desconectar();

            if(!$stmt){
                //devolvemos false
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->datosPedido()<FALSE");
                return false;
            }
            $row=  mysql_fetch_array($stmt);
            $datosFinales['NombreEmpresa']=$row['NombreEmpresa'];
            $datosFinales['CIFEmpresa']=$row['CIF'];
            $datosFinales['ContactoEmpresa']=$row['Cliente'];
            $datosFinales['DireccionEmpresa']=$row['direccion'];
            $datosFinales['PoblacionEmpresa']=$row['poblacion'];
            $datosFinales['ProvinciaEmpresa']=$row['Provincia'];
        }else if($contacto[0]==='CL'){//Cliente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPedido()|| Es un CLIENTE");
            //la informacion que extraemos esta en dos tablas, dbContabilidad.tbcliprov y dbCliente.tbmiscontactos
            //y se busca de esta forma
            //1-Cliente: tbmiscontactos.NombreContacto + tbmiscontactos.ApellidosContacto
            //2-NombreEmpresa: tbcliprov.nombre
            //3-CIF: tbcliprov.CIF
            //4-direccion: tbcliprov.direccion
            //5-poblacion: tbcliprov.municipio
            //6-FormaPagoHabitual: tbmiscontactos.FormaPagoHabitual

            //array donde guardo los datos
            $datos=array(
                    "Cliente"=>'',
                    "NombreEmpresa"=>'',
                    "CIF"=>'',
                    "direccion"=>'',
                    "FormaPagoHabitual"=>'',
                    "Correo"=>'',
            );

            //primero hago la consulta en dbContabilidad.tbcliprov y estraigo los campos 2, 3 y 4
            //el numero de la cuenta en la tabla tbrelacioncliprov esta dividido en dos partes
            //4300=0 se guarda en CliProv y  el resto '00005' se guarda en 'codigo'
//            $codigo=substr($contacto[1],-5);
            $codigo=$contacto[1];
            $query="
                            SELECT C.nombre AS NombreEmpresa,C.CIF,
                            C.direccion,CONCAT(C.CP,' - ',C.municipio) AS poblacion,C.provincia,C.IdCliProv
                            FROM tbrelacioncliprov R, tbcliprov C
                            WHERE C.IdCliProv=R.IdCliProv
                            AND R.Borrado=0
                            AND R.IdEmpresa=".$_SESSION['idEmp']."
                            AND R.codigo='$codigo'
                            ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPedido()|| SQL : ".$query);

            $dbG->conectar($this->getStrBD());
            $result=$dbG->ejecutar($query);
            $dbG->desconectar();
    
            if(!$result){
                //devolvemos false
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->datosPedido()<FALSE");
                return false;
            }
			
            if($result){
                    $count= mysql_num_rows($result);
                    if($count>0){
                            $row= mysql_fetch_array($result);
                            $datos['NombreEmpresa']=$row['NombreEmpresa'];//2
                            $datos['CIF']=$row['CIF'];//3
                            $datos['direccion']=$row['direccion'];//4
                            $datos['poblacion']=$row['poblacion'];//5
                            $datos['provincia']=$row['provincia'];//6

                            $IdCliProv=$row['IdCliProv'];

                            //ahora hago la consulta contra la tabla dbCliente.tbmiscontactos
                            //y extraigo si encuentro los campos 1 y 5
                            $query="
                                            SELECT CONCAT(C.NombreContacto,' ',C.ApellidosContacto) AS Cliente,C.FormaPagoHabitual,C.Correo
                                            FROM tbmiscontactos C
                                            WHERE C.IdCliProv =$IdCliProv
                                            AND Borrado=1
                                            ";
                            $dbC->conectar($this->getStrBDCliente());
                            $result2=$dbC->ejecutar($query);
                            $dbC->desconectar();
                            if($result2){
                                    $count= mysql_num_rows($result2);
                                    if($count>0){
                                            $row= mysql_fetch_array($result2);
                                            $datos['Cliente']=$row['Cliente'];
                                            $datos['FormaPagoHabitual']=$row['FormaPagoHabitual'];
                                    }
                            }else{
                                    //devolvemos false
                                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                            " clsCADContabilidad->datosPedido()<FALSE");
                                    return false;
                            }
                    }
            }
            $datosFinales['NombreEmpresa']=$datos['NombreEmpresa'];
            $datosFinales['CIFEmpresa']=$datos['CIF'];
            $datosFinales['ContactoEmpresa']=$datos['Cliente'];
            $datosFinales['DireccionEmpresa']=$datos['direccion'];
            $datosFinales['PoblacionEmpresa']=$datos['poblacion'];
            $datosFinales['ProvinciaEmpresa']=$datos['provincia'];
        }
        
        
        return $datosFinales;
    }
    
    //BORRAR (comprobar antes 20/3/2014)
    function datosPresupuestoDiferencia($IdPresupuesto){
        //extraigo los datos con la funcion 'datosPresupuesto' 
        $resultado=$this->datosPresupuesto($IdPresupuesto);
        $resultadoFinal=$resultado;
        //como presento la factura que sale de lo que le queda pendiente de facturar,
        //copio CantidadPEN, ImportePEN y CuotaIvaPEN en cantidad, importe y cuota en $resultadoFinal 
        foreach($resultado['DetallePresupuesto'] as $propiedad=>$datosLinea){
            $resultadoFinal['DetallePresupuesto'][$propiedad]['cantidad']=$datosLinea['CantidadPEN'];
            $resultadoFinal['DetallePresupuesto'][$propiedad]['importe']=$datosLinea['ImportePEN'];
            $resultadoFinal['DetallePresupuesto'][$propiedad]['cuota']=$datosLinea['CuotaIvaPEN'];
        }
        return $resultadoFinal;
    }
    
    function datosPresupuesto($IdPresupuesto){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();
        require_once '../general/conexion.php';
        $dbG = new DbC();

        
        //extraigo primero los datos de la tabla 'tbmispresupuestos'
        $strSQL = "SELECT NumPresupuesto,Contacto_Cliente,DATE_FORMAT(FechaPresupuesto,'%Y/%m/%d') AS FechaPresupuesto"
                . ",DATE_FORMAT(FechaVtoPresupuesto,'%Y/%m/%d') AS FechaVtoPresupuesto,FormaPago,Estado,Retencion,lngIdUsuario,Proforma,Borrado FROM tbmispresupuestos WHERE IdPresupuesto=".$IdPresupuesto;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosPresupuesto()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();
        
        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPresupuesto()<FALSE");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        foreach($row as $propiedad=>$valor){
            if(!is_numeric($propiedad)){
                $reg[$propiedad]=$valor;
            }
        }
        
        //guardo los datos en el array final
        //primero formateo el numero de presupuesto que se presenta en pantalla del formulario
        //el numero esta guardado en la BBDD como '20140005' donde las 4 primeras cifras son el año
        //y las 4 últimas son el número en si
        //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
        $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        
        //ahora segun el tipo de contador calculo en nuevo numero
        $numPresupuesto = numeroDesformateado($reg['NumPresupuesto'],$tipoContador);
        
//        switch ($tipoContador) {
//            case 'simple':
//                $numPresupuesto=$reg['NumPresupuesto'];
//                break;
//            case 'compuesto1':
//                $num=substr($reg['NumPresupuesto'],4,4);
//                while(substr($num,0,1)==='0'){
//                    $num=substr($num,1);
//                }
//                $ejercicio=substr($reg['NumPresupuesto'],0,4);
//                $numPresupuesto=$num.'/'.$ejercicio;
//                break;
//            case 'compuesto2':
//                $num=substr($reg['NumPresupuesto'],4,4);
//                while(substr($num,0,1)==='0'){
//                    $num=substr($num,1);
//                }
//                $ejercicio=substr($reg['NumPresupuesto'],0,4);
//                $numPresupuesto=$ejercicio.'/'.$num;
//                break;
//            default://ningun contador
//                $numPresupuesto=$reg['NumPresupuesto'];
//                break;
//        }
        
        $datosFinales=array(
            "NumPresupuesto"=>$numPresupuesto,
            "NumPresupuestoBBDD"=>$reg['NumPresupuesto'],
            "Contacto_Cliente"=>$reg['Contacto_Cliente'],
            "NombreEmpresa"=>'',
            "Retencion"=>$reg['Retencion'],
            "Estado"=>$reg['Estado'],
            "FormaPago"=>$reg['FormaPago'],
            "DetallePresupuesto"=>'',
            "Validez"=>0,
            "FechaPresupuesto"=>$reg['FechaPresupuesto'],
            "Proforma"=>$reg['Proforma'],
            "Borrado"=>$reg['Borrado'],
        );
        
        //ahora calculo la validez del presupuesto (diferencia en dias entre FechaVtoPresupuesto y FechaPresupuesto
        //la funcion strtotime extrae un numero en segundos
        //$uno=strtotime($reg['FechaVtoPresupuesto']);
        //$dos=strtotime($reg['FechaPresupuesto']);
        $validez=strtotime($reg['FechaVtoPresupuesto'])-strtotime($reg['FechaPresupuesto']);
        $validez=round($validez/86400,0);//24 horas x 60 minutos x 60 segundos = 86400 segundo/dia
        $datosFinales['Validez']=$validez;
        
        //ahora extraigo los datos de las lineas del presupuesto
        $strSQL = "
                    SELECT L.IdPresupLineas,L.NumLineaPresup,L.IdArticulo,L.CantidadPED AS cantidad,L.CantidadPEN,L.DescripcionProducto AS concepto,
                    L.ImporteUnidad AS precio,L.ImportePED AS importe,ImportePEN,L.TipoIVA as iva,L.CuotaIvaPED AS cuota,L.CuotaIvaPEN
                    FROM tbmispresupuestos P,tbmispresupuestoslineas L
                    WHERE P.IdPresupuesto=L.IdPresupuesto
                    AND P.IdPresupuesto=$IdPresupuesto
                    ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosPresupuesto()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();
        
        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPresupuesto()<FALSE");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosPresupuesto()|| Consulta OK. Llego a datosLineas");
        $datosLineas='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            //ahora busco si este IdPresupLineas existe en tbmisfacturaslineas (significa que ya esta facturado parcial o totalmente)
            //asi me vale para que el formulario presente o no el botón de borrar este concepto
            //si esta facturado no debe poder borrarse este concepto (seria incongruente borrar un concepto ya facturado)
            $strSQL = "
                        SELECT L.IdPresupLineas
                        FROM tbmisfacturaslineas L
                        WHERE L.IdPresupLineas=".$reg['IdPresupLineas']."
                        ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPresupuesto()|| SQL : ".$strSQL);
            $dbC->conectar($this->getStrBDCliente());
            $stmt2 = $dbC->ejecutar ( $strSQL );
            $reg['estaFacturado']='NO';
            if($stmt2){
                $num=  mysql_num_rows($stmt2);
                if($num>0){
                    $reg['estaFacturado']='SI';
                }
            }else{
                //devolvemos false
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->datosPresupuesto()<FALSE");
                return false;
            }
            //ahora busco si este IdPresupLineas existe en tbmispedidoslineas (significa que ya esta pedido parcial o totalmente)
            //asi me vale para que el formulario presente o no el botón de borrar este concepto
            //si esta pedido no debe poder borrarse este concepto (seria incongruente borrar un concepto ya pedido)
            $strSQL = "
                        SELECT L.IdPresupLineas
                        FROM tbmispedidoslineas L
                        WHERE L.IdPresupLineas=".$reg['IdPresupLineas']."
                        ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPresupuesto()|| SQL : ".$strSQL);
            $dbC->conectar($this->getStrBDCliente());
            $stmt2 = $dbC->ejecutar ( $strSQL );
            $dbC->desconectar();
            $reg['estaPedido']='NO';
            if($stmt2){
                $num=  mysql_num_rows($stmt2);
                if($num>0){
                    $reg['estaPedido']='SI';
                }
            }else{
                //devolvemos false
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->datosPresupuesto()<FALSE");
                return false;
            }
            
            //ahora añado los totales (cuota + importe)
            $reg['total']=$reg['cuota']+$reg['importe'];
            $datosLineas[]=$reg;
        }
        $datosFinales['DetallePresupuesto']=$datosLineas;
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosPresupuesto()|| Meto en datosFinales el datosLineas");
        
        //ahora averiguo el nombre de la empresa
        $contacto=explode('.',$datosFinales['Contacto_Cliente']);
        if($contacto[0]==='CO'){//contacto
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPresupuesto()|| Es un CONTACTO");
            //busco en la tabla tbcontactos
            $strSQL="
                    SELECT CONCAT(M.NombreContacto,' ',M.ApellidosContacto) AS Cliente,M.NombreEmpresa,
                    M.CIF,M.direccion,CONCAT(M.CodPostal,' - ',M.Ciudad) AS poblacion,M.Provincia,M.FormaPagoHabitual,M.Correo
                    FROM tbmiscontactos M
                    WHERE M.Borrado=1 
                    AND M.IdCliProv=0 
                    AND M.IdContacto=".$contacto[1]
                    ;
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPresupuesto()|| SQL : ".$strSQL);
            $dbC->conectar($this->getStrBDCliente());
            $stmt = $dbC->ejecutar ( $strSQL );
            $dbC->desconectar();

            if(!$stmt){
                //devolvemos false
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->datosPresupuesto()<FALSE");
                return false;
            }
            $row=  mysql_fetch_array($stmt);
            $datosFinales['NombreEmpresa']=$row['NombreEmpresa'];
            $datosFinales['CIFEmpresa']=$row['CIF'];
            $datosFinales['ContactoEmpresa']=$row['Cliente'];
            $datosFinales['DireccionEmpresa']=$row['direccion'];
            $datosFinales['PoblacionEmpresa']=$row['poblacion'];
            $datosFinales['ProvinciaEmpresa']=$row['Provincia'];
        }else if($contacto[0]==='CL'){//Cliente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPresupuesto()|| Es un CLIENTE");
            //la informacion que extraemos esta en dos tablas, dbContabilidad.tbcliprov y dbCliente.tbmiscontactos
            //y se busca de esta forma
            //1-Cliente: tbmiscontactos.NombreContacto + tbmiscontactos.ApellidosContacto
            //2-NombreEmpresa: tbcliprov.nombre
            //3-CIF: tbcliprov.CIF
            //4-direccion: tbcliprov.direccion
            //5-poblacion: tbcliprov.municipio
            //6-FormaPagoHabitual: tbmiscontactos.FormaPagoHabitual

            //array donde guardo los datos
            $datos=array(
                    "Cliente"=>'',
                    "NombreEmpresa"=>'',
                    "CIF"=>'',
                    "direccion"=>'',
                    "FormaPagoHabitual"=>'',
                    "Correo"=>'',
            );

            //primero hago la consulta en dbContabilidad.tbcliprov y estraigo los campos 2, 3 y 4
            //el numero de la cuenta en la tabla tbrelacioncliprov esta dividido en dos partes
            //4300=0 se guarda en CliProv y  el resto '00005' se guarda en 'codigo'
//            $codigo=substr($contacto[1],-5);
            $codigo=$contacto[1];
            $query="
                            SELECT C.nombre AS NombreEmpresa,C.CIF,
                            C.direccion,CONCAT(C.CP,' - ',C.municipio) AS poblacion,C.provincia,C.IdCliProv
                            FROM tbrelacioncliprov R, tbcliprov C
                            WHERE C.IdCliProv=R.IdCliProv
                            AND R.Borrado=0
                            AND R.IdEmpresa=".$_SESSION['idEmp']."
                            AND R.codigo='$codigo'
                            ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosPresupuesto()|| SQL : ".$query);

            $dbG->conectar($this->getStrBD());
            $result=$dbG->ejecutar($query);
            $dbG->desconectar();
    
            if(!$result){
                //devolvemos false
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                       " clsCADContabilidad->datosPresupuesto()<FALSE");
                return false;
            }
			
            if($result){
                    $count= mysql_num_rows($result);
                    if($count>0){
                            $row= mysql_fetch_array($result);
                            $datos['NombreEmpresa']=$row['NombreEmpresa'];//2
                            $datos['CIF']=$row['CIF'];//3
                            $datos['direccion']=$row['direccion'];//4
                            $datos['poblacion']=$row['poblacion'];//5
                            $datos['provincia']=$row['provincia'];//6

                            $IdCliProv=$row['IdCliProv'];

                            //ahora hago la consulta contra la tabla dbCliente.tbmiscontactos
                            //y extraigo si encuentro los campos 1 y 5
                            $query="
                                            SELECT CONCAT(C.NombreContacto,' ',C.ApellidosContacto) AS Cliente,C.FormaPagoHabitual,C.Correo
                                            FROM tbmiscontactos C
                                            WHERE C.IdCliProv =$IdCliProv
                                            AND Borrado=1
                                            ";
                            $dbC->conectar($this->getStrBDCliente());
                            $result2=$dbC->ejecutar($query);
                            $dbC->desconectar();
                            if($result2){
                                    $count= mysql_num_rows($result2);
                                    if($count>0){
                                            $row= mysql_fetch_array($result2);
                                            $datos['Cliente']=$row['Cliente'];
                                            $datos['FormaPagoHabitual']=$row['FormaPagoHabitual'];
                                    }
                            }else{
                                    //devolvemos false
                                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                            " clsCADContabilidad->datosPresupuesto()<FALSE");
                                    return false;
                            }
                    }
            }
            $datosFinales['NombreEmpresa']=$datos['NombreEmpresa'];
            $datosFinales['CIFEmpresa']=$datos['CIF'];
            $datosFinales['ContactoEmpresa']=$datos['Cliente'];
            $datosFinales['DireccionEmpresa']=$datos['direccion'];
            $datosFinales['PoblacionEmpresa']=$datos['poblacion'];
            $datosFinales['ProvinciaEmpresa']=$datos['provincia'];
        }
        
        
        return $datosFinales;
    }
    
    function listadoIdPresupLineas($IdPresupuesto){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();

        
    }
    
    function ParametrosGenerales_email(){
        require_once '../general/'.$_SESSION['mapeo'];
        $dbC = new Db();

        //extraigo los datos de la tabla 'tbparametros_generales'
        $strSQL="SELECT * FROM tbparametros_generales WHERE nombre='Email Envios'";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->ParametrosGenerales_email()|| SQL : ".$strSQL);
        $dbC->conectar($this->getStrBDCliente());
        $stmt = $dbC->ejecutar ( $strSQL );
        $dbC->desconectar();
        
        if(!$stmt){
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->ParametrosGenerales_email()<FALSE");
            return false;
        }
        $email='';
        while($row=  mysql_fetch_array($stmt)){
            $reg='';
            foreach($row as $propiedad=>$valor){
                if(!is_numeric($propiedad)){
                    $reg[$propiedad]=$valor;
                }
            }
            $email[]=$reg;
        }
        
        date_default_timezone_set('Europe/Madrid');
        $hoy = date("Y-m-d H:i:s");
        //ahora busco el que sea valido ()la fecha de hoy tiene que ser ValidoDesde>=Hoy y Hoy<=ValidoHasta
        $resultado=false;
        for($i=0;$i<count($email);$i++){
            //si ValidoHasta es null, o esta entre ValidoDesde y ValidoHasta, el parametro es el actual
            $difDesde=strtotime($hoy) - strtotime($email[$i]['ValidoDesde']);
            if($difDesde >= 0){
                if($email[$i]['ValidoHasta']<>null){
                    //comprobamos que la fecha ValidaHasta<=Hoy
                    $difHasta=strtotime($email[$i]['ValidoHasta']) - strtotime($hoy);
                    If($difHasta>=0){
                        $resultado=$email[$i]['valor'];
                        break;
                    }
                }
                //si es null no hace falta comprobar, es valido
                else{
                    $resultado=$email[$i]['valor'];
                    break;
                }
            }
        }
        
        return $resultado;
    }
    
    function FechaAltaEmpresa(){
        require_once '../general/conexion.php';
        $dbG = new DbC();

        //listo los presupuestos de la tabla 'tbmispresupuestos'
        $strSQL = "SELECT fechaAlta FROM tbempresas WHERE IdEmpresa=".$_SESSION['idEmp'];
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->FechaAltaEmpresa()|| SQL : ".$strSQL);
        $dbG->conectar($this->getStrBD());
        $stmt = $dbG->ejecutar ( $strSQL );
        $dbG->desconectar();
        
        if($stmt){
            //devolvemos la fecha
            $row=  mysql_fetch_array($stmt);
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->FechaAltaEmpresa()<Fecha es: ".$row['fechaAlta']);
            return $row['fechaAlta'];
        }else{
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->FechaAltaEmpresa()<FALSE");
            return false;
        }
    }

    //NO VALE 23/1/2014
    function TipoContador(){
//        require_once '../general/'.$_SESSION['mapeo'];
//        $dbC = new Db();
//        
//        //extraigo los datos de la tabla 'tbparametros_generales'
//        $strSQL="SELECT * FROM tbparametros_generales WHERE nombre='Tipo Contador'";
//        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//               " clsCADContabilidad->TipoContador()|| SQL : ".$strSQL);
//        $dbC->conectar($this->getStrBD());
//        $stmt = $dbC->ejecutar ( $strSQL );
//        $dbC->desconectar();
//        
//        if($stmt){
//            $row=  mysql_fetch_array($stmt);
//            
//        }
        
        
    }

    function Parametro_general($parametroBuscar,$fechaInicio,$fechaFin){
        require_once '../general/funcionesGenerales.php';
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //extraigo el parametro a buscar de la tabla  'tbparametros_generales'
        $strSQL="
                SELECT valor,ValidoDesde,ValidoHasta
                FROM tbparametros_generales
                WHERE nombre ='$parametroBuscar'
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Parametro_general()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
        }
        
//        //paso a DATETIME
//        $fechaInicio=fecha_to_DATETIME($fechaInicio);
//        $fechaFin=fecha_to_DATETIME($fechaFin);
        
        //ahora busco en este array por fechas que este valido este parametro
        if(is_array($resultado)){
            for($i=0;$i<count($resultado);$i++){
                //si ValidoHasta = null , solo hay que combrobar que $fechaInicio>=ValidoDesde
                if($resultado[$i]['ValidoHasta']==null){
                    if(strtotime($fechaInicio) >= $resultado[$i]['ValidoDesde']){
                        $valorParametro=$resultado[$i]['valor'];
                    }
                }else{
                //si ValidoHasta tiene valor 
                    //hay que ver que $fechaInicio>=ValidoDesde y $fechaFin<=ValidoHasta
                    if((strtotime($fechaInicio) >= $resultado[$i]['ValidoDesde']) && (strtotime($fechaFin) <= $resultado[$i]['ValidoHasta'])){
                        $valorParametro=$resultado[$i]['valor'];
                    }
                }
            }
        }
        //sino no hay array es que no se a encntrado nada, por defecto se pone 0
        else{
            $valorParametro = 0;
        }
        return $valorParametro;
    }
    
    function Parametro_general_Id($parametroBuscar,$fechaInicio,$fechaFin){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //extraigo el parametro a buscar de la tabla  'tbparametros_generales'
        $strSQL="
                SELECT IdParam,valor,ValidoDesde,ValidoHasta
                FROM tbparametros_generales
                WHERE nombre ='$parametroBuscar'
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Parametro_general()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
        }
        
        //paso a DATETIME
//        $fechaInicio=fecha_to_DATETIME($fechaInicio);
//        $fechaFin=fecha_to_DATETIME($fechaFin);
        
        //ahora busco en este array por fechas que este valido este parametro
        if(is_array($resultado)){
            for($i=0;$i<count($resultado);$i++){
                //si ValidoHasta = null , solo hay que combrobar que $fechaInicio>=ValidoDesde
                if($resultado[$i]['ValidoHasta']==null){
                    if($fechaInicio >= $resultado[$i]['ValidoDesde']){
                        $valorParametro=$resultado[$i]['IdParam'];
                    }
                }else{
                //si ValidoHasta tiene valor 
                    //hay que ver que $fechaInicio>=ValidoDesde y $fechaFin<=ValidoHasta
                    if(($fechaInicio >= $resultado[$i]['ValidoDesde']) && ($fechaFin <= $resultado[$i]['ValidoHasta'])){
                        $valorParametro=$resultado[$i]['IdParam'];
                    }
                }
            }
        }
        //sino no hay array es que no se a encntrado nada, por defecto se pone 0
        else{
            $valorParametro=0;
        }
        return $valorParametro;
    }
    
    function Contador_Compuesto1_NuevoNumero($campo,$tabla){
        //este contador compuesto1 es: Número/Año
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //primero extraemos el listado de Numeros de presupuestos
        $strSQL="
                SELECT $campo
                FROM $tabla
                WHERE Borrado=1
                ORDER BY $campo DESC
                LIMIT 0,1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Contador_Compuesto1_NuevoNumero()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        $numero=1;
        if($stmt){
            $row=  mysql_fetch_array($stmt);
            //si $row es false es que no hay ningun registro guardado por lo que le damos numero nuevo
            if($row==false){
                $numero='1/'.date('Y');
            }else{
                //como el numero es de la forma '20140005' donde las 4 primeras cifras son el ejercicio
                //y las 4 ultimas el numero y se presenta 5/2014
                
                //primero comprobamos si el ejercicio es el actual
                $ejercicio=substr($row[$campo],0,4);
                if($ejercicio==date('Y')){
                    $numero=substr($row[$campo],4,4);
                    while(substr($numero,0,1)==='0'){
                        $numero=substr($numero,1);
                    }
                    $numero=$numero+1;
                    $numero=$numero.'/'.$ejercicio;
                }else
                //el ejercicio no es el mismo por lo que comienza la numeracion de un ejercicio nuevo    
                {
                    $numero='1/'.date('Y');
                }
            }
        }
        
        return $numero;
    }
    
    function Contador_Compuesto1_NuevoNumero2($campo,$tabla){
        //este contador compuesto1 es: Número/Año
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //primero extraemos el listado de Numeros de presupuestos
        $strSQL="
                SELECT $campo
                FROM $tabla
                WHERE Borrado=1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Contador_Compuesto1_NuevoNumero()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        
        $resultado = '';
        if($stmt){
            while($row = mysql_fetch_array($stmt)){
                $reg = '';
                foreach($row as $propiedad => $valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad] = $valor;
                    }
                }
                $resultado[] = $reg;
            }
        }
        
        
        //ahora miro las que no tengan de prefijo las letras tbparametros_generales[PrefijoFacturaAbono]
        $PrefijoFacturaAbono = $this->Parametro_general('PrefijoFacturaAbono',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
            
        //ahora quito el año (4 primeras cifras)
        $numeroMasAlto = 0;//al final sumo 1, por eso empiezo en 0
        for ($i = 0; $i < count($resultado); $i++) {
            $numero = $resultado[$i]['NumFactura'];
            $ejercicio = substr($resultado[$i]['NumFactura'],0,4);
            
            $pos = strpos($numero,$PrefijoFacturaAbono);
            
            if($pos === false){
                //la comparo con el valor $numeroMasAlto y actualizo este si es mas alto el ´numero
                if($numeroMasAlto < $numero){
                    $numeroMasAlto = $numero;
                }
            }
        }
        
        //ahora extraigo el año
        $ejercicio = substr($numeroMasAlto,0,4);

        if($ejercicio === date('Y')){//estamos en el año
            $numeroFinal = (int)substr($numeroMasAlto,4,20) + 1;
            $numeroFinal = $numeroFinal . '/' . $ejercicio;
        }else{//numeracion nueva del año
            $numeroFinal = '1/' . date('Y');
        }
        
        
        return $numeroFinal;
    }
    
    function Contador_Compuesto1_NuevoNumeroRectificativa($campo,$tabla){
        //este contador compuesto1 es: Número/Año
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //primero extraemos el listado de Numeros de presupuestos
        $strSQL="
                SELECT $campo
                FROM $tabla
                WHERE Borrado=1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Contador_Compuesto1_NuevoNumero()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        
        $resultado = '';
        if($stmt){
            while($row = mysql_fetch_array($stmt)){
                $reg = '';
                foreach($row as $propiedad => $valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad] = $valor;
                    }
                }
                $resultado[] = $reg;
            }
        }
        
        
        //ahora miro las que no tengan de prefijo las letras tbparametros_generales[PrefijoFacturaAbono]
        $PrefijoFacturaAbono = $this->Parametro_general('PrefijoFacturaAbono',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
            
        //ahora quito el año (4 primeras cifras)
        $numeroMasAlto = 0;//al final sumo 1, por eso empiezo en 0
        for ($i = 0; $i < count($resultado); $i++) {
            $numero = $resultado[$i]['NumFactura'];
            $ejercicio = substr($resultado[$i]['NumFactura'],0,4);
            $numeroSinEjercicio = substr($resultado[$i]['NumFactura'],4,20);
            
            $pos = strpos($numeroSinEjercicio,$PrefijoFacturaAbono);
            
            if($pos !== false){
                //quito el prefijo
                $numeracion = iconv_substr($numeroSinEjercicio,strlen($PrefijoFacturaAbono),strlen($numero));
                //junto el ejercicio y el numero sin prefijo
                $numeracionSinPrefijo = $ejercicio . $numeracion;
                //la comparo con el valor $numeroMasAlto y actualizo este si es mas alto el numero
                if($numeroMasAlto < (int)$numeracionSinPrefijo){
                    $numeroMasAlto = (int)$numeracionSinPrefijo;
                }
            }
        }
        
        //ahora extraigo el año de $numeroMasAlto
        $ejercicio = substr($numeroMasAlto,0,4);
        $restoDelNumero = substr($numeroMasAlto,4,20);
        
        if($ejercicio === date('Y')){//estamos en el año
            $numeroFinal = (int)$restoDelNumero + 1;
            while(strlen($numeroFinal)<4){
                $numeroFinal = '0' . $numeroFinal;
            }
            $numeroFinal = $PrefijoFacturaAbono . $numeroFinal . '/' . $ejercicio;
        }else{//numeracion nueva del año en curso
            $numeroFinal = $PrefijoFacturaAbono . '0001/' . date('Y');
        }
        
        return $numeroFinal;
    }
    
    //REVISAR CUANDO SE PONGA EN FUNCIONAMIENTO 7/10/2015
    function Contador_Compuesto2_NuevoNumero($campo,$tabla){
        //este contador compuesto2 es: Año/Número
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //primero extraemos el listado de Numeros de presupuestos
        $strSQL="
                SELECT $campo
                FROM $tabla
                WHERE Borrado=1
                ORDER BY $campo DESC
                LIMIT 0,1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Contador_Simple_NuevoNumero2()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        $numero=1;
        if($stmt){
            $row=  mysql_fetch_array($stmt);
            //si $row es false es que no hay ningun registro guardado por lo que le damos numero nuevo
            if($row==false){
                $numero=date('Y').'/1';
            }else{
                //como el numero es de la forma '20140005' donde las 4 primeras cifras son el ejercicio
                //y las 4 ultimas el numero y se presenta 2014/5
                
                //primero comprobamos si el ejercicio es el actual
                $ejercicio=substr($row[$campo],0,4);
                if($ejercicio==date('Y')){
                    $numero=substr($row[$campo],4,4);
                    while(substr($numero,0,1)==='0'){
                        $numero=substr($numero,1);
                    }
                    $numero=$numero+1;
                    $numero=$ejercicio.'/'.$numero;
                }else
                //el ejercicio no es el mismo por lo que comienza la numeracion de un ejercicio nuevo    
                {
                    $numero=date('Y').'/1';
                }
            }
        }
        
        return $numero;
    }
    
    function Contador_Simple_NuevoNumero($campo,$tabla){
        //este contador simple es: Número
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //primero extraemos el listado de Numeros de presupuestos
        $strSQL="
                SELECT $campo
                FROM $tabla
                WHERE Borrado=1
                ORDER BY $campo DESC
                LIMIT 0,1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Contador_Simple_NuevoNumero()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        
        $numero=1;
        if($stmt){
            $row=  mysql_fetch_array($stmt);
            //si $row es false es que no hay ningun registro guardado por lo que le damos numero nuevo
            if($row==false){
                $numero='1';
            }else{
                //como el numero es de la forma '20140005' donde las 4 primeras cifras son el ejercicio
                //y las 4 ultimas el numero y se presenta 5
                
                //primero comprobamos si el ejercicio es el actual
                //$ejercicio=substr($row[$campo],0,4);
                //if($ejercicio==date('Y')){
                    $numero=substr($row[$campo],4,4);
                    while(substr($numero,0,1)==='0'){
                        $numero=substr($numero,1);
                    }
                    $numero=$numero+1;
                    //$numero=$numero.'/'.$ejercicio;
                //}else
                //el ejercicio no es el mismo por lo que comienza la numeracion de un ejercicio nuevo    
                //{
                //    $numero='1/'.date('Y');
                //}
            }
        }

        
        return $numero;
    }
    
    function Contador_Simple_NuevoNumero2($campo,$tabla){
        //este contador simple es: Número
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //primero extraemos el listado de Numeros de factura
        $strSQL="
                SELECT $campo
                FROM $tabla
                WHERE Borrado=1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Contador_Simple_NuevoNumero2()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        
        $resultado = '';
        if($stmt){
            while($row = mysql_fetch_array($stmt)){
                $reg = '';
                foreach($row as $propiedad => $valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad] = $valor;
                    }
                }
                $resultado[] = $reg;
            }
        }
        
        //ahora miro las que no tengan de prefijo las letras detbparametros_generales[PrefijoFacturaAbono]
        $PrefijoFacturaAbono = $this->Parametro_general('PrefijoFacturaAbono',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
            
        //ahora quito el año (4 primeras cifras)
        $numeroMasAlto = 0;//al final sumo 1, por eso empiezo en 0
        if(is_array($resultado)){
            for ($i = 0; $i < count($resultado); $i++) {
                $numero = substr($resultado[$i]['NumFactura'],4,20);

                $pos = strpos($numero,$PrefijoFacturaAbono);

                if($pos === false){
                    //la comparo con el valor $numeroMasAlto y actualizo este si es mas alto el ´numero
                    if($numeroMasAlto < $numero){
                        $numeroMasAlto = $numero;
                    }
                }
            }
        }
        
        
        return $numeroMasAlto + 1;
    }
    
    function Contador_Simple_NuevoNumeroRectificativa($campo,$tabla){
        //este contador simple es: Número
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //primero extraemos el listado de Numeros de factura
        $strSQL="
                SELECT $campo
                FROM $tabla
                WHERE Borrado=1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Contador_Simple_NuevoNumero2()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        
        $resultado = '';
        if($stmt){
            while($row = mysql_fetch_array($stmt)){
                $reg = '';
                foreach($row as $propiedad => $valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad] = $valor;
                    }
                }
                $resultado[] = $reg;
            }
        }
        
        //ahora miro las que no tengan de prefijo las letras detbparametros_generales[PrefijoFacturaAbono]
        $PrefijoFacturaAbono = $this->Parametro_general('PrefijoFacturaAbono',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
            
        //ahora quito el año (4 primeras cifras)
        $numeroMasAlto = 0;//al final sumo 1, por eso empiezo en 0
        if(is_array($resultado)){
            for ($i = 0; $i < count($resultado); $i++) {
                $numero = substr($resultado[$i]['NumFactura'],4,20);

                $pos = strpos($numero,$PrefijoFacturaAbono);

                if($pos !== false){//que tengan el prefijo
                    $numeracion = iconv_substr($numero,strlen($PrefijoFacturaAbono),strlen($numero));
                    //la comparo con el valor $numeroMasAlto y actualizo este si es mas alto el ´numero
                    if($numeroMasAlto < (int)$numeracion){
                        $numeroMasAlto = (int)$numeracion;
                    }
                }
            }
        }
        
        
        $numeroMasAlto = $numeroMasAlto + 1;
        
        //incluir 0 delante hasta formar numero de 4 cifras
        while(strlen($numeroMasAlto)<4){
            $numeroMasAlto = '0'.$numeroMasAlto;
        }
        
        return $PrefijoFacturaAbono . $numeroMasAlto;
    }
    
    function Contador_NuevoNumero($campo,$tabla,$tipoContador){
        switch ($tipoContador) {
            case 'simple':
                $numero = $this->Contador_Simple_NuevoNumero2($campo, $tabla);
                break;
            case 'compuesto1':
                $numero = $this->Contador_Compuesto1_NuevoNumero2($campo, $tabla);
                break;
            case 'compuesto2':
                $numero = $this->Contador_Compuesto2_NuevoNumero($campo, $tabla);
                break;
            default://ningun contador
                break;
        }
        
        return $numero;
    }
    
    function Actualizar_tbmispresupuestos_Contacto_Cliente($contacto,$numCuenta){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //primero extraemos el listado de Numeros de presupuestos
        $strSQL="
                UPDATE tbmispresupuestos
                SET Contacto_Cliente='$numCuenta'
                WHERE Contacto_Cliente='$contacto'
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Actualizar_tbmispresupuestos_Contacto_Cliente()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        $numero=1;
        if($stmt){
            return true;
        }else{
            return false;
        }
    }
    
    function DatosEmpresa(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //primero extraemos el listado de Numeros de presupuestos
        $strSQL="
                SELECT nombre,valor,ValidoDesde,ValidoHasta
                FROM tbparametros_generales
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->DatosEmpresa()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();

        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                if($reg['ValidoHasta']==null){
                    if(date('Y-m-d H:i:s') >= $reg['ValidoDesde']){
                        $resultado[$reg['nombre']]=$reg['valor'];
                    }
                }else{
                //si ValidoHasta tiene valor 
                    //hay que ver que HOY>=ValidoDesde y HOY<=ValidoHasta
                    if((date('Y-m-d H:i:s') >= $reg['ValidoDesde']) && (date('Y-m-d H:i:s') <= $reg['ValidoHasta'])){
                        $resultado[$reg['nombre']]=$reg['valor'];
                    }
                }
            }
        }
        
        return $resultado;
    }
    
    function DatosEmpresa_tbempresas($idEmp){
        require_once '../general/conexion.php';
        $dbG = new DbC();

        //listo los datos de la empresa de la tabla 'tbempresas'
        $strSQL = "
                    SELECT E.strNombre,E.strPassword,E.strSesion,E.strCIF,E.fechaAlta,E.fechaVencimiento,
                                     E.direccion,E.municipio,E.provincia,E.CP,E.telefono,E.email1,E.email2,E.Version,E.numApuntes,
                                     E.strMapeo,E.lngAsesor,E.claseEmpresa,DATE_FORMAT(E.fechaAlta,'%d/%m/%Y') AS fechaAlta,
                                     DATE_FORMAT(E.fechaVencimiento,'%d/%m/%Y') AS fechaVencimiento
                    FROM tbempresas E
                    WHERE E.IdEmpresa=$idEmp
                    AND E.borrado=0
                   ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->DatosEmpresa_tbempresas()|| SQL : ".$strSQL);
        $dbG->conectar($this->getStrBD());
        $stmt = $dbG->ejecutar ( $strSQL );
        $dbG->desconectar();
        
        if($stmt){
            //devolvemos los datos
            $row=  mysql_fetch_array($stmt);
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->DatosEmpresa_tbempresas()<Datos Empresa ");
            return $row;
        }else{
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->DatosEmpresa_tbempresas()<FALSE ");
            return false;
        }
    }

    function datosDuplicarFactura($IdFactura,$numeroNuevaFactura){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();

        //recojo los datos de la tabla 'tbmisfacturas'
        $strSQL="
                SELECT *
                FROM tbmisfacturas
                WHERE IdFactura=$IdFactura
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarFactura()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado=$reg;
            }
        }

        //ahora saco el nuevo número IdFactura
        $strSQL="
                SELECT IdFactura
                FROM tbmisfacturas
                ORDER BY IdFactura DESC LIMIT 0,1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarFactura()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();

        if($stmt){
            $row=  mysql_fetch_array($stmt);
            $IdFacturaNueva=$row['IdFactura']+1;
        }else{
            $IdFacturaNueva=1;
        }
        
        $db->conectar($this->getStrBD());
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->datosDuplicarFactura() || START TRANSACTION");
        
        //inserto el nueva factura
        $strSQL="
                INSERT INTO tbmisfacturas (IdFactura,NumFactura,Cliente,FechaFactura,FechaVtoFactura,FormaPago,Estado,Retencion,lngIdUsuario,Borrado,Referencia,CC_Trans)
                VALUES ($IdFacturaNueva,'$numeroNuevaFactura','".$resultado['Cliente']."',NOW(),NOW(),
                        '".$resultado['FormaPago']."','Emitida',".$resultado['Retencion'].",".$_SESSION['usuario'].",1,'".$resultado['Referencia']."','".$resultado['CC_Trans']."') 
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->datosDuplicarFactura()<ROLLBACK");
            return 'false';
        }
        
        //ahora extraigo las lineas de esta factura en 'tbmisfacturaslineas' y los inserto con el nuevo IdFactura
        $strSQL="
                SELECT *
                FROM tbmisfacturaslineas
                WHERE IdFactura=$IdFactura
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->datosDuplicarFactura()<ROLLBACK");
            return 'false';
        }
        
        $lineas='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $lineas[]=$reg;
            }
        }
        
        foreach ($lineas as $resul){
            //hago una insercion por cada linea que tengo en este array
            //primero calculo un nuevo numero IdFacturaLineas
            $strSQL="
                    SELECT IdFacturaLineas
                    FROM tbmisfacturaslineas
                    ORDER BY IdFacturaLineas DESC LIMIT 0,1
                    ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosDuplicarFactura()|| SQL : ".$strSQL);

            $stmt = $db->ejecutar ( $strSQL );

            if($stmt){
                $row=  mysql_fetch_array($stmt);
                $IdFacturaLineas=$row['IdFacturaLineas']+1;
            }else{
                $IdFacturaLineas=1;
            }
            
            //compruebo si IdArticulo esta vacio (es null)
            if($resul['IdArticulo'] === null){
                //hago la insercion
                $strSQL="
                        INSERT INTO tbmisfacturaslineas (IdFacturaLineas,IdFactura,NumLineaFactura,cuentaArticulo,DescripcionProducto,TipoIVA,
                                                             CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,
                                                             ImportePEN,CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN)
                        VALUES
                        ($IdFacturaLineas,$IdFacturaNueva,".$resul['NumLineaFactura'].",'".$resul['cuentaArticulo']."','".$resul['DescripcionProducto']."',".$resul['TipoIVA'].",
                         ".$resul['CantidadPED'].",0,".$resul['CantidadPED'].",
                         ".$resul['ImporteUnidad'].",".$resul['ImportePED'].",0,
                         ".$resul['ImportePED'].",".$resul['CuotaIvaPED'].",0,
                         ".$resul['CuotaIvaPED'].")
                        ";
            }else{
                //hago la insercion
                $strSQL="
                        INSERT INTO tbmisfacturaslineas (IdFacturaLineas,IdFactura,NumLineaFactura,IdArticulo,cuentaArticulo,DescripcionProducto,TipoIVA,
                                                             CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,
                                                             ImportePEN,CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN)
                        VALUES
                        ($IdFacturaLineas,$IdFacturaNueva,".$resul['NumLineaFactura'].",".$resul['IdArticulo'].",'".$resul['cuentaArticulo']."','".$resul['DescripcionProducto']."',".$resul['TipoIVA'].",
                         ".$resul['CantidadPED'].",0,".$resul['CantidadPED'].",
                         ".$resul['ImporteUnidad'].",".$resul['ImportePED'].",0,
                         ".$resul['ImportePED'].",".$resul['CuotaIvaPED'].",0,
                         ".$resul['CuotaIvaPED'].")
                        ";
            }
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosDuplicarFactura()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );

            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->datosDuplicarFactura()<ROLLBACK");
                return 'false';
            }
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->datosDuplicarFactura()<COMMIT");
        
        $db->desconectar ();

        return $IdFacturaNueva;
    }
    
    function datosDuplicarFacturaRectificativa($IdFactura,$numeroNuevaFactura){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();

        //recojo los datos de la tabla 'tbmisfacturas'
        $strSQL="
                SELECT *
                FROM tbmisfacturas
                WHERE IdFactura=$IdFactura
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarFacturaRectificativa()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado=$reg;
            }
        }

        //ahora saco el nuevo número IdFactura
        $strSQL="
                SELECT IdFactura
                FROM tbmisfacturas
                ORDER BY IdFactura DESC LIMIT 0,1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarFacturaRectificativa()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();

        if($stmt){
            $row=  mysql_fetch_array($stmt);
            $IdFacturaNueva=$row['IdFactura']+1;
        }else{
            $IdFacturaNueva=1;
        }
        
        $db->conectar($this->getStrBD());
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->datosDuplicarFacturaRectificativa() || START TRANSACTION");
        
        //inserto el nueva factura
        $strSQL="
                INSERT INTO tbmisfacturas (IdFactura,NumFactura,Cliente,FechaFactura,FechaVtoFactura,FormaPago,Estado,Retencion,lngIdUsuario,Borrado,Referencia,CC_Trans,esAbono)
                VALUES ($IdFacturaNueva,'$numeroNuevaFactura','".$resultado['Cliente']."',NOW(),NOW(),
                        '".$resultado['FormaPago']."','Emitida',".$resultado['Retencion'].",".$_SESSION['usuario'].",1,'".$resultado['Referencia']."','".$resultado['CC_Trans']."','".$resultado['NumFactura']."') 
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarFacturaRectificativa()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->datosDuplicarFacturaRectificativa()<ROLLBACK");
            return 'false';
        }
        
        //ahora extraigo las lineas de esta factura en 'tbmisfacturaslineas' y los inserto con el nuevo IdFactura
        $strSQL="
                SELECT *
                FROM tbmisfacturaslineas
                WHERE IdFactura=$IdFactura
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarFacturaRectificativa()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->datosDuplicarFacturaRectificativa()<ROLLBACK");
            return 'false';
        }
        
        $lineas='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $lineas[]=$reg;
            }
        }
        
        foreach ($lineas as $resul){
            //hago una insercion por cada linea que tengo en este array
            //primero calculo un nuevo numero IdFacturaLineas
            $strSQL="
                    SELECT IdFacturaLineas
                    FROM tbmisfacturaslineas
                    ORDER BY IdFacturaLineas DESC LIMIT 0,1
                    ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosDuplicarFacturaRectificativa()|| SQL : ".$strSQL);

            $stmt = $db->ejecutar ( $strSQL );

            if($stmt){
                $row=  mysql_fetch_array($stmt);
                $IdFacturaLineas=$row['IdFacturaLineas']+1;
            }else{
                $IdFacturaLineas=1;
            }
            
            //compruebo si IdArticulo esta vacio (es null)
            if($resul['IdArticulo'] === null){
                //hago la insercion
                $strSQL="
                        INSERT INTO tbmisfacturaslineas (IdFacturaLineas,IdFactura,NumLineaFactura,cuentaArticulo,DescripcionProducto,TipoIVA,
                                                             CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,
                                                             ImportePEN,CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN)
                        VALUES
                        ($IdFacturaLineas,$IdFacturaNueva,".$resul['NumLineaFactura'].",'".$resul['cuentaArticulo']."','".$resul['DescripcionProducto']."',".$resul['TipoIVA'].",
                         ".$resul['CantidadPED'].",0,".$resul['CantidadPED'].",
                         ".(-$resul['ImporteUnidad']).",".(-$resul['ImportePED']).",0,
                         ".(-$resul['ImportePED']).",".(-$resul['CuotaIvaPED']).",0,
                         ".(-$resul['CuotaIvaPED']).")
                        ";
            }else{
                //hago la insercion
                $strSQL="
                        INSERT INTO tbmisfacturaslineas (IdFacturaLineas,IdFactura,NumLineaFactura,IdArticulo,cuentaArticulo,DescripcionProducto,TipoIVA,
                                                             CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,
                                                             ImportePEN,CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN)
                        VALUES
                        ($IdFacturaLineas,$IdFacturaNueva,".$resul['NumLineaFactura'].",".$resul['IdArticulo'].",'".$resul['cuentaArticulo']."','".$resul['DescripcionProducto']."',".$resul['TipoIVA'].",
                         ".$resul['CantidadPED'].",0,".$resul['CantidadPED'].",
                         ".(-$resul['ImporteUnidad']).",".(-$resul['ImportePED']).",0,
                         ".(-$resul['ImportePED']).",".(-$resul['CuotaIvaPED']).",0,
                         ".(-$resul['CuotaIvaPED']).")
                        ";
            }
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosDuplicarFacturaRectificativa()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );

            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->datosDuplicarFacturaRectificativa()<ROLLBACK");
                return 'false';
            }
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->datosDuplicarFacturaRectificativa()<COMMIT");
        
        $db->desconectar ();

        return $IdFacturaNueva;
    }
    
    function datosDuplicarPedido($IdPedido,$numeroNuevoPedido){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();

        //recojo los datos de la tabla 'tbmispedidos'
        $strSQL="
                SELECT *
                FROM tbmispedidos
                WHERE IdPedido=$IdPedido
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarPedido()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado=$reg;
            }
        }

        //ahora saco el nuevo número IdPedido
        $strSQL="
                SELECT IdPedido
                FROM tbmispedidos
                ORDER BY IdPedido DESC LIMIT 0,1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarPedido()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();

        if($stmt){
            $row=  mysql_fetch_array($stmt);
            $IdPedidoNuevo=$row['IdPedido']+1;
        }else{
            $IdPedidoNuevo=1;
        }
        
        $db->conectar($this->getStrBD());
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->datosDuplicarPedido() || START TRANSACTION");
        
        //inserto el nuevo pedido
        $strSQL="
                INSERT INTO tbmispedidos (IdPedido,NumPedido,Cliente,FechaPedido,FechaVtoPedido,FormaPago,FechaFinalizacion,
                Estado,Retencion,lngIdUsuario,Borrado,TipoFactura,DiaPeriodica,FrecuenciaPeriodica,FechaProximaFacturaPeriodica,CC_Trans,Referencia)
                VALUES ($IdPedidoNuevo,'$numeroNuevoPedido','".$resultado['Cliente']."','".$resultado['FechaPedido']."','".$resultado['FechaVtoPedido']."',
                        '".$resultado['FormaPago']."','".$resultado['FechaFinalizacion']."','".$resultado['Estado']."',".$resultado['Retencion'].",".$_SESSION['usuario'].",1,
                        '".$resultado['TipoFactura']."','".$resultado['DiaPeriodica']."','".$resultado['FrecuenciaPeriodica']."','".$resultado['FechaProximaFacturaPeriodica']."','".$resultado['CC_Trans']."','".$resultado['Referencia']."') 
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarPedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->datosDuplicarPedido()<ROLLBACK");
            return 'false';
        }
        
        //ahora extraigo las lineas de este pedido en 'tbmispedidoslineas' y los inserto con el nuevo IdPedido
        $strSQL="
                SELECT *
                FROM tbmispedidoslineas
                WHERE IdPedido=$IdPedido
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarPedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->datosDuplicarPedido()<ROLLBACK");
            return 'false';
        }
        
        $lineas='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $lineas[]=$reg;
            }
        }
        
        foreach ($lineas as $resul){
            //hago una insercion por cada linea que tengo en este array
            //primero calculo un nuevo numero IdPedidoLineas
            $strSQL="
                    SELECT IdPedidoLineas
                    FROM tbmispedidoslineas
                    ORDER BY IdPedidoLineas DESC LIMIT 0,1
                    ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosDuplicarPedido()|| SQL : ".$strSQL);

            $stmt = $db->ejecutar ( $strSQL );

            if($stmt){
                $row=  mysql_fetch_array($stmt);
                $IdPedidoLineas=$row['IdPedidoLineas']+1;
            }else{
                $IdPedidoLineas=1;
            }
            
            //compruebo si IdArticulo esta vacio (es null)
            if($resul['IdArticulo'] === null){
                //hago la insercion
                $strSQL="
                        INSERT INTO tbmispedidoslineas (IdPedidoLineas,IdPedido,NumLineaPedido,DescripcionProducto,TipoIVA,
                                                             CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,
                                                             ImportePEN,CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN)
                        VALUES
                        ($IdPedidoLineas,$IdPedidoNuevo,".$resul['NumLineaPedido'].",'".$resul['DescripcionProducto']."',".$resul['TipoIVA'].",
                         ".$resul['CantidadPED'].",0,".$resul['CantidadPED'].",
                         ".$resul['ImporteUnidad'].",".$resul['ImportePED'].",0,
                         ".$resul['ImportePED'].",".$resul['CuotaIvaPED'].",0,
                         ".$resul['CuotaIvaPED'].")
                        ";
            }else{
                //hago la insercion
                $strSQL="
                        INSERT INTO tbmispedidoslineas (IdPedidoLineas,IdPedido,NumLineaPedido,IdArticulo,DescripcionProducto,TipoIVA,
                                                             CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,
                                                             ImportePEN,CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN)
                        VALUES
                        ($IdPedidoLineas,$IdPedidoNuevo,".$resul['NumLineaPedido'].",".$resul['IdArticulo'].",'".$resul['DescripcionProducto']."',".$resul['TipoIVA'].",
                         ".$resul['CantidadPED'].",0,".$resul['CantidadPED'].",
                         ".$resul['ImporteUnidad'].",".$resul['ImportePED'].",0,
                         ".$resul['ImportePED'].",".$resul['CuotaIvaPED'].",0,
                         ".$resul['CuotaIvaPED'].")
                        ";
            }
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosDuplicarPedido()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );

            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->datosDuplicarPedido()<ROLLBACK");
                return 'false';
            }
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->datosDuplicarPedido()<COMMIT");
        
        $db->desconectar ();

        return $IdPedidoNuevo;
    }
    
    function datosDuplicarPresupuesto($IdPresupuesto,$numeroNuevoPresupuesto){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();

        //recojo los datos de la tabla 'tbmispresupuestos'
        $strSQL="
                SELECT *
                FROM tbmispresupuestos
                WHERE IdPresupuesto=$IdPresupuesto
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarPresupuesto()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado=$reg;
            }
        }

        //ahora saco el nuevo número IdPresupuesto
        $strSQL="
                SELECT IdPresupuesto
                FROM tbmispresupuestos
                ORDER BY IdPresupuesto DESC LIMIT 0,1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarPresupuesto()|| SQL : ".$strSQL);
        
        $db->conectar($this->getStrBD());
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();

        if($stmt){
            $row=  mysql_fetch_array($stmt);
            $IdPresupuestoNuevo=$row['IdPresupuesto']+1;
        }else{
            $IdPresupuestoNuevo=1;
        }
        
        $db->conectar($this->getStrBD());
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->datosDuplicarPresupuesto() || START TRANSACTION");
        
        //inserto el nuevo presupuesto
        $strSQL="
                INSERT INTO tbmispresupuestos (IdPresupuesto,NumPresupuesto,Contacto_Cliente,FechaPresupuesto,FechaVtoPresupuesto,FormaPago,Estado,Retencion,lngIdUsuario,Borrado)
                VALUES ($IdPresupuestoNuevo,'$numeroNuevoPresupuesto','".$resultado['Contacto_Cliente']."',now(),now(),
                        '".$resultado['FormaPago']."','".$resultado['Estado']."',".$resultado['Retencion'].",".$_SESSION['usuario'].",1) 
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarPresupuesto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->datosDuplicarPresupuesto()<ROLLBACK");
            return 'false';
        }
        
        //ahora extraigo las lineas de esta factura en 'tbmispresupuestoslineas' y los inserto con el nuevo IdPresupuesto
        $strSQL="
                SELECT *
                FROM tbmispresupuestoslineas
                WHERE IdPresupuesto=$IdPresupuesto
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->datosDuplicarPresupuesto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->datosDuplicarPresupuesto()<ROLLBACK");
            return 'false';
        }
        
        $lineas='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $lineas[]=$reg;
            }
        }
        
        foreach ($lineas as $resul){
            //hago una insercion por cada linea que tengo en este array
            //primero calculo un nuevo numero IdPresupLineas
            $strSQL="
                    SELECT IdPresupLineas
                    FROM tbmispresupuestoslineas
                    ORDER BY IdPresupLineas DESC LIMIT 0,1
                    ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosDuplicarPresupuesto()|| SQL : ".$strSQL);

            $stmt = $db->ejecutar ( $strSQL );

            if($stmt){
                $row=  mysql_fetch_array($stmt);
                $IdPresupLineas=$row['IdPresupLineas']+1;
            }else{
                $IdPresupLineas=1;
            }
            
            //compruebo si s campo IdArticulo viene vacio (es null)
            if($resul['IdArticulo'] === NULL){
                //hago la insercion
                $strSQL="
                        INSERT INTO tbmispresupuestoslineas (IdPresupLineas,IdPresupuesto,NumLineaPresup,DescripcionProducto,TipoIVA,
                                                             CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,
                                                             ImportePEN,CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN,Facturada)
                        VALUES
                        ($IdPresupLineas,$IdPresupuestoNuevo,".$resul['NumLineaPresup'].",'".$resul['DescripcionProducto']."',".$resul['TipoIVA'].",
                         ".$resul['CantidadPED'].",0,".$resul['CantidadPED'].",
                         ".$resul['ImporteUnidad'].",".$resul['ImportePED'].",0,
                         ".$resul['ImportePED'].",".$resul['CuotaIvaPED'].",0,
                         ".$resul['CuotaIvaPED'].",'NF')
                        ";
            }else{
                //hago la insercion
                $strSQL="
                        INSERT INTO tbmispresupuestoslineas (IdPresupLineas,IdPresupuesto,NumLineaPresup,IdArticulo,DescripcionProducto,TipoIVA,
                                                             CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,
                                                             ImportePEN,CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN,Facturada)
                        VALUES
                        ($IdPresupLineas,$IdPresupuestoNuevo,".$resul['NumLineaPresup'].",".$resul['IdArticulo'].",'".$resul['DescripcionProducto']."',".$resul['TipoIVA'].",
                         ".$resul['CantidadPED'].",0,".$resul['CantidadPED'].",
                         ".$resul['ImporteUnidad'].",".$resul['ImportePED'].",0,
                         ".$resul['ImportePED'].",".$resul['CuotaIvaPED'].",0,
                         ".$resul['CuotaIvaPED'].",'NF')
                        ";
            }
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->datosDuplicarPresupuesto()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );

            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->datosDuplicarPresupuesto()<ROLLBACK");
                return 'false';
            }
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->datosDuplicarPresupuesto()<COMMIT");
        
        $db->desconectar ();

        return $IdPresupuestoNuevo;
    }
    
    function guardarParametros_generales($post){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //el mapeo de los campos del formulario con respecto a los valores de la tabla 'tbparametros_generales'
        $mapeo=array(
            "PorcAutonomo"=>"Porcentaje Autonomo",
            "PagosCuentas"=>"Pagos Cuenta",
            "IvaGenerico"=>"IvaGenerico",
            "email"=>"Email Envios",
            "logoDocumento"=>"Logo en Documentos",
            "logoAplicacion"=>"Logo en Aplicacion",
            "tipoContador"=>"Tipo Contador",
            "tituloPrep"=>"Titulo Presupuesto",
            "txtPie"=>"Texto Pie",
            "tipoIRPF"=>"Tipo IRPF",
            "alias"=>"Alias",
            "FacturaTipo"=>"Factura Tipo",
            "articulo"=>"articulo",
            "cuentaContable"=>"cuentaContable",
            "codigoEmpresa"=>"codigoEmpresa",
            "CCTrans"=>"CCTrans",
            "PrefijoFacturaAbono"=>"PrefijoFacturaAbono"
        );

        $db->conectar($this->getStrBD());
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarParametros_generales() || START TRANSACTION");
        
        //recorro todo el array $post y los valores que son de la tabla 'tbparametros_generales' los guardo
        foreach ($post as $propiedad=>$valor){
            //compruebo si existe esta propiedad en el array $mapeo
            $existe='NO';
            foreach($mapeo as $mapeoPropiedad=>$mapeoValor){
                if($propiedad==$mapeoPropiedad){
                    $existe='SI';
                    break;
                }
            }
            //si existe actualizo el valor en la tabla 'tbparametros_generales'
            if($existe==='SI'){
                //1º- Busco el valor actual 
                $Id=$this->Parametro_general_Id($mapeo[$propiedad], date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
                $strSQL="
                        SELECT valor
                        FROM tbparametros_generales 
                        WHERE IdParam=$Id
                        ";
                
                $db->conectar($this->getStrBD());
                $stmt = $db->ejecutar ( $strSQL );
                if(!$stmt){
                    //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->guardarParametros_generales()<ROLLBACK");
                    return 'false';
                }
                $row=  mysql_fetch_array($stmt);
                
                //2º- Comparo este valor actual con el nuevo, si es el mismo no hago nada, sigue valiendo y si es distinto lo guardo y cierro este
                //(le pongo fecha a ValidoHasta)
                if($row['valor']<>$valor){
                    //3º- Actualizo el campo ValidoHasta el valor actual (con la fecha de hoy entre ValidoDesde y ValidoHasta y le pongo ValidoHasta la de ahora mismo)
                    $Id=$this->Parametro_general_Id($mapeo[$propiedad], date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
                    $strSQL="
                            UPDATE tbparametros_generales 
                            SET ValidoHasta=now()
                            WHERE IdParam=$Id
                            ";
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->guardarParametros_generales()|| SQL : ".$strSQL);

                    $db->conectar($this->getStrBD());
                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->guardarParametros_generales()<ROLLBACK");
                        return 'false';
                    }

                    //4º- Inserto este nuevo valor con la ValidoDesde de ahora mismo 
                    $strSQL="
                            SELECT IdParam FROM tbparametros_generales ORDER BY IdParam DESC LIMIT 0,1
                            ";
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->guardarParametros_generales()|| SQL : ".$strSQL);

                    $stmt = $db->ejecutar ( $strSQL );

                    if($stmt){
                        $row=  mysql_fetch_array($stmt);
                        $IdParamNuevo=$row['IdParam']+1;
                    }else{
                        $IdParamNuevo=1;
                    }

                    $strSQL="
                            INSERT INTO tbparametros_generales (IdParam,nombre,valor,ValidoDesde)
                            VALUES ($IdParamNuevo,'$mapeo[$propiedad]','".mysql_real_escape_string($valor)."',now())
                            ";
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                           " clsCADContabilidad->guardarParametros_generales()|| SQL : ".$strSQL);

                    $stmt = $db->ejecutar ( $strSQL );
                    if(!$stmt){
                        //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->guardarParametros_generales()<ROLLBACK");
                        return 'false';
                    }

                    //5º Compruebo si el parametro $mapeo[$propiedad]='Logo en Documentos'
                    //si es, actualizo $_SESSION[imprimeDoc]
                    if($mapeo[$propiedad]==='Logo en Documentos'){
                        $_SESSION['imprimeDoc']=$valor;
                    }

                    //6º Compruebo si el parametro $mapeo[$propiedad]='Logo en Aplicacion'
                    //si es, actualizo $_SESSION[logo]
                    if($mapeo[$propiedad]==='Logo en Aplicacion'){
                        if($valor==='on'){
                            $_SESSION['logo']=$this->Parametro_general('Logo',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
                        }else{
                            $_SESSION['logo']='logo-Qualidad.JPG';
                        }
                    }
                }
            }
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->guardarParametros_generales()<COMMIT");
        
        $db->desconectar ();
        
        return true;
    }
    
    function Actualizar_tbempresas($post){
        require_once '../general/conexion.php';
        $db = new DbC();
        $db->conectar($this->getStrBD());
                  
        $strSQL = "
                    UPDATE tbempresas
                    SET strSesion='".$post['strSesion']."',
                    direccion='".$post['strDireccion']."',
                    municipio='".$post['strMunicipio']."',
                    provincia='".$post['provincia']."',
                    CP=".$post['lngCP'].",
                    telefono=".$post['lngTelefono'].",
                    email1='".$post['strEmail1']."',
                    email2='".$post['strEmail2']."',
                    Version=".$post['version'].",
                    email1='".$post['strEmail1']."',
                    numApuntes=".$post['numApuntes'].",
                    strNombre='".$post['strNombre']."',
                    strPassword='".$post['strPassword']."',
                    lngAsesor=".$post['IdAsesor'].",
                    claseEmpresa='".$post['claseEmpresa']."',
                    fechaAlta='".fecha_to_DATETIME($post['fechaAlta'])."',
                    fechaVencimiento='".fecha_to_DATETIME($post['fechaVencimiento'])."'
                    WHERE IdEmpresa=".$_SESSION['idEmp']."
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADUsu->Actualizar_tbempresas()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        if($stmt){
            return true;
        }else{
            return false;
        }
    }
    
    function Actualizar_Logo_tbparametros_generales($doc){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        
        //1º- Busco el valor actual (con la fecha de hoy entre ValidoDesde y ValidoHasta y le pongo ValidoHasta la de ahora mismo
        $Id=$this->Parametro_general_Id('Logo', date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        $db->conectar($this->getStrBD());
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->Actualizar_Logo_tbparametros_generales() || START TRANSACTION");
        $strSQL="
                UPDATE tbparametros_generales 
                SET ValidoHasta=now()
                WHERE IdParam=$Id
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Actualizar_Logo_tbparametros_generales()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->Actualizar_Logo_tbparametros_generales()<ROLLBACK");
            return 'false';
        }

        //2º- Inserto este nuevo valor con la ValidoDesde de ahora mismo 
        $strSQL="
                SELECT IdParam FROM tbparametros_generales ORDER BY IdParam DESC LIMIT 0,1
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Actualizar_Logo_tbparametros_generales()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            $row=  mysql_fetch_array($stmt);
            $IdParamNuevo=$row['IdParam']+1;
        }else{
            $IdParamNuevo=1;
        }
        
        $strSQL="
                INSERT INTO tbparametros_generales (IdParam,nombre,valor,ValidoDesde)
                VALUES ($IdParamNuevo,'Logo','$doc',now())
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->Actualizar_Logo_tbparametros_generales()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->Actualizar_Logo_tbparametros_generales()<ROLLBACK");
            return 'false';
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaPresupuesto()<COMMIT");
        
        $db->desconectar ();

        return true;
    }
    
    function generarFacturaDePresupuesto($usuario,$post){
        //1- Se guarda la factura en tbmisfacturas y tbmisfacturaslineas
        //2- Se actualiza las lineas de tbmispresupuestoslineas

        // 1
        //lo primero que hacemos es guardar todas las lineas de factura en un array
        //buscamos todo lo que comienze por 'cantidad..'
        $lineasFactura='';
        foreach($post as $propiedad=>$valor){
            //si $propiedad = 'cantidad..' recojo el resto de datos en el array
            //(cantidad,concepto,importe,iva,cuota)
            
            //busco cantidad 
            if(substr($propiedad,0,8)==='cantidad'){
                //ahora veo si el check viene activado o no, si viene se incluye este concepto, sino no
                $nomCheck='check'.substr($propiedad,8);
                if($post[$nomCheck]==='on'){
                    //extraigo en numero de cantidad para buscar el resto de valores que terminen en ese numero 
                    //(son de la misma linea de factura)
                    $num=substr($propiedad,8);
                    //IdPresupLinea
                    $propIdPresupLinea='idPresupLinea'.$num;
                    $valorIdPresupLinea=$post[$propIdPresupLinea];
                    //numLineaPresup
                    $propNumLineaPresup='numLineaPresup'.$num;
                    $valorNumLineaPresup=$post[$propNumLineaPresup];
                    //si $valorNumLineaPresup (venimos de facturar totalmente) es NULL
                    if($valorNumLineaPresup==null){
                        $valorNumLineaPresup=$num;
                    }
                    
                    //IdArticulo
                    $propIdArticulo='IdArticulo'.$num;
                    $valorIdArticulo=$post[$propIdArticulo];
                    
                    //ahora extraigo la cuenta del articulo.
                    //Primero extraigo la cuenta general, despues la cuenta del grupo (si hay), 
                    //que sustituye a la general y por último la cuenta del articulo (si hay)
                    $cuentaContable = $this->Parametro_general('cuentaContable',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
                    $cuentaArticulo = $this->LeeArticulo($valorIdArticulo);
                    $cuentaArticulo2 = explode('-',$cuentaArticulo[0]['CuentaContable']);
                    $cuentaArticulo2 = $cuentaArticulo2[0];
                    $cuentaGrupoArticulo = $this->LeeGrupo($cuentaArticulo[0]['IdGrupo']);
                    if(isset($cuentaGrupoArticulo[0]['Cuenta']) && $cuentaGrupoArticulo[0]['Cuenta'] !== ''){
                        $cuentaContable = $cuentaGrupoArticulo[0]['Cuenta'];
                    }
                    if(isset($cuentaArticulo[0]['CuentaContable']) && $cuentaArticulo2 !== ''){
                        $cuentaContable = $cuentaArticulo2;
                    }
                    
                    //concepto
                    $propConcepto='concepto'.$num;
                    $valorConcepto=$post[$propConcepto];
                    //cambio las comillas simples si hay por dobles, me da error sino al leer este dato el formulario html
                    $valorConcepto = str_replace("'", "\"", $valorConcepto);
                    //importe
                    $propImporte='importe'.$num;
                    $valorImporte=$post[$propImporte];
                    //importe unidad (precio)
                    $propPrecio='precio'.$num;
                    $valorPrecio=$post[$propPrecio];

                    //iva
                    $propIVA='iva'.$num;
                    $valorIVA=$post[$propIVA];

                    //cuota
                    $propCuota='cuota'.$num;
                    $valorCuota=$post[$propCuota];

                    //si vienen vacias las vble $valor y $valorImporte, les asigno 0
                    if($valor===''){
                        $valor=0;
                    }
                    if($valorPrecio===''){
                        $valorPrecio=0;
                    }

                    //ahora guardo el valor en el array
                    $lineasFactura[]=array(
                        "idPresupLinea"=>$valorIdPresupLinea,
                        "numLineaPresup"=>$valorNumLineaPresup,
                        "cantidad"=>  desFormateaNumeroContabilidad($valor), //sale del foreach inicial
                        "IdArticulo"=>$valorIdArticulo,
                        "cuentaArticulo"=>$cuentaContable,
                        "concepto"=>$valorConcepto,
                        "importeUnidad"=>desFormateaNumeroContabilidad($valorPrecio),
                        "importe"=>desFormateaNumeroContabilidad($valorImporte),
                        "IVA"=>desFormateaNumeroContabilidad($valorIVA),
                        "cuota"=>desFormateaNumeroContabilidad($valorCuota),
                        "total"=>desFormateaNumeroContabilidad($valorImporte)+desFormateaNumeroContabilidad($valorCuota),
                    );
                }
            }
        }
        
        //hay que guardar los datos en las tablas 'tbfacturas' y 'tbmisfacturaslineas'
        
        //guardo el numero de proyecto con este formato '20140001' donde las 4 primeras cifras son el año y las 4 ultimas la numeracion
        $numeroNuevaFactura=$this->leeNuevoNumeroFactura();
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarFacturaDePresupuesto() || START TRANSACTION");
        
        //obtengo el idFactura
        $strSQL = "SELECT idFactura FROM tbmisfacturas ORDER BY idFactura DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarFacturaDePresupuesto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $idFactura=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idFactura=$row['idFactura']+1;
            }else{
                $idFactura=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->generarFacturaDePresupuesto()<ROLLBACK");
            return 'false';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarFacturaDePresupuesto()|| idFactura : ".$idFactura);

        //ContactoHidden viene de esta forma CL.430000005 o CO.6
        if(is_numeric($post['ContactoHidden'])){
            $contactoHidden=$post['ContactoHidden'];
        }else{
            $contactoHidden=explode('.',$post['ContactoHidden']);
            $contactoHidden=$contactoHidden[1];
        }
        
        if($post['validez']===''){
            $post['validez']=0;
        }
        
        //inserto en la tabla 'tbmisfacturas'
        $strSQL = "
                    INSERT INTO tbmisfacturas (IdFactura,NumFactura,IdPresupuesto,Cliente,FechaFactura,
                                FechaVtoFactura,FormaPago,Estado,Retencion,lngIdUsuario,Borrado,Situacion) 
                    VALUES ($idFactura,'".$numeroNuevaFactura."',".$post['IdPresupuesto'].",'".$contactoHidden."',NOW(),ADDDATE(NOW(),".$post['validez']."),
                            '".$post['FormaPagoHabitual']."','Emitida',".$post['irpf'].",$usuario,1,'En plazo')
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->generarFacturaDePresupuesto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->generarFacturaDePresupuesto()<ROLLBACK");
            return 'false';
        }
        
        //ahora vamos a insertar las lineas del presupuesto (una insercion por cada linea) en la tabla 'tbmispresupuestoslineas'
        //y también ponemos todas las lineas de este presupuesto (tbmispresupuestoslineas) el campo 'Facturada' en T = Total
        //recorro el array $lineasPresupuesto
        for($i=0;$i<count($lineasFactura);$i++){
            //saco el numero linea nuevo
            $numLinea=$this->numeroFacturaLineaNueva($db);
            $numLineaFactura=$i+1;
            
            $IdArticulo = 'null';
            if(isset($lineasFactura[$i]['IdArticulo']) && $lineasFactura[$i]['IdArticulo'] !== ''){
                $IdArticulo = $lineasFactura[$i]['IdArticulo'];
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->generarFacturaDePresupuesto()|| IdArticulo : ".$IdArticulo);
                
            //inserto en la tabla 'tbmisfacturaslineas'
            $strSQL = "
                        INSERT INTO tbmisfacturaslineas (IdFacturaLineas,IdFactura,NumLineaFactura,NumLineaPresup,IdPresupLineas,IdArticulo,cuentaArticulo,DescripcionProducto,
                                    TipoIVA,CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,ImportePEN,
                                    CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN,GenFacPed,Facturada) 
                        VALUES ($numLinea,$idFactura,$numLineaFactura,".$lineasFactura[$i]['numLineaPresup'].",".$lineasFactura[$i]['idPresupLinea'].",".$IdArticulo.",'".$lineasFactura[$i]['cuentaArticulo']."','".$lineasFactura[$i]['concepto']."',".$lineasFactura[$i]['IVA'].",".$lineasFactura[$i]['cantidad'].",
                                0,0,".$lineasFactura[$i]['importeUnidad'].",".$lineasFactura[$i]['importe'].",0,0,".$lineasFactura[$i]['cuota'].",0,0,'NO','NF')
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->generarFacturaDePresupuesto()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->generarFacturaDePresupuesto()<ROLLBACK");
                return 'false';
            }
            
            // 2
            //actualizo las lineas de tbmispresupuestoslineas (Facturada=T, GenPadPed=SI,
            //y los campos CantidadFAC, ImporteFAC, CuotaIvaFAC se les suma la cantidad, importe y couaIva
            //y a su vez se resta de los campos CantidadPEN, ImportePEN, CuotaIvaPEN)
            $strSQL = "
                        SELECT CantidadFAC,CantidadPEN,ImporteFAC,ImportePEN,CuotaIvaFAC,CuotaIvaPEN
                        FROM tbmispresupuestoslineas
                        WHERE IdPresupLineas=".$lineasFactura[$i]['idPresupLinea']."
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->listadoContactos()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_assoc($stmt);
                //sumo los FAC
                $CantidadFAC=$row['CantidadFAC']+$lineasFactura[$i]['cantidad'];
                $ImporteFAC=$row['ImporteFAC']+$lineasFactura[$i]['importe'];
                $CuotaIvaFAC=$row['CuotaIvaFAC']+$lineasFactura[$i]['cuota'];
                //sumo los PEN (si sale negativo pongo 0)
                $CantidadPEN=$row['CantidadPEN']-$lineasFactura[$i]['cantidad'];
                if($CantidadPEN<0){
                    $CantidadPEN=0;
                }
                $ImportePEN=$row['ImportePEN']-$lineasFactura[$i]['importe'];
                if($ImportePEN<0){
                    $ImportePEN=0;
                }
                $CuotaIvaPEN=$row['CuotaIvaPEN']-$lineasFactura[$i]['cuota'];
                if($CuotaIvaPEN<0){
                    $CuotaIvaPEN=0;
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->generarFacturaDePresupuesto()<ROLLBACK");
                return 'false';
            }
            
            //actualizo los datos de la tabla 'tbmispresupuestoslineas'
            $strSQL = "
                        UPDATE tbmispresupuestoslineas
                        SET Facturada='T',GenFacPed='SI',
                        CantidadFAC=$CantidadFAC,
                        ImporteFAC=$ImporteFAC,
                        CuotaIvaFAC=$CuotaIvaFAC,
                        CantidadPEN=$CantidadPEN,
                        ImportePEN=$ImportePEN,
                        CuotaIvaPEN=$CuotaIvaPEN
                        WHERE IdPresupLineas=".$lineasFactura[$i]['idPresupLinea']."
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->listadoContactos()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->generarFacturaDePresupuesto()<ROLLBACK");
                return 'false';
            }
        }

        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarFacturaDePresupuesto()<COMMIT");
        
        $db->desconectar ();
        
        //todo correcto, devuelvo el IdFactura
        return $idFactura;
    }
    
    function generarPedidoDePresupuesto($usuario,$post){
        //1- Se guarda el pedido en tbmispedidos y tbmispedidoslineas
        //2- Se actualiza las lineas de tbmispresupuestoslineas

        // 1
        //lo primero que hacemos es guardar todas las lineas del pedido en un array
        //buscamos todo lo que comienze por 'cantidad..'
        $lineasFactura='';
        foreach($post as $propiedad=>$valor){
            //si $propiedad = 'cantidad..' recojo el resto de datos en el array
            //(cantidad,concepto,importe,iva,cuota)
            
            //busco cantidad 
            if(substr($propiedad,0,8)==='cantidad'){
                //ahora veo si el check viene activado o no, si viene se incluye este concepto, sino no
                $nomCheck='check'.substr($propiedad,8);
                if($post[$nomCheck]==='on'){
                    //extraigo en numero de cantidad para buscar el resto de valores que terminen en ese numero 
                    //(son de la misma linea de factura)
                    $num=substr($propiedad,8);
                    //IdPresupLinea
                    $propIdPresupLinea='idPresupLinea'.$num;
                    $valorIdPresupLinea=$post[$propIdPresupLinea];
                    //numLineaPresup
                    $propNumLineaPresup='numLineaPresup'.$num;
                    $valorNumLineaPresup=$post[$propNumLineaPresup];
                    //si $valorNumLineaPresup (venimos de pedido total) es NULL
                    if($valorNumLineaPresup==null){
                        $valorNumLineaPresup=$num;
                    }
                    
                    //IdArticulo
                    $propIdArticulo='IdArticulo'.$num;
                    $valorIdArticulo=$post[$propIdArticulo];
                    
                    //concepto
                    $propConcepto='concepto'.$num;
                    $valorConcepto=$post[$propConcepto];
                    //cambio las comillas simples si hay por dobles, me da error sino al leer este dato el formulario html
                    $valorConcepto = str_replace("'", "\"", $valorConcepto);
                    //importe
                    $propImporte='importe'.$num;
                    $valorImporte=$post[$propImporte];
                    //importe unidad (precio)
                    $propPrecio='precio'.$num;
                    $valorPrecio=$post[$propPrecio];

                    //iva
                    $propIVA='iva'.$num;
                    $valorIVA=$post[$propIVA];

                    //cuota
                    $propCuota='cuota'.$num;
                    $valorCuota=$post[$propCuota];

                    //si vienen vacias las vble $valor y $valorImporte, les asigno 0
                    if($valor===''){
                        $valor=0;
                    }
                    if($valorPrecio===''){
                        $valorPrecio=0;
                    }

                    //ahora guardo el valor en el array
                    $lineasFactura[]=array(
                        "idPresupLinea"=>$valorIdPresupLinea,
                        "numLineaPresup"=>$valorNumLineaPresup,
                        "cantidad"=>  desFormateaNumeroContabilidad($valor), //sale del foreach inicial
                        "IdArticulo"=>$valorIdArticulo,
                        "concepto"=>$valorConcepto,
                        "importeUnidad"=>desFormateaNumeroContabilidad($valorPrecio),
                        "importe"=>desFormateaNumeroContabilidad($valorImporte),
                        "IVA"=>desFormateaNumeroContabilidad($valorIVA),
                        "cuota"=>desFormateaNumeroContabilidad($valorCuota),
                        "total"=>desFormateaNumeroContabilidad($valorImporte)+desFormateaNumeroContabilidad($valorCuota),
                    );
                }
            }
        }
        
        //hay que guardar los datos en las tablas 'tbmispedidos' y 'tbmispedidoslineas'
        
        //guardo el numero de proyecto con este formato '20140001' donde las 4 primeras cifras son el año y las 4 ultimas la numeracion
        $numeroNuevoPedido=$this->leeNuevoNumeroPedido();
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarPedidoDePresupuesto() || START TRANSACTION");
        
        //obtengo el idPedido
        $strSQL = "SELECT idPedido FROM tbmispedidos ORDER BY idPedido DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarPedidoDePresupuesto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $idFactura=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idPedido=$row['idPedido']+1;
            }else{
                $idPedido=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->generarPedidoDePresupuesto()<ROLLBACK");
            return 'false';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarPedidoDePresupuesto()|| idFactura : ".$idFactura);

        //ContactoHidden viene de esta forma CL.430000005 o CO.6
        if(is_numeric($post['ContactoHidden'])){
            $contactoHidden=$post['ContactoHidden'];
        }else{
            $contactoHidden=explode('.',$post['ContactoHidden']);
            $contactoHidden=$contactoHidden[1];
        }
        
        //inserto en la tabla 'tbmispedidos'
        $strSQL = "
                    INSERT INTO tbmispedidos (IdPedido,NumPedido,IdPresupuesto,Cliente,FechaPedido,
                                FechaVtoPedido,FormaPago,FechaFinalizacion,Estado,Retencion,lngIdUsuario,Borrado,TipoFactura,
                                DiaPeriodica,FrecuenciaPeriodica,FechaProximaFacturaPeriodica,CC_Trans) 
                    VALUES ($idFactura,'".$numeroNuevoPedido."',".$post['IdPresupuesto'].",'".$contactoHidden."','".fecha_to_DATETIME($post['FechaPedido'])."','".fecha_to_DATETIME($post['FechaVtoPedido'])."',
                            '".$post['FormaPagoHabitual']."','".$post['FechaFinalizacion']."','Aceptado',".$post['irpf'].",$usuario,1,'".$post['TipoFactura']."',
                            '".$post['DiaPeriodica']."','".$post['FrecuenciaPeriodica']."','".fecha_to_DATETIME($post['FechaProximaFacturaPeriodica'])."','".$post['CC_Recibos']."')
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->generarPedidoDePresupuesto()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->generarPedidoDePresupuesto()<ROLLBACK");
            return 'false';
        }
        
        //ahora vamos a insertar las lineas del pedido (una insercion por cada linea) en la tabla 'tbmispedidoslineas'
        //y también ponemos todas las lineas de este presupuesto (tbmispresupuestoslineas) el campo 'Facturada' en T = Total
        //recorro el array $lineasPresupuesto
        for($i=0;$i<count($lineasFactura);$i++){
            //saco el numero linea nuevo
            $numLinea=$this->numeroPedidoLineaNueva($db);
            $numLineaPedido=$i+1;
            
            $IdArticulo = 'null';
            if(isset($lineasFactura[$i]['IdArticulo']) && $lineasFactura[$i]['IdArticulo'] !== ''){
                $IdArticulo = $lineasFactura[$i]['IdArticulo'];
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->generarPedidoDePresupuesto()|| IdArticulo : ".$IdArticulo);
                
            //inserto en la tabla 'tbmispedidoslineas'
            $strSQL = "
                        INSERT INTO tbmispedidoslineas (IdPedidoLineas,IdPedido,NumLineaPedido,NumLineaPresup,IdPresupLineas,IdArticulo,DescripcionProducto,
                                    TipoIVA,CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,ImportePEN,
                                    CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN,GenFacPed,Facturada) 
                        VALUES ($numLinea,$idPedido,$numLineaPedido,".$lineasFactura[$i]['numLineaPresup'].",".$lineasFactura[$i]['idPresupLinea'].",".$IdArticulo.",'".$lineasFactura[$i]['concepto']."',".$lineasFactura[$i]['IVA'].",".$lineasFactura[$i]['cantidad'].",
                                0,".$lineasFactura[$i]['cantidad'].",".$lineasFactura[$i]['importeUnidad'].",".$lineasFactura[$i]['importe'].",0,".$lineasFactura[$i]['importe'].",".$lineasFactura[$i]['cuota'].",0,".$lineasFactura[$i]['cuota'].",'NO','NF')
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->generarPedidoDePresupuesto()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->generarPedidoDePresupuesto()<ROLLBACK");
                return 'false';
            }
            
            // 2
            //actualizo las lineas de tbmispresupuestoslineas (Pedido=T, GenPedPre=SI,
            //y los campos CantidadFAC, ImporteFAC, CuotaIvaFAC se les suma la cantidad, importe y coutaIva
            //y a su vez se resta de los campos CantidadPEN, ImportePEN, CuotaIvaPEN)
            $strSQL = "
                        SELECT CantidadFAC,CantidadPEN,ImporteFAC,ImportePEN,CuotaIvaFAC,CuotaIvaPEN
                        FROM tbmispresupuestoslineas
                        WHERE IdPresupLineas=".$lineasFactura[$i]['idPresupLinea']."
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->generarPedidoDePresupuesto()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_assoc($stmt);
                //sumo los FAC
                $CantidadFAC=$row['CantidadFAC']+$lineasFactura[$i]['cantidad'];
                $ImporteFAC=$row['ImporteFAC']+$lineasFactura[$i]['importe'];
                $CuotaIvaFAC=$row['CuotaIvaFAC']+$lineasFactura[$i]['cuota'];
                //sumo los PEN (si sale negativo pongo 0)
                $CantidadPEN=$row['CantidadPEN']-$lineasFactura[$i]['cantidad'];
                if($CantidadPEN<0){
                    $CantidadPEN=0;
                }
                $ImportePEN=$row['ImportePEN']-$lineasFactura[$i]['importe'];
                if($ImportePEN<0){
                    $ImportePEN=0;
                }
                $CuotaIvaPEN=$row['CuotaIvaPEN']-$lineasFactura[$i]['cuota'];
                if($CuotaIvaPEN<0){
                    $CuotaIvaPEN=0;
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->generarPedidoDePresupuesto()<ROLLBACK");
                return 'false';
            }
            
            //actualizo los datos de la tabla 'tbmispresupuestoslineas'
            $strSQL = "
                        UPDATE tbmispresupuestoslineas
                        SET Pedido='T',GenPedPre='SI',
                        CantidadFAC=$CantidadFAC,
                        ImporteFAC=$ImporteFAC,
                        CuotaIvaFAC=$CuotaIvaFAC,
                        CantidadPEN=$CantidadPEN,
                        ImportePEN=$ImportePEN,
                        CuotaIvaPEN=$CuotaIvaPEN
                        WHERE IdPresupLineas=".$lineasFactura[$i]['idPresupLinea']."
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->generarPedidoDePresupuesto()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->generarPedidoDePresupuesto()<ROLLBACK");
                return 'false';
            }
        }

        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarPedidoDePresupuesto()<COMMIT");
        
        $db->desconectar ();
        
        //todo correcto, devuelvo el IdFactura
        return $idPedido;
    }
    
    function leeNuevoNumeroFactura(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL = "
                    SELECT NumFactura
                    FROM tbmisfacturas
                    WHERE Borrado=1
                    ORDER BY NumFactura DESC
                    LIMIT 0,1
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->leeNuevoNumeroFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        $numero=1;
        if($stmt){
            $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
            
            $row=  mysql_fetch_array($stmt);
            //si $row es false es que no hay ningun registro guardado por lo que le damos numero nuevo
            //if($row==false){
                //$numero=date('Y').'0001';
            //}else{
            
            $numero = $this->Contador_NuevoNumero('NumFactura','tbmisfacturas',$tipoContador);
            $numero = numeroFormateado($numero, $tipoContador);
            
        }
        return $numero;
    }

    function leeNuevoNumeroPedido(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL = "
                    SELECT NumPedido
                    FROM tbmispedidos
                    WHERE Borrado=1
                    ORDER BY NumPedido DESC
                    LIMIT 0,1
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->leeNuevoNumeroPedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar();
        
        $numero=1;
        if($stmt){
            $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));

            $row=  mysql_fetch_array($stmt);
            //si $row es false es que no hay ningun registro guardado por lo que le damos numero nuevo
            //if($row==false){
                //$numero=date('Y').'0001';
            //}else{
                //como el numero es de la forma '20140005' donde las 4 primeras cifras son el ejercicio
                //y las 4 ultimas el numero
            
            $numero = $this->Contador_NuevoNumero('NumPedido','tbmispedidos',$tipoContador);
            $numero = numeroFormateado($numero, $tipoContador);
            
            
            //$numero = numeroDesformateado($row['NumPedido'],$tipoContador)+1;
//                switch ($tipoContador) {
//                    case 'simple':
//                        $numPresupuesto=$row['NumPedido']+1;
//                        break;
//                    case 'compuesto1':
//                        $num=substr($row['NumPedido'],4,4);
//                        $num++;
//                        while(substr($num,0,1)==='0'){
//                            $num=substr($num,1);
//                        }
//                        $ejercicio=substr($row['NumPedido'],0,4);
//                        $numPresupuesto=$num.'/'.$ejercicio;
//                        break;
//                    case 'compuesto2':
//                        $num=substr($row['NumPedido'],4,4);
//                        $num++;
//                        while(substr($num,0,1)==='0'){
//                            $num=substr($num,1);
//                        }
//                        $ejercicio=substr($row['NumPedido'],0,4);
//                        $numPresupuesto=$ejercicio.'/'.$num;
//                        break;
//                    default://ningun contador
//                        $numPresupuesto=$row['NumPedido'];
//                        break;
//                }
                        
                //$numero=$numPresupuesto;
                
            //}
        }
        return $numero;
    }

    private function numeroFacturaLineaNueva($db){
        //averiguo el numero de linea de factura de la tabla 'tbmisfacturaslineas' mas alto que haya
        $strSQL = 'SELECT IdFacturaLineas FROM tbmisfacturaslineas ORDER BY IdFacturaLineas DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->numeroFacturaLineaNueva()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $lineaFactura=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $lineaFactura=$row['IdFacturaLineas']+1;
            }else{
                $lineaFactura=1;
            }
        }else{
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->numeroFacturaLineaNueva()<FALSE");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->numeroFacturaLineaNueva()|| Nº Linea : ".$lineaFactura);
        return $lineaFactura;
    }
    
    private function numeroPedidoLineaNueva($db){
        //averiguo el numero de linea del pedido de la tabla 'tbmispedidoslineas' mas alto que haya
        $strSQL = 'SELECT IdPedidoLineas FROM tbmispedidoslineas ORDER BY IdPedidoLineas DESC LIMIT 0,1';
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->numeroPedidoLineaNueva()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $lineaPedido=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $lineaPedido=$row['IdPedidoLineas']+1;
            }else{
                $lineaPedido=1;
            }
        }else{
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->numeroPedidoLineaNueva()<FALSE");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->numeroPedidoLineaNueva()|| Nº Linea : ".$lineaPedido);
        return $lineaPedido;
    }
    
    //SIN DESARROLLAR 13/3/2014
//    function ListadoPresupuestosPendientesFacturar($strNomContacto,$estado){
//        
//    }
    
    function listadoFacturasEmitidas($IdPresupuesto){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL = "
                  SELECT NumFactura FROM tbmisfacturas
                  WHERE IdPresupuesto=$IdPresupuesto
                  AND Borrado=1    
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listadoFacturasEmitidas()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }

            //primero formateo el numero de presupuesto que se presenta en pantalla del formulario
            //el numero esta guardado en la BBDD como '20140005' donde las 4 primeras cifras son el año
            //y las 4 últimas son el número en si
            //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
            $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));

            $resulFinal='';
            if(is_array($resultado)){
                for($ii=0;$ii<count($resultado);$ii++){
                    //ahora segun el tipo de contador calculo en nuevo numero
                    $numPresupuesto = numeroDesformateado($resultado[$ii]['NumFactura'],$tipoContador);
                    //var_dump($numPresupuesto);die;
//                    switch ($tipoContador) {
//                        case 'simple':
//                            $numPresupuesto=$resultado[$ii]['NumFactura'];
//                            break;
//                        case 'compuesto1':
//                            $num=substr($resultado[$ii]['NumFactura'],4,4);
//                            while(substr($num,0,1)==='0'){
//                                $num=substr($num,1);
//                            }
//                            $ejercicio=substr($resultado[$ii]['NumFactura'],0,4);
//                            $numPresupuesto=$num.'/'.$ejercicio;
//                            break;
//                        case 'compuesto2':
//                            $num=substr($resultado[$ii]['NumFactura'],4,4);
//                            while(substr($num,0,1)==='0'){
//                                $num=substr($num,1);
//                            }
//                            $ejercicio=substr($resultado[$ii]['NumFactura'],0,4);
//                            $numPresupuesto=$ejercicio.'/'.$num;
//                            break;
//                        default://ningun contador
//                            $numPresupuesto=$resultado[$ii]['NumFactura'];
//                            break;
//                    }
                    $resulFinal[]=$numPresupuesto;
                }
            }
        }else{
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->numeroFacturaLineaNueva()<FALSE");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->numeroFacturaLineaNueva()|| Nº Linea : ".$lineaFactura);
        return $resulFinal;
    }
    
    function listadoPedidosEmitidos($IdPresupuesto){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL = "
                  SELECT NumPedido FROM tbmispedidos
                  WHERE IdPresupuesto=$IdPresupuesto
                  AND Borrado=1    
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listadoPedidosEmitidos()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }

            //primero formateo el numero de pedido que se presenta en pantalla del formulario
            //el numero esta guardado en la BBDD como '20140005' donde las 4 primeras cifras son el año
            //y las 4 últimas son el número en si
            //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
            $tipoContador=$this->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));

            $resulFinal='';
            if(is_array($resultado)){
                for($ii=0;$ii<count($resultado);$ii++){
                    //ahora segun el tipo de contador calculo en nuevo numero
                    $numPresupuesto = numeroFormateado($resultado[$ii]['NumPedido'],$tipoContador);
                    
//                    $num=substr($resultado[$ii]['NumPedido'],4,4);
//                    while(substr($num,0,1)==='0'){
//                        $num=substr($num,1);
//                    }
//                    $ejercicio=substr($resultado[$ii]['NumPedido'],0,4);
//                    switch ($tipoContador) {
//                        case 'simple':
//                            $numPresupuesto=$resultado[$ii]['NumPedido'];
//                            break;
//                        case 'compuesto1':
//                            $numPresupuesto=$num.'/'.$ejercicio;
//                            break;
//                        case 'compuesto2':
//                            $numPresupuesto=$ejercicio.'/'.$num;
//                            break;
//                        default://ningun contador
//                            $numPresupuesto=$resultado[$ii]['NumPedido'];
//                            break;
//                    }
                    $resulFinal[]=$numPresupuesto;
                }
            }
        }else{
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->listadoPedidosEmitidos()<FALSE");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listadoPedidosEmitidos()|| Nº Linea : ".$lineaFactura);
        return $resulFinal;
    }
    
    function comprobarSiEstaInsertadoAsiento($IdFactura){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL = "
                  SELECT Asiento FROM tbmisfacturas
                  WHERE IdFactura=$IdFactura
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->comprobarSiEstaInsertadoAsiento()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            $num=  mysql_num_rows($stmt);
            if($num>0){
            $row=  mysql_fetch_array($stmt);
            $asiento=$row['Asiento'];
                //devolvemos true
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->comprobarSiEstaInsertadoAsiento()<TRUE");
                return $asiento;
            }else{
                //devolvemos false
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->comprobarSiEstaInsertadoAsiento()<FALSE");
                return false;
            }
        }else{
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->comprobarSiEstaInsertadoAsiento()<FALSE");
            return false;
        }
    }
    
    function actualizarAsientoEnFactura($IdFactura,$asiento){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL = "
                  UPDATE tbmisfacturas
                  SET Asiento=$asiento,
                  Estado='Contabilizada'    
                  WHERE IdFactura=$IdFactura
                  ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->actualizarAsientoEnFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            //devolvemos true
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->actualizarAsientoEnFactura()<TRUE");
            return true;
        }else{
            //devolvemos false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->actualizarAsientoEnFactura()<FALSE");
            return false;
        }
    }
    
//    function listadoMovimientosContabil($post){
//        require_once '../general/'.$_SESSION['mapeo'];
//        $db = new Db();
//        $db->conectar($this->getStrBD());
//
//        $strSQL = "
//                    SELECT M.*,F.asiento AS asientoF,F.NumFactura
//                    FROM tbmovimientos M LEFT JOIN tbmisfacturas F ON (M.asiento=F.asiento)
//                    WHERE M.Borrado=1
//                    AND M.Exportado IS NULL
//                  ";
//        
//        //filtros
//        if($post['datFechaInicio']<>''){
//            $strSQL = $strSQL."AND M.fechaApunte>='".fecha_to_DATETIME($post['datFechaInicio']) ."'";
//        }
//        if($post['datFechaFin']<>''){
//            $strSQL = $strSQL."AND M.fechaApunte<='".fecha_to_DATETIME_F($post['datFechaFin'])."'";
//        }
//        
//        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
//                " clsCADContabilidad->listadoMovimientosContabil()|| SQL : ".$strSQL);
//        
//        $stmt = $db->ejecutar ( $strSQL );
//        
//        $resultado='';
//        if($stmt){
//            while($row=  mysql_fetch_array($stmt)){
//                $reg='';
//                foreach($row as $propiedad=>$valor){
//                    if(!is_numeric($propiedad)){
//                        $reg[$propiedad]=$valor;
//                    }
//                }
//                $resultado[]=$reg;
//            }
//            return $resultado;
//        }else{
//            return '';
//        }
//    }
    
    function listadoMovimientosContabil2($post){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL = "
                    SELECT DISTINCT M.asiento
                    FROM tbmovimientos M LEFT JOIN tbmisfacturas F ON (M.asiento=F.asiento)
                    WHERE M.Borrado=1
                    AND M.Exportado IS NULL
                  ";
        
        //filtros
        if($post['datFechaInicio']<>''){
            $strSQL = $strSQL."AND M.fechaApunte>='".fecha_to_DATETIME($post['datFechaInicio']) ."'";
        }
        if($post['datFechaFin']<>''){
            $strSQL = $strSQL."AND M.fechaApunte<='".fecha_to_DATETIME_F($post['datFechaFin'])."'";
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listadoMovimientosContabil()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            return '';
        }
    }
    
    function listadoMovimientosIvaContabil($post){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

//        $strSQL = "
//                    SELECT DISTINCT M.asiento,I.IdIvaOrden,I.BaseImponible,I.Iva,I.CuotaIVA,F.NumFactura
//                    FROM tbmovimientos M LEFT JOIN tbmisfacturas F ON (M.asiento=F.asiento), tbmovimientos_iva I
//                    WHERE M.Borrado=1
//                    AND M.Exportado IS NULL
//                    AND I.IdAsiento=M.asiento
//                  ";
        
        $strSQL = "
                    SELECT DISTINCT M.asiento,I.IdIvaOrden,I.BaseImponible,I.Iva,I.CuotaIVA,F.NumFactura
                    FROM tbmovimientos M LEFT JOIN tbmisfacturas F ON (M.asiento=F.asiento), tbmovimientos_iva I
                    WHERE M.Borrado=1
                    AND M.Exportado IS NULL
                    AND I.IdAsiento=M.asiento
                    AND I.Borrado=1
                  ";
        
        //filtros
        if($post['datFechaInicio']<>''){
            $strSQL = $strSQL."AND M.fechaApunte>='".fecha_to_DATETIME($post['datFechaInicio']) ."'";
        }
        if($post['datFechaFin']<>''){
            $strSQL = $strSQL."AND M.fechaApunte<='".fecha_to_DATETIME_F($post['datFechaFin'])."'";
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listadoMovimientosIvaContabil()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            return '';
        }
    }
    
    function listadoMovimientosIvaContabil2($post){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL = "
                    SELECT DISTINCT M.asiento
                    FROM tbmovimientos M LEFT JOIN tbmisfacturas F ON (M.asiento=F.asiento), tbmovimientos_iva I
                    WHERE M.Borrado=1
                    AND M.Exportado IS NULL
                    AND I.IdAsiento=M.asiento
                    AND I.Borrado=1
                  ";
        
        //filtros
        if($post['datFechaInicio']<>''){
            $strSQL = $strSQL."AND M.fechaApunte>='".fecha_to_DATETIME($post['datFechaInicio']) ."'";
        }
        if($post['datFechaFin']<>''){
            $strSQL = $strSQL."AND M.fechaApunte<='".fecha_to_DATETIME_F($post['datFechaFin'])."'";
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listadoMovimientosIvaContabil()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        $resultado='';
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            return '';
        }
    }
    
    function NuevoNumeroProcesoContabil(){
        require_once '../MovimientosImpExp/msaccess.class.php';
        $db = new msaccess();
        
        if(!$db->conectar()){
            return false;
        }

        //consulto el datode Proceso en la tabla Iniciador
        $rs = $db->consulta( "SELECT Proceso FROM Iniciador" );
        
        if(!$rs){
            $db->desconectar();
            return false;
        }

        //introduzco los datos de la consulta en un array
        $listado='';
        while(odbc_fetch_row($rs)){
            $numero = odbc_result($rs,'Proceso');
        }
        
        //aumentamos el proceso una unidad
        $numero++;
        
        //actualizamos este dato en la tabla 'Iniciador'
        $rs = $db->consulta( "UPDATE Iniciador SET Proceso =" . $numero );
        $db->desconectar();
        
        if(!$rs){
            return false;
        }
        
        return $numero;
    }
    
    function BorrarMovimientosContabil(){
        require_once '../MovimientosImpExp/msaccess.class.php';
        $db = new msaccess();
        
        if(!$db->conectar()){
            return false;
        }

        //borro la tabla
        $rs = $db->consulta( " DELETE FROM movimientos" );
        $db->desconectar();
        
        if(!$rs){
            return false;
        }

        return true;
    }
    
    function BorrarFacturasContabil(){
        require_once '../MovimientosImpExp/msaccess.class.php';
        $db = new msaccess();
        
        if(!$db->conectar()){
            return false;
        }

        //borro los datos de la tabla
        $rs = $db->consulta( " DELETE FROM movimientosFacturas" );
        $db->desconectar();
        
        if(!$rs){
            return false;
        }

        return true;
    }
    
    function BorrarMovimientosIvasContabil(){
        require_once '../MovimientosImpExp/msaccess.class.php';
        $db = new msaccess();
        
        if(!$db->conectar()){
            return false;
        }

        //borro los datos de la tabla
        $rs = $db->consulta( " DELETE FROM movimientosIva" );
        $db->desconectar();
        
        if(!$rs){
            return false;
        }

        return true;
    }
    
    function ActualizarMovimientosContabil($listadoMovimientos){
        require_once '../MovimientosImpExp/msaccess.class.php';
        $db = new msaccess();
        
        if(!$db->conectar()){
            return false;
        }

        //borro la tabla
        $rs = $db->consulta( " DELETE FROM movimientos" );
        
        if(!$rs){
            $db->desconectar();
            return false;
        }

        $arrayControlInsercionesMov='';
        //hago la inserción de los datos de $listadoMovimientos
        if(is_array($listadoMovimientos)){
            foreach($listadoMovimientos as $movimiento){
                //preparo los datos
                $StatusTraspasadoConta=1;
                $Proceso=10064;
                $Aplicacion='CON';
                $CodigoAsesor='000';
                $CodigoEmpresa=92;
                $Asiento=(int)$movimiento['asiento'];
                $Orden=(int)$movimiento['orden'];
                $Fecha=substr($movimiento['fechaApunte'],8,2).'/'.substr($movimiento['fechaApunte'],5,2).'/'.substr($movimiento['fechaApunte'],0,4);
                $StatusRecalculoAsiento=-1;
                $Periodo=(int)substr($movimiento['fechaApunte'],5,2);
                while(substr($Periodo,0,1)==='0'){
                    $Periodo=(int)substr($Periodo,1);
                }
                $CargoAbono=$movimiento['DoH'];
                $CodigoCuenta=$movimiento['idCuenta'];
                $ContrapartidaInfo='';
                $numFactura=substr($movimiento['NumFactura'],4,4);
                while(substr($numFactura,0,1)==='0'){
                    $numFactura=substr($numFactura,1);
                }
                $Documento=$numFactura;
                $CodigoConcepto=0;
                $Comentario=substr($movimiento['concepto'],0,35);
                $Importe=(float)($movimiento['cantidad']);
                // Factura=10, resto=12
                $CodigoDiario=12;
                if(isset($movimiento['NumFactura']) && $movimiento['NumFactura']<>''){
                    $CodigoDiario=10;
                }
                $CodigoCanal=0;
                $CodigoActividad='';
                $Previsiones='';
                $StatusConciliacion=0;
                $StatusSaldo=0;
                $StatusTraspaso=0;
                $CodigoUsuario=0;
                date_default_timezone_set('Europe/Madrid');
                $FechaGrabacion=date('d/m/Y');
                $TipoEntrada='99';
                $Impagado=0;
                $Vto='';//no lo he indicado en la SQL
                $CodigoProyecto='';
                $CodigoDepartamento='';
                $CodigoSeccion='';
                $CodigoDivisa='';
                $ImporteCambio=0;
                $ImporteDivisa=0;
                $FactorCambio=0;
                $CodigoConciliacion=0;
                $FechaConciliacion='';//no lo he indicado en la SQL
                $CodigoDisparoAnalitica='';
                $StatusAnalitica=0;
                $TipoMovimiento=0;
                $TipoDocumento='';
                $EnEuros_=2;
                $LibreN1=0;
                $LibreN2=0;
                $LibreA1='';
                $LibreA2='';
                $IdDelegacion='';

                //preparo la consulta SQL
                $strSQL="
                        INSERT INTO movimientos
                        (StatusTraspasadoConta,Proceso,Aplicacion,CodigoAsesor,CodigoEmpresa,Asiento,Orden,Fecha,StatusRecalculoAsiento,Periodo,CargoAbono,
                        CodigoCuenta,ContrapartidaInfo,Documento,CodigoConcepto,Comentario,Importe,CodigoDiario,CodigoCanal,CodigoActividad,Previsiones,StatusConciliacion,
                        StatusSaldo,StatusTraspaso,CodigoUsuario,FechaGrabacion,TipoEntrada,Impagado,CodigoProyecto,CodigoDepartamento,CodigoSeccion,
                        CodigoDivisa,ImporteCambio,ImporteDivisa,FactorCambio,CodigoConciliacion,CodigoDisparoAnalitica,StatusAnalitica,TipoMovimiento,
                        TipoDocumento,EnEuros_,LibreN1,LibreN2,LibreA1,LibreA2,IdDelegacion)
                        VALUES
                        ($StatusTraspasadoConta,$Proceso,'$Aplicacion','$CodigoAsesor',$CodigoEmpresa,$Asiento,$Orden,'$Fecha',$StatusRecalculoAsiento,
                        $Periodo,'$CargoAbono','$CodigoCuenta','$ContrapartidaInfo','$Documento',$CodigoConcepto,'$Comentario',$Importe,$CodigoDiario,
                        $CodigoCanal,'$CodigoActividad','$Previsiones',$StatusConciliacion,$StatusSaldo,$StatusTraspaso,$CodigoUsuario,'$FechaGrabacion',
                        '$TipoEntrada',$Impagado,'$CodigoProyecto','$CodigoDepartamento','$CodigoSeccion','$CodigoDivisa',$ImporteCambio,
                        $ImporteDivisa,$FactorCambio,$CodigoConciliacion,'$CodigoDisparoAnalitica',$StatusAnalitica,$TipoMovimiento,'$TipoDocumento',
                        $EnEuros_,$LibreN1,$LibreN2,'$LibreA1','$LibreA2','$IdDelegacion')
                        ";
                
                $rs = $db->consulta( $strSQL );

                if($rs){
                    $arrayControlInsercionesMov[]=array(
                        'IdMovimiento'=>$movimiento['IdMovimiento'],
                        'Asiento'=>$Asiento,
                        'Orden'=>$Orden,
                        'Exportado'=>'SI'
                    );
                }else{
                    $arrayControlInsercionesMov[]=array(
                        'IdMovimiento'=>$movimiento['IdMovimiento'],
                        'Asiento'=>$Asiento,
                        'Orden'=>$Orden,
                        'Exportado'=>'NO'
                    );
                }
            }
        }
        
        
        //desconecto de la BBDD Contabil.Mdb
        $db->desconectar();
        
        return $arrayControlInsercionesMov;
    }
    
    function ActualizarMovimientosFacturasContabil($listadoMovFacturas){
        require_once '../MovimientosImpExp/msaccess.class.php';
        $db = new msaccess();

        if(!$db->conectar()){
            return false;
        }

        //borro la tabla
        $rs = $db->consulta( " DELETE FROM movimientosFacturas" );
        
        if(!$rs){
            $db->desconectar();
            return false;
        }

        //hago la inserción de los datos de $listadoMovimientos
        $arrayControlInsercionesMovFacturas='';
        if(is_array($listadoMovFacturas)){
            foreach($listadoMovFacturas as $movimiento){
                if(substr($movimiento['idCuenta'],0,2)==='43'){
                    //preparo los datos
                    $StatusTraspasadoConta=1;
                    $Proceso=10064;
                    $Aplicacion='CON';
                    $CodigoAsesor='000';
                    $CodigoEmpresa=92;
                    $Asiento=(int)$movimiento['asiento'];
                    $OrdenMov=1;
                    $FacturaRegistro=(int)substr($movimiento['NumFactura'],4,4);
                    $FechaFactura=substr($movimiento['fechaApunte'],8,2).'/'.substr($movimiento['fechaApunte'],5,2).'/'.substr($movimiento['fechaApunte'],0,4);
                    $ImporteFactura=(float)($movimiento['cantidad']);
                    $RegistroCartera=$FacturaRegistro;
                    $TipoIva='E';
                    $CodigoCuenta=$movimiento['idCuenta'];
                    $CodigoRetencion=0;
                    $PorcientoRetencion=0;
                    $Retencion=0;
                    $BaseRetencion=0;
                    $Intracomunitaria=0;
                    $Fecha347=$FechaFactura;
                    $EnEuros_=2;
                    $FechaOperacion=$FechaFactura;
                    

                    //preparo la consulta SQL
                    $strSQL="
                            INSERT INTO movimientosFacturas
                            (StatusTraspasadoConta,Proceso,Aplicacion,CodigoAsesor,CodigoEmpresa,Asiento,OrdenMov,FacturaRegistro,FechaFactura,
                            ImporteFactura,RegistroCartera,TipoIva,CodigoCuenta,CodigoRetencion,[%Retencion],Retencion,BaseRetencion,Intracomunitaria,
                            Fecha347,EnEuros_,FechaOperacion)
                            VALUES
                            ($StatusTraspasadoConta,$Proceso,'$Aplicacion','$CodigoAsesor',$CodigoEmpresa,$Asiento,$OrdenMov,$FacturaRegistro,
                            '$FechaFactura',$ImporteFactura,$RegistroCartera,'$TipoIva','$CodigoCuenta',$CodigoRetencion,$PorcientoRetencion,
                            $Retencion,$BaseRetencion,$Intracomunitaria,'$Fecha347',$EnEuros_,'$FechaOperacion')
                            ";

                    $rs = $db->consulta( $strSQL );

                    if($rs){
                        $arrayControlInsercionesMovFacturas[]=array(
                            'IdMovimiento'=>$movimiento['IdMovimiento'],
                            'Asiento'=>$Asiento,
                            'Orden'=>$OrdenMov,
                            'Exportado'=>'SI'
                        );
                    }else{
                        $arrayControlInsercionesMovFacturas[]=array(
                            'IdMovimiento'=>$movimiento['IdMovimiento'],
                            'Asiento'=>$Asiento,
                            'Orden'=>$OrdenMov,
                            'Exportado'=>'NO'
                        );
                    }
                }
            }
        }
        
        //desconecto de la BBDD Contabil.Mdb
        $db->desconectar();
        
        return $arrayControlInsercionesMovFacturas;
    }
    
    function ActualizarMovimientosIvaContabil($listadoMovimientosIva){
        require_once '../MovimientosImpExp/msaccess.class.php';
        $db = new msaccess();

        if(!$db->conectar()){
            return false;
        }

        //borro la tabla
        $rs = $db->consulta( " DELETE FROM movimientosIva" );
        
        if(!$rs){
            $db->desconectar();
            return false;
        }
        
        //hago la inserción de los datos de $listadoMovimientos
        $arrayControlInsercionesMovIva='';
        if(is_array($listadoMovimientosIva)){
            foreach($listadoMovimientosIva as $movimientoIva){
                //preparo los datos
                $StatusTraspasadoConta=1;
                $Proceso=10064;
                $Aplicacion='CON';
                $CodigoAsesor='000';
                $CodigoEmpresa=92;
                $Asiento=(int)$movimientoIva['asiento'];
                $OrdenMov=(int)$movimientoIva['IdIvaOrden'];
                $OrdenIva=$OrdenMov;
                $CodigoIva=(int)$movimientoIva['Iva'];
                $BaseIva=(float)$movimientoIva['BaseImponible'];
                $BaseCorrectora=0;
                $Iva=$CodigoIva;
                $CuotaIva=(float)$movimientoIva['CuotaIVA'];
                $PorcRecargoEquivalencia=0;
                $RecargoEquivalencia=0;
                $CodigoTransaccion=1;
                $Deducible=-1;
                $Exclusion347=0;
                $Mediacion=0;
                $CodigoActividad='';
                $Prorrateo=0;
                
                //preparo la consulta SQL
                $strSQL="
                        INSERT INTO movimientosIva
                        (StatusTraspasadoConta,Proceso,Aplicacion,CodigoAsesor,CodigoEmpresa,Asiento,OrdenMov,OrdenIva,CodigoIva,BaseIva,
                        [%BaseCorrectora],[%Iva],CuotaIva,[%RecargoEquivalencia],RecargoEquivalencia,CodigoTransaccion,Deducible,Exclusion347,
                        Mediacion,CodigoActividad,Prorrateo)
                        VALUES
                        ($StatusTraspasadoConta,$Proceso,'$Aplicacion','$CodigoAsesor',$CodigoEmpresa,$Asiento,$OrdenMov,$OrdenIva,$CodigoIva,
                         $BaseIva,$BaseCorrectora,$Iva,$CuotaIva,$PorcRecargoEquivalencia,$RecargoEquivalencia,$CodigoTransaccion,$Deducible,
                         $Exclusion347,$Mediacion,'$CodigoActividad',$Prorrateo)
                        ";

                $rs = $db->consulta( $strSQL );

                if($rs){
                    $arrayControlInsercionesMovIva[]=array(
                        'Asiento'=>$Asiento,
                        'Orden'=>$OrdenMov,
                        'Exportado'=>'SI'
                    );
                }else{
                    $arrayControlInsercionesMovIva[]=array(
                        'Asiento'=>$Asiento,
                        'Orden'=>$OrdenMov,
                        'Exportado'=>'NO'
                    );
                }
            }
        }
        
        //desconecto de la BBDD Contabil.Mdb
        $db->desconectar();
        
        return $arrayControlInsercionesMovIva;
    }
    
    function arrayResultadosContabil($resultados){
        if(is_array($resultados)){
            require_once '../general/'.$_SESSION['mapeo'];
            $dbMySQL = new Db();
            $dbMySQL->conectar($this->getStrBD());
            
            foreach($resultados as $resultado){
                if($resultado['Exportado']==='SI'){
                    $strSQL = "
                                UPDATE tbmovimientos 
                                SET Exportado=now()
                                WHERE IdMovimiento=".$resultado['IdMovimiento']."
                             ";
                    $dbMySQL->ejecutar ( $strSQL );
                }
            }
            $dbMySQL->desconectar();
        }
    }
    
    function importarMovimientosContabil($name){
        require_once '../MovimientosImpExp/msaccess.class.php';
        $db = new msaccess();
        //metemos el nombre del fichero ContabilImp.mdb
        $db->setMDB($name);

        if(!$db->conectar()){
            return false;
        }
        
        
        //hago un listado de la tabla movimientos
        $rs = $db->consulta( " SELECT Asiento,Orden,Fecha,Periodo,CargoAbono,CodigoCuenta,Comentario,Importe FROM movimientos" );
        
        if(!$rs){
            $db->desconectar();
            return false;
        }
        
        //introduzco los datos de la consulta en un array
        $listado='';
        while(odbc_fetch_row($rs)){
            $listado[]=array(
                'Asiento'=>odbc_result($rs,'Asiento'),
                'Orden'=>odbc_result($rs,'Orden'),
                'Fecha'=>odbc_result($rs,'Fecha'),
                'Periodo'=>odbc_result($rs,'Periodo'),
                'CargoAbono'=>odbc_result($rs,'CargoAbono'),
                'CodigoCuenta'=>odbc_result($rs,'CodigoCuenta'),
                'Comentario'=>odbc_result($rs,'Comentario'),
                'Importe'=>odbc_result($rs,'Importe'),
            );
        }
        
        return $listado;
    }
    
    function ListarAsientosContabil($name){
        require_once '../MovimientosImpExp/msaccess.class.php';
        $db = new msaccess();
        //metemos el nombre del fichero ContabilImp.mdb
        $db->setMDB($name);

        if(!$db->conectar()){
            return false;
        }
        
        
        //hago un listado de la tabla movimientos
        $rs = $db->consulta( " SELECT DISTINCT Asiento FROM movimientos" );
        
        if(!$rs){
            $db->desconectar();
            return false;
        }
        
        //introduzco los datos de la consulta en un array
        $listado='';
        while(odbc_fetch_row($rs)){
            $listado[]=array(
                'Asiento'=>odbc_result($rs,'Asiento'),
            );
        }
        
        return $listado;
    }
    
    function importarMovimientosFacturaContabil($name){
        require_once '../MovimientosImpExp/msaccess.class.php';
        $db = new msaccess();
        //metemos el nombre del fichero ContabilImp.mdb
        $db->setMDB($name);

        if(!$db->conectar()){
            return false;
        }
        
        
        //hago un listado de la tabla movimientosFacturas
        $rs = $db->consulta( " SELECT Asiento,FacturaRegistro,FechaFactura,ImporteFactura,CodigoCuenta FROM movimientosFacturas" );
        
        if(!$rs){
            $db->desconectar();
            return false;
        }
        
        //introduzco los datos de la consulta en un array
        $listado='';
        while(odbc_fetch_row($rs)){
            $listado[]=array(
                'Asiento'=>odbc_result($rs,'Asiento'),
                'FacturaRegistro'=>odbc_result($rs,'FacturaRegistro'),
                'FechaFactura'=>odbc_result($rs,'FechaFactura'),
                'ImporteFactura'=>odbc_result($rs,'ImporteFactura'),
                'CodigoCuenta'=>odbc_result($rs,'CodigoCuenta'),
            );
        }
        
        return $listado;
    }
    
    function importarMovimientosIvaContabil($name,$asiento){
        require_once '../MovimientosImpExp/msaccess.class.php';
        $db = new msaccess();
        //metemos el nombre del fichero ContabilImp.mdb
        $db->setMDB($name);

        if(!$db->conectar()){
            return false;
        }
        
        
        //hago un listado de la tabla movimientosIva
        $rs = $db->consulta( " SELECT OrdenIva,[%Iva] AS IVA,BaseIva,CuotaIva FROM movimientosIva WHERE Asiento=".$asiento );
        
        if(!$rs){
            $db->desconectar();
            return false;
        }
        
        //introduzco los datos de la consulta en un array
        $listado='';
        while(odbc_fetch_row($rs)){
            $listado[]=array(
                'OrdenIva'=>odbc_result($rs,'OrdenIva'),
                'CodigoIva'=>(int)odbc_result($rs,'IVA'),
                'BaseIva'=>odbc_result($rs,'BaseIva'),
                'CuotaIva'=>odbc_result($rs,'CuotaIva'),
            );
        }
        
        return $listado;
    }
    
    function existeAsiento($Asiento){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL = "
                    SELECT asiento
                    FROM tbmovimientos 
                    WHERE Borrado=1
                    AND asiento=$Asiento
                  ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->existeAsiento()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            $num= mysql_num_rows($stmt);
            if($num>0){
                return 'SI';
            }else{
                return 'NO';
            }
        }else{
            return false;
        }
    }
    
    function AsientoImportado_tbmovimientos($Asiento){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL = "
                    UPDATE tbmovimientos 
                    SET Importado=now()
                    WHERE asiento=$Asiento
                    AND Borrado=1
                  ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AsientoImportado_tbmovimientos()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            return true;
        }else{
            return false;
        }
    }
    
    function ActualizarAsientoImportado_tbmovimientos($Asiento){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //busco el campo Importado mas reciente borrada
        $strSQL = "
                    SELECT Importado,Exportado
                    FROM tbmovimientos
                    WHERE Borrado=0
                    AND asiento=$Asiento
                    ORDER BY IdMovimiento DESC LIMIT 0,1
                  ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ActualizarAsientoImportado_tbmovimientos()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if(!$stmt){
            return false;
        }
        
        $row=  mysql_fetch_assoc($stmt);
        
        $campos='';
        if($row['Exportado']<>NULL){
            $campos[]="Exportado='".$row['Exportado']."'";
        }
        if($row['Importado']<>NULL){
            $campos[]="Importado='".$row['Importado']."'";
        }
        if(is_array($campos)){
            $textoCampo='';
            foreach($campos as $campo){
                $textoCampo=$textoCampo.$campo.',';
            }
            //quito la utlima coma
            $textoCampo=substr($textoCampo,0,strlen($textoCampo)-1);

            //ahora actualizo el campo importado
            $strSQL = "
                        UPDATE tbmovimientos
                        SET $textoCampo
                        WHERE Borrado=1
                        AND asiento=$Asiento
                      ";

            $stmt = $db->ejecutar ( $strSQL );
        }
        
        $db->desconectar();
        
        if($stmt){
            return true;
        }else{
            return false;
        }
    }
    
    function NuevoAsiento(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //busco el campo Importado mas reciente borrada
        $strSQL = "
            SELECT IF(ISNULL(MAX(asiento)),1,MAX(asiento)+1) AS asiento FROM tbmovimientos
        ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->NuevoAsiento()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            $row=  mysql_fetch_assoc($stmt);
            return $row['asiento'];
        }else{
            return false;
        }
    }
    
    public function ExisteCuenta($mov) {
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //busco el campo Importado mas reciente borrada
        $strSQL = "
            SELECT NumCuenta FROM tbcuenta
            WHERE Borrado=0
            AND NumCuenta=$mov
        ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->NuevoAsiento()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            $num=  mysql_num_rows($stmt);
            if($num>0){
                return true;
            }else{
                return false;
            }
        }else{
            return false;
        }
    }
    
    function datosIncidencia($IdIncidencia){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //busco los datos de la incidencia
        $strSQL = "
            SELECT DATE_FORMAT(fechaInicio,'%d/%m/%Y') AS fechaInicio,DATE_FORMAT(fechaFin,'%d/%m/%Y') AS fechaFin,
            tipo,observaciones,cerrada
            FROM tbempleados_incidencias
            WHERE Borrado=1
            AND IdIncidencia=$IdIncidencia
        ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->datosIncidencia()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            $num=  mysql_num_rows($stmt);
            if($num>0){
                $row=  mysql_fetch_array($stmt);
                
                //si viene la fecha 00/00/0000 la indicamos a ''
                foreach ($row as $key => $value) {
                    if($value==='00/00/0000'){
                        $row[$key]='';
                    }
                }
                return $row;
            }else{
                return false;
            }
        }else{
            return false;
        }
    }
    
    function EditarIncidencia($post,$listIdEmpleados,$usuario){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //preparo los datos a actualizar
        $fechaInicio = fecha_to_DATETIME($post['fechaInicio']);
        $fechaFin = '';
        if($post['fechaFin']<>''){
            $fechaFin = fecha_to_DATETIME($post['fechaFin']);
        }
        $tipo = $post['tipo'];
        $observaciones = $post['observaciones'];
        $IdIncidencia = $post['IdIncidencia'];
        
        //ahora controlo si esta cerrada o no la incidencia
        //me traigo el dato como esta antes de insertar en la BBDD
        $cerradaAnt = '';
        //actualizo los datos de la incidencia
        $strSQL = "
                SELECT I.cerrada
                FROM tbempleados_incidencias I
                WHERE I.Borrado=1
                AND I.IdIncidencia=$IdIncidencia
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarIncidencia()|| SQL : ".$strSQL);

        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            $row=  mysql_fetch_array($stmt);
            $cerradaAnt = $row['cerrada'];
        }else{
            return false;
        }
        
        //extraigo el dato de cerrada actual
        $cerrada = '0';
        if(isset($post['cerrada'])){
            $cerrada = '1';
        }
        
        //actualizo los datos de la incidencia
        $strSQL = "
            UPDATE tbempleados_incidencias
            SET fechaInicio='$fechaInicio',
                fechaFin='$fechaFin',
                tipo='$tipo',    
                cerrada='$cerrada',    
                observaciones='".mysql_real_escape_string($observaciones)."'
            WHERE IdIncidencia=$IdIncidencia    
        ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarIncidencia()|| SQL : ".$strSQL);

        $stmt = $db->ejecutar ( $strSQL );

        //ahora comparamos y si $cerradaAnt <> $cerrada, se envia una respuesta
        //pongo la fecha en formato d/m/Y
        $dia = explode (' ',$fechaInicio);
        $dia = explode ('-',$dia[0]);
        $dia = $dia[2].'/'.$dia[1].'/'.$dia[0];
        
        $txtRespuesta = '';
        if($cerrada !== $cerradaAnt){
            if($cerrada ==='0'){
                $txtRespuesta = "La incidencia del dia $dia, de tipo $tipo";
                $txtRespuesta = $txtRespuesta . " y de Observaciones $observaciones, ";
                $txtRespuesta = $txtRespuesta . "ha sido abierta por el asesor";
            }else{
                $txtRespuesta = "La incidencia del dia $dia, de tipo $tipo";
                $txtRespuesta = $txtRespuesta . " y de Observaciones $observaciones, ";
                $txtRespuesta = $txtRespuesta . "ha sido cerrada por el asesor";
            }
            
            //por ultimo enviamos las respuestas a los hilos de las preguntas de los empleados 
            require_once '../CAD/clsCADConsultas.php';
            $clsCADConsultas=new clsCADConsultas();
            $clsCADConsultas->setStrBD($_SESSION['dbContabilidad']);

            //recorremos de nuevo los empleados
            for($i=0;$i<count($listIdEmpleados);$i++){
                //extraigo el numeroPregunta y como esta el check (chatAutomatico) guardado en la tabla tbempleados
                $datosEmpleado = $this->EmpleadoNumPregunta($listIdEmpleados[$i]['IdEmpleado']);

                $clsCADConsultas->AltaRespuestaAPregunta($usuario, $txtRespuesta, $datosEmpleado['numPregunta'], '');
            }
        }
        
        
        
        if($stmt){
            return true;
        }else{
            return false;
        }
    }
    
    function AltaIncidencia($post,$usuario){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        
        //primero veo el listado de los empleados a guardar la incidencia
        $listEmpleados = stripslashes($_POST['listEmp']); 
        $listEmpleados = urldecode($listEmpleados); 
        $listEmpleados = unserialize($listEmpleados);

        //preparo los datos a actualizar
        $fechaInicio = fecha_to_DATETIME($post['fechaInicio']);
        $fechaFin = '';
        if($post['fechaFin']<>''){
            $fechaFin = fecha_to_DATETIME($post['fechaFin']);
        }
        $tipo = $post['tipo'];
        $observaciones = $post['observaciones'];
        $IdIncidencia = $post['IdIncidencia'];

        
        //se guarda la incidencia en la tabla tbempleados_incidencias
        //busco el numero siguiente en la tabla tbempleados_incidencias 
        $strSQL = "
            SELECT IF(ISNULL(MAX(IdIncidencia)),1,MAX(IdIncidencia)+1) AS Id FROM tbempleados_incidencias
        ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIncidencia()|| SQL : ".$strSQL);

        $stmt = $db->ejecutar ( $strSQL );

        if($stmt){
            $row=  mysql_fetch_assoc($stmt);
            $IdIncidencia=$row['Id'];
        }else{
            //salimos de esta iteracion del for
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIncidencia()<FALSE");
            return false;
        }

        $db->ejecutar ("START TRANSACTION");

        //inserto los datos
        $strSQL = "
            INSERT INTO tbempleados_incidencias
            (IdIncidencia,fechaInicio,fechaFin,tipo,observaciones,cerrada,Borrado,datFechaStatus,lngIdEmpleadoStatus)
            VALUES ($IdIncidencia,'$fechaInicio','$fechaFin','$tipo','".mysql_real_escape_string($observaciones)."',0,
                    1,now(),$usuario)
        ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIncidencia()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIncidencia()<ROLLBACK");
            return false;
        }
        
        
        //ahora insertamos en la tabla tbempleados_incidencias_listado los empleados a los que se guarda esta incidencia
        //se recorre la lista de empleados
        for($i=0;$i<count($listEmpleados);$i++){
            //busco el numero siguiente en la tabla tbempleados_incidencias 
            $strSQL = "
                SELECT IF(ISNULL(MAX(Id)),1,MAX(Id)+1) AS Id FROM tbempleados_incidencias_listado
            ";

            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIncidencia()|| SQL : ".$strSQL);

            $stmt = $db->ejecutar ( $strSQL );

            if($stmt){
                $row=  mysql_fetch_assoc($stmt);
                $Id=$row['Id'];
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIncidencia()<ROLLBACK");
                return false;
            }
            
            //inserto los datos en la tabla tbempleados_incidencias_listado
            $strSQL = "
                INSERT INTO tbempleados_incidencias_listado
                (Id,IdIncidencia,IdEmpleado)
                VALUES ($Id,$IdIncidencia,".$listEmpleados[$i].")
            ";

            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaIncidencia()|| SQL : ".$strSQL);
        
            $stmt = $db->ejecutar ( $strSQL );

            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIncidencia()<ROLLBACK");
                return false;
            }
        }
        
        
        //-------------------------------------------------------------
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaIncidencia()<COMMIT");

        
        //por ultimo enviamos las respuestas a los hilos de las preguntas de los empleados 
        require_once '../CAD/clsCADConsultas.php';
        $clsCADConsultas=new clsCADConsultas();
        $clsCADConsultas->setStrBD($_SESSION['dbContabilidad']);

        //recorremos de nuevo los empleados
        for($i=0;$i<count($listEmpleados);$i++){
            //extraigo el numeroPregunta y como esta el check (chatAutomatico) guardado en la tabla tbempleados
            $datosIncidencia = $this->EmpleadoNumPregunta($listEmpleados[$i]);
            //pongo la fecha en formato d/m/Y
            $dia = $post['fechaInicio'];

            $txtRespuesta = $txtRespuesta . "- Incidencia del dia $dia, de tipo ".$post['tipo'];
            $txtRespuesta = $txtRespuesta . " y de Observaciones ".$post['observaciones'].'<br/><br/>';
            
            $clsCADConsultas->AltaRespuestaAPregunta($usuario, $txtRespuesta, $datosIncidencia['numPregunta'], '');
        }
        
        
        //devuelvo el IdIncidencia por si lo necesito para adjuntar ficheros
        return $IdIncidencia;
    }

    function Incidencia_adjunto_nuevo_id(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //numero Id
        $strSQL="
                SELECT IF(ISNULL(MAX(IdAdjunto)),1,MAX(IdAdjunto)+1) AS Id FROM tbempleados_incidencias_adj
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->Incidencia_adjunto_nuevo_id()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        $IdNuevo=false;
        if($stmt){
            $row=  mysql_fetch_array($stmt);
            $IdNuevo=$row['Id'];
        }
        
        return $IdNuevo;
    }
    
    function AltaEmpleado_incidencia_adj($IdIncidencia,$IdAdjunto,$nombre,$strDescFichero){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //inserto los datos
        $strSQL="
                INSERT INTO tbempleados_incidencias_adj (IdAdjunto,IdIncidencia,fichero,descripcion,Borrado,fecha) 
                VALUES ($IdAdjunto,".$IdIncidencia.",'$nombre','".$strDescFichero."',1,now())
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaEmpleado_incidencia_adj()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            echo true;
        }else{
            echo false;
        }
    }
    
    function ListadoIncidencias($get){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //inserto los datos
        $strSQL="
                SELECT DISTINCT I.IdIncidencia,I.fechaInicio,I.fechaFin,I.tipo,I.observaciones,I.cerrada
                FROM tbempleados_incidencias I, tbempleados E, tbempleados_incidencias_listado L 
                WHERE E.Borrado=1
                AND I.IdIncidencia=L.IdIncidencia
                AND L.IdEmpleado=E.IdEmpleado
                ORDER BY I.fechaInicio DESC
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ListadoIncidencias()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            
            //ahora compruebo los datos con los filtros, y ls que cumplan los meto en el array final
            $resultFinal = '';
            for ($i = 0; $i < count($resultado); $i++) {
                //de principio, cumple
                $cumple = 'SI';
                //vamos haciendo las distintas comprobaciones, cuando una falle, ya no cumple
                if($get['fechaInicioDesde']<>''){
                    $fechaInicioDesde = fecha_to_DATETIME($get['fechaInicioDesde']);
                    if(!($resultado[$i]['fechaInicio'] >= $fechaInicioDesde)){
                        $cumple = 'NO';
                    }
                }

                if($get['fechaInicioHasta']<>''){
                    $fechaInicioHasta = fecha_to_DATETIME($get['fechaInicioHasta']);
                    if(!($resultado[$i]['fechaInicio'] <= $fechaInicioHasta)){
                        $cumple = 'NO';
                    }
                }

                if($get['fechaFinDesde']<>''){
                    $fechaFinDesde = fecha_to_DATETIME($get['fechaFinDesde']);
                    if(!($resultado[$i]['fechaFin'] >= $fechaFinDesde)){
                        $cumple = 'NO';
                    }
                }

                if($get['fechaFinHasta']<>''){
                    $fechaFinHasta = fecha_to_DATETIME($get['fechaFinHasta']);
                    if(!($resultado[$i]['fechaFin'] <= $fechaFinHasta)){
                        $cumple = 'NO';
                    }
                }

                if($get['tipoIncidencia']<>''){
                    if(!($resultado[$i]['tipo'] === $get['tipoIncidencia'])){
                        $cumple = 'NO';
                    }
                }
                
                if($get['cerrada']<>''){
                    if(!($resultado[$i]['cerrada'] === $get['cerrada'])){
                        $cumple = 'NO';
                    }
                }
                
                
                
                //si cumple lo añadimos al array final
                if($cumple === 'SI'){
                    $resultFinal[] = $resultado[$i];
                }
            }
            
            
            return $resultFinal;
        }else{
            echo false;
        }
    }
    
    function ListadoEmpleadosIncidencia($IdIncidencia){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //listo ls empleados de la incidencia
        $strSQL="
                SELECT E.IdEmpleado, CONCAT(E.nombre,' ',E.apellido1,' ',E.apellido2) AS Empleado
                FROM tbempleados_incidencias_listado L, tbempleados E
                WHERE L.IdEmpleado=E.IdEmpleado
                AND E.Borrado=1
                AND L.IdIncidencia=$IdIncidencia
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ListadoEmpleadosIncidencia()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function listadoEmpleadosInicial(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //listo los empleados en contrato actualmente (a dia de hoy)
        $strSQL="
                SELECT E.IdEmpleado,E.NumEmpleado,CONCAT(E.nombre,' ',E.apellido1,' ',E.apellido2) AS empleado,E.Categoria,DATE_FORMAT(E.fechaBaja,'%d/%m/%Y') AS fechaBaja,DATE_FORMAT(E.fechaVtoContrato,'%d/%m/%Y') AS VtoContrato,E.tipoContrato,E.tipoJornada,E.Horas
                FROM tbempleados E
                WHERE E.Borrado=1
                AND E.fechaAlta <= '".date('Y-m-d H:i:s')."'
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listadoEmpleadosInicial()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function EmpleadoNumPregunta($IdEmpleado){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //busco el numero de pregunta del empleado
        $strSQL="
                SELECT E.Observaciones,E.chatActualizado
                FROM tbempleados E
                WHERE E.Borrado
                AND E.IdEmpleado=$IdEmpleado
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EmpleadoNumPregunta()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            $row = mysql_fetch_array($stmt);
            $resultado['numPregunta'] = $row['Observaciones'];
            $resultado['chatActualizado'] = $row['chatActualizado'];
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function tieneRespuestasLaPreguntaDelEmpleado($IdEmpleado){
        $numPregunta = $this->EmpleadoNumPregunta($IdEmpleado);
        
        //cuando es dar de alta empleado nuevo todavia no hay pregunta guardada, logicamente
        if($numPregunta === null){
            return 'NO';
        }
        
        require_once '../general/conexion.php';
        $db = new DbC();
        $db->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT R.lngIdRespuesta
                FROM tbconsulta_pregunta P, tbconsulta_respuestas R
                WHERE P.lngIdPregunta=R.lngIdPregunta
                AND P.lngStatus=1
                AND P.lngIdPregunta=".$numPregunta['numPregunta']."  
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tieneRespuestasLaPreguntaDelEmpleado($IdEmpleado)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            $num = mysql_num_rows($stmt);
            if($num > 0){
                return 'SI';
            }else{
                return 'NO';
            }
        }else{
            echo 'NO';
        }
    }
    
    function IncidenciasCerrarPorListadoEmpleados($listIdEmpleados){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //como van a ser varias operaciones contra la BBDD lo hago por transaccion
        $db->ejecutar ("START TRANSACTION");
        
        //preparamos el listado con los empleados y las incidencias de cada uno de ellos
        //recorremos el listado de empleados
        $listado = '';
        for ($i = 0; $i < count($listIdEmpleados); $i++) {
            //extraigo las incidencias que tiene este empleado
            $strSQL="
                    SELECT L.IdIncidencia
                    FROM tbempleados_incidencias_listado L
                    WHERE L.IdEmpleado=".$listIdEmpleados[$i]."
                    ";

            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->IncidenciasCerrarPorListadoEmpleados()|| SQL : ".$strSQL);
            
            $stmt = $db->ejecutar ( $strSQL );
            
            $incidenciasPorEmpleado = '';
            if($stmt){
                while($row = mysql_fetch_array($stmt)){
                    $reg='';
                    foreach($row as $propiedad=>$valor){
                        if(!is_numeric($propiedad)){
                            $incidenciasPorEmpleado[] = $valor;
                        }
                    }
                    //$incidenciasPorEmpleado[]=$reg;
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->IncidenciasCerrarPorListadoEmpleados()<ROLLBACK");
                return false;
            }

            $listado[$listIdEmpleados[$i]] = $incidenciasPorEmpleado;
                    
            //$listIdEmpleados[$i][]['IdIncidencias'] = $incidenciasPorEmpleado;
        }
        
        //ahora con esta variable $listIdEmpleados la utilizamos para:
        //1- Cerrar las incidencias
        //2-enviar una respuesta a cada uno de los empleados indicando las incidencias cerradas
        
        //1- 
        foreach ($listado as $IdEmpleado => $listIncidencias) {
            foreach ($listIncidencias as $key2 => $IdIncidencia) {
                $strSQL="
                        UPDATE tbempleados_incidencias I
                        SET I.cerrada=1
                        WHERE I.Borrado=1
                        AND I.IdIncidencia=".$IdIncidencia."
                        ";

                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->IncidenciasCerrarPorListadoEmpleados()|| SQL : ".$strSQL);
                
                $stmt = $db->ejecutar ( $strSQL );

                if(!$stmt){
                    //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->IncidenciasCerrarPorListadoEmpleados()<ROLLBACK");
                    return false;
                }
            }
        }
        
        //-------------------------------------------------------------
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->IncidenciasCerrarPorListadoEmpleados()<COMMIT");
        
        
        //2- envio una respuesta a cada hilo de empleado de que se a cerrado la incidencia
        require_once '../CAD/clsCADConsultas.php';
        $clsCADConsultas=new clsCADConsultas();
        $clsCADConsultas->setStrBD($_SESSION['dbContabilidad']);
            
        //recorremos el listado de empleados
        foreach ($listado as $IdEmpleado => $listIncidencias) {
            $txtRespuesta = 'La(s) incidencia(s) está(n) cerrada(s) son las siguientes:<br/><br/>';
            //recorremos las incidencias del empleado
            foreach ($listIncidencias as $key2 => $IdIncidencia) {
                $datos= $this->datosIncidencia($IdIncidencia);
                //pongo la fecha en formato d/m/Y
                $dia = $datos['fechaInicio'];
                
                $txtRespuesta = $txtRespuesta . "- Incidencia del dia $dia, de tipo ".$datos['tipo'];
                $txtRespuesta = $txtRespuesta . " y de Observaciones ".$datos['observaciones'].'<br/><br/>';
            }
            
            //extraigo el numeroPregunta y como esta el check (chatAutomatico) guardado en la tabla tbempleados
            $datosEmpleado = $this->EmpleadoNumPregunta($IdEmpleado);

            $clsCADConsultas->AltaRespuestaAPregunta($_SESSION['usuario'], $txtRespuesta, $datosEmpleado['numPregunta'], '');
        }
        
        
        return true;
    }
    
    function IncidenciasCerrarPorListadoIncidencias($listIdIncidencias){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //como van a ser varias operaciones contra la BBDD lo hago por transaccion
        $db->ejecutar ("START TRANSACTION");

        //1- Cerrar las incidencias
        //2- enviar una respuesta a cada uno de los empleados indicando las incidencias cerradas
        
        //1- Cerrar las incidencias
        for ($i = 0; $i < count($listIdIncidencias); $i++) {
            $strSQL="
                    UPDATE tbempleados_incidencias I
                    SET I.cerrada=1
                    WHERE I.Borrado=1
                    AND I.IdIncidencia=".$listIdIncidencias[$i]."
                    ";

            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->IncidenciasCerrarPorListadoIncidencias()|| SQL : ".$strSQL);
            
            $stmt = $db->ejecutar ( $strSQL );

            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->IncidenciasCerrarPorListadoIncidencias()<ROLLBACK");
                return false;
            }
        }
        
        //-------------------------------------------------------------
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->IncidenciasCerrarPorListadoIncidencias()<COMMIT");
        
        
        //2- envio una respuesta a cada hilo de empleado de que se a cerrado la incidencia
        require_once '../CAD/clsCADConsultas.php';
        $clsCADConsultas=new clsCADConsultas();
        $clsCADConsultas->setStrBD($_SESSION['dbContabilidad']);
        
        //recorremos el listado de las incidencias
        //y preparo un array con los empleados e incidencias
        $empleados_incidencias = '';
        for ($i = 0; $i < count($listIdIncidencias); $i++) {
            //listado de empleados de esta incidencia
            $listIdEmpleados = $this->ListadoEmpleadosIncidencia($listIdIncidencias[$i]);
            
            for ($ii = 0; $ii < count($listIdEmpleados); $ii++) {
                $empleados_incidencias[] = $listIdEmpleados[$ii]['IdEmpleado'] . '-' . $listIdIncidencias[$i];
            }
        }
        
        //ahora ordenamos este array (viene de esta forma 2-6, el priero es el empleado y el segundo la incidencia
        asort($empleados_incidencias);
        
        //preparo un array con los empleados primero y dentro las incidencias de cada empleado
        $listado = '';
        $empleado = '';
        foreach ($empleados_incidencias as $key => $value) {
            $datos = explode('-',$value);
            if(isset($datosAnt)){
                //$datosAE = explode('-',$datosAnt);
                if($datos[0]=== $datosAnt[0]){
                    $empleado[] = $datos[1];
                }else{
                    //ya a terminado este empleado, lo guardo en el listado 
                    $listado[$datosAnt[0]] = $empleado;
                    $empleado = '';
                    $empleado[] = $datos[1];
                }
            }else{
                //es el primer dato, se introduce directamente
                $empleado[] = $datos[1];
            }
            
            $datosAnt = $datos;
        }
        //guardamos el ultimo valor que nos queda
        $listado[$datos[0]] = $empleado;
        
        foreach ($listado as $IdEmpleado => $listIncidencias) {
            $txtRespuesta = 'La(s) incidencia(s) está(n) cerrada(s) son las siguientes:<br/><br/>';
            //recorremos las incidencias del empleado
            foreach ($listIncidencias as $key2 => $IdIncidencia) {
                $datos= $this->datosIncidencia($IdIncidencia);
                //pongo la fecha en formato d/m/Y
                $dia = $datos['fechaInicio'];
                
                $txtRespuesta = $txtRespuesta . "- Incidencia del dia $dia, de tipo ".$datos['tipo'];
                $txtRespuesta = $txtRespuesta . " y de Observaciones ".$datos['observaciones'].'<br/><br/>';
            }
            
            //extraigo el numeroPregunta y como esta el check (chatAutomatico) guardado en la tabla tbempleados
            $datosEmpleado = $this->EmpleadoNumPregunta($IdEmpleado);

            $clsCADConsultas->AltaRespuestaAPregunta($_SESSION['usuario'], $txtRespuesta, $datosEmpleado['numPregunta'], '');
        }
        
        return true;
    }
    
    function cobrosFactura($IdFactura){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL="
                SELECT SUM(C.cantidad) AS cantidad
                FROM tbmisfacturas_cobros C
                WHERE C.IdFactura=$IdFactura
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->cobrosFactura($IdFactura)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            $row = mysql_fetch_array($stmt);
            //si ha sido correcta la consulta hacemos DEVOLVEMOS la cantidad
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->cobrosFactura():".$row['cantidad']);
            return $row['cantidad'];
        }else{
            //si ha fallado la consulta hacemos DEVOLVEMOS false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->cobrosFactura()<FALSE");
            return false;
        }
    }
    
    function ActualizarSituacionFactura($IdFactura,$situacion){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        $strSQL="
                UPDATE tbmisfacturas
                SET Situacion='$situacion'
                WHERE IdFactura=".$IdFactura."
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ActualizarSituacionFactura()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            //si ha sido correcta la consulta hacemos DEVOLVEMOS la cantidad
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ActualizarSituacionFactura()<TRUE");
            return true;
        }else{
            //si ha fallado la consulta hacemos DEVOLVEMOS false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ActualizarSituacionFactura()<FALSE");
            return false;
        }
    }
    
    function FacturaCobro($numeroFactura,$cantidad,$fecha,$cuenta){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //numero Id
        $strSQL="
                SELECT IF(ISNULL(MAX(Id)),1,MAX(Id)+1) AS Id FROM tbmisfacturas_cobros
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->FacturaCobro()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            $row = mysql_fetch_array($stmt);
            $IdNueva = $row['Id'];
        }else{
            return false;
        }
        
        $strSQL="
                INSERT INTO tbmisfacturas_cobros
                (Id,IdFactura,fecha,cantidad,forma_cobro)
                VALUES ($IdNueva,$numeroFactura,'$fecha',$cantidad,'$cuenta')
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->FacturaCobro()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            //se ha insertado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->FacturaCobro()<TRUE ");
            return true;
        }else{
            //NO se ha insertado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->FacturaCobro()<FALSE ");
            return false;
        }
    }
    
    function FacturasCobrosGrafica(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //numero Id
        $strSQL="
                SELECT MONTH(C.fecha) AS Mes,YEAR(C.fecha) AS Ejercicio,SUM(C.cantidad) AS cantidad
                FROM tbmisfacturas_cobros C
                GROUP BY YEAR(C.fecha),MONTH(C.fecha)
                ORDER BY YEAR(C.fecha) ASC,MONTH(C.fecha) ASC
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->FacturasCobrosGrafica()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            while($row=  mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function listadoTiposFactura(){
        require_once '../general/conexion.php';
        $db = new DbC();
        $db->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT F.IdTipo,F.Nombre
                FROM tbtipofactura F
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listadoTiposFactura()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function nombreFacturaFichero($FacturaTipo){
        require_once '../general/conexion.php';
        $db = new DbC();
        $db->conectar($_SESSION['dbContabilidad']);

        //numero Id
        $strSQL="
                SELECT F.Fichero
                FROM tbtipofactura F
                WHERE F.IdTipo=$FacturaTipo
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->FacturasCobrosGrafica()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            $row = mysql_fetch_array($stmt);
            return $row['Fichero'];
        }else{
            return false;
        }
    }

    function listadoCuentas($filtro){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //listado de cuentas
        $strSQL="
                SELECT CONCAT(NumCuenta , ' - ' , Nombre) AS cuenta,NumCuenta
                FROM tbcuenta
                WHERE Borrado=0
                AND NumCuenta LIKE '$filtro%'
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->FacturasCobrosGrafica()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function ListadoArticulos($get){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //listado de cuentas
        $strSQL="
                SELECT * FROM tbarticulos WHERE Borrado=1
                ";
        
        //añado los filtros
        $filtros = 0;
        $strSQLFiltro = "";
        if($get['strDescripcion'] !== ""){
            $filtros++;
            $strSQLFiltro = $strSQLFiltro . "AND Descripcion LIKE '%".$get['strDescripcion']."%'";
        }
        if($get['cuentaContable'] !== ""){
            $filtros++;
            $strSQLFiltro = $strSQLFiltro . "AND CuentaContable LIKE '%".$get['cuentaContable']."%'";
        }
        
        if($filtros > 0){
            $strSQL = $strSQL.$strSQLFiltro;
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ListadoArticulos()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }

    function LeeArticulo($Id){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //listado de cuentas
        $strSQL="
                SELECT A.Id,A.Referencia,A.Descripcion,A.Precio,A.tipoIVA,A.IdGrupo,
                A.CantidadAlmacen,CONCAT(A.CuentaContable,' - ',C.Nombre) AS CuentaContable
                FROM tbarticulos A
                LEFT JOIN tbcuenta C
                ON C.NumCuenta=A.CuentaContable
                WHERE A.Id=$Id
                AND A.Borrado=1
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->LeeArticulo($Id)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function AltaArticulo($post){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //numero Id
        $strSQL="
                SELECT IF(ISNULL(MAX(Id)),1,MAX(Id)+1) AS Id FROM tbarticulos
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaArticulo()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            $row = mysql_fetch_array($stmt);
            $IdNueva = $row['Id'];
        }else{
            return false;
        }
        
        //cojo el numero de la cuenta contable (viene en este formato 708000000 - Devolución ventas mercaderías)
        $cuenta = explode ('-',$post['cuentaContable']);
        
        $strSQL="
                INSERT INTO tbarticulos
                (Id,Referencia,Descripcion,Precio,tipoIVA,CantidadAlmacen,CuentaContable,IdGrupo,Borrado,datFechaStatus,lngIdEmpleadoStatus)
                VALUES ($IdNueva,'".$post['Referencia']."','".$post['Descripcion']."',".desFormateaNumeroContabilidad($post['Precio']).",".$post['tipoIVA'].",".$post['cantidadAlmacen'].",'".$post['cuentaContable']."',".$post['IdGrupo'].",1,now(),".$_SESSION['usuario'].")
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaArticulo()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            //se ha insertado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaArticulo()<TRUE ");
            return $IdNueva;
        }else{
            //NO se ha insertado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaArticulo()<FALSE ");
            return false;
        }
    }
    
    function BorrarArticulo($Id){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //borrar articulo
        $strSQL="
                UPDATE tbarticulos
                SET Borrado=0
                WHERE Id=$Id
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->BorrarArticulo($Id)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            //se ha borrado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->BorrarArticulo($Id)<TRUE ");
            return true;
        }else{
            //NO se ha borrado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->BorrarArticulo($Id)<FALSE ");
            return false;
        }
    }
    
    function EditarArticulo($post){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //editar articulo
        $strSQL="
                UPDATE tbarticulos
                SET Referencia='".$post['Referencia']."',
                Descripcion='".$post['Descripcion']."',
                Precio=".desFormateaNumeroContabilidad($post['Precio']).",
                tipoIVA=".$post['tipoIVA'].",
                CantidadAlmacen=".$post['cantidadAlmacen'].",
                CuentaContable='".$post['cuentaContable']."',
                IdGrupo=".$post['IdGrupo'].",
                datFechaStatus=now(),
                lngIdEmpleadoStatus=".$_SESSION['usuario']."
                WHERE Id=".$post['Id']."
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarArticulo()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            //se ha actualizado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarArticulo()<TRUE ");
            return true;
        }else{
            //NO se ha actualizado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarArticulo()<FALSE ");
            return false;
        }
    }

    function listarCuentasArticulos(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //listar cuenta del articulo
        $strSQL="
                SELECT C.NumCuenta, CONCAT(C.NumCuenta,' - ',C.Nombre) AS cuenta
                FROM tbcuenta C
                WHERE C.Borrado=0
                AND C.NumCuenta LIKE '7%'
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listarCuentasArticulos()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function ListadoGruposArticulos(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //listar cuenta del articulo
        $strSQL="
                SELECT G.IdGrupo,G.Grupo,G.Identificador,G.Cuenta
                FROM tbgrupoarticulos G
                WHERE G.Borrado=1
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listarCuentasArticulos()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function ListadoArticulosDeGrupo($IdGrupo){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //listar cuenta del articulo
        $strSQL="
                SELECT A.Id,A.Referencia,A.Descripcion,A.Precio,A.tipoIVA,
                A.CantidadAlmacen,A.CuentaContable
                FROM tbarticulos A, tbgrupoarticulos G
                WHERE A.IdGrupo=G.IdGrupo
                AND A.Borrado=1
                AND G.IdGrupo=$IdGrupo
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listarCuentasArticulos()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function nombreGrupoArticulo($IdGrupoListar){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //listar cuenta del articulo
        $strSQL="
                SELECT A.Grupo
                FROM tbgrupoarticulos A
                WHERE A.IdGrupo=$IdGrupoListar
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listarCuentasArticulos()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function LeeGrupo($Id){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //listar cuenta del articulo
        $strSQL="
                SELECT A.IdGrupo,A.Identificador,A.Cuenta,A.Grupo
                FROM tbgrupoarticulos A
                WHERE A.IdGrupo=$Id
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->listarCuentasArticulos()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
            return $resultado;
        }else{
            echo false;
        }
    }
    
    function EditarGrupoArticulo($post){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //editar articulo
        $strSQL="
                UPDATE tbgrupoarticulos
                SET Grupo='".$post['Grupo']."',
                Identificador='".$post['Identificador']."',
                Cuenta='".$post['cuentaContable']."',
                datFechaStatus=now(),
                lngIdEmpleadoStatus=".$_SESSION['usuario']."
                WHERE IdGrupo=".$post['Id']."
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->EditarGrupoArticulo()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            //se ha actualizado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarGrupoArticulo()<TRUE ");
            return true;
        }else{
            //NO se ha actualizado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->EditarGrupoArticulo()<FALSE ");
            return false;
        }
    }
    
    function AltaGrupoArticulo($post){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //numero Id
        $strSQL="
                SELECT IF(ISNULL(MAX(IdGrupo)),1,MAX(IdGrupo)+1) AS Id FROM tbgrupoarticulos
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaGrupoArticulo()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            $row = mysql_fetch_array($stmt);
            $IdNueva = $row['Id'];
        }else{
            return false;
        }
        
        $strSQL="
                INSERT INTO tbgrupoarticulos
                (IdGrupo,Grupo,Identificador,Cuenta,Borrado,datFechaStatus,lngIdEmpleadoStatus)
                VALUES ($IdNueva,'".$post['Grupo']."','".$post['Identificador']."','".$post['cuentaContable']."',1,now(),".$_SESSION['usuario'].")
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaArticulo()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            //se ha insertado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaArticulo()<TRUE ");
            return true;
        }else{
            //NO se ha insertado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaArticulo()<FALSE ");
            return false;
        }
    }
    
    function PonerIdArticuloACeroPresupuesto($varRes){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //guardo las lineas que voy a pasar IdArticulo a 0, me veldran despues para buscarlas en tbmisfacturaslineas
        $strSQL="
                SELECT IdPresupLineas
                FROM tbmispresupuestoslineas
                WHERE IdPresupuesto=$varRes
                AND ISNULL(IdArticulo)
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroPresupuesto($varRes)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );

        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
        }else{
            return false;
        }
        

        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroPresupuesto($varRes) || START TRANSACTION");
        
        //ponemos a = 0 los IdArticulos de este presupuesto que sean NULL
        $strSQL="
                UPDATE tbmispresupuestoslineas
                SET IdArticulo=0
                WHERE IdPresupuesto=$varRes
                AND ISNULL(IdArticulo)
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroPresupuesto($varRes)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->PonerIdArticuloACeroPresupuesto($varRes)<ROLLBACK");
            return false;
        }

        //ahora recorro el array y si el valor IdPresupLineas >0 busco estas lineas en tbmisfacturaslineas
        // y las pongo a 0 (estan relacionados la factura y el presupuesto por este campo IdPresupLineas)
        if(is_array($resultado)){
            for ($i = 0; $i < count($resultado); $i++) {
                if((int)$resultado[$i]['IdPresupLineas']>0){
                    //ahora ponemos a 0 los IdArticulos de esta facturas que sean NULL
                    $strSQL="
                            UPDATE tbmisfacturaslineas
                            SET IdArticulo=0
                            WHERE IdPresupLineas=".$resultado[$i]['IdPresupLineas']."
                            ";

                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->PonerIdArticuloACeroPresupuesto($varRes)|| SQL : ".$strSQL);

                    $stmt = $db->ejecutar ( $strSQL );

                    if(!$stmt){
                        //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->PonerIdArticuloACeroPresupuesto($varRes)<ROLLBACK");
                        return false;
                    }
                }
            }
        }
        
        
        //-------------------------------------------------------------
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroPresupuesto($varRes)<COMMIT");
        return true;
    }
    
    function PonerIdArticuloACeroFactura($varRes){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        
        //miro si esta factura viene de un presupuesto
        //(se ve en el campo tbmisfacturaslineas.IdPresupLineas es distinto de 0
        //primero listo las lineas de esta factura
        $strSQL="
                SELECT IdPresupLineas
                FROM tbmisfacturaslineas
                WHERE IdFactura=$varRes
                AND ISNULL(IdArticulo)
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroFactura($varRes)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );

        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
        }else{
            return false;
        }
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroFactura($varRes) || START TRANSACTION");
        
        //ahora ponemos a 0 los IdArticulos de esta facturas que sean NULL
        $strSQL="
                UPDATE tbmisfacturaslineas
                SET IdArticulo=0
                WHERE IdFactura=$varRes
                AND ISNULL(IdArticulo)
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroFactura($varRes)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->PonerIdArticuloACeroFactura($varRes)<ROLLBACK");
            return false;
        }
        
        //ahora recorremos el array $resultado y si es valor es mayor 0 cambiamos esa linea en tbmispresupuestoslineas
        if(is_array($resultado)){
            for ($i = 0; $i < count($resultado); $i++) {
                if((int)$resultado[$i]['IdPresupLineas']>0){
                    //ahora ponemos a 0 los IdArticulos de esta facturas que sean NULL
                    $strSQL="
                            UPDATE tbmispresupuestoslineas
                            SET IdArticulo=0
                            WHERE IdPresupLineas=".$resultado[$i]['IdPresupLineas']."
                            ";

                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->PonerIdArticuloACeroFactura($varRes)|| SQL : ".$strSQL);

                    $stmt = $db->ejecutar ( $strSQL );

                    if(!$stmt){
                        //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->PonerIdArticuloACeroFactura($varRes)<ROLLBACK");
                        return false;
                    }
                }
            }
        }
        
        
        //-------------------------------------------------------------
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroFactura($varRes)<COMMIT");
        return true;
    }
    
    function PonerIdArticuloACeroPedido($varRes){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        
        //miro si esta pedido viene de un presupuesto
        //(se ve en el campo tbmispedidoslineas.IdPresupLineas es distinto de 0
        //primero listo las lineas de esta factura
        $strSQL="
                SELECT IdPresupLineas
                FROM tbmispedidoslineas
                WHERE IdPedido=$varRes
                AND ISNULL(IdArticulo)
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroPedido($varRes)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );

        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
        }else{
            return false;
        }
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroPedido($varRes) || START TRANSACTION");
        
        //ahora ponemos a 0 los IdArticulos de este pedido que sean NULL
        $strSQL="
                UPDATE tbmispedidoslineas
                SET IdArticulo=0
                WHERE IdPedido=$varRes
                AND ISNULL(IdArticulo)
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroPedido($varRes)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->PonerIdArticuloACeroPedido($varRes)<ROLLBACK");
            return false;
        }
        
        //ahora recorremos el array $resultado y si es valor es mayor 0 cambiamos esa linea en tbmispresupuestoslineas
        if(is_array($resultado)){
            for ($i = 0; $i < count($resultado); $i++) {
                if((int)$resultado[$i]['IdPresupLineas']>0){
                    //ahora ponemos a 0 los IdArticulos de esta facturas que sean NULL
                    $strSQL="
                            UPDATE tbmispresupuestoslineas
                            SET IdArticulo=0
                            WHERE IdPresupLineas=".$resultado[$i]['IdPresupLineas']."
                            ";

                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->PonerIdArticuloACeroPedido($varRes)|| SQL : ".$strSQL);

                    $stmt = $db->ejecutar ( $strSQL );

                    if(!$stmt){
                        //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->PonerIdArticuloACeroPedido($varRes)<ROLLBACK");
                        return false;
                    }
                }
            }
        }
        
        
        //-------------------------------------------------------------
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->PonerIdArticuloACeroPedido($varRes)<COMMIT");
        return true;
    }
    
    function ActualizarLineaPresupuesto($post,$IdArticulo){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();

        //cambio las comillas simples si hay por dobles, me da error sino al leer este dato el formulario html
        $Descripcion = str_replace("'", "\"", $post['Descripcion']);
        //ahora lo guardo con el formato Referencia - Descripcion (Ej: R0014 - Balon)
        $Descripcion = $post['Referencia'] . ' - ' . $Descripcion;
        
        //el precio
        $importeUnidad = desFormateaNumeroContabilidad($post['Precio']);
        
        //IVA
        $tipoIVA = $post['tipoIVA'];
        
        $IdPresupLinea = $post['IdPresupLineas'];

        //primero busco la variable de 'Tipo de Contador' de la tabla 'tbparametros_generales'
        $cuentaContable = $this->Parametro_general('cuentaContable',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        //busco la cuenta del articulo
        $cuentaArticulo = $this->LeeArticulo($IdArticulo);
        $cuenta = explode('-',$cuentaArticulo[0]['CuentaContable']);
        $cuenta = $cuenta[0];
        if($cuenta === '' || $cuenta === null){
            //sino tiene datos de cuenta este articulo, busco si la hay en su grupo
            $cuentaGrupo = $this->LeeGrupo($cuentaArticulo[0]['IdGrupo']);
            if($cuentaGrupo[0]['Cuenta'] === '' || $cuentaGrupo[0]['Cuenta'] === null){
                $cuenta = $cuentaContable;
            }else{
                $cuenta = $cuentaGrupo[0]['Cuenta'];
            }
        }
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->conectar($this->getStrBD());
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ActualizarLineaPresupuesto() || START TRANSACTION");
        
        
        //actualizo esta linea del presupuesto
        $strSQL="
                UPDATE tbmispresupuestoslineas
                SET IdArticulo = $IdArticulo,
                    DescripcionProducto = '$Descripcion'
                WHERE IdPresupLineas = $IdPresupLinea
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ActualizarLineaPresupuesto()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ActualizarLineaPresupuesto()<ROLLBACK");
            return false;
        }
        
        //ahora buscamos si esta linea del presupuesto esta en tbmisfacturaslineas (estan relaccionados 
        //el presupuesto y la factura)
        
        //busco las IdPresupLineas que haya en tbmisfacturaslineas
        $strSQL="
                SELECT IdFacturaLineas
                FROM tbmisfacturaslineas
                WHERE IdPresupLineas=".$post['IdPresupLineas']."
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ActualizarLineaPresupuesto()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );

        if($stmt){
            $num = mysql_num_rows($stmt);
            //si hay lineas en tbmisfacturaslineas
            if($num>0){
                //actualizo estas lineas con los datos del IdArticulo y el concepto
                while($row = mysql_fetch_assoc($stmt)){
                    //actualizo esta linea de la factura
                    $strSQL="
                            UPDATE tbmisfacturaslineas
                            SET IdArticulo = $IdArticulo,
                                cuentaArticulo = '$cuenta',
                                DescripcionProducto = '$Descripcion'
                            WHERE IdFacturaLineas = ".$row['IdFacturaLineas']."
                            ";
                    
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->ActualizarLineaPresupuesto()|| SQL : ".$strSQL);

                    $stmt2 = $db->ejecutar ( $strSQL );

                    if(!$stmt2){
                        //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                        $db->ejecutar ("ROLLBACK");
                        $db->desconectar ();
                        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                                " clsCADContabilidad->ActualizarLineaPresupuesto()<ROLLBACK");
                        return false;
                    }
                }
            }
        }else{
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ActualizarLineaPresupuesto()<ROLLBACK");
            return false;
        }
        
        
        //-------------------------------------------------------------
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ActualizarLineaPresupuesto()<COMMIT");
        return true;
    }
    
    function ActualizarLineaFactura($post,$IdArticulo){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //cambio las comillas simples si hay por dobles, me da error sino al leer este dato el formulario html
        $Descripcion = str_replace("'", "\"", $post['Descripcion']);
        //ahora lo guardo con el formato Referencia - Descripcion (Ej: R0014 - Balon)
        $Descripcion = $post['Referencia'] . ' - ' . $Descripcion;
        
        //el precio
        $importeUnidad = desFormateaNumeroContabilidad($post['Precio']);
        
        //IVA
        $tipoIVA = $post['tipoIVA'];
        
        $IdPresupLineas = $post['idPresupLineas'];

        //miramos si la cuenta esta vacia o no
        //actualizo las lineas de la factura donde venga el IdPresupLineas 
        //(puede haber varias facturas de un mismo presupuesto)
        
        //añado la condicion si $IdPresupLineas=0 para que solo actualice una linea
        $condicion = '';
        if($IdPresupLineas === '0'){
            $condicion =" AND IdFacturaLineas = ".$post['IdFacturaLineas'];
        }
        
        if($post['cuentaContable'] === ''){
            $strSQL="
                    UPDATE tbmisfacturaslineas
                    SET IdArticulo = $IdArticulo,
                        DescripcionProducto = '$Descripcion'
                    WHERE IdPresupLineas = $IdPresupLineas
                    $condicion
                    ";
        }else{
            $cuentaContable = $post['cuentaContable'];

            $strSQL="
                    UPDATE tbmisfacturaslineas
                    SET IdArticulo = $IdArticulo,
                        cuentaArticulo = '$cuentaContable',
                        DescripcionProducto = '$Descripcion'
                    WHERE IdPresupLineas = $IdPresupLineas
                    $condicion
                    ";
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ActualizarLineaFactura()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        $result = true;
        if(!$stmt){
            //NO se ha actualizado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ActualizarLineaPresupuesto()<FALSE ");
            $result = false;
        }
        
        //ahora miramos si $post['idPresupLineas'] > 0 , si es asi guardamos el IdArticulo en la tabla 
        //tbmispresupuestoslineas
        $idPresupLineas = $post['idPresupLineas'];
        if((int)$idPresupLineas > 0){
            //actualizo esta linea de la factura
            $strSQL="
                    UPDATE tbmispresupuestoslineas
                    SET IdArticulo = $IdArticulo,
                        DescripcionProducto = '$Descripcion'
                    WHERE IdPresupLineas = $idPresupLineas
                    ";
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ActualizarLineaFactura()|| SQL : ".$strSQL);

            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //NO se ha actualizado correctamente
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->ActualizarLineaFactura()<FALSE ");
                $result = false;
            }
        }
        
        $db->desconectar ();

        if($stmt){
            //se ha actualizado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ActualizarLineaFactura()<TRUE ");
            $result = true;
        }
        
        return $result;
    }
    
    function ActualizarLineaPedido($post,$IdArticulo){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //cambio las comillas simples si hay por dobles, me da error sino al leer este dato el formulario html
        $Descripcion = str_replace("'", "\"", $post['Descripcion']);
        //ahora lo guardo con el formato Referencia - Descripcion (Ej: R0014 - Balon)
        $Descripcion = $post['Referencia'] . ' - ' . $Descripcion;
        
        //el precio
        $importeUnidad = desFormateaNumeroContabilidad($post['Precio']);
        
        //IVA
        $tipoIVA = $post['tipoIVA'];
        
        $IdPresupLineas = $post['idPresupLineas'];

        //miramos si la cuenta esta vacia o no
        //actualizo las lineas de la factura donde venga el IdPresupLineas 
        //(puede haber varios pedidos de un mismo presupuesto)
        
        //añado la condicion si $IdPresupLineas=0 para que solo actualice una linea
        $condicion = '';
        if($IdPresupLineas === '0'){
            $condicion =" AND IdPedidoLineas = ".$post['IdPedidoLineas'];
        }
        
        $strSQL="
                UPDATE tbmispedidoslineas
                SET IdArticulo = $IdArticulo,
                    DescripcionProducto = '$Descripcion'
                WHERE IdPresupLineas = $IdPresupLineas
                $condicion
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ActualizarLineaPedido()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        $result = true;
        if(!$stmt){
            //NO se ha actualizado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ActualizarLineaPedido()<FALSE ");
            $result = false;
        }
        
        //ahora miramos si $post['idPresupLineas'] > 0 , si es asi guardamos el IdArticulo en la tabla 
        //tbmispresupuestoslineas
        $idPresupLineas = $post['idPresupLineas'];
        if((int)$idPresupLineas > 0){
            //actualizo esta linea de la factura
            $strSQL="
                    UPDATE tbmispresupuestoslineas
                    SET IdArticulo = $IdArticulo,
                        DescripcionProducto = '$Descripcion'
                    WHERE IdPresupLineas = $idPresupLineas
                    ";
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ActualizarLineaPedido()|| SQL : ".$strSQL);

            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //NO se ha actualizado correctamente
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->ActualizarLineaPedido()<FALSE ");
                $result = false;
            }
        }
        
        $db->desconectar ();

        if($stmt){
            //se ha actualizado correctamente
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ActualizarLineaPedido()<TRUE ");
            $result = true;
        }
        
        return $result;
    }
    
    function ArticuloIdArticuloACeroEnPresupuesto($IdPresupLinea){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->conectar($this->getStrBD());
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ArticuloIdArticuloACeroEnPresupuesto() || START TRANSACTION");
        
        //actualizo esta linea del presupuesto IdArticulo=0
        $strSQL="
                UPDATE tbmispresupuestoslineas
                SET IdArticulo = 0
                WHERE IdPresupLineas = $IdPresupLinea
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ArticuloIdArticulACeroEnPresupuesto($IdPresupLinea)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ArticuloIdArticulACeroEnPresupuesto()<ROLLBACK");
            return false;
        }
        
        //ahora buscamos si hay lineas en las facturas que contengan a esta linea de presupuesto
        $strSQL="
                SELECT IdFacturaLineas
                FROM tbmisfacturaslineas
                WHERE IdPresupLineas = $IdPresupLinea
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ArticuloIdArticulACeroEnPresupuesto($IdPresupLinea)|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            while($row = mysql_fetch_array($stmt)){
                //pongo la(s) linea(s) a 0
                $strSQL="
                        UPDATE tbmisfacturaslineas
                        SET IdArticulo = 0
                        WHERE IdFacturaLineas = ".$row['IdFacturaLineas']."
                        ";

                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->ArticuloIdArticulACeroEnPresupuesto($IdPresupLinea)|| SQL : ".$strSQL);

                $stmt2 = $db->ejecutar ( $strSQL );
                
                if(!$stmt2){
                    //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->ArticuloIdArticulACeroEnPresupuesto()<ROLLBACK");
                    return false;
                }
            }
        }else{
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ArticuloIdArticulACeroEnPresupuesto()<ROLLBACK");
            return false;
        }     
        
        
        //-------------------------------------------------------------
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ArticuloIdArticulACeroEnPresupuesto()<COMMIT");
        return true;
    }
    
    function ArticuloIdArticuloACeroEnFactura($IdFacturaLinea){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->conectar($this->getStrBD());
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ArticuloIdArticuloACeroEnFactura() || START TRANSACTION");
        
        
        //buscamos el IdPresupLinea de esta IdFacturaLinea
        $strSQL="
                SELECT IdPresupLineas
                FROM tbmisfacturaslineas
                WHERE IdFacturaLineas = $IdFacturaLinea
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ArticuloIdArticuloACeroEnFactura()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            $row = mysql_fetch_array($stmt);
            $IdPresupLinea = $row['IdPresupLineas'];
        }else{
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ArticuloIdArticuloACeroEnFactura()<ROLLBACK");
            return false;
        }

        //actualizo el IdPresupLinea (si es mayor de 0
        if($IdPresupLinea > 0){
            $strSQL="
                    UPDATE tbmispresupuestoslineas
                    SET IdArticulo = 0
                    WHERE IdPresupLineas = $IdPresupLinea
                    ";

            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ArticuloIdArticuloACeroEnFactura($IdPresupLinea)|| SQL : ".$strSQL);

            $stmt = $db->ejecutar ( $strSQL );

            if(!$stmt){
                //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->ArticuloIdArticuloACeroEnFactura()<ROLLBACK");
                return false;
            }
        }
        
        //añado la condicion si $IdPresupLineas=0 para que solo actualice una linea
        $condicion = '';
        if($IdPresupLinea === '0'){
            $condicion =" AND IdFacturaLineas = ".$IdFacturaLinea;
        }
        
        
        //ahora busco los IdFacturaLineas de este IdPresupLineas
        $strSQL="
                SELECT IdFacturaLineas
                FROM tbmisfacturaslineas
                WHERE IdPresupLineas = $IdPresupLinea
                $condicion
                ";
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ArticuloIdArticuloACeroEnFactura()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        
        if($stmt){
            while($row = mysql_fetch_array($stmt)){
                //pongo la(s) linea(s) a 0
                $strSQL="
                        UPDATE tbmisfacturaslineas
                        SET IdArticulo = 0,
                        cuentaArticulo = '700000000'
                        WHERE IdFacturaLineas = ".$row['IdFacturaLineas']."
                        ";

                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->ArticuloIdArticuloACeroEnFactura($IdPresupLinea)|| SQL : ".$strSQL);

                $stmt2 = $db->ejecutar ( $strSQL );
                
                if(!$stmt2){
                    //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                    $db->ejecutar ("ROLLBACK");
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->ArticuloIdArticuloACeroEnFactura()<ROLLBACK");
                    return false;
                }
            }
        }else{
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->ArticuloIdArticuloACeroEnFactura()<ROLLBACK");
            return false;
        }
        
        
        //-------------------------------------------------------------
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        $db->desconectar ();
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->ArticuloIdArticuloACeroEnFactura()<COMMIT");
        return true;
    }
    
    function AltaAsientoMovimientos_SinIRPF($post,$cuentaVentas,$idEmp, $strUsuario){
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strCuentaCli = explode('-',$post['strCuentaCli']);
        $strCuentaCli = $strCuentaCli[0];
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa=$idEmp AND codigo=$strCuentaCli AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $dbCont->ejecutar ("ROLLBACK");
            $dbCont->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()<ROLLBACK");
            return false;
        }
        $row=  mysql_fetch_array($stmt);
        $IdCliProv=$row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv==null){
            $IdCliProv='null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()|| IdCliProv : ".$IdCliProv);
        
        
        //ahora trabajo con la BBDD del cliente
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF() || START TRANSACTION");

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()>");
        
        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        //$asiento=$this->numeroAsientoNuevo($db);
        $asiento=$post['Asiento'];
        
        
        
        
        //1º Cuentas 7 (Ingreso)
        if($post['esAbono'] === 'NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        
        $contadorOrden = 1;
        
        for ($z = 0; $z < count($cuentaVentas); $z++) {
            $importe = desFormateaNumeroContabilidad($cuentaVentas[$z]['cantidad']);
            $cuota = desFormateaNumeroContabilidad($cuentaVentas[$z]['cuota']);
            $concepto = addslashes($post['strConcepto']);
            
            //aqui definimos el tipo de asiento a guardar indicando el 2 al final de que ya 
            //no esta ligado a la factura de origen
            if($post['TipoAsiento'] === '15N' || $post['TipoAsiento'] === '15N2'){
                $tipoAsiento = '15N2';
            }
            else
            if($post['TipoAsiento'] === '15A' || $post['TipoAsiento'] === '15A2'){
                $tipoAsiento = '15A2';
            }
            else
            if($post['TipoAsiento'] === '16N' || $post['TipoAsiento'] === '16N2'){
                $tipoAsiento = '16N2';
            }
            else
            if($post['TipoAsiento'] === '16A' || $post['TipoAsiento'] === '16A2'){
                $tipoAsiento = '16A2';
            }
            else
            if($post['TipoAsiento'] === '17N' || $post['TipoAsiento'] === '17N2'){
                $tipoAsiento = '17N2';
            }
            else
            if($post['TipoAsiento'] === '17A' || $post['TipoAsiento'] === '17A2'){
                $tipoAsiento = '17A2';
            }
            else
            if($post['TipoAsiento'] === '18N' || $post['TipoAsiento'] === '18N2'){
                $tipoAsiento = '18N2';
            }
            else
            if($post['TipoAsiento'] === '18A' || $post['TipoAsiento'] === '18A2'){
                $tipoAsiento = '18A2';
            }
            
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $cuentaVentas[$z]['idCuenta'], $DoH,
                    $importe, $cuota, $post['datFecha'], $post['lngPeriodo'], $post['lngEjercicio'], $concepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
        }
        
        //2º Cuenta 4770 (IVA)
        if($post['esAbono'] === 'NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        
        //ahora calculo el/los ivas a introducir
        $totalcuota = 0;
        $IVAs = '';
        for ($ij = 0; $ij < count($cuentaVentas); $ij++) {
            $cuota = desFormateaNumeroContabilidad($cuentaVentas[$ij]['cuota']);
            $base = desFormateaNumeroContabilidad($cuentaVentas[$ij]['cantidad']);
            //sumo el total de los ivas
            $totalcuota = (float)$totalcuota + $cuota;
            if($cuentaVentas[$ij]['iva'] === '0'){
                $IVAs['0']['base'] = (float)$IVAs['0']['base'] + (float)$base;
                $IVAs['0']['cuota'] = (float)$IVAs['0']['cuota'] + (float)$cuota;
            }else
            if($cuentaVentas[$ij]['iva'] === '4'){
                $IVAs['4']['base'] = (float)$IVAs['4']['base'] + (float)$base;
                $IVAs['4']['cuota'] = (float)$IVAs['4']['cuota'] + (float)$cuota;
            }else
            if($cuentaVentas[$ij]['iva'] === '10'){
                $IVAs['10']['base'] = (float)$IVAs['10']['base'] + (float)$base;
                $IVAs['10']['cuota'] = (float)$IVAs['10']['cuota'] + (float)$cuota;
            }else
            if($cuentaVentas[$ij]['iva'] === '21'){
                $IVAs['21']['base'] = (float)$IVAs['21']['base'] + (float)$base;
                $IVAs['21']['cuota'] = (float)$IVAs['21']['cuota'] + (float)$cuota;
            }
        }
        
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $this->IVAREPERCUTIDO, $DoH,
                $totalcuota, 0, $post['datFecha'], $post['lngPeriodo'], $post['lngEjercicio'], $concepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        //3º si hay IRPF se inserta (4730)
        if($post['porcientoIRPF'] !== '0'){
            if($post['esAbono'] === 'NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }
            
            $lngIRPF = desFormateaNumeroContabilidad($post['lngIRPFContabilidad']);
            
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $this->IRPFPago, $DoH,
                    $lngIRPF, 0, $post['datFecha'], $post['lngPeriodo'], $post['lngEjercicio'], $concepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaIngresosMovimientosIRPF_VariasCuentas()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
        }
        
        //4º Cuenta 43 (cliente)
        if($post['esAbono'] === 'NO'){
            $DoH='D';
            $lngIngreso = desFormateaNumeroContabilidad($post['lngIngresoContabilidad']);
        }else{
            $DoH='H';
            $lngIngreso = -desFormateaNumeroContabilidad($post['lngIngresoContabilidad']);
        }
        
        
        $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaCli, $DoH,
                $lngIngreso, 0, $post['datFecha'], $post['lngPeriodo'], $post['lngEjercicio'], $concepto, $strUsuario,$db,$tipoAsiento);
        if($OK==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()<ROLLBACK");
            return false;
        }
        $contadorOrden++;
        
        
        //si se ha pagado se inserta
        if($post['optTipo'] === '1'){
            //4º Cuenta 43 (cliente)
            if($post['esAbono'] === 'NO'){
                $DoH='H';
            }else{
                $DoH='D';
            }
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaCli, $DoH,
                    $lngIngreso, 0, $post['datFecha'], $post['lngPeriodo'], $post['lngEjercicio'], $concepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()<ROLLBACK");
                return false;
            }
            $contadorOrden++;
            
            //5º Cuenta 57 (banco o caja)
            if($post['esAbono'] === 'NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }
            $strCuentaBancos = explode('-',$post['strCuentaBancos']);
            
            $OK=$this->tbmovimientos_insertar($idEmp, $asiento, $contadorOrden, $strCuentaBancos[0], $DoH,
                    $lngIngreso, 0, $post['datFecha'], $post['lngPeriodo'], $post['lngEjercicio'], $concepto, $strUsuario,$db,$tipoAsiento);
            if($OK==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()<ROLLBACK");
                return false;
            }
        }
        
        
        //AHORA SE INSERTA EN LA TABLA DE LOS IVAS
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
            
        //obtengo el IdIva (en este caso es Repercutido por lo que comienza por R)
        $IdIva=$this->tbmovimientos_iva_IdIva($db,'R',$asiento);
        if($IdIva==false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");

        //recorro todo el array $IVAs
        $cont = 1;
        foreach ($IVAs as $key => $value) {
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()>");
            //obtengo el Id
            $Id=$this->tbmovimientos_iva_Id($db); 
            if($Id==false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()<ROLLBACK");
                return false;
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->tbmovimientos_iva_Id()<OK");

            //ahora hacemos la insercion del iva
            //comprobamos si es asiento normal o abono
            if($post['esAbono'] === 'NO'){//asiento normal->el importe de iva es positivo
                $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                        Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                        " VALUES ($Id,'$IdIva',$cont,$asiento,$IdCliProv,".$value['base'].",$key,".$value['cuota'].",1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
            }else{//abono->el importe de iva es negativo 

                $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                        Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                        " VALUES ($Id,'$IdIva',$cont,$asiento,$IdCliProv,-".$value['base'].",$key,-".$value['cuota'].",1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
            }
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if(!$stmt){
                //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()<ROLLBACK");
                return false;
            }
            $cont++;
        }
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaAsientoMovimientos_SinIRPF()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function generarFacturaDePedido($usuario,$IdPedido,$fechaHoy){
        //1- Se guarda la factura en tbmisfacturas y tbmisfacturaslineas
        //2- Se actualiza las lineas de tbmispedidos y tbmispedidoslineas

        // 1
        //lo primero que hacemos es traernos los datos del pedido
        $pedido = $this->datosPedido($IdPedido);
               
        if($pedido == false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->generarFacturaDePedido()<ROLLBACK");
            return 'false';
        }
        
        //hay que guardar los datos en las tablas 'tbfacturas' y 'tbmisfacturaslineas'
        
        //guardo el numero de proyecto con este formato '20140001' donde las 4 primeras cifras son el año y las 4 ultimas la numeracion
        $numeroNuevaFactura=$this->leeNuevoNumeroFactura();
        
        //ahora busco la cuenta contable del IdArticulo, este bucle lo he hecho fuera del bucle de 
        //insercion en la tabla porque las funciones que uso me interfieren en la transaccion
        for($i=0;$i<count($pedido['DetalleFactura']);$i++){
            $IdArticulo = 'null';
            if(isset($pedido['DetalleFactura'][$i]['IdArticulo']) && $pedido['DetalleFactura'][$i]['IdArticulo'] !== ''){
                $IdArticulo = $pedido['DetalleFactura'][$i]['IdArticulo'];
            }
            $pedido['DetalleFactura'][$i]['IdArticulo'] = $IdArticulo;
            
            //extraigo la cuenta del articulo.
            //Primero extraigo la cuenta general, despues la cuenta del grupo (si hay), 
            //que sustituye a la general y por último la cuenta del articulo (si hay)
            $cuentaContable = $this->Parametro_general('cuentaContable',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
            $cuentaArticulo = $this->LeeArticulo($IdArticulo);
            $cuentaArticulo2 = explode('-',$cuentaArticulo[0]['CuentaContable']);
            $cuentaArticulo2 = $cuentaArticulo2[0];
            $cuentaGrupoArticulo = $this->LeeGrupo($cuentaArticulo[0]['IdGrupo']);
            if(isset($cuentaGrupoArticulo[0]['Cuenta']) && $cuentaGrupoArticulo[0]['Cuenta'] !== ''){
                $cuentaContable = $cuentaGrupoArticulo[0]['Cuenta'];
            }
            if(isset($cuentaArticulo[0]['CuentaContable']) && $cuentaArticulo2 !== ''){
                $cuentaContable = $cuentaArticulo2;
            }
            $pedido['DetalleFactura'][$i]['cuentaArticulo'] = $cuentaContable;
        }
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());
        
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarFacturaDePedido() || START TRANSACTION");
        
        //obtengo el idFactura
        $strSQL = "SELECT idFactura FROM tbmisfacturas ORDER BY idFactura DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarFacturaDePedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num=  mysql_num_rows($stmt);
            $idFactura=0;
            if($num>0){
                $row=  mysql_fetch_assoc($stmt);
                $idFactura=$row['idFactura']+1;
            }else{
                $idFactura=1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->generarFacturaDePedido()<ROLLBACK");
            return 'false';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarFacturaDePedido()|| idFactura : ".$idFactura);

        //ContactoHidden viene de esta forma CL.430000005 o CO.6
        if(is_numeric($pedido['Cliente'])){
            $contactoHidden=$pedido['Cliente'];
        }else{
            $contactoHidden=explode('.',$pedido['Cliente']);
            $contactoHidden=$contactoHidden[1];
        }
        
        //ahora compruebo si $fechaHoy trae datos,si es asi, sta es la fecha qeu inserto, sino
        //inserto la que viene de $pedido['FechaProximaFacturaPeriodica']
        if($fechaHoy === ''){
            $fechaPF = $pedido['FechaProximaFacturaPeriodica'];
        }else{
            $fechaPF = $fechaHoy;
        }
        
        //inserto en la tabla 'tbmisfacturas'
        $strSQL = "
                    INSERT INTO tbmisfacturas (IdFactura,NumFactura,IdPedido,Cliente,FechaFactura,
                                FechaVtoFactura,FormaPago,Estado,Retencion,lngIdUsuario,Borrado,Situacion,Referencia,CC_Trans) 
                    VALUES ($idFactura,'".$numeroNuevaFactura."',".$IdPedido.",'".$contactoHidden."','".fecha_to_DATETIME($fechaPF)."','".fecha_to_DATETIME($pedido['FechaProximaFacturaPeriodica'])."',
                            '".$pedido['FormaPago']."','Emitida',".$pedido['Retencion'].",$usuario,1,'En plazo','".$pedido['Referencia']."','".$pedido['CC_Trans']."')
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->generarFacturaDePedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );

        if(!$stmt){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->generarFacturaDePedido()<ROLLBACK");
            return 'false';
        }
        
        //ahora vamos a insertar las lineas de la factura (una insercion por cada linea) en la tabla 'tbmisfacturaslineas'
        //y también ponemos todas las lineas de este presupuesto (tbmispresupuestoslineas) el campo 'Facturada' en T = Total
        //recorro el array $lineasPresupuesto
        for($i=0;$i<count($pedido['DetalleFactura']);$i++){
            //saco el numero linea nuevo
            $numLinea=$this->numeroFacturaLineaNueva($db);
            $numLineaFactura=$i+1;
            
            
            
            //inserto en la tabla 'tbmisfacturaslineas'
            $strSQL = "
                        INSERT INTO tbmisfacturaslineas (IdFacturaLineas,IdFactura,NumLineaFactura,NumLineaPedido,IdPedidoLineas,IdArticulo,cuentaArticulo,DescripcionProducto,
                                    TipoIVA,CantidadPED,CantidadFAC,CantidadPEN,ImporteUnidad,ImportePED,ImporteFAC,ImportePEN,
                                    CuotaIvaPED,CuotaIvaFAC,CuotaIvaPEN,GenFacPed,Facturada) 
                        VALUES ($numLinea,$idFactura,$numLineaFactura,".$pedido['DetalleFactura'][$i]['NumLineaPedido'].",".$pedido['DetalleFactura'][$i]['IdPedidoLineas'].",".$pedido['DetalleFactura'][$i]['IdArticulo'].",'".$pedido['DetalleFactura'][$i]['cuentaArticulo']."','".$pedido['DetalleFactura'][$i]['concepto']."',".$pedido['DetalleFactura'][$i]['iva'].",".$pedido['DetalleFactura'][$i]['cantidad'].",
                                0,0,".$pedido['DetalleFactura'][$i]['precio'].",".$pedido['DetalleFactura'][$i]['importe'].",0,0,".$pedido['DetalleFactura'][$i]['cuota'].",0,0,'NO','NF')
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->generarFacturaDePedido()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->generarFacturaDePedido()<ROLLBACK");
                return 'false';
            }
            
            // 2
            //actualizo las lineas de tbmispedidoslineas (Facturada=T, GenPadPed=SI,
            //y los campos CantidadFAC, ImporteFAC, CuotaIvaFAC se les suma la cantidad, importe y couaIva
            //y a su vez se resta de los campos CantidadPEN, ImportePEN, CuotaIvaPEN)
            $strSQL = "
                        SELECT CantidadFAC,CantidadPEN,ImporteFAC,ImportePEN,CuotaIvaFAC,CuotaIvaPEN
                        FROM tbmispedidoslineas
                        WHERE IdPedidoLineas=".$pedido['DetalleFactura'][$i]['IdPedidoLineas']."
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->generarFacturaDePedido()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            if($stmt){
                $row=  mysql_fetch_assoc($stmt);
                //sumo los FAC
                $CantidadFAC=$row['CantidadFAC']+$pedido['DetalleFactura'][$i]['cantidad'];
                $ImporteFAC=$row['ImporteFAC']+$pedido['DetalleFactura'][$i]['importe'];
                $CuotaIvaFAC=$row['CuotaIvaFAC']+$pedido['DetalleFactura'][$i]['cuota'];
                //sumo los PEN (si sale negativo pongo 0)
                $CantidadPEN=$row['CantidadPEN']-$pedido['DetalleFactura'][$i]['cantidad'];
                if($CantidadPEN<0){
                    $CantidadPEN=0;
                }
                $ImportePEN=$row['ImportePEN']-$pedido['DetalleFactura'][$i]['importe'];
                if($ImportePEN<0){
                    $ImportePEN=0;
                }
                $CuotaIvaPEN=$row['CuotaIvaPEN']-$pedido['DetalleFactura'][$i]['cuota'];
                if($CuotaIvaPEN<0){
                    $CuotaIvaPEN=0;
                }
            }else{
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->generarFacturaDePedido()<ROLLBACK");
                return 'false';
            }
            
            //actualizo los datos de la tabla 'tbmispedidoslineas'
            $strSQL = "
                        UPDATE tbmispedidoslineas
                        SET Facturada='T',GenFacPed='SI',
                        CantidadFAC=$CantidadFAC,
                        ImporteFAC=$ImporteFAC,
                        CuotaIvaFAC=$CuotaIvaFAC,
                        CantidadPEN=$CantidadPEN,
                        ImportePEN=$ImportePEN,
                        CuotaIvaPEN=$CuotaIvaPEN
                        WHERE IdPedidoLineas=".$pedido['DetalleFactura'][$i]['IdPedidoLineas']."
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->generarFacturaDePedido()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            if(!$stmt){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->generarFacturaDePedido()<ROLLBACK");
                return 'false';
            }
        }

        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->generarFacturaDePedido()<COMMIT");
        
        $db->desconectar ();
        
        //todo correcto, devuelvo el IdFactura
        return $idFactura;
    }
    
    function PedidoActualizarFechaProximaFactura($IdPedido){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //busco los datos de este pedido
        $strSQL = "
                    SELECT P.TipoFactura,P.DiaPeriodica,P.FrecuenciaPeriodica,P.FechaProximaFacturaPeriodica,P.FechaFinalizacion
                    FROM tbmispedidos P
                    WHERE P.IdPedido=$IdPedido
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->PedidoActualizarFechaProximaFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        
        $resultado='';
        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
            }
        }else{
            //si ha fallado la consulta DEVOLVEMOS false
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->PedidoActualizarFechaProximaFactura()<FALSE");
            return 'false';
        }
        
        //ahora comprobamos si el pedido es puntual o periodico
        if($reg['TipoFactura'] === 'Puntual'){
            //al ser puntual este pedido ya esta terminado por lo que indico 
            //el campo 'FechaProximaFacturaPeriodica' a null
            
            //y actualizamos en la BBDD
            $strSQL = "
                        UPDATE tbmispedidos
                        SET FechaProximaFacturaPeriodica= null
                        WHERE IdPedido=$IdPedido
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->PedidoActualizarFechaProximaFactura()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $db->desconectar ();
            
            if($stmt){
                //todo a salido correcto, DEVOLVEMOS true
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->PedidoActualizarFechaProximaFactura()<TRUE");
                return 'true';
            }else{
                //si ha fallado la consulta DEVOLVEMOS false
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->PedidoActualizarFechaProximaFactura()<FALSE");
                return 'false';
            }
        }else
        if($reg['TipoFactura'] === 'Periodica'){
            //al ser periodico 
            //preparo la proxima fecha
            switch ($reg['FrecuenciaPeriodica']) {
                case 'Mensual':
                    $sumaMes = 1;
                    break;
                case 'Bimensual':
                    $sumaMes = 2;
                    break;
                case 'Trimestral':
                    $sumaMes = 3;
                    break;
                case 'Cuatrimestral':
                    $sumaMes = 4;
                    break;
                case 'Semestral':
                    $sumaMes = 6;
                    break;
                case 'Anual':
                    $sumaMes = 12;
                    break;
                default:
                    //si ha fallado switch DEVOLVEMOS false
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->PedidoActualizarFechaProximaFactura()<FALSE");
                    return 'NO';
            }
            
            //calculo la fecha nueva
            $strSQL = "
                        SELECT ADDDATE(P.FechaProximaFacturaPeriodica,INTERVAL $sumaMes MONTH) AS FechaNueva
                        FROM tbmispedidos P
                        WHERE P.IdPedido=$IdPedido
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->PedidoActualizarFechaProximaFactura()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            
            $fechaNueva = '';
            if($stmt){
                $row = mysql_fetch_array($stmt);
                $fechaNueva = $row['FechaNueva'];
            }else{
                //si ha fallado la consulta DEVOLVEMOS false
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->PedidoActualizarFechaProximaFactura()<FALSE");
                return 'false';
            }

            //si la FechaFinalizacion es null se graba la siguiente fecha en FechaProximaFacturaPeriodica
            if($reg['FechaFinalizacion'] == null || $reg['FechaFinalizacion'] === '' || $reg['FechaFinalizacion'] === '0000-00-00 00:00:00'){
                //y actualizamos en la BBDD
                $strSQL = "
                            UPDATE tbmispedidos
                            SET FechaProximaFacturaPeriodica= '$fechaNueva'
                            WHERE IdPedido=$IdPedido
                           ";
            }else{
                //ahora comparo esta $fechaNueva con la FechaFinalizacion 
                //si esta fecha es superior a FechaFinalizacion entonces es que ya esta terminado este pedido
                //por lo que paso 'FechaProximaFacturaPeriodica' a null
                $dif = strtotime($reg['FechaFinalizacion']) - strtotime($fechaNueva);

                //si sale positivo, es que la 'FechaProximaFacturaPeriodica' es inferior a 'FechaFinalizacion'
                //por lo que se graba en el pedido esta fecha
                if($dif >= 0){
                    //y actualizamos en la BBDD
                    $strSQL = "
                                UPDATE tbmispedidos
                                SET FechaProximaFacturaPeriodica= '$fechaNueva'
                                WHERE IdPedido=$IdPedido
                               ";
                }else{
                    //y actualizamos en la BBDD
                    $strSQL = "
                                UPDATE tbmispedidos
                                SET FechaProximaFacturaPeriodica= null
                                WHERE IdPedido=$IdPedido
                               ";
                }
            }
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                   " clsCADContabilidad->PedidoActualizarFechaProximaFactura()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar ( $strSQL );
            $db->desconectar ();
            
            if($stmt){
                //todo a salido correcto, DEVOLVEMOS true
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->PedidoActualizarFechaProximaFactura()<TRUE");
                return 'true';
            }else{
                //si ha fallado la consulta DEVOLVEMOS false
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->PedidoActualizarFechaProximaFactura()<FALSE");
                return 'false';
            }
        }
    }
    
    function listadoFacturasDelPedido($IdPedido){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //busco los datos de este pedido
        $strSQL = "
                    SELECT F.IdFactura,F.NumFactura,DATE_FORMAT(F.FechaFactura,'%d/%m/%Y') AS Fecha
                    FROM tbmisfacturas F
                    WHERE F.Borrado=1
                    AND F.IdPedido=$IdPedido
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->listadoFacturasDelPedido()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        $resultado='';
        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $datosFactura = $this->datosFactura($reg['IdFactura']);
                $importe = 0;
                $total = 0;
                for ($ii = 0; $ii < count($datosFactura['DetalleFactura']); $ii++) {
                    $importe = (float)$importe + $datosFactura['DetalleFactura'][$ii]['importe'];
                    $total = (float)$total + $datosFactura['DetalleFactura'][$ii]['total'];
                }
                $retencion = $importe * $datosFactura['Retencion'] / 100;
                $reg['importe'] = $total - $retencion;
                
                $resultado[] = $reg;
            }
        }else{
            //si ha fallado la consulta DEVOLVEMOS false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->listadoFacturasDelPedido()<FALSE");
            return 'false';
        }
        
        return $resultado;
    }
    
    function fechaUltimaFactura(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //busco los datos de este pedido
        $strSQL = "
                    SELECT DATE_FORMAT(F.FechaFactura,'%Y-%m-%d') AS Fecha
                    FROM tbmisfacturas F
                    WHERE F.Borrado=1
                    AND F.NumFactura REGEXP '^[0-9]+$'
                    ORDER BY F.FechaFactura DESC LIMIT 0,1
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->fechaUltimaFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        if($stmt){
            $row = mysql_fetch_array($stmt);
            //si ha fallado la consulta DEVOLVEMOS la fecha
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->fechaUltimaFactura()<".$row['Fecha']);
            return $row['Fecha'];
        }else{
            //si ha fallado la consulta DEVOLVEMOS false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->fechaUltimaFactura()<FALSE");
            return 'false';
        }
    }
    
    function verEjerciciosFacturas(){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //busco los datos de este pedido
        $strSQL = "
                    SELECT DISTINCT DATE_FORMAT(F.FechaFactura,'%Y') AS Ejercicio
                    FROM tbmisfacturas F
                    WHERE F.Borrado=1
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->fechaUltimaFactura()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        $resultado='';
        if($stmt){
            while($row=mysql_fetch_array($stmt)){
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $resultado[]=$valor;
                    }
                }
            }
        }else{
            //si ha fallado la consulta DEVOLVEMOS false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->listadoFacturasDelPedido()<FALSE");
            return 'false';
        }
        
        return $resultado;
    }
    
    function contabilizarVentas($datos){
        //se hacen los siguientes pasos:
        //
        //1º se guarda/actualiza los datos en la tabla "tbventas"
        //   de aqui se saca el numero de factura
        //
        //2º se guarda los datos en la tabla "tbmovimientos", que constara de tres lineas
        //     - Cuenta                 DoH       Cantidad    TipoAsiento  
        //   1 - 4300.00001            D (H)       Ventas      11N o 11A
        //   2 - 7000.xxxxx            H (D)       BaseI       11N o 11A (1)
        //   3 - 4770.00000            H (D)       IVA         11N o 11A
        //
        //(1) esta cuenta se saca de tbparametros_generales (cuentaContable)
        //Entre parentesis es cuando es un abono
        //De aqui saldra el numero de asiento
        //
        //3º se guarda los datos en la tabla "tbmovimientos_iva", que constara de una linea
        //     - IdIva        IdCliente    BaseI  Iva  CuotaIVA      TipoAsiento  
        //   1 - R000x            64 (2)                                  2
        //
        //   
        //   Y si todo a ido correctamente hacemos COMMIT

        $cuentaContable = $this->Parametro_general('cuentaContable',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        $IVA = $this->Parametro_general('IvaGenerico',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));
        
        //0º Pasos iniciales
        //obtengo el IdCliProv
        //este dato los busco en la tabla 'tbrelacionCliProv' de la BBDD de Contabilidad
        require_once '../general/conexion.php';
        $dbCont = new DbC();
        $dbCont->conectar($_SESSION['dbContabilidad']);
        
        $strSQL="
                SELECT IdCliProv FROM tbrelacioncliprov
                WHERE IdEmpresa = ".$_SESSION['idEmp']." AND codigo = '$cuentaContable' AND Borrado=0
                ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarVentas()|| SQL : ".$strSQL);
        $stmt = $dbCont->ejecutar ( $strSQL );
        $dbCont->desconectar();
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()<ROLLBACK");
            return false;
        }
        $row = mysql_fetch_array($stmt);
        $IdCliProv = $row['IdCliProv'];
        //si es null ( es una cuenta general 4000 00000 no hay cliente o proveedor 
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        if($IdCliProv === null){
            $IdCliProv = 'null';
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarVentas()|| IdCliProv : ".$IdCliProv);
        
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //compruebo si este IdVentas no esta contabilizado (por si se repite sin querer el POST)
        //Numero Factura Nuevo (en editar no esta el numero de factura todavia)
        if($datos['IdVenta'] === ''){
            $strSQL = "
                        SELECT Asiento FROM tbventas WHERE fecha = '".$datos['fecha']."' AND Borrado = 1
                       ";
        }else{
            $strSQL = "
                        SELECT Asiento FROM tbventas WHERE IdVenta = '".$datos['IdVenta']."'
                       ";
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar($strSQL);
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()<ROLLBACK");
            return false;
        }

        if($stmt){
            $num = mysql_num_rows($stmt);
            //si existe y es numerico es que está contabilizado (devuelvo contabilizado)
            if($num > 0){
                $row = mysql_fetch_array($stmt);
                if(is_numeric($row['Asiento'])){
                    //devolvemos false
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->contabilizarVentas()<ROLLBACK y false (esta contabilizado)");
                    return 'EstaContabilizada';
                }
            }
        }
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarVentas() || START TRANSACTION");

        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        $asiento = $this->numeroAsientoNuevo($db);

        //1º Paso
        //-------

        //Numero Factura Nuevo (en editar no esta el numero de factura todavia)
        $strSQL = "
                    SELECT IF(ISNULL(MAX(Factura)),1,MAX(Factura)+1) AS Factura FROM tbventas WHERE DATE_FORMAT(Fecha,'%Y') = ".date('Y')."
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar($strSQL);
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()<ROLLBACK");
            return false;
        }

        $row = mysql_fetch_array($stmt);
        $numFactura = $row['Factura'];
        
        //veo como viene el dato $datos['IdVenta']
        if($datos['IdVenta'] === '' || $datos['IdVenta'] === NULL){
            //se inserta una nueva linea en la tabla

            //IdVenta Nuevo
            $strSQL = "
                        SELECT IF(ISNULL(MAX(IdVenta)),1,MAX(IdVenta)+1) AS IdVenta FROM tbventas
                       ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->contabilizarVentas()|| SQL : ".$strSQL);
            $stmt = $db->ejecutar($strSQL);
            if(!$stmt){
                //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->contabilizarVentas()<ROLLBACK");
                return false;
            }
            
            $row = mysql_fetch_array($stmt);
            $IdVenta = $row['IdVenta'];


            $strSQL = "
                        INSERT INTO tbventas 
                        (IdVenta, Fecha, BaseI, IVA, Ventas, Asiento, Factura, Borrado)
                        VALUES ($IdVenta,'".$datos['fecha']."',".$datos['BaseI'].",".$datos['IVA'].",".$datos['Ventas'].",'$asiento',$numFactura,1)
                      ";
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->contabilizarVentas()|| SQL : ".$strSQL);
            
            $stmt = $db->ejecutar($strSQL);
            
        }else{
            //se actualiza la linea $datos['IdVenta']
            $strSQL="
                    UPDATE tbventas B
                    SET B.BaseI = ".$datos['BaseI'].",
                    B.IVA = ".$datos['IVA'].",
                    B.Ventas = ".$datos['Ventas'].",
                    B.Asiento = '$asiento',
                    B.Factura = $numFactura
                    WHERE B.IdVenta = ".$datos['IdVenta']."
                    ";
            
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->contabilizarVentas()|| SQL : ".$strSQL);
            
            $stmt = $db->ejecutar($strSQL);
            
        }
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()<ROLLBACK");
            return false;
        }
        
        
        //2º Paso
        //-------
        
        $strConcepto = "Nuestra Fra " . $numFactura;
        $esAbono = 'NO';
        if((float)$datos['Ventas'] < 0){
            $esAbono = 'SI';
        }
        
        //Cuenta 430000001 (Ventas)
        if($esAbono === 'NO'){
            $DoH='D';
            $tipoAsiento = '11N';
        }else{
            $DoH='H';
            $tipoAsiento = '11A';
        }
        
        $ejercicios = explode('-',$datos['fecha']);
        $ejercicio = $ejercicios[0];
        $mes = (int)$ejercicios[1];
        $fecha = $ejercicios[2].'/'.$ejercicios[1].'/'.$ejercicios[0];
        
        $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 1, '430000001', $DoH,
                abs($datos['Ventas']), 0, $fecha, $mes, $ejercicio, $strConcepto, $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()<ROLLBACK");
            return false;
        }
        
        
        //Cuenta 4770 (IVA)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 3, $this->IVAREPERCUTIDO, $DoH,
                abs($datos['IVA']), 0, $fecha, $mes, $ejercicio, $strConcepto, $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()<ROLLBACK");
            return false;
        }


        //Cuenta cuentaContable (BaseI)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        
        $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 2, $cuentaContable, $DoH,
                abs($datos['BaseI']), 0, $fecha, $mes, $ejercicio, $strConcepto, $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()<ROLLBACK");
            return false;
        }


        //AHORA SE INSERTA EN LA TABLA DE LOS IVAS
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarVentas()|| INSERTAR DATOS EN LA TABLA tbmovimientos_iva");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()>");
        //obtengo el Id
        $Id = $this->tbmovimientos_iva_Id($db); 
        if($Id === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_Id()<OK");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()>");
        //obtengo el IdIva (en este caso es Repercutido por lo que comienza por R)
        $IdIva = $this->tbmovimientos_iva_IdIva($db,'R',0);//0 es nuevo asiento
        if($IdIva === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->tbmovimientos_iva_IdIva()<OK");
        
        //ahora hacemos la insercion del iva
        //comprobamos si es asiento normal o abono
        $strSQL="INSERT INTO tbmovimientos_iva (Id,IdIva,IdIvaOrden,IdAsiento,IdCliProv,BaseImponible,Iva,CuotaIva,
                                                Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento)".
                " VALUES ($Id,'$IdIva',1,$asiento,$IdCliProv,".$datos['BaseI'].",$IVA,".$datos['IVA'].",1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."')";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarVentas()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarVentas()<ROLLBACK");
            return false;
        }
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarVentas()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function contabilizarBancos($datos){
        //se hacen los siguientes pasos:
        //
        //1º se actualiza los datos en la tabla "tbventas_bancos"
        //
        //2º se guarda los datos en la tabla "tbmovimientos", que constara de 2(Caja)/4(Banco) lineas
        //     - Cuenta                 DoH       Cantidad    TipoAsiento  
        //   1 - 5700.00000            D (H)       Cantidad        2  (Solo Caja)
        //   2 - 4300.00001            H (D)       Cantidad        2  (Solo Caja) 
        //   ***********************************************************************
        //   3 - 5720.xxxxx            D (H)       Cantidad        2  (Caja y Banco) (1)
        //   4 - 5700.00000            H (D)       Cantidad        2  (Caja y Banco)
        //
        //(1) esta cuenta es la que viene de CuentaBanco. Hay que añadir 5720...
        //Entre parentesis es cuando es un abono
        //De aqui saldra el numero de asiento
        //
        //   
        //   Y si todo a ido correctamente hacemos COMMIT

        
        
        //0º Pasos iniciales
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //compruebo si este IdVentas no esta contabilizado (por si se repite sin querer el POST)
        //Numero Factura Nuevo (en editar no esta el numero de factura todavia)
        if($datos['IdBanco'] === ''){
            $strSQL = "
                        SELECT Asiento FROM tbventas_bancos WHERE Fecha = '".$datos['fecha']."' AND Borrado = 1
                       ";
        }else{
            $strSQL = "
                        SELECT Asiento FROM tbventas_bancos WHERE IdBanco = '".$datos['IdBanco']."'
                       ";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarBancos()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar($strSQL);
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarBancos()<ROLLBACK");
            return false;
        }
        
        if($stmt){
            $num = mysql_num_rows($stmt);
            //si existe y es numerico es que está contabilizado (devuelvo contabilizado)
            if($num > 0){
                $row = mysql_fetch_array($stmt);
                if(is_numeric($row['Asiento'])){
                    //devolvemos false
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->contabilizarBancos()<FALSE (esta contabilizado)");
                    return 'EstaContabilizada';
                }
            }
        }
        
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarBancos() || START TRANSACTION");

        //veo que numero de asiento 
        $asiento = $this->numeroAsientoNuevo($db);

        //1º Paso
        //-------

        //se actualiza la linea $datos['IdBanco']
        $strSQL="
                UPDATE tbventas_bancos B
                SET B.Asiento = $asiento
                WHERE B.IdBanco = ".$datos['IdBanco']."
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarBancos()|| SQL : ".$strSQL);

        $stmt = $db->ejecutar($strSQL);
            
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarBancos()<ROLLBACK");
            return false;
        }
        
        
        //2º Paso
        //-------
        
        $esAbono = 'NO';
        if((float)$datos['Cantidad'] < 0){
            $esAbono = 'SI';
        }
        
        //Cuenta 570000000 (Caja)
        if($esAbono === 'NO'){
            $DoH='D';
            $tipoAsiento = '2';
        }else{
            $DoH='H';
            $tipoAsiento = '2';
        }
        
        $ejercicios = explode('-',$datos['fecha']);
        $ejercicio = $ejercicios[0];
        $mes = (int)$ejercicios[1];
        $fecha = $ejercicios[2].'/'.$ejercicios[1].'/'.$ejercicios[0];
        
        $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 1, '570000000', $DoH,
                abs($datos['Cantidad']), 0, $fecha, $mes, $ejercicio, "Cobro efectivo", $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarBancos()<ROLLBACK");
            return false;
        }
        
        
        //Cuenta 430000001 (cliente)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 2, '430000001', $DoH,
                abs($datos['Cantidad']), 0, $fecha, $mes, $ejercicio, "Cobro efectivo", $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarBancos()<ROLLBACK");
            return false;
        }

        //ahora vemos la vble $datos[CuentaBanco], si es 0 es caja, entonces ya esta terminado este asiento
        //si es distinto de 570000000, s la cuenta del banco donde se hace el ingreso, se be incluir dos lineas
        //mas al asiento
        if((int)$datos['CuentaBanco'] !== 570000000){
            //Cuenta CuentaBanco (debo formatearla, añadiendo el 5720...)
            $cuentaBanco = $datos['CuentaBanco'];
//            while(strlen($cuentaBanco)<5){
//                $cuentaBanco = '0' . $cuentaBanco;
//            }
//            $cuentaBanco = '5720' . $cuentaBanco;
            if($esAbono==='NO'){
                $DoH='D';
            }else{
                $DoH='H';
            }

            $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 3, $cuentaBanco, $DoH,
                    abs($datos['Cantidad']), 0, $fecha, $mes, $ejercicio, "Ingreso efectivo", $_SESSION['strUsuario'],$db,$tipoAsiento);
            if($OK === false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->contabilizarBancos()<ROLLBACK");
                return false;
            }
            
            //Cuenta 570000000 (Caja)
            if($esAbono === 'NO'){
                $DoH='H';
                $tipoAsiento = '2';
            }else{
                $DoH='D';
                $tipoAsiento = '2';
            }

            $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 4, '570000000', $DoH,
                    abs($datos['Cantidad']), 0, $fecha, $mes, $ejercicio, "Ingreso efectivo", $_SESSION['strUsuario'],$db,$tipoAsiento);
            if($OK === false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->contabilizarBancos()<ROLLBACK");
                return false;
            }
        }

        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarBancos()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function contabilizarTarjetas($datos){
        //se hacen los siguientes pasos:
        //
        //1º se actualiza los datos en la tabla "tbventas_tarjetas"
        //
        //2º se guarda los datos en la tabla "tbmovimientos", estos asientos se haran de dos formas
        //
        //   Forma 1: Para Tarjeta Visa 
        //
        //     - Cuenta                 DoH       Cantidad    TipoAsiento  
        //   1 - 5750.xxxxx            D (H)       Bruto           2  (1)
        //   2 - 4300.00001            H (D)       Bruto           2   
        //   3 - 5720.xxxxx            D (H)       Bruto           2  (2)
        //   4 - 5750.xxxxx            H (D)       Bruto           2  (1)
        //   5 - 6262.00000            D (H)       Comision        2
        //   6 - 5720.xxxxx            H (D)       Comision        2  (2)
        //
        //   Forma 2: Para el resto de tarjetas 
        //
        //     - Cuenta                 DoH       Cantidad    TipoAsiento  
        //   1 - 5750.xxxxx            D (H)       Bruto           2  (1)
        //   2 - 4300.00001            H (D)       Bruto           2   
        //   3 - 5720.xxxxx            D (H)       Liquido         2  (2)
        //   4 - 5750.xxxxx            H (D)       Bruto           2  (1)
        //   5 - 6262.00000            D (H)       Comision        2
        //
        //(1) Esta cuenta es la que viene de TipoTarjeta.
        //(2) esta cuenta es la que viene de CuentaTarjeta. Hay que añadir 5720...
        //
        //Entre parentesis es cuando es un abono
        //De aqui saldra el numero de asiento
        //
        //   
        //   Y si todo a ido correctamente hacemos COMMIT
        
        
        //0º Pasos iniciales
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //compruebo si este IdVentas no esta contabilizado (por si se repite sin querer el POST)
        //Numero Factura Nuevo (en editar no esta el numero de factura todavia)
        if($datos['IdTarjeta'] === ''){
            $strSQL = "
                        SELECT Asiento FROM tbventas_tarjetas WHERE Fecha = '".$datos['fecha']."' AND Borrado = 1
                       ";
        }else{
            $strSQL = "
                        SELECT Asiento FROM tbventas_tarjetas WHERE IdTarjeta = '".$datos['IdTarjeta']."'
                       ";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarTarjetas()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar($strSQL);
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarTarjetas()<ROLLBACK");
            return false;
        }
        
        if($stmt){
            $num = mysql_num_rows($stmt);
            //si existe y es numerico es que está contabilizado (devuelvo contabilizado)
            if($num > 0){
                $row = mysql_fetch_array($stmt);
                if(is_numeric($row['Asiento'])){
                    //devolvemos false
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->contabilizarTarjetas()<FALSE (esta contabilizado)");
                    return 'EstaContabilizada';
                }
            }
        }
        
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarTarjetas() || START TRANSACTION");

        //veo que numero de asiento 
        $asiento = $this->numeroAsientoNuevo($db);

        //1º Paso
        //-------

        //se actualiza la linea $datos['IdTarjeta']
        $strSQL="
                UPDATE tbventas_tarjetas B
                SET B.Asiento = $asiento
                WHERE B.IdTarjeta = ".$datos['IdTarjeta']."
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarTarjetas()|| SQL : ".$strSQL);

        $stmt = $db->ejecutar($strSQL);
            
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarTarjetas()<ROLLBACK");
            return false;
        }
        
        
        //2º Paso
        //-------
        
        //Cuenta 5750.xxxxx (D)
        $esAbono = 'NO';
        if((float)$datos['Bruto'] < 0){
            $esAbono = 'SI';
        }
        
        //Cuenta 5750.xxxxx (TipoTarjeta) (D)
        if($esAbono === 'NO'){
            $DoH='D';
            $tipoAsiento = '2';
        }else{
            $DoH='H';
            $tipoAsiento = '2';
        }
        
        $ejercicios = explode('-',$datos['fecha']);
        $ejercicio = $ejercicios[0];
        $mes = (int)$ejercicios[1];
        $fecha = $ejercicios[2].'/'.$ejercicios[1].'/'.$ejercicios[0];
        
        $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 1, $datos['TipoTarjeta'], $DoH,
                abs($datos['Bruto']), 0, $fecha, $mes, $ejercicio, "Cobro del dia", $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarTarjetas()<ROLLBACK");
            return false;
        }


        //Cuenta 430000001 (cliente)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 2, '430000001', $DoH,
                abs($datos['Bruto']), 0, $fecha, $mes, $ejercicio, "Cobro del dia", $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarTarjetas()<ROLLBACK");
            return false;
        }

        //Cuenta CuentaTarjeta (debo formatearla, añadiendo el 5720...)
        $cuentaTarjeta = $datos['CuentaTarjeta'];
//        while(strlen($cuentaTarjeta)<5){
//            $cuentaTarjeta = '0' . $cuentaTarjeta;
//        }
//        $cuentaTarjeta = '5720' . $cuentaTarjeta;
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        
        //vemos si es de la Forma 1 o Forma 2
        $strSQL = "
                    SELECT Nombre FROM tbcuenta WHERE NumCuenta = '".$datos['TipoTarjeta']."' AND Borrado = 0
                   ";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarTarjetas()|| SQL : ".$strSQL);

        $stmt = $db->ejecutar($strSQL);
            
        if($stmt){
            $row = mysql_fetch_array($stmt);
            $nombreTipoTarjeta = $row['Nombre'];
        }else{
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarTarjetas()<ROLLBACK");
            return false;
        }
        $cantidad3 = abs($datos['Liquido']);
        if($nombreTipoTarjeta === 'Visa'){
            $cantidad3 = abs($datos['Bruto']);
        }
        

        $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 3, $cuentaTarjeta, $DoH,
                $cantidad3, 0, $fecha, $mes, $ejercicio, "Ingreso TC", $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarTarjetas()<ROLLBACK");
            return false;
        }


        //Cuenta 5750.xxxxx (TipoTarjeta) (H)
        if($esAbono === 'NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        
        $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 4, $datos['TipoTarjeta'], $DoH,
                abs($datos['Bruto']), 0, $fecha, $mes, $ejercicio, "Ingreso TC", $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarTarjetas()<ROLLBACK");
            return false;
        }


        //Cuenta 6262.00000 (Comision)
        if($esAbono === 'NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }
        
        $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 5, '626200000', $DoH,
                abs($datos['Comision']), 0, $fecha, $mes, $ejercicio, "Ingreso TC", $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarTarjetas()<ROLLBACK");
            return false;
        }

        
        //Cuenta 5720.xxxxx (Comision)(Visa)
        if($nombreTipoTarjeta === 'Visa'){
            if($esAbono === 'NO'){
                $DoH='H';
            }else{
                $DoH='D';
            }

            $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 6, $cuentaTarjeta, $DoH,
                    abs($datos['Comision']), 0, $fecha, $mes, $ejercicio, "Ingreso TC", $_SESSION['strUsuario'],$db,$tipoAsiento);
            if($OK === false){
                //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
                $db->ejecutar ("ROLLBACK");
                $db->desconectar ();
                logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                        " clsCADContabilidad->contabilizarTarjetas()<ROLLBACK");
                return false;
            }
        }
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarTarjetas()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function contabilizarCheque($datos){
        //se hacen los siguientes pasos:
        //
        //1º se actualiza los datos en la tabla "tbventas_tarjetas"
        //
        //2º se guarda los datos en la tabla "tbmovimientos", estos asientos se haran de esta forma
        //
        //     - Cuenta                 DoH       Cantidad    TipoAsiento  
        //   1 - 4100.xxxxx            D (H)       Bruto           2  (1)   
        //   2 - 4300.00001            H (D)       Bruto           2
        //   3 - 5720.xxxxx            D (H)       Liquido         2  (2)
        //   4 - 4100.xxxxx            H (D)       Liquido         2  (1)
        //
        //(1) Esta cuenta es la que viene de TipoTarjeta.
        //(2) esta cuenta es la que viene de CuentaTarjeta. Hay que añadir 5720...
        //
        //Entre parentesis es cuando es un abono
        //De aqui saldra el numero de asiento
        //
        //   
        //   Y si todo a ido correctamente hacemos COMMIT
        
        
        //0º Pasos iniciales
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //compruebo si este IdVentas no esta contabilizado (por si se repite sin querer el POST)
        if($datos['IdTarjeta'] === ''){
            $strSQL = "
                        SELECT Asiento FROM tbventas_tarjetas WHERE Fecha = '".$datos['fecha']."' AND Borrado = 1
                       ";
        }else{
            $strSQL = "
                        SELECT Asiento FROM tbventas_tarjetas WHERE IdTarjeta = '".$datos['IdTarjeta']."'
                       ";
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarCheque()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar($strSQL);
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarCheque()<ROLLBACK");
            return false;
        }
        
        if($stmt){
            $num = mysql_num_rows($stmt);
            //si existe y es numerico es que está contabilizado (devuelvo contabilizado)
            if($num > 0){
                $row = mysql_fetch_array($stmt);
                if(is_numeric($row['Asiento'])){
                    //devolvemos false
                    $db->desconectar ();
                    logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                            " clsCADContabilidad->contabilizarCheque()<FALSE (esta contabilizado)");
                    return 'EstaContabilizada';
                }
            }
        }
        
        
        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarCheque() || START TRANSACTION");

        //veo que numero de asiento 
        $asiento = $this->numeroAsientoNuevo($db);

        //1º Paso
        //-------

        //se actualiza la linea $datos['IdTarjeta']
        $strSQL="
                UPDATE tbventas_tarjetas B
                SET B.Asiento = $asiento
                WHERE B.IdTarjeta = ".$datos['IdTarjeta']."
                ";

        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarCheque()|| SQL : ".$strSQL);

        $stmt = $db->ejecutar($strSQL);
            
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarCheque()<ROLLBACK");
            return false;
        }
        
        
        //2º Paso
        //-------
        
        //Cuenta 4100.xxxxx (D)
        $esAbono = 'NO';
        if((float)$datos['Bruto'] < 0){
            $esAbono = 'SI';
        }
        
        //Cuenta 4100.xxxxx (TipoTarjeta)[cheque] (D)
        if($esAbono === 'NO'){
            $DoH='D';
            $tipoAsiento = '2';
        }else{
            $DoH='H';
            $tipoAsiento = '2';
        }
        
        $ejercicios = explode('-',$datos['fecha']);
        $ejercicio = $ejercicios[0];
        $mes = (int)$ejercicios[1];
        $fecha = $ejercicios[2].'/'.$ejercicios[1].'/'.$ejercicios[0];
        
        $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 1, $datos['TipoTarjeta'], $DoH,
                abs($datos['Bruto']), 0, $fecha, $mes, $ejercicio, "Cobro del dia", $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarCheque()<ROLLBACK");
            return false;
        }


        //Cuenta 430000001 (cliente)
        if($esAbono==='NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }
        $OK=$this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 2, '430000001', $DoH,
                abs($datos['Bruto']), 0, $fecha, $mes, $ejercicio, "Cobro del dia", $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarCheque()<ROLLBACK");
            return false;
        }

        //Cuenta CuentaTarjeta (debo formatearla, añadiendo el 5720...)
        $cuentaTarjeta = $datos['CuentaTarjeta'];
//        while(strlen($cuentaTarjeta)<5){
//            $cuentaTarjeta = '0' . $cuentaTarjeta;
//        }
//        $cuentaTarjeta = '5720' . $cuentaTarjeta;
        if($esAbono==='NO'){
            $DoH='D';
        }else{
            $DoH='H';
        }

        $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 3, $cuentaTarjeta, $DoH,
                abs($datos['Liquido']), 0, $fecha, $mes, $ejercicio, "Ingreso Cheque", $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarCheque()<ROLLBACK");
            return false;
        }


        //Cuenta 4100.xxxxx (H)
        if($esAbono === 'NO'){
            $DoH='H';
        }else{
            $DoH='D';
        }

        $OK = $this->tbmovimientos_insertar($_SESSION['idEmp'], $asiento, 4, $datos['TipoTarjeta'], $DoH,
                abs($datos['Liquido']), 0, $fecha, $mes, $ejercicio, "Ingreso Cheque", $_SESSION['strUsuario'],$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->contabilizarCheque()<ROLLBACK");
            return false;
        }
        
        
        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->contabilizarCheque()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    
    function diario($get){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        //busco los datos de este pedido
        $strSQL = "
                    SELECT M.asiento, M.orden, DATE_FORMAT(M.fechaApunte,'%d/%m/%Y') AS Fecha, 
                    M.idCuenta, M.concepto, IF(M.DoH = 'D',M.cantidad,'') AS Debe,
                    IF(M.DoH = 'H',M.cantidad,'') AS Haber
                    FROM tbmovimientos M
                    WHERE M.Borrado = 1
                   ";
        
        //indico los filtros
        if($get['datFechaInicio'] !==''){
            $strSQL = $strSQL . " AND M.fechaApunte >= '" . fecha_to_DATETIME($get['datFechaInicio']) . "'";
        }
        if($get['datFechaFin'] !==''){
            $strSQL = $strSQL . " AND M.fechaApunte <= '" . fecha_to_DATETIME_F($get['datFechaFin']) . "'";
        }
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
               " clsCADContabilidad->diario()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();

        
        $resultado='';
        if($stmt){
            while($row = mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
        }else{
            //si ha fallado la consulta DEVOLVEMOS false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->diario()<FALSE");
            return 'false';
        }
        
        return $resultado;
    }
    
    
    function AltaNomina($post, $strUsuario, $idEmp){
        //se inserta null en las tablas tbmovimeitos_iva y tbretencion_irpf
        $IdCliProv = 'null';
        
        //var_dump($post);die;
        
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());


        //como voy a realizar varias operaciones contra la BBDD
        //lo hare utilizando las transacciones en MySQL
        $db->ejecutar ("START TRANSACTION");
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaNomina() || START TRANSACTION");

        //veo que numero de asiento viene, si es 0 es un asiento nuevo, sino es el asiento a insertar
        $asiento = $this->numeroAsientoNuevo($db);

        
        //Estructura del asiento
        //    Orden   |   Cuenta   | DoH  |  cantidad  |  concepto   |  TipoAsiento
        //--------------------------------------------------------------------------
        //      1     | 640000000  |  D   |      2000  |  nomina ... |    3N o 3A
        //      2     | 475100000  |  H   |       200  |  nomina ... |    3N o 3A
        //      3     | 642000000  |  H   |        20  |  nomina ... |    3N o 3A
        //      4     | 465000000  |  H   |      1780  |  nomina ... |    3N o 3A
        //      5     | 642000000  |  D   |       700  |  nomina ... |    3N o 3A
        //      6     | 476000000  |  H   |       700  |  nomina ... |    3N o 3A
        
        
        
        //1º Cuenta 6400 (Importe Bruto)
        $esAbono = $post['esAbono'];
        $lngBruto = $post['lngBruto'];
        $datFecha = $post['datFecha'];
        $lngPeriodo = $post['lngPeriodo'];
        $lngEjercicio = $post['lngEjercicio'];
        $strConcepto = addslashes($post['strConcepto']);
        $lngEjercicio = $post['lngEjercicio'];
        
        if($esAbono === 'NO'){
            $DoH = 'D';
            $tipoAsiento = '3N';
        }else{
            $DoH = 'H';
            $tipoAsiento = '3A';
        }
        $OK = $this->tbmovimientos_insertar($idEmp, $asiento, 1, 640000000, $DoH,
                $lngBruto, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaNomina()<ROLLBACK");
            return false;
        }
        
        
        //2º Cuenta 4751 (Retencion IRPF)
        $lngIRPF = $post['lngIRPF'];
        
        if($esAbono === 'NO'){
            $DoH = 'H';
        }else{
            $DoH = 'D';
        }
        $OK = $this->tbmovimientos_insertar($idEmp, $asiento, 2, $this->IRPF, $DoH,
                $lngIRPF, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaNomina()<ROLLBACK");
            return false;
        }
        
        
        //3º Cuenta 6420 (Retencion Seg Sociales Trabajador)
        $lngSSTrab = $post['lngSSTrab'];
        
        if($esAbono === 'NO'){
            $DoH = 'H';
        }else{
            $DoH = 'D';
        }
        $OK = $this->tbmovimientos_insertar($idEmp, $asiento, 3, 642000000, $DoH,
                $lngSSTrab, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaNomina()<ROLLBACK");
            return false;
        }
        

        //4º Cuenta 4650 (Importe Líquido)
        $lngLiquido = $post['lngLiquido'];
        
        if($esAbono === 'NO'){
            $DoH = 'H';
        }else{
            $DoH = 'D';
        }
        $OK = $this->tbmovimientos_insertar($idEmp, $asiento, 4, 465000000, $DoH,
                $lngLiquido, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaNomina()<ROLLBACK");
            return false;
        }

        
        
        //5º Cuenta 6420 (Retencion Seg Sociales Empresa)
        $lngSSEmp = $post['lngSSEmp'];
        
        if($esAbono === 'NO'){
            $DoH = 'D';
        }else{
            $DoH = 'H';
        }
        $OK = $this->tbmovimientos_insertar($idEmp, $asiento, 5, 642000000, $DoH,
                $lngSSEmp, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaNomina()<ROLLBACK");
            return false;
        }


        //6º Cuenta 4760 (Retencion Seg Sociales Empresa)
        if($esAbono === 'NO'){
            $DoH = 'H';
        }else{
            $DoH = 'D';
        }
        $OK = $this->tbmovimientos_insertar($idEmp, $asiento, 6, 476000000, $DoH,
                $lngSSEmp, 0, $datFecha, $lngPeriodo, $lngEjercicio, $strConcepto, $strUsuario,$db,$tipoAsiento);
        if($OK === false){
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaNomina()<ROLLBACK");
            return false;
        }


        //POR ULTIMO SE INSERTA EN LA TABLA DEL IRPF tbretenciones_irpf
        //obtengo el idMovimiento
        $strSQL = "SELECT Id FROM tbretenciones_irpf ORDER BY Id DESC LIMIT 0,1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaNomina()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if($stmt){
            $num = mysql_num_rows($stmt);
            $Id = 0;
            if($num > 0){
                $row = mysql_fetch_assoc($stmt);
                $Id = $row['Id']+1;
            }else{
                $Id = 1;
            }
        }else{
            //si ha fallado la consulta hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaNomina()<ROLLBACK");
            return false;
        }
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaNomina()|| Id : ".$Id);
        
        //ahora hacemos la insercion del IRPF
        //comprobamos si es asiento normal o abono
        $lngCantidad = $lngIRPF;
        $lngPorcientoIRPF = (float)round($lngIRPF / $lngBruto * 100,2);
        
        if($esAbono === 'NO'){//asiento normal->el importe de IRPF es positivo
            //nada
        }else{//Abono->el importe del IRPF es negativo
            $lngCantidad = -$lngCantidad;
            $lngIRPF = -$lngIRPF;
        }
        
        $strSQL="INSERT INTO tbretenciones_irpf (Id,IdAsiento,IdCliProv,BaseImponible,Retencion,ImporteRetencion,
                                                Borrado,datFechaStatus,lngIdEmpleadoStatus,TipoAsiento,Clave)".
                " VALUES ($Id,$asiento,$IdCliProv,$lngBruto,$lngPorcientoIRPF,$lngIRPF,1,now(),".$_SESSION['usuario'].",'".$tipoAsiento."','G')";
        
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaNomina()|| SQL : ".$strSQL);
        $stmt = $db->ejecutar ( $strSQL );
        if(!$stmt){
            //si ha fallado la insercion hacemos ROLLBACK Y DEVOLVEMOS false
            $db->ejecutar ("ROLLBACK");
            $db->desconectar ();
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->AltaNomina()<ROLLBACK");
            return false;
        }



        //si todas las operaciones contra la BBDD se han efectuado correctamente se hace COMMIT y devolvemos true
        $db->ejecutar ("COMMIT");
        
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->AltaNomina()<COMMIT");
        
        $db->desconectar ();
        
        // actualizo la tabla 'tbacumulados'
        $this->actualizar_tbacumulados();
        
        return $asiento;
    }
    

    function DatosAsientoNomina($Asiento,$esAbono){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());

        
        //array donde guardo los datos
        $datos = "";

        //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
        $strSQL =  "SELECT orden,idCuenta,DoH,cantidad,ejercicio,periodo,concepto,DATE_FORMAT(fechaApunte,'%d/%m/%Y') AS Fecha,Borrado
                    FROM tbmovimientos
                    WHERE asiento=$Asiento
                    AND Borrado = 1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DatosAsientoNomina()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        $resultado = '';
        if($stmt){
            while($row = mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
        }else{
            //si ha fallado la consulta DEVOLVEMOS false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsientoNomina()<FALSE");
            return false;
        }
        
        //veo el array, si viene vacio, es que n ha encontrado el asiento, devuelvo false
        if($resultado === ''){
            return false;
        }else{
            //ahora guardo los datos en el array
            $datos['lngPeriodo'] = $resultado[0]['periodo'];
            $datos['lngEjercicio'] = $resultado[0]['ejercicio'];
            $datos['datFecha'] = $resultado[0]['Fecha'];
            $datos['strConcepto'] = $resultado[0]['concepto'];

            for ($i = 0; $i < count($resultado); $i++) {
                //bruto - 640000000
                if($resultado[$i]['idCuenta'] === '640000000' && $resultado[$i]['DoH'] === 'D'){
                    $datos['lngBruto'] = $resultado[$i]['cantidad'];
                }
                //irpf - 475100000
                if($resultado[$i]['idCuenta'] === '475100000' && $resultado[$i]['DoH'] === 'H'){
                    $datos['lngIRPF'] = $resultado[$i]['cantidad'];
                }
                //SS trabajador - 642000000
                if($resultado[$i]['idCuenta'] === '642000000' && $resultado[$i]['DoH'] === 'H'){
                    $datos['lngSSTrab'] = $resultado[$i]['cantidad'];
                }
                //Importe Liquido - 465000000
                if($resultado[$i]['idCuenta'] === '465000000' && $resultado[$i]['DoH'] === 'H'){
                    $datos['lngLiquido'] = $resultado[$i]['cantidad'];
                }
                //SS Empresa - 642000000
                if($resultado[$i]['idCuenta'] === '642000000' && $resultado[$i]['DoH'] === 'D'){
                    $datos['lngSSEmp'] = $resultado[$i]['cantidad'];
                }
            }
        }
        
        //devuelvo los datos
        return $datos;
    }
    
    
    function DatosLineaMovimientos($IdLinea){
        require_once '../general/'.$_SESSION['mapeo'];
        $db = new Db();
        $db->conectar($this->getStrBD());


        //Extraemos de la tabla 'tbmovimientos' los datos de la cuenta
        $strSQL =  "SELECT idCuenta,DoH,cantidad,Borrado
                    FROM tbmovimientos
                    WHERE asiento=$Asiento
                    AND Borrado = 1";
        logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                " clsCADContabilidad->DatosAsientoNomina()|| SQL : ".$strSQL);
        
        $stmt = $db->ejecutar ( $strSQL );
        $db->desconectar ();
        
        $resultado = '';
        if($stmt){
            while($row = mysql_fetch_array($stmt)){
                $reg='';
                foreach($row as $propiedad=>$valor){
                    if(!is_numeric($propiedad)){
                        $reg[$propiedad]=$valor;
                    }
                }
                $resultado[]=$reg;
            }
        }else{
            //si ha fallado la consulta DEVOLVEMOS false
            logger('traza','clsCADContabilidad.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().
                    " clsCADContabilidad->DatosAsientoNomina()<FALSE");
            return false;
        }


        
    }
}
?>