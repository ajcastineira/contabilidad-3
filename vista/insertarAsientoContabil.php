<?phpsession_start();//carga la conexion MySQLrequire_once '../general/funcionesGenerales.php';require_once '../general/'.$_SESSION['mapeo'];require_once '../general/myLogger.php';$db = new Db();//carga conexion Access Contabil.Mdbrequire_once '../MovimientosImpExp/msaccess.class.php';$dbAccess = new msaccess();require_once '../CAD/clsCADContabilidad.php';$clsCADContabilidad = new clsCADContabilidad();$codigoEmpresa = $clsCADContabilidad->Parametro_general('codigoEmpresa',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));$tipoContador = $clsCADContabilidad->Parametro_general('Tipo Contador',date('Y-m-d H:i:s'),date('Y-m-d H:i:s'));//cojemos los parametros de la URL$idAsiento = $_GET["idAsiento"];$color = $_GET["backgroundcolor"];$numeroProceso = $_GET["numeroProceso"];echo '<tr style="background:'.$color.'" align="center">';echo '<td>Asiento '.$idAsiento.': ';//ANTIGUA 11/4/2016//$strSQL = "//            SELECT M.*,F.asiento AS asientoF,F.NumFactura//            FROM tbmovimientos M LEFT JOIN tbmisfacturas F ON (M.asiento=F.asiento)//            WHERE M.Borrado=1//            AND M.Exportado IS NULL//            AND M.asiento=$idAsiento//          ";//consulta de tbmisfacturas y tbventas//$strSQL = "//        (SELECT M.*,F.asiento AS asientoF,F.NumFactura,'F'//        FROM tbmovimientos M LEFT JOIN tbmisfacturas F ON (M.asiento=F.asiento)//        WHERE M.Borrado=1//        AND M.Exportado IS NULL//        AND M.asiento=$idAsiento)//        UNION //        (SELECT M.*,F.asiento AS asientoF,F.Factura AS NumFactura,'V' //        FROM tbmovimientos M LEFT JOIN tbventas F ON (M.asiento=F.asiento)//        WHERE M.Borrado=1//        AND M.Exportado IS NULL//        AND M.asiento=$idAsiento)//          ";//selecciono los datos de el asiento en la tabla "tbmovimientos"$strSQL = "            SELECT *            FROM tbmovimientos M            WHERE M.Borrado=1            AND M.Exportado IS NULL            AND M.asiento=$idAsiento          ";logger('traza','insertarAsientoContabil.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().        " || SQL : ".$strSQL);$db->conectar($_SESSION['mapeo']);$stmt = $db->ejecutar ( $strSQL );$db->desconectar();$asiento='';if($stmt){    while($row = mysql_fetch_array($stmt)){        $mov='';        foreach($row as $propiedad=>$valor){            if(!is_numeric($propiedad)){                $mov[$propiedad]=$valor;            }        }        $asiento[]=$mov;    }}else{    echo '... ERROR';    die;}//ahora selecciono los datos de el asiento en la tabla "tbmisfacturas" (si hay)$strSQL = "            SELECT F.asiento AS asientoF,F.NumFactura            FROM tbmisfacturas F            WHERE F.Borrado=1            AND F.asiento=$idAsiento          ";logger('traza','insertarAsientoContabil.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().        " || SQL : ".$strSQL);$db->conectar($_SESSION['mapeo']);$stmt = $db->ejecutar ( $strSQL );$db->desconectar();$factura='';if($stmt){    while($row = mysql_fetch_array($stmt)){        foreach($row as $propiedad=>$valor){            if(!is_numeric($propiedad)){                $factura[$propiedad]=$valor;            }        }    }}else{    echo '... ERROR';    die;}//si hay datos los incorporo al array $asientoif(is_array($factura)){    for ($i = 0; $i < count($asiento); $i++) {        $asiento[$i]['asientoF'] = $factura['asientoF'];        $asiento[$i]['NumFactura'] = $factura['NumFactura'];        $asiento[$i]['Tipo'] = 'Factura';    }}//y por ultimo busco si hay asientos en "tbventas" (si hay)$strSQL = "            SELECT F.asiento AS asientoF,F.Factura            FROM tbventas F            WHERE F.Borrado=1            AND F.Asiento=$idAsiento              ";logger('traza','insertarAsientoContabil.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().        " || SQL : ".$strSQL);$db->conectar($_SESSION['mapeo']);$stmt = $db->ejecutar ( $strSQL );$db->desconectar();$venta='';if($stmt){    while($row = mysql_fetch_array($stmt)){        foreach($row as $propiedad=>$valor){            if(!is_numeric($propiedad)){                $venta[$propiedad]=$valor;            }        }    }}else{    echo '... ERROR';    die;}//si hay datos los incorporo al array $asientoif(is_array($venta)){    for ($i = 0; $i < count($asiento); $i++) {        $asiento[$i]['asientoF'] = $venta['asientoF'];        $asiento[$i]['NumFactura'] = $venta['Factura'];        $asiento[$i]['Tipo'] = 'Venta';    }}$insertadoOK='';foreach($asiento as $movimiento){    //la consulta a sido correcta, preparo los datos para la insercion en Access    $StatusTraspasadoConta=0;    $Proceso=$numeroProceso;    $Aplicacion='CON';    $CodigoAsesor='000';    $CodigoEmpresa=$codigoEmpresa;    $Asiento=(int)$movimiento['asiento'] + 7000;//le sumo 7000 por indicacion de JM    $Orden=(int)$movimiento['orden'];    $Fecha=substr($movimiento['fechaApunte'],8,2).'/'.substr($movimiento['fechaApunte'],5,2).'/'.substr($movimiento['fechaApunte'],0,4);    $StatusRecalculoAsiento=-1;    $Periodo=(int)substr($movimiento['fechaApunte'],5,2);    while(substr($Periodo,0,1)==='0'){        $Periodo=(int)substr($Periodo,1);    }    $CargoAbono=$movimiento['DoH'];    $CodigoCuenta=$movimiento['idCuenta'];    $ContrapartidaInfo='';//    $numFactura=substr($movimiento['NumFactura'],4,4);    if($movimiento['NumFactura'] !== null){        //$numFactura = contador($movimiento['NumFactura'],$tipoContador);                    $numFactura = numeroDesformateado($movimiento['NumFactura'],$tipoContador);        }    while(substr($numFactura,0,1)==='0'){        $numFactura=substr($numFactura,1);    }    $Documento=$numFactura;    $CodigoConcepto=0;    $Comentario=utf8_decode(substr($movimiento['concepto'],0,35));    $Importe=(float)($movimiento['cantidad']);    // Factura=10, resto=12    $CodigoDiario=12;    if(isset($movimiento['NumFactura']) && $movimiento['NumFactura']<>''){        $CodigoDiario=10;    }    $CodigoCanal=0;    $CodigoActividad='';    $Previsiones='';    $StatusConciliacion=0;    $StatusSaldo=0;    $StatusTraspaso=0;    $CodigoUsuario=0;    date_default_timezone_set('Europe/Madrid');    $FechaGrabacion=date('d/m/Y');    $TipoEntrada='99';    $Impagado=0;    $Vto='';//no lo he indicado en la SQL    $CodigoProyecto='';    $CodigoDepartamento='';    $CodigoSeccion='';    $CodigoDivisa='';    $ImporteCambio=0;    $ImporteDivisa=0;    $FactorCambio=0;    $CodigoConciliacion=0;    $FechaConciliacion='';//no lo he indicado en la SQL    $CodigoDisparoAnalitica='';    $StatusAnalitica=0;    $TipoMovimiento=0;    $TipoDocumento='';    $EnEuros_=2;    $LibreN1=0;    $LibreN2=0;    $LibreA1='';    $LibreA2='';    $IdDelegacion='';    //preparo la consulta SQL    $strSQL="            INSERT INTO movimientos            (StatusTraspasadoConta,Proceso,Aplicacion,CodigoAsesor,CodigoEmpresa,Asiento,Orden,Fecha,StatusRecalculoAsiento,Periodo,CargoAbono,            CodigoCuenta,ContrapartidaInfo,Documento,CodigoConcepto,Comentario,Importe,CodigoDiario,CodigoCanal,CodigoActividad,Previsiones,StatusConciliacion,            StatusSaldo,StatusTraspaso,CodigoUsuario,FechaGrabacion,TipoEntrada,Impagado,CodigoProyecto,CodigoDepartamento,CodigoSeccion,            CodigoDivisa,ImporteCambio,ImporteDivisa,FactorCambio,CodigoConciliacion,CodigoDisparoAnalitica,StatusAnalitica,TipoMovimiento,            TipoDocumento,EnEuros_,LibreN1,LibreN2,LibreA1,LibreA2,IdDelegacion)            VALUES            ($StatusTraspasadoConta,$Proceso,'$Aplicacion','$CodigoAsesor',$CodigoEmpresa,$Asiento,$Orden,'$Fecha',$StatusRecalculoAsiento,            $Periodo,'$CargoAbono','$CodigoCuenta','$ContrapartidaInfo','$Documento',$CodigoConcepto,'$Comentario',$Importe,$CodigoDiario,            $CodigoCanal,'$CodigoActividad','$Previsiones',$StatusConciliacion,$StatusSaldo,$StatusTraspaso,$CodigoUsuario,'$FechaGrabacion',            '$TipoEntrada',$Impagado,'$CodigoProyecto','$CodigoDepartamento','$CodigoSeccion','$CodigoDivisa',$ImporteCambio,            $ImporteDivisa,$FactorCambio,$CodigoConciliacion,'$CodigoDisparoAnalitica',$StatusAnalitica,$TipoMovimiento,'$TipoDocumento',            $EnEuros_,$LibreN1,$LibreN2,'$LibreA1','$LibreA2','$IdDelegacion')            ";    logger('traza','insertarAsientoContabil.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().            " || SQL : ".$strSQL);        if(!$dbAccess->conectar()){        echo '... ERROR';        die;    }    $rs = $dbAccess->consulta( $strSQL );    if($rs){        $insertadoOK[]=$movimiento['IdMovimiento'];    }else{        echo '... ERROR';        die;    }    //ahora inserto los movimientos que son de factura    if($movimiento['asientoF']<>''){        //veo si la cuenta es 43.. y si el TipoAsiento es..N es Debe(D) y si es ..A es Haber(H)        $tipoAsiento = substr($movimiento['TipoAsiento'],2,3);        $DoH = 'D';        if($tipoAsiento === 'A'){            $DoH = 'H';        }                if(substr($movimiento['idCuenta'],0,2) === '43' && $movimiento['DoH'] === $DoH){            //preparo los datos            $StatusTraspasadoConta=0;            $Proceso=$numeroProceso;            $Aplicacion='CON';            $CodigoAsesor='000';            $CodigoEmpresa=$codigoEmpresa;            $Asiento=(int)$movimiento['asiento'] + 7000;//le sumo 7000 por indicacion de JM            $OrdenMov=1;            //veo si vengo de Facturas o de Ventas            if($movimiento['Tipo'] === 'Factura'){                $FacturaRegistro = $numFactura;            }else{                $FacturaRegistro = $movimiento['NumFactura'];            }            $FechaFactura=substr($movimiento['fechaApunte'],8,2).'/'.substr($movimiento['fechaApunte'],5,2).'/'.substr($movimiento['fechaApunte'],0,4);            $ImporteFactura=(float)($movimiento['cantidad']);            $RegistroCartera=$FacturaRegistro;            $TipoIva='E';            $CodigoCuenta=$movimiento['idCuenta'];            //para el nombre me tengo que traer los datos del cliente(nombre)            $strSQL = "                        SELECT C.Nombre                        FROM tbcuenta C                        WHERE C.NumCuenta='".$movimiento['idCuenta']."'                        AND C.Borrado=0                      ";            logger('traza','insertarAsientoContabil.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().                    " || SQL : ".$strSQL);                $db->conectar($_SESSION['mapeo']);            $stmt = $db->ejecutar ( $strSQL );            $db->desconectar();                        $rowNombre = mysql_fetch_array($stmt);                        $Nombre = utf8_decode($rowNombre['Nombre']);//            $Nombre = mb_convert_encoding($Nombre, "UTF-8", "auto");            $CodigoRetencion=0;            $PorcientoRetencion=0;            $Retencion=0;            $BaseRetencion=0;            $Intracomunitaria=0;            $Fecha347=$FechaFactura;            $EnEuros_=2;            $Abono='NO';            $texto = substr($movimiento['TipoAsiento'],2,1);            if(substr($movimiento['TipoAsiento'],2,1) === 'A'){                $Abono='SI';            }            $FechaOperacion=$FechaFactura;            //preparo la consulta SQL            $strSQL="                    INSERT INTO movimientosFacturas                    (StatusTraspasadoConta,Proceso,Aplicacion,CodigoAsesor,CodigoEmpresa,Asiento,OrdenMov,FacturaRegistro,FechaFactura,                    ImporteFactura,RegistroCartera,TipoIva,CodigoCuenta,Nombre,CodigoRetencion,[%Retencion],Retencion,BaseRetencion,Intracomunitaria,                    Fecha347,EnEuros_,Abono,FechaOperacion)                    VALUES                    ($StatusTraspasadoConta,$Proceso,'$Aplicacion','$CodigoAsesor',$CodigoEmpresa,$Asiento,$OrdenMov,$FacturaRegistro,                    '$FechaFactura',$ImporteFactura,$RegistroCartera,'$TipoIva','$CodigoCuenta','$Nombre',$CodigoRetencion,$PorcientoRetencion,                    $Retencion,$BaseRetencion,$Intracomunitaria,'$Fecha347',$EnEuros_,'$Abono','$FechaOperacion')                    ";            logger('traza','insertarAsientoContabil.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().                    " || SQL : ".$strSQL);                        $rs = $dbAccess->consulta( $strSQL );            $dbAccess->desconectar();            if(!$rs){                echo '... ERROR';                die;            }        }    }//    $par++;}//ahora leo los datos de la tabla 'tbmovimientosIva'$strSQL = "            SELECT DISTINCT M.asiento,I.IdIvaOrden,I.BaseImponible,I.Iva,I.CuotaIVA,F.NumFactura            FROM tbmovimientos M LEFT JOIN tbmisfacturas F ON (M.asiento=F.asiento), tbmovimientos_iva I            WHERE M.Borrado=1            AND M.Exportado IS NULL            AND I.IdAsiento=M.asiento            AND I.Borrado=1            AND M.asiento=".$movimiento['asiento']."          ";logger('traza','insertarAsientoContabil.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().        " || SQL : ".$strSQL);$db->conectar($_SESSION['mapeo']);$stmt = $db->ejecutar ( $strSQL );$db->desconectar();$asientoIVA='';if($stmt){    while($row=  mysql_fetch_array($stmt)){        $mov='';        foreach($row as $propiedad=>$valor){            if(!is_numeric($propiedad)){                $mov[$propiedad]=$valor;            }        }        $asientoIVA[]=$mov;    }}else{    echo '... ERROR';    die;}if(is_array($asientoIVA)){    foreach($asientoIVA as $movimientoIva){        //preparo los datos        $StatusTraspasadoConta=0;        $Proceso=$numeroProceso;        $Aplicacion='CON';        $CodigoAsesor='000';        $CodigoEmpresa=$codigoEmpresa;        $Asiento=(int)$movimientoIva['asiento'] + 7000;//le sumo 7000 por indicacion de JM        $OrdenMov=(int)$movimientoIva['IdIvaOrden'];        $OrdenIva=$OrdenMov;        $CodigoIva=(int)$movimientoIva['Iva'];        $BaseIva=(float)$movimientoIva['BaseImponible'];        $BaseCorrectora=0;        $Iva=$CodigoIva;        $CuotaIva=(float)$movimientoIva['CuotaIVA'];        $PorcRecargoEquivalencia=0;        $RecargoEquivalencia=0;        $CodigoTransaccion=1;        $Deducible=-1;        $Exclusion347=0;        $Mediacion=0;        $CodigoActividad='';        $Prorrateo=0;        //preparo la consulta SQL        $strSQL="                INSERT INTO movimientosIva                (StatusTraspasadoConta,Proceso,Aplicacion,CodigoAsesor,CodigoEmpresa,Asiento,OrdenMov,OrdenIva,CodigoIva,BaseIva,                [%BaseCorrectora],[%Iva],CuotaIva,[%RecargoEquivalencia],RecargoEquivalencia,CodigoTransaccion,Deducible,Exclusion347,                Mediacion,CodigoActividad,Prorrateo)                VALUES                ($StatusTraspasadoConta,$Proceso,'$Aplicacion','$CodigoAsesor',$CodigoEmpresa,$Asiento,$OrdenMov,$OrdenIva,$CodigoIva,                 $BaseIva,$BaseCorrectora,$Iva,$CuotaIva,$PorcRecargoEquivalencia,$RecargoEquivalencia,$CodigoTransaccion,$Deducible,                 $Exclusion347,$Mediacion,'$CodigoActividad',$Prorrateo)                ";        logger('traza','insertarAsientoContabil.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().                " || SQL : ".$strSQL);                    if(!$dbAccess->conectar()){            echo '... ERROR';            die;        }        $rs = $dbAccess->consulta( $strSQL );        $dbAccess->desconectar();        if(!$rs){            echo '... ERROR';            die;        }    }}//por ultimo actualizo la tabla 'tbmovimientos' el campo 'Exportado'foreach($insertadoOK as $exportado){    $strSQL = "                UPDATE tbmovimientos                 SET Exportado=now()                WHERE IdMovimiento=".$exportado."             ";    logger('traza','insertarAsientoContabil.php-' ,"Usuario: ".$_SESSION['strUsuario'].', Empresa: '.$_SESSION['strBD'].', SesionID: '.  session_id().            " || SQL : ".$strSQL);                $db->conectar($_SESSION['mapeo']);    $stmt = $db->ejecutar ( $strSQL );    $db->desconectar();}echo '... OK';echo '</td>';    echo '</tr>';    ?>